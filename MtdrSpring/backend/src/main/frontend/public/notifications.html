<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Notificaciones</title>
  <link rel="icon" href="/favicon.svg" type="image/svg+xml" />
  <link rel="apple-touch-icon" href="/favicon.svg" />
  <link rel="stylesheet" href="Css/notifications.css"/>
  <link href="https://api.fontshare.com/v2/css?f[]=panchang@500,600,700,800,900&display=swap" rel="stylesheet">
  <script src="/session.js"></script>
</head>
<body class="theme-dark">

  <!-- ============================
       PANTALLA DE CARGA - CUBO ROJO
       ============================ -->
  <div class="loading-screen" id="notifications-loading-screen">
    <div class="spinner">
      <div></div><div></div><div></div>
      <div></div><div></div><div></div>
    </div>
    <div class="loading-text">Cargando notificaciones...</div>
  </div>

  <!-- ICON SPRITE -->
  <svg xmlns="http://www.w3.org/2000/svg" style="display:none">
    <symbol id="i-dashboard" viewBox="0 0 24 24" fill="none" stroke="currentColor">
      <path stroke-width="1.6" d="M3 3h8v8H3zM13 3h8v5h-8zM13 10h8v11h-8zM3 13h8v8H3z"/>
    </symbol>
    <symbol id="i-users" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round">
      <path d="M17 21v-2a4 4 0 0 0-3-3.87"/><path d="M7 21v-2a4 4 0 0 1 3-3.87"/>
      <circle cx="12" cy="7" r="4"/><path d="M5.5 8a3.5 3.5 0 1 0 0 7"/><path d="M18.5 8a3.5 3.5 0 1 1 0 7"/>
    </symbol>
    <symbol id="i-folder" viewBox="0 0 24 24" fill="none" stroke="currentColor">
      <path stroke-width="1.6" d="M3 7h6l2 2h10v9a3 3 0 0 1-3 3H6a3 3 0 0 1-3-3z"/>
    </symbol>
    <symbol id="i-board" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <rect width="8" height="4" x="8" y="2" rx="1" ry="1"/>
      <path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"/>
      <path d="M12 11h4"/><path d="M12 16h4"/><path d="M8 11h.01"/><path d="M8 16h.01"/>
    </symbol>
    <symbol id="i-chart" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round">
      <path d="M12 16v5"/><path d="M16 14v7"/><path d="M20 10v11"/><path d="m22 3-8.646 8.646a.5.5 0 0 1-.708 0L9.354 8.354a.5.5 0 0 0-.707 0L2 15"/>
      <path d="M4 18v3"/><path d="M8 14v7"/>
    </symbol>
    <symbol id="i-bell" viewBox="0 0 24 24" fill="none" stroke="currentColor">
      <path stroke-width="1.6" d="M18 8a6 6 0 1 0-12 0c0 7-3 7-3 7h18s-3 0-3-7"/>
      <path stroke-width="1.6" d="M13.73 21a2 2 0 0 1-3.46 0"/>
    </symbol>
    <symbol id="i-gear" viewBox="0 0 24 24" fill="none" stroke="currentColor">
      <circle cx="12" cy="12" r="3"/>
      <path stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round" d="M9.671 4.136a2.34 2.34 0 0 1 4.659 0 2.34 2.34 0 0 0 3.319 1.915 2.34 2.34 0 0 1 2.33 4.033 2.34 2.34 0 0 0 0 3.831 2.34 2.34 0 0 1-2.33 4.033 2.34 2.34 0 0 0-3.319 1.915 2.34 2.34 0 0 1-4.659 0 2.34 2.34 0 0 0-3.32-1.915 2.34 2.34 0 0 1-2.33-4.033 2.34 2.34 0 0 0 0-3.831A2.34 2.34 0 0 1 6.35 6.051a2.34 2.34 0 0 0 3.319-1.915"/>
    </symbol>
  </svg>

  <!-- TOPBAR -->
  <header class="topbar">
    <div class="brand"><h1 class="logo-text">TMDV</h1></div>
    <div class="topbar-right">
      <div class="user-circle" title="Usuario">U</div>
      <a href="/index.html" class="logout-btn">Salir</a>
    </div>
  </header>

  <div class="app">
    <!-- SIDEBAR -->
    <aside class="aside">
      <nav class="menu">
        <a class="mi" href="/dashboard.html"><svg class="ico"><use href="#i-dashboard"/></svg><span>Dashboard</span></a>
        <a class="mi" href="/Equipos.html"><svg class="ico"><use href="#i-users"/></svg><span>Equipos</span></a>
        <a class="mi" href="/projects.html"><svg class="ico"><use href="#i-folder"/></svg><span>Proyectos</span></a>
        <a class="mi" href="/tarea.html"><svg class="ico"><use href="#i-board"/></svg><span>Mis Tareas</span></a>
        <a class="mi" href="/KPIs.html"><svg class="ico"><use href="#i-chart"/></svg><span>KPIs</span></a>
        <a class="mi active" href="#"><svg class="ico"><use href="#i-bell"/></svg><span>Notificaciones</span></a>
        <a class="mi" href="/settings.html"><svg class="ico"><use href="#i-gear"/></svg><span>Ajustes</span></a>
      </nav>
    </aside>

    <!-- MAIN -->
    <main class="main">
      <section class="panel">
        <div class="panel-head">
          <h1 class="title">Notificaciones <span id="counter" class="muted">â€”</span></h1>
          <div class="head-actions">
            <div class="pills">
              <button id="filterAll" class="pill active">Todo</button>
              <button id="filterUnread" class="pill">No leÃ­das</button>
              <button id="filterInv" class="pill">Invitaciones</button>
            </div>
            <div class="actions-end">
              <button id="btnMarkAll" class="btn ghost">Marcar todas como leÃ­das</button>
              <button id="btnDeleteAll" class="btn danger">Eliminar todas</button>
            </div>
          </div>
        </div>
      </section>

      <section id="list" class="list">
        <div class="meta">Cargandoâ€¦</div>
      </section>
    </main>
  </div>

  <!-- LOADER GLOBAL (el que ya tenÃ­as, lo conservamos) -->
  <div class="page-loader" data-page-loader>
    <div class="loader-card">
      <div class="loader-dots">
        <span></span><span></span><span></span>
      </div>
      <p>Cargando notificaciones...</p>
    </div>
  </div>

  <div id="toast" class="toast ok">Hecho</div>

<script>
const API_BASE = '';
const NOTIF_API = `${API_BASE}/notificaciones`;
const EQUIPOS_API = `${API_BASE}/equipos`;

const user = JSON.parse(localStorage.getItem('user') || 'null');
const USER_ID = Number(user?.usuarioId ?? user?.id ?? NaN);

const loaderEl = document.querySelector('[data-page-loader]');
const loadingScreenEl = document.getElementById('notifications-loading-screen');

const escapeHtml = s => String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
const fmt = iso => { try{ const d=new Date(iso); return isNaN(d)?'â€”':d.toLocaleString(); }catch{ return 'â€”'; } };
const toast = (msg='Hecho', type='ok') => {
  const t=document.getElementById('toast');
  t.textContent = msg;
  t.classList.remove('err','ok');
  t.classList.add(type === 'ok' ? 'ok' : 'err','show');
  setTimeout(()=>t.classList.remove('show'), 2200);
};
const authHeaders = () => {
  const h = {};
  if (!Number.isNaN(USER_ID)) h['X-User-Id'] = String(USER_ID);
  return h;
};

// ðŸ‘‰ Ahora showLoader controla tanto el loader antiguo como la pantalla del cubo rojo
const showLoader = (show) => {
  if (loaderEl) loaderEl.style.display = show ? 'flex' : 'none';
  if (loadingScreenEl) loadingScreenEl.classList.toggle('hidden', !show);
};

let FULL = [];
let FILTER = 'ALL'; // ALL | UNREAD | INVITES

function applyFilter(arr){
  if (FILTER === 'UNREAD') return arr.filter(n => n.leida === 'N');
  if (FILTER === 'INVITES') return arr.filter(n => String(n.tipo||'').toUpperCase()==='INVITACION_EQUIPO');
  return arr;
}

function extractToken(msg){
  const s = String(msg || '');
  const m = s.match(/token[:=]\s*([A-Za-z0-9_\-]+)/i) || s.match(/\b([A-Za-z0-9_\-]{16,})\b/);
  return m ? m[1] : '';
}

function render(){
  const list = applyFilter(FULL);
  const $list = document.getElementById('list');
  const $counter = document.getElementById('counter');

  const unread = FULL.filter(n => n.leida==='N').length;
  $counter.textContent = `${FULL.length} Â· ${unread} sin leer`;

  if (!list.length){
    $list.innerHTML = `<div class="meta">Sin notificaciones</div>`;
    return;
  }

  $list.innerHTML = list.map(n=>{
    const isInvite = String(n.tipo || '').toUpperCase() === 'INVITACION_EQUIPO';
    const token = isInvite ? extractToken(n.mensaje) : '';

    const baseText = isInvite
      ? `Has sido invitado al equipo #${n.equipoId}.`
      : (n.mensaje || '');

    const raw = (baseText || '').trim();
    const short = raw.length > 120 ? raw.slice(0, 120) + 'â€¦' : raw;

    const previewHtml = escapeHtml(short);
    const fullHtml = escapeHtml(raw || short);

    const right = isInvite
      ? `<div class="row-actions">
           <button class="chip primary" data-accept="${token}" data-team-id="${n.equipoId || ''}" ${!token ? 'disabled' : ''}>Aceptar</button>
           <button class="chip ghost" data-decline="${token}" ${!token ? 'disabled' : ''}>Rechazar</button>
           <button class="chip danger" data-del="${n.id}">Eliminar</button>
         </div>`
      : `<div class="row-actions">
           ${n.leida==='N' ? `<button class="chip ghost" data-read="${n.id}">Marcar leÃ­da</button>` : ``}
           <button class="chip danger" data-del="${n.id}">Eliminar</button>
         </div>`;

    return `
      <article class="card-item ${n.leida==='N' ? 'unread' : ''}">
        <div class="card-left">
          <div class="bullet ${n.leida==='N' ? 'on' : ''}"></div>
          <div class="content">
            <div class="title-row">
              <h3 class="item-title">${escapeHtml(n.titulo || 'NotificaciÃ³n')}</h3>
              ${right}
            </div>
            <div class="meta small">${fmt(n.fechaEnvio)}
              ${n.prioridad ? (' Â· '+escapeHtml(n.prioridad)) : ''} ${n.tipo ? (' Â· '+escapeHtml(n.tipo)) : ''}</div>
            <p class="text text-preview">${previewHtml}</p>
            <p class="text text-full">${fullHtml}</p>
            <div class="expand-hint">Haz clic para ver mÃ¡s detalles</div>
          </div>
        </div>
      </article>`;
  }).join('');

  // Handlers
  document.querySelectorAll('[data-read]').forEach(b=>{
    b.onclick = async (e) => {
      e.stopPropagation();
      const id = b.getAttribute('data-read');
      try{
        const r = await fetch(`${NOTIF_API}/${id}/leer`, { method:'PATCH', headers: { 'Content-Type':'application/json', ...authHeaders() } });
        if (r.ok){ await load(); toast('NotificaciÃ³n marcada'); }
      }catch{ toast('Error de red', 'err'); }
    };
  });

  document.querySelectorAll('[data-del]').forEach(b=>{
    b.onclick = async (e) => {
      e.stopPropagation();
      const id = b.getAttribute('data-del');
      if (!confirm('Â¿Eliminar notificaciÃ³n?')) return;
      try{
        const r = await fetch(`${NOTIF_API}/${id}`, { method:'DELETE', headers: { ...authHeaders() } });
        if (r.ok || r.status===204){ await load(); toast('Eliminada'); }
        else toast('No se pudo eliminar','err');
      }catch{ toast('Error de red','err'); }
    };
  });

  document.querySelectorAll('[data-accept]').forEach(b=>{
    b.onclick = async (e) => {
      e.stopPropagation();
      const tk = b.getAttribute('data-accept');
      const teamId = b.getAttribute('data-team-id');
      if (!tk) return;
      let teamName = '';
      if (teamId) {
        try {
          const rTeam = await fetch(`${EQUIPOS_API}/${teamId}`, { headers: { ...authHeaders() } });
          if (rTeam.ok) teamName = (await rTeam.json())?.nombreEquipo || '';
        } catch {}
      }
      b.disabled = true;
      try{
        const r = await fetch(`${API_BASE}/equipos/invitaciones/${encodeURIComponent(tk)}/aceptar`, { method:'POST', headers: { ...authHeaders() } });
        if (r.ok){ await load(); toast(`Te uniste a "${teamName || ('#'+teamId)}"`); }
        else { toast(await r.text() || 'No se pudo aceptar','err'); b.disabled=false; }
      }catch{ toast('Error de red','err'); b.disabled=false; }
    };
  });

  document.querySelectorAll('[data-decline]').forEach(b=>{
    b.onclick = async (e) => {
      e.stopPropagation();
      const tk = b.getAttribute('data-decline');
      if (!tk) return;
      b.disabled = true;
      try{
        const r = await fetch(`${API_BASE}/equipos/invitaciones/${encodeURIComponent(tk)}/rechazar`, { method:'POST', headers: { ...authHeaders() } });
        if (r.ok){ await load(); toast('InvitaciÃ³n rechazada'); }
        else { toast(await r.text() || 'No se pudo rechazar','err'); b.disabled=false; }
      }catch{ toast('Error de red','err'); b.disabled=false; }
    };
  });

  // Expand / collapse detalle al hacer clic en la tarjeta
  document.querySelectorAll('.card-item').forEach(card=>{
    card.addEventListener('click', () => {
      card.classList.toggle('expanded');
    });
  });
}

async function load(){
  showLoader(true);
  try{
    if (!Number.isNaN(USER_ID)) {
      const r = await fetch(`${NOTIF_API}?usuarioId=${USER_ID}`, { headers: { ...authHeaders() } });
      if (r.ok){ FULL = await r.json(); render(); return; }
    }
    const r2 = await fetch(`${NOTIF_API}`, { headers: { ...authHeaders() } });
    if (r2.ok){ FULL = await r2.json(); render(); return; }
  }catch{
    document.getElementById('list').innerHTML = `<div class="meta">Error cargando notificaciones.</div>`;
    document.getElementById('counter').textContent = 'â€”';
  } finally {
    showLoader(false);
  }
}

document.getElementById('btnMarkAll').onclick = async () => {
  try{
    const r = await fetch(`${NOTIF_API}/leer-todas`, { method:'PATCH', headers: { ...authHeaders() } });
    if (r.ok){ await load(); toast('Listo'); }
  }catch{}
};

document.getElementById('btnDeleteAll').onclick = async () => {
  if (!confirm('Â¿Eliminar todas tus notificaciones?')) return;
  try{
    const r = await fetch(`${NOTIF_API}/todas`, { method:'DELETE', headers: { ...authHeaders() } });
    if (r.ok){ await load(); toast('Todas eliminadas'); }
    else toast('No se pudieron eliminar','err');
  }catch{ toast('Error de red','err'); }
};

// Filtros (pills)
const setActive = (id) => {
  document.querySelectorAll('.pill').forEach(p=>p.classList.remove('active'));
  document.getElementById(id).classList.add('active');
};
document.getElementById('filterAll').onclick = ()=>{ FILTER='ALL'; setActive('filterAll'); render(); };
document.getElementById('filterUnread').onclick = ()=>{ FILTER='UNREAD'; setActive('filterUnread'); render(); };
document.getElementById('filterInv').onclick = ()=>{ FILTER='INVITES'; setActive('filterInv'); render(); };

// Init
document.addEventListener('DOMContentLoaded', () => {
  const $u = document.querySelector('.user-circle');
  if ($u && (user?.nombre || user?.email)) {
    $u.textContent = String((user?.nombre?.[0] || user?.email?.[0] || 'U')).toUpperCase();
  }
  load();
});
</script>

  <!-- BotÃ³n flotante de Telegram -->
  <a 
    href="https://t.me/HoracioTDBOT"
    target="_blank" 
    rel="noopener noreferrer"
    class="telegram-floating-button"
    title="Hablar con el bot en Telegram"
  >
    <button class="button telegram-button">
      <div class="icon">
        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor"
             viewBox="0 0 16 16" aria-hidden="true">
          <path d="M16 8A8 8 0 1 1 0 8a8 8 0 0 1 16 0zM8.287 5.906c-.778.324-2.334.994-4.666 2.01-.378.15-.577.298-.595.442-.03.243.275.339.69.47l.175.055c.408.133.958.288 1.243.294.26.006.549-.1.868-.32 2.179-1.471 3.304-2.214 3.374-2.23.05-.012.12-.026.166.016.047.041.042.12.037.141-.03.129-1.227 1.241-1.846 1.817-.193.18-.33.307-.358.336a8.154 8.154 0 0 1-.188.186c-.38.366-.664.64.015 1.088.327.216.589.393.85.571.284.194.568.387.936.629.093.06.183.125.27.187.331.236.63.448.997.414.214-.02.435-.22.547-.82.265-1.417.786-4.486.906-5.751a1.426 1.426 0 0 0-.013-.315.337.337 0 0 0-.114-.217.526.526 0 0 0-.31-.093c-.3.005-.763.166-2.984 1.09z"></path>
        </svg>
      </div>
      <p>Telegram</p>
    </button>
  </a>
  
</body>
</html>
