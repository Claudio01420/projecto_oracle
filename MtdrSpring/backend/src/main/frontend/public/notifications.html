<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Notificaciones</title>
  <link rel="stylesheet" href="Css/notifications.css"/>
</head>


<body>

  <!-- Barra superior -->
  <header class="topbar">
         <div class="brand">
        <img src="/image/Oracle_logo.png" alt="Oracle Logo"/>
      </div>
    <div class="topbar-right">
      <div class="user-circle" title="Usuario">U</div>
      <a href="/index.html" class="logout-btn">
        <svg class="ico-sm" aria-hidden="true"><use href="#i-exit"/></svg>
        <span>Salir</span>
      </a>
    </div>
  </header>

  <div class="app">
    <!-- Sidebar -->
    <aside class="aside">
      <nav class="menu">
        <a class="mi" href="/dashboard.html"><span>üìä</span> Dashboard</a>
        <a class="mi" href="/projects.html"><span>üìÅ</span> Proyectos</a>
        <a class="mi" href="/tarea.html"><span>‚úÖ</span> Tareas</a>
        <a class="mi" href="/kpis.html"><span>üìà</span> KPIs</a>
        <a class="mi" href="/chatbot.html"><span>ü§ñ</span> Chatbot</a>
        <a class="mi active" href="#"><span>üîî</span> Notificaciones</a>
        <a class="mi" href="/settings.html"><span>‚öôÔ∏è</span> Ajustes</a>
      </nav>
    </aside>

    <main class="main">
      <section class="card card-soft">
        <h1 class="h4">Notificaciones</h1>

        <div class="grid">
          <!-- Filtros -->
          <div class="col filters">
            <h3 class="h6">Filtros</h3>

            <div class="filter-group">
              <span class="filter-label">Tipo</span>
              <label><input type="checkbox" class="f-tipo" value="Proyectos" checked/> Proyectos</label>
              <label><input type="checkbox" class="f-tipo" value="Tareas" checked/> Tareas</label>
              <label><input type="checkbox" class="f-tipo" value="Sprints" checked/> Sprints</label>
              <label><input type="checkbox" class="f-tipo" value="Equipo" checked/> Equipo</label>
            </div>

            <div class="filter-group">
              <span class="filter-label">Estado</span>
              <label><input type="radio" name="estado" value="unread" checked/> No le√≠das</label>
              <label><input type="radio" name="estado" value="read"/> Le√≠das</label>
              <label><input type="radio" name="estado" value="all"/> Todas</label>
            </div>

            <label class="switch">
              <input type="checkbox" id="toggle-notifs"/>
              <span class="slider"></span>
              Activar notificaciones
            </label>

            <button id="btn-read-all" class="btn">Marcar todas como le√≠das</button>
          </div>

          <!-- Bandeja -->
          <div class="col inbox">
            <h3 class="h6">Bandeja</h3>
            <ul id="notif-list" class="notif-list"></ul>
          </div>
        </div>
      </section>
    </main>
  </div>

  <script>
    // ===== Sesi√≥n =====
    const user = JSON.parse(localStorage.getItem("user") || "null");
    const userEmail = user?.email || null;

    // ===== DOM =====
    const $list = document.getElementById("notif-list");
    const $btnReadAll = document.getElementById("btn-read-all");

    function getEstado() {
      const r = document.querySelector('input[name="estado"]:checked');
      return r ? r.value : "unread";
    }
    function getTiposCSV() {
      const vals = Array.from(document.querySelectorAll('.f-tipo:checked')).map(i => i.value);
      return vals.join(',');
    }

    async function loadNotifs() {
      $list.innerHTML = '';
      if (!userEmail) {
        $list.innerHTML = `<li class="empty">Inicia sesi√≥n para ver tus notificaciones.</li>`;
        return;
      }
      const estado = getEstado();
      const tipos = getTiposCSV();

      const url = new URL(window.location.origin + '/notificaciones');
      url.searchParams.set('estado', estado);
      if (tipos) url.searchParams.set('tipos', tipos);

      try {
        const res = await fetch(url.toString(), {
          headers: { 'X-User-Email': userEmail }
        });
        if (!res.ok) {
          $list.innerHTML = `<li class="empty">Error al cargar notificaciones.</li>`;
          return;
        }
        const data = await res.json();
        if (!data || !data.length) {
          $list.innerHTML = `<li class="empty">No hay notificaciones</li>`;
          return;
        }
        renderList(data);
      } catch {
        $list.innerHTML = `<li class="empty">Error de red al cargar notificaciones.</li>`;
      }
    }

    function fmt(dt) {
      try { return new Date(dt).toLocaleString(); } catch { return ''; }
    }

    function renderList(items) {
      $list.innerHTML = '';
      for (const n of items) {
        const li = document.createElement('li');
        li.className = 'notif-item';

        const icon = document.createElement('div');
        if (n.leida === 'Y') {
          icon.className = 'badge-check';
          icon.innerHTML = '‚úî';
        } else {
          icon.className = 'badge-dot';
        }

        const content = document.createElement('div');
        content.className = 'notif-content';
        content.innerHTML = `
          <div class="notif-title">${escapeHtml(n.mensaje)} <span class="chip ${escapeHtml(n.tipo)}">${escapeHtml(n.tipo)}</span></div>
          <small>${fmt(n.fechaEnvio)}${n.prioridad ? ' ‚Äì '+escapeHtml(n.prioridad): ''}</small>
        `;

        const actions = document.createElement('div');
        actions.className = 'notif-actions';
        if (n.leida !== 'Y') {
          const a = document.createElement('span');
          a.className = 'link';
          a.textContent = 'Marcar como le√≠do';
          a.onclick = async () => {
            const r = await fetch(`/notificaciones/${n.id}/leer`, { method:'PATCH' });
            if (r.ok) loadNotifs();
          };
          actions.appendChild(a);
        } else {
          const ok = document.createElement('span');
          ok.style.color = '#22c55e';
          ok.textContent = 'Le√≠da';
          actions.appendChild(ok);
        }

        li.appendChild(icon);
        li.appendChild(content);
        li.appendChild(actions);
        $list.appendChild(li);
      }
    }

    function escapeHtml(s){
      return String(s ?? '').replace(/[&<>"']/g, m => (
        {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]
      ));
    }

    // Eventos de filtros
    document.querySelectorAll('.f-tipo').forEach(ch => ch.addEventListener('change', loadNotifs));
    document.querySelectorAll('input[name="estado"]').forEach(r => r.addEventListener('change', loadNotifs));

    // Marcar todas como le√≠das (con estado de carga)
    $btnReadAll.addEventListener('click', async () => {
      if (!userEmail) return;
      const original = $btnReadAll.textContent;
      $btnReadAll.disabled = true;
      $btnReadAll.textContent = 'Marcando...';
      try {
        const r = await fetch(`/notificaciones/leer-todas`, {
          method:'PATCH',
          headers: { 'X-User-Email': userEmail }
        });
        if (r.ok) await loadNotifs();
      } finally {
        $btnReadAll.disabled = false;
        $btnReadAll.textContent = original;
      }
    });

    document.addEventListener('DOMContentLoaded', loadNotifs);
  </script>
</body>
</html>
