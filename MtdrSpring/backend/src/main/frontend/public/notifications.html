<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Notificaciones</title>
  <link rel="stylesheet" href="Css/notifications.css"/>
  <link href="https://api.fontshare.com/v2/css?f[]=panchang@500,600,700,800,900&display=swap" rel="stylesheet">

    <!-- Sprite de íconos -->
  <svg xmlns="http://www.w3.org/2000/svg" style="display:none">
  <!-- Dashboard -->
  <symbol id="i-dashboard" viewBox="0 0 24 24" fill="none" stroke="currentColor">
    <path stroke-width="1.6" d="M3 3h8v8H3zM13 3h8v5h-8zM13 10h8v11h-8zM3 13h8v8H3z"/>
  </symbol>
  <!-- Equipos -->
  <symbol id="i-users" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round">
    <path d="M17 21v-2a4 4 0 0 0-3-3.87"/>
    <path d="M7 21v-2a4 4 0 0 1 3-3.87"/>
    <circle cx="12" cy="7" r="4"/>
    <path d="M5.5 8a3.5 3.5 0 1 0 0 7"/>
    <path d="M18.5 8a3.5 3.5 0 1 1 0 7"/>
  </symbol>
  <!-- Proyectos -->
  <symbol id="i-folder" viewBox="0 0 24 24" fill="none" stroke="currentColor">
    <path stroke-width="1.6" d="M3 7h6l2 2h10v9a3 3 0 0 1-3 3H6a3 3 0 0 1-3-3z"/>
  </symbol>
  <!-- Tareas -->
  <symbol id="i-board" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
    <rect width="8" height="4" x="8" y="2" rx="1" ry="1"/>
    <path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"/>
    <path d="M12 11h4"/><path d="M12 16h4"/>
    <path d="M8 11h.01"/><path d="M8 16h.01"/>
  </symbol>
  <!-- KPIs -->
  <symbol id="i-chart" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round">
    <path d="M12 16v5"/>
    <path d="M16 14v7"/>
    <path d="M20 10v11"/>
    <path d="m22 3-8.646 8.646a.5.5 0 0 1-.708 0L9.354 8.354a.5.5 0 0 0-.707 0L2 15"/>
    <path d="M4 18v3"/>
    <path d="M8 14v7"/>
  </symbol>
  <!-- Chatbot -->
  <symbol id="i-bot" viewBox="0 0 24 24" fill="none" stroke="currentColor">
    <rect x="4" y="8" width="16" height="10" rx="4" stroke-width="1.6"/>
    <circle cx="9" cy="13" r="1" stroke-width="1.6"/>
    <circle cx="15" cy="13" r="1" stroke-width="1.6"/>
    <path stroke-width="1.6" d="M12 4v2m-7 6H4m16 0h1"/>
  </symbol>
  <!-- Notificaciones -->
  <symbol id="i-bell" viewBox="0 0 24 24" fill="none" stroke="currentColor">
    <path stroke-width="1.6" d="M18 8a6 6 0 1 0-12 0c0 7-3 7-3 7h18s-3 0-3-7"/>
    <path stroke-width="1.6" d="M13.73 21a2 2 0 0 1-3.46 0"/>
  </symbol>
  <!-- Ajustes -->
  <symbol id="i-gear" viewBox="0 0 24 24" fill="none" stroke="currentColor">
    <circle cx="12" cy="12" r="3" />
    <path stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round" d="M9.671 4.136a2.34 2.34 0 0 1 4.659 0 2.34 2.34 0 0 0 3.319 1.915 2.34 2.34 0 0 1 2.33 4.033 2.34 2.34 0 0 0 0 3.831 2.34 2.34 0 0 1-2.33 4.033 2.34 2.34 0 0 0-3.319 1.915 2.34 2.34 0 0 1-4.659 0 2.34 2.34 0 0 0-3.32-1.915 2.34 2.34 0 0 1-2.33-4.033 2.34 2.34 0 0 0 0-3.831A2.34 2.34 0 0 1 6.35 6.051a2.34 2.34 0 0 0 3.319-1.915" />
  </symbol>
  <!-- Power -->
  <symbol id="i-power" viewBox="0 0 24 24" fill="none" stroke="currentColor">
    <path stroke-width="1.8" d="M12 2v8"/>
    <path stroke-width="1.6" d="M5.5 7a8 8 0 1 0 13 0"/>
  </symbol>
  </svg>
</head>


<body>

 <!-- Topbar -->
  <header class="topbar">
    <div class="brand">
      <h1 class="logo-text">TMDV</h1>
    </div>
    <div class="topbar-right">
      <div class="user-circle" title="Usuario">U</div>
      <a href="/index.html" class="logout-btn">
        <svg class="ico-sm" aria-hidden="true"><use href="#i-power"/></svg>
        <span>Salir</span>
      </a>
    </div>
  </header>

 <div class="app">
    <!-- Sidebar -->
    <aside class="aside">
      <nav class="menu">
        <a class="mi" href="/dashboard.html">
          <svg class="ico" aria-hidden="true"><use href="#i-dashboard"/></svg>
          <span>Dashboard</span>
        </a>
        <a class="mi" href="/Equipos.html">
          <svg class="ico"><use href="#i-users"/></svg>
          <span>Equipos</span>
        </a>
        <a class="mi" href="/projects.html">
          <svg class="ico"><use href="#i-folder"/></svg>
          <span>Proyectos</span>
        </a>
        <a class="mi" href="/tarea.html">
          <svg class="ico"><use href="#i-board"/></svg>
          <span>Tareas</span>
        </a>
        <a class="mi" href="/KPIs.html">
          <svg class="ico"><use href="#i-chart"/></svg>
          <span>KPIs</span>
        </a>
        <a class="mi" href="/chatbot.html">
          <svg class="ico"><use href="#i-bot"/></svg>
          <span>Chatbot</span>
        </a>
        <a class="mi active" href="#">
          <svg class="ico"><use href="#i-bell"/></svg>
          <span>Notificaciones</span>
        </a>
        <a class="mi" href="/settings.html">
          <svg class="ico"><use href="#i-gear"/></svg>
          <span>Ajustes</span>
        </a>
      </nav>
    </aside>

    <main class="main">
      <section class="card card-soft">
        <h1 class="h4">Notificaciones</h1>

        <div class="grid">
          <!-- Filtros -->
          <div class="col filters">
            <h3 class="h6">Filtros</h3>

            <div class="filter-group">
              <span class="filter-label">Tipo</span>
              <label><input type="checkbox" class="f-tipo" value="Proyectos" checked/> Proyectos</label>
              <label><input type="checkbox" class="f-tipo" value="Tareas" checked/> Tareas</label>
              <label><input type="checkbox" class="f-tipo" value="Sprints" checked/> Sprints</label>
              <label><input type="checkbox" class="f-tipo" value="Equipo" checked/> Equipo</label>
            </div>

            <div class="filter-group">
              <span class="filter-label">Estado</span>
              <label><input type="radio" name="estado" value="unread" checked/> No leídas</label>
              <label><input type="radio" name="estado" value="read"/> Leídas</label>
              <label><input type="radio" name="estado" value="all"/> Todas</label>
            </div>

            <label class="switch">
              <input type="checkbox" id="toggle-notifs"/>
              <span class="slider"></span>
              Activar notificaciones
            </label>

            <button id="btn-read-all" class="btn">Marcar todas como leídas</button>
          </div>

          <!-- Bandeja -->
          <div class="col inbox">
            <h3 class="h6">Bandeja</h3>
            <ul id="notif-list" class="notif-list"></ul>
          </div>
        </div>
      </section>
    </main>
  </div>

  <script>
    // ===== Sesión =====
    const user = JSON.parse(localStorage.getItem("user") || "null");
    const userEmail = user?.email || null;

    // ===== DOM =====
    const $list = document.getElementById("notif-list");
    const $btnReadAll = document.getElementById("btn-read-all");

    function getEstado() {
      const r = document.querySelector('input[name="estado"]:checked');
      return r ? r.value : "unread";
    }
    function getTiposCSV() {
      const vals = Array.from(document.querySelectorAll('.f-tipo:checked')).map(i => i.value);
      return vals.join(',');
    }

    async function loadNotifs() {
      $list.innerHTML = '';
      if (!userEmail) {
        $list.innerHTML = `<li class="empty">Inicia sesión para ver tus notificaciones.</li>`;
        return;
      }
      const estado = getEstado();
      const tipos = getTiposCSV();

      const url = new URL(window.location.origin + '/notificaciones');
      url.searchParams.set('estado', estado);
      if (tipos) url.searchParams.set('tipos', tipos);

      try {
        const res = await fetch(url.toString(), {
          headers: { 'X-User-Email': userEmail }
        });
        if (!res.ok) {
          $list.innerHTML = `<li class="empty">Error al cargar notificaciones.</li>`;
          return;
        }
        const data = await res.json();
        if (!data || !data.length) {
          $list.innerHTML = `<li class="empty">No hay notificaciones</li>`;
          return;
        }
        renderList(data);
      } catch {
        $list.innerHTML = `<li class="empty">Error de red al cargar notificaciones.</li>`;
      }
    }

    function fmt(dt) {
      try { return new Date(dt).toLocaleString(); } catch { return ''; }
    }

    function renderList(items) {
      $list.innerHTML = '';
      for (const n of items) {
        const li = document.createElement('li');
        li.className = 'notif-item';

        const icon = document.createElement('div');
        if (n.leida === 'Y') {
          icon.className = 'badge-check';
          icon.innerHTML = '✔';
        } else {
          icon.className = 'badge-dot';
        }

        const content = document.createElement('div');
        content.className = 'notif-content';
        content.innerHTML = `
          <div class="notif-title">${escapeHtml(n.mensaje)} <span class="chip ${escapeHtml(n.tipo)}">${escapeHtml(n.tipo)}</span></div>
          <small>${fmt(n.fechaEnvio)}${n.prioridad ? ' – '+escapeHtml(n.prioridad): ''}</small>
        `;

        const actions = document.createElement('div');
        actions.className = 'notif-actions';
        if (n.leida !== 'Y') {
          const a = document.createElement('span');
          a.className = 'link';
          a.textContent = 'Marcar como leído';
          a.onclick = async () => {
            const r = await fetch(`/notificaciones/${n.id}/leer`, { method:'PATCH' });
            if (r.ok) loadNotifs();
          };
          actions.appendChild(a);
        } else {
          const ok = document.createElement('span');
          ok.style.color = '#22c55e';
          ok.textContent = 'Leída';
          actions.appendChild(ok);
        }

        li.appendChild(icon);
        li.appendChild(content);
        li.appendChild(actions);
        $list.appendChild(li);
      }
    }

    function escapeHtml(s){
      return String(s ?? '').replace(/[&<>"']/g, m => (
        {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]
      ));
    }

    // Eventos de filtros
    document.querySelectorAll('.f-tipo').forEach(ch => ch.addEventListener('change', loadNotifs));
    document.querySelectorAll('input[name="estado"]').forEach(r => r.addEventListener('change', loadNotifs));

    // Marcar todas como leídas (con estado de carga)
    $btnReadAll.addEventListener('click', async () => {
      if (!userEmail) return;
      const original = $btnReadAll.textContent;
      $btnReadAll.disabled = true;
      $btnReadAll.textContent = 'Marcando...';
      try {
        const r = await fetch(`/notificaciones/leer-todas`, {
          method:'PATCH',
          headers: { 'X-User-Email': userEmail }
        });
        if (r.ok) await loadNotifs();
      } finally {
        $btnReadAll.disabled = false;
        $btnReadAll.textContent = original;
      }
    });

    document.addEventListener('DOMContentLoaded', loadNotifs);
  </script>
</body>
</html>
