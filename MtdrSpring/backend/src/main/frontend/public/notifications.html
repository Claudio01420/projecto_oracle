<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Notificaciones</title>
  <link rel="stylesheet" href="Css/notifications.css"/>
  <link href="https://api.fontshare.com/v2/css?f[]=panchang@500,600,700,800,900&display=swap" rel="stylesheet">
  <script src="/session.js"></script>

  <style>
    .toolbar{display:flex;gap:10px;align-items:center;justify-content:space-between}
    .btn{padding:8px 12px;border-radius:10px;border:1px solid var(--line);background:#fff;cursor:pointer;font-weight:700}
    .btn.primary{background:var(--brand);color:#fff;border:none}
    .btn:disabled{opacity:.5;cursor:not-allowed}
    .list{margin-top:14px;display:grid;gap:12px}
    .item{border:1px solid var(--line);border-radius:12px;padding:12px;background:#fff;display:flex;justify-content:space-between;gap:12px}
    .item.unread{background:#fffdf5}
    .meta{font-size:12px;color:#64748b}
    .badge{font-size:12px;border:1px solid var(--line);padding:2px 8px;border-radius:999px;background:#fff}
    .modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.45);z-index:300}
    .modal.open{display:flex}
    .card{width:560px;max-width:92vw;background:#fff;border:1px solid var(--line);border-radius:16px;padding:16px}
    .row{display:grid;grid-template-columns:160px 1fr;gap:10px;margin:8px 0}
    .row input,.row textarea,.row select{width:100%;padding:8px;border:1px solid var(--line);border-radius:10px}
    .toast{position:fixed;right:18px;bottom:18px;background:#111;color:#fff;padding:10px 14px;border-radius:10px;opacity:.95;display:none}
    .toast.show{display:block}
  </style>
</head>
<body>
  <!-- Topbar -->
  <header class="topbar">
    <div class="brand"><h1 class="logo-text">TMDV</h1></div>
    <div class="topbar-right">
      <div class="user-circle" title="Usuario">U</div>
      <a href="/index.html" class="logout-btn">
        <svg class="ico-sm" aria-hidden="true"><use href="#i-exit"/></svg>
        <span>Salir</span>
      </a>
    </div>
  </header>

  <div class="app">
    <!-- Sidebar -->
    <aside class="aside">
      <nav class="menu">
        <a class="mi" href="/dashboard.html"><svg class="ico"><use href="#i-dashboard"/></svg><span>Dashboard</span></a>
        <a class="mi" href="/Equipos.html"><svg class="ico"><use href="#i-users"/></svg><span>Equipos</span></a>
        <a class="mi" href="/projects.html"><svg class="ico"><use href="#i-folder"/></svg><span>Proyectos</span></a>
        <a class="mi" href="/tarea.html"><svg class="ico"><use href="#i-board"/></svg><span>Tareas</span></a>
        <a class="mi" href="/KPIs.html"><svg class="ico"><use href="#i-chart"/></svg><span>KPIs</span></a>
        <a class="mi" href="/chatbot.html"><svg class="ico"><use href="#i-bot"/></svg><span>Chatbot</span></a>
        <a class="mi active" href="#"><svg class="ico"><use href="#i-bell"/></svg><span>Notificaciones</span></a>
        <a class="mi" href="/settings.html"><svg class="ico"><use href="#i-gear"/></svg><span>Ajustes</span></a>
      </nav>
    </aside>

    <!-- Main -->
    <main class="main">
      <section class="card card-soft">
        <div class="toolbar">
          <h1 class="h4" style="margin:0">Notificaciones</h1>
          <div>
            <button id="btnMarkAll" class="btn">Marcar todas como leídas</button>
            <button id="btnNew" class="btn primary">+ Crear notificación</button>
          </div>
        </div>
        <div class="meta" id="counter">—</div>
      </section>

      <section class="list" id="list">
        <div class="meta">Cargando…</div>
      </section>
    </main>
  </div>

  <!-- Modal crear notificación -->
  <div id="modal" class="modal" aria-hidden="true">
    <div class="card">
      <h3 style="margin:4px 0 12px 0">Nueva notificación</h3>

      <div class="row">
        <label>Nombre</label>
        <input id="f_title" type="text" placeholder="Ej. Aviso sprint / Nueva tarea asignada">
      </div>

      <div class="row">
        <label>Asunto</label>
        <textarea id="f_msg" rows="4" placeholder="Describe el mensaje para tu equipo…"></textarea>
      </div>

      <div class="row">
        <label>Equipo</label>
        <select id="f_team">
          <option value="">Cargando…</option>
        </select>
      </div>

      <div class="row">
        <label>Urgencia</label>
        <select id="f_prio">
          <option value="">—</option>
          <option>BAJA</option>
          <option>MEDIA</option>
          <option>ALTA</option>
        </select>
      </div>

      <div class="row">
        <label>Tipo</label>
        <select id="f_type">
          <option value="">—</option>
          <option>INFO</option>
          <option>WARN</option>
          <option>ALERT</option>
        </select>
      </div>

      <div style="display:flex; justify-content:flex-end; gap:8px; margin-top:10px">
        <button id="btnCancel" class="btn">Cancelar</button>
        <button id="btnCreate" class="btn primary">Crear notificación</button>
      </div>
    </div>
  </div>

  <div id="toast" class="toast">Listo</div>

  <script>
    /* ===== Config ===== */
    const API_BASE    = 'http://localhost:8080';
    const NOTIF_API   = `${API_BASE}/notificaciones`;
    const EQUIPOS_API = `${API_BASE}/equipos`;
    const UE_API      = `${API_BASE}/usuarios-equipos`;

    /* ===== Sesión / usuario ===== */
    const user = JSON.parse(localStorage.getItem('user') || 'null');
    const USER_ID   = Number(user?.usuarioId ?? user?.id ?? NaN);
    const USER_MAIL = (user?.email || '').toLowerCase();

    // Normalizador: "Super Admin" -> "SUPER_ADMIN", "Scrum Master" -> "SCRUM_MASTER"
    const normalizeRole = r => String(r||'').trim().toUpperCase().replace(/\s+/g,'_');
    const USER_ROLE = normalizeRole(user?.rol ?? user?.role);

    // Claudio siempre puede crear, además de SUPER_ADMIN / SCRUM_MASTER
    const CAN_EMAILS = ['claudio@correo.com'];
    const canCreate = ['SUPER_ADMIN','SCRUM_MASTER'].includes(USER_ROLE) || CAN_EMAILS.includes(USER_MAIL);

    const authHeaders = () => {
      const h = {};
      if (!Number.isNaN(USER_ID)) h['X-User-Id'] = String(USER_ID);
      if (!h['X-User-Id'] && USER_MAIL) h['X-User-Email'] = USER_MAIL;
      return h;
    };

    /* ===== DOM ===== */
    const $btnNew     = document.getElementById('btnNew');
    const $btnMarkAll = document.getElementById('btnMarkAll');
    const $list       = document.getElementById('list');
    const $counter    = document.getElementById('counter');
    const $modal      = document.getElementById('modal');
    const $fTitle     = document.getElementById('f_title');
    const $fMsg       = document.getElementById('f_msg');
    const $fTeam      = document.getElementById('f_team');
    const $fPrio      = document.getElementById('f_prio');
    const $fType      = document.getElementById('f_type');
    const $btnCancel  = document.getElementById('btnCancel');
    const $btnCreate  = document.getElementById('btnCreate');
    const $toast      = document.getElementById('toast');

    /* ===== UI permisos ===== */
    $btnNew.disabled = !canCreate;

    /* ===== Utils ===== */
    const escapeHtml = s => String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
    const fmt = iso => { try{ const d=new Date(iso); return isNaN(d)?'—':d.toLocaleString(); }catch{ return '—'; } };
    const toast = (msg='Hecho') => { $toast.textContent = msg; $toast.classList.add('show'); setTimeout(()=> $toast.classList.remove('show'), 1800); };

    /* ===== Render ===== */
    function render(list) {
      if (!Array.isArray(list) || list.length === 0) {
        $list.innerHTML = `<div class="meta">No tienes notificaciones.</div>`;
        $counter.textContent = '0 notificaciones';
        return;
      }
      $counter.textContent = `${list.length} notificación(es)`;
      $list.innerHTML = list.map(n => `
        <div class="item ${n.leida === 'N' ? 'unread' : ''}">
          <div>
            <div style="font-weight:800">${escapeHtml(n.titulo || 'Notificación')}</div>
            <div class="meta">${fmt(n.fechaEnvio)}
              ${n.prioridad ? ' · '+escapeHtml(n.prioridad) : ''}
              ${n.tipo ? ' · '+escapeHtml(n.tipo) : ''}
            </div>
            <div style="margin-top:6px">${escapeHtml(n.mensaje || '')}</div>
          </div>
          <div style="display:flex;flex-direction:column;gap:6px;align-items:flex-end">
            ${n.leida === 'N' ? `<span class="badge">Nueva</span>` : `<span class="badge">Leída</span>`}
            ${n.leida === 'N' ? `<button class="btn" data-act="read" data-id="${n.id}">Marcar leída</button>` : ``}
          </div>
        </div>
      `).join('');

      // Acciones "Marcar leída"
      $list.querySelectorAll('button[data-act="read"]').forEach(b=>{
        b.onclick = async () => {
          const id = b.dataset.id;
          try{
            const r = await fetch(`${NOTIF_API}/${id}/leer`, { method:'PATCH', headers:{ 'Content-Type':'application/json', ...authHeaders() }});
            if (r.ok) { load(); toast('Notificación marcada'); }
          }catch{}
        };
      });
    }

    /* ===== Carga con fallback ===== */
    async function load() {
      // 1) ?usuarioId=
      if (!Number.isNaN(USER_ID)) {
        try {
          const r1 = await fetch(`${NOTIF_API}?usuarioId=${encodeURIComponent(USER_ID)}`, { headers: authHeaders() });
          if (r1.ok) { render(await r1.json()); return; }
        } catch {}
        // 2) /usuario/{id}
        try {
          const r2 = await fetch(`${NOTIF_API}/usuario/${encodeURIComponent(USER_ID)}`, { headers: authHeaders() });
          if (r2.ok) { render(await r2.json()); return; }
        } catch {}
      }
      // 3) /notificaciones con headers
      try {
        const r3 = await fetch(`${NOTIF_API}`, { headers: authHeaders() });
        if (r3.ok) { render(await r3.json()); return; }
      } catch {}
      $list.innerHTML = `<div class="meta">Error cargando notificaciones.</div>`;
      $counter.textContent = '—';
    }

    /* ===== Crear ===== */
    function openModal(){ if (!canCreate) return; $fTitle.value=''; $fMsg.value=''; $fTeam.value=''; $fPrio.value=''; $fType.value=''; $modal.classList.add('open'); }
    function closeModal(){ $modal.classList.remove('open'); }

    $btnNew.onclick    = openModal;
    $btnCancel.onclick = closeModal;

    $btnCreate.onclick = async () => {
      const payload = {
        titulo:   $fTitle.value.trim() || 'Notificación',
        mensaje:  $fMsg.value.trim(),
        equipoId: $fTeam.value ? Number($fTeam.value) : null,
        prioridad:$fPrio.value || null,   // Urgencia
        tipo:     $fType.value || null
      };
      if (!payload.equipoId) { alert('Selecciona un equipo'); return; }
      try{
        $btnCreate.disabled = true;
        const r = await fetch(`${NOTIF_API}`, {
          method:'POST',
          headers:{ 'Content-Type':'application/json', ...authHeaders() },
          body: JSON.stringify(payload)
        });
        if (!r.ok) { alert(await r.text() || 'No se pudo crear'); $btnCreate.disabled=false; return; }
        $btnCreate.disabled=false; closeModal(); toast('Notificación creada');
        load();
      }catch{ $btnCreate.disabled=false; alert('Error de red'); }
    };

    /* ===== Marcar todas ===== */
    $btnMarkAll.onclick = async () => {
      try{
        const r = await fetch(`${NOTIF_API}/leer-todas`, { method:'PATCH', headers: authHeaders() });
        if (r.ok) { load(); toast('Listo'); }
      }catch{}
    };

    /* ===== Cargar equipos para el creador (con cascada y logs) ===== */
    async function loadTeamsForCreator() {
      if (!canCreate) {
        $fTeam.innerHTML = `<option value="">No autorizado a crear</option>`;
        return;
      }

      const fill = (arr) => {
        const opts = (arr || []).map(e => {
          const name = e?.nombreEquipo || e?.nombre || `Equipo #${e?.id ?? ''}`;
          return `<option value="${e.id}">${escapeHtml(name)}</option>`;
        }).join('');
        $fTeam.innerHTML = `<option value="">Selecciona equipo…</option>` + opts;
      };

      try {
        if (USER_ROLE === 'SUPER_ADMIN') {
          // Todos los equipos
          const rAll = await fetch(`${EQUIPOS_API}`, { headers: authHeaders() });
          if (rAll.ok) {
            const arr = await rAll.json();
            console.log('[equipos] (admin) ->', arr);
            fill(arr);
            return;
          } else {
            console.warn('GET /equipos ->', rAll.status, await rAll.text());
          }
          fill([]);
          return;
        }

        // SCRUM_MASTER o casos permitidos por email (Claudio)
        // 1) Intentar /equipos/member/{id}
        try {
          const rMember = await fetch(`${EQUIPOS_API}/member/${encodeURIComponent(USER_ID)}`, { headers: authHeaders() });
          if (rMember.ok) {
            const data = await rMember.json();
            console.log('[equipos/member]', data);
            if (Array.isArray(data) && data.length) { fill(data); return; }
          } else {
            console.warn('GET /equipos/member/{id} ->', rMember.status, await rMember.text());
          }
        } catch (e) {
          console.warn('Error /equipos/member', e);
        }

        // 2) Fallback: relaciones usuario-equipo
        const rel = await fetch(`${UE_API}/usuario/${encodeURIComponent(USER_ID)}`, { headers: authHeaders() });
        if (rel.ok) {
          const lista = await rel.json();
          console.log('[usuarios-equipos/usuario]', lista);
          const ids = [...new Set((lista || []).map(r => r?.id?.equipoId).filter(Boolean))];

          if (ids.length === 0) { fill([]); return; }

          // 2.a) Intento de bulk si lo tienes implementado
          try {
            const bulk = await fetch(`${EQUIPOS_API}/by-ids?` + new URLSearchParams({ ids: ids.join(',') }), { headers: authHeaders() });
            if (bulk.ok) {
              const equipos = await bulk.json();
              console.log('[equipos/by-ids]', equipos);
              if (Array.isArray(equipos) && equipos.length) { fill(equipos); return; }
            }
          } catch (e) {
            console.warn('falló /equipos/by-ids', e);
          }

          // 2.b) Último recurso: pedir cada equipo
          const names = await Promise.all(ids.map(async id => {
            try {
              const rr = await fetch(`${EQUIPOS_API}/${id}`, { headers: authHeaders() });
              if (rr.ok) {
                const d = await rr.json();
                return { id, nombreEquipo: d?.nombreEquipo || `Equipo #${id}` };
              }
            } catch {}
            return { id, nombreEquipo: `Equipo #${id}` };
          }));
          fill(names);
          return;
        } else {
          console.warn('GET /usuarios-equipos/usuario/{id} ->', rel.status, await rel.text());
        }

        fill([]); // si no hubo suerte
      } catch (err) {
        console.error('loadTeamsForCreator error', err);
        $fTeam.innerHTML = `<option value="">Error al cargar equipos</option>`;
      }
    }

    /* ===== Init ===== */
    document.addEventListener('DOMContentLoaded', async () => {
      const $userInitial = document.querySelector('.user-circle');
      if ($userInitial && (user?.nombre || user?.email)) {
        $userInitial.textContent = String((user?.nombre?.[0] || user?.email?.[0] || 'U')).toUpperCase();
      }
      await load();
      await loadTeamsForCreator();
    });
  </script>
</body>
</html>
