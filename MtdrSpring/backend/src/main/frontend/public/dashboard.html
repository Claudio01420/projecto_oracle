<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Dashboard</title>
  <link rel="stylesheet" href="Css/dashboard.css"/>
  <link href="https://api.fontshare.com/v2/css?f[]=panchang@500,600,700,800,900&display=swap" rel="stylesheet">

  <!-- Sprite de iconos -->
  <svg xmlns="http://www.w3.org/2000/svg" style="display:none">
    <!-- Dashboard -->
    <symbol id="i-dashboard" viewBox="0 0 24 24" fill="none" stroke="currentColor">
      <path stroke-width="1.6" d="M3 3h8v8H3zM13 3h8v5h-8zM13 10h8v11h-8zM3 13h8v8H3z"/>
    </symbol>
    <!-- Equipos -->
    <symbol id="i-users" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round">
      <path d="M17 21v-2a4 4 0 0 0-3-3.87"/>
      <path d="M7 21v-2a4 4 0 0 1 3-3.87"/>
      <circle cx="12" cy="7" r="4"/>
      <path d="M5.5 8a3.5 3.5 0 1 0 0 7"/>
      <path d="M18.5 8a3.5 3.5 0 1 1 0 7"/>
    </symbol>
    <!-- Proyectos -->
    <symbol id="i-folder" viewBox="0 0 24 24" fill="none" stroke="currentColor">
      <path stroke-width="1.6" d="M3 7h6l2 2h10v9a3 3 0 0 1-3 3H6a3 3 0 0 1-3-3z"/>
    </symbol>
    <!-- Tareas -->
    <symbol id="i-board" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <rect width="8" height="4" x="8" y="2" rx="1" ry="1"/>
      <path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"/>
      <path d="M12 11h4"/><path d="M12 16h4"/>
      <path d="M8 11h.01"/><path d="M8 16h.01"/>
    </symbol>
    <!-- KPIs -->
    <symbol id="i-chart" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round">
      <path d="M12 16v5"/>
      <path d="M16 14v7"/>
      <path d="M20 10v11"/>
      <path d="m22 3-8.646 8.646a.5.5 0 0 1-.708 0L9.354 8.354a.5.5 0 0 0-.707 0L2 15"/>
      <path d="M4 18v3"/>
      <path d="M8 14v7"/>
    </symbol>
    <!-- Notificaciones -->
    <symbol id="i-bell" viewBox="0 0 24 24" fill="none" stroke="currentColor">
      <path stroke-width="1.6" d="M18 8a6 6 0 1 0-12 0c0 7-3 7-3 7h18s-3 0-3-7"/>
      <path stroke-width="1.6" d="M13.73 21a2 2 0 0 1-3.46 0"/>
    </symbol>
    <!-- Ajustes -->
    <symbol id="i-gear" viewBox="0 0 24 24" fill="none" stroke="currentColor">
      <circle cx="12" cy="12" r="3"/>
      <path stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round" d="M9.671 4.136a2.34 2.34 0 0 1 4.659 0 2.34 2.34 0 0 0 3.319 1.915 2.34 2.34 0 0 1 2.33 4.033 2.34 2.34 0 0 0 0 3.831 2.34 2.34 0 0 1-2.33 4.033 2.34 2.34 0 0 0-3.319 1.915 2.34 2.34 0 0 1-4.659 0 2.34 2.34 0 0 0-3.32-1.915 2.34 2.34 0 0 1-2.33-4.033 2.34 2.34 0 0 0 0-3.831A2.34 2.34 0 0 1 6.35 6.051a2.34 2.34 0 0 0 3.319-1.915"/>
    </symbol>
    <!-- Exit -->
    <symbol id="i-exit" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <path d="m16 17 5-5-5-5"/>
      <path d="M21 12H9"/>
      <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/>
    </symbol>
    <!-- Tareas activas -->
    <symbol id="i-board_clock" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <path d="M16 14v2.2l1.6 1"/>
      <path d="M16 4h2a2 2 0 0 1 2 2v.832"/>
      <path d="M8 4H6a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h2"/>
      <circle cx="16" cy="16" r="6"/>
      <rect x="8" y="2" width="8" height="4" rx="1"/>
    </symbol>
    <!-- Productividad -->
    <symbol id="i-100_power" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <path d="M10 10v4"/>
      <path d="M14 10v4"/>
      <path d="M22 14v-4"/>
      <path d="M6 10v4"/>
      <rect x="2" y="6" width="16" height="12" rx="2"/>
    </symbol>
    <!-- Burnout Risk -->
    <symbol id="i-heart" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <path d="M2 9.5a5.5 5.5 0 0 1 9.591-3.676.56.56 0 0 0 .818 0A5.49 5.49 0 0 1 22 9.5c0 2.29-1.5 4-3 5.5l-5.492 5.313a2 2 0 0 1-3 .019L5 15c-1.5-1.5-3-3.2-3-5.5"/>
    </symbol>
    <!-- Sprint / Proyecto actual -->
    <symbol id="i-foot" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <path d="M4 16v-2.38C4 11.5 2.97 10.5 3 8c.03-2.72 1.49-6 4.5-6C9.37 2 10 3.8 10 5.5c0 3.11-2 5.66-2 8.68V16a2 2 0 1 1-4 0Z"/>
      <path d="M20 20v-2.38c0-2.12 1.03-3.12 1-5.62-.03-2.72-1.49-6-4.5-6C14.63 6 14 7.8 14 9.5c0 3.11 2 5.66 2 8.68V20a2 2 0 1 0 4 0Z"/>
      <path d="M16 17h4"/>
      <path d="M4 13h4"/>
    </symbol>
  </svg>
</head>

<body>
  <!-- Topbar -->
  <header class="topbar">
    <div class="brand">
      <h1 class="logo-text">TMDV</h1>
    </div>
    <div class="topbar-right">
      <div class="user-circle" title="Usuario">U</div>
      <a href="/index.html" class="logout-btn">
        <svg class="ico-sm" aria-hidden="true"><use href="#i-exit"/></svg>
        <span>Salir</span>
      </a>
    </div>
  </header>

  <div class="app">
    <!-- Sidebar -->
    <aside class="aside">
      <nav class="menu">
        <a class="mi active" href="#">
          <svg class="ico"><use href="#i-dashboard"/></svg>
          <span>Dashboard</span>
        </a>
        <a class="mi" href="/Equipos.html">
          <svg class="ico"><use href="#i-users"/></svg>
          <span>Equipos</span>
        </a>
        <a class="mi" href="/projects.html">
          <svg class="ico"><use href="#i-folder"/></svg>
          <span>Proyectos</span>
        </a>
        <a class="mi" href="/tarea.html">
          <svg class="ico"><use href="#i-board"/></svg>
          <span>Tareas</span>
        </a>
        <a class="mi" href="/KPIs.html">
          <svg class="ico"><use href="#i-chart"/></svg>
          <span>KPIs</span>
        </a>
        <a class="mi" href="/notifications.html">
          <svg class="ico"><use href="#i-bell"/></svg>
          <span>Notificaciones</span>
        </a>
        <a class="mi" href="/settings.html">
          <svg class="ico"><use href="#i-gear"/></svg>
          <span>Ajustes</span>
        </a>
      </nav>
    </aside>

    <!-- CONTENIDO -->
    <main class="main">
      <!-- Welcome / HERO del dashboard -->
      <section class="card card-soft">
        <h1 class="hero-title" style="margin:0">Bienvenido</h1>
        <p class="hero-desc" style="margin:.25rem 0 1rem">
          Recorre los indicadores y atajos en orden. Te mostramos lo esencial primero.
        </p>
      </section>

      <!-- Banda: KPIs + Panel derecho -->
      <section class="band band-gap">
        <!-- KPIs -->
        <div class="stack kpi-stack">

          <!-- Productividad -->
          <div class="kpi-alert kpi-success">
            <div class="kpi-icon">
              <svg class="ico"><use href="#i-100_power"/></svg>
            </div>
            <div class="kpi-text">
              <div class="kpi-label">Productividad</div>
              <div class="kpi-main">
                <span id="productivity-percent">-</span>
              </div>
              <div class="kpi-sub" id="productivity-sub">
                Cargando datos...
              </div>
            </div>
          </div>

          <!-- Tareas activas -->
          <div class="kpi-alert kpi-info">
            <div class="kpi-icon">
              <svg class="ico"><use href="#i-board_clock"/></svg>
            </div>
            <div class="kpi-text">
              <div class="kpi-label">Tareas activas</div>
              <div class="kpi-main">
                <span id="total-tasks">0</span>
              </div>
              <div class="kpi-sub">
                <span id="completed-tasks">0</span> completadas
              </div>
            </div>
          </div>

          <!-- Proyecto actual -->
          <div class="kpi-alert kpi-warning">
            <div class="kpi-icon">
              <svg class="ico"><use href="#i-foot"/></svg>
            </div>
            <div class="kpi-text">
              <div class="kpi-label">Proyecto actual</div>
              <div class="kpi-main">
                <span id="project-name">-</span>
              </div>
              <div class="kpi-sub">
                <span id="project-days">-</span> días restantes
              </div>
            </div>
          </div>

          <!-- Burnout Risk -->
          <div class="kpi-alert kpi-danger">
            <div class="kpi-icon">
              <svg class="ico"><use href="#i-heart"/></svg>
            </div>
            <div class="kpi-text">
              <div class="kpi-label">Burnout Risk</div>
              <div class="kpi-main">
                <span id="burnout-risk-level">-</span>
              </div>
              <div class="kpi-sub">
                <span id="burnout-icl">-</span> ICL ·
                <span id="burnout-msg">Cargando...</span>
              </div>
            </div>
          </div>

        </div>

        <!-- Panel derecho -->
        <aside id="calendar-panel" class="panel card-soft">
          <div class="panel-title">
            <span class="dot"></span>
            <h3>Calendario de Tareas</h3>
          </div>

          <div class="calendar-controls">
            <button id="prev-week" class="btn-sm">←</button>
            <div class="calendar-week-label" id="week-label"></div>
            <button id="next-week" class="btn-sm">→</button>
          </div>

          <div id="week-calendar" class="week-calendar">
            <!-- Loading mientras se trae el calendario -->
            <div class="loading-bar-wrapper" id="calendar-loading">
              <div class="loading-bar">
                <div class="loading-inner"></div>
              </div>
            </div>
          </div>

          <hr class="sep"/>
          <div class="block-title"><strong>Próximas tareas</strong></div>
          <div id="upcoming-tasks" class="upcoming-tasks">
            <div class="loading-bar-wrapper" id="upcoming-loading">
              <div class="loading-bar">
                <div class="loading-inner"></div>
              </div>
            </div>
          </div>
        </aside>
      </section>

      <!-- Proyectos activos -->
      <section class="card">
        <div class="row-sb">
          <h2 class="h6">Proyectos activos</h2>
          <a class="link" href="/projects.html">Ir a proyectos ➜</a>
        </div>
        <div class="stack" id="projects-list">
          <!-- Loading inicial -->
          <div class="loading-bar-wrapper" id="projects-loading">
            <div class="loading-bar">
              <div class="loading-inner"></div>
            </div>
          </div>
        </div>
      </section>

      <!-- CTA final -->
      <section class="card">
        <div class="cta">
          <div>
            <div class="cta-title">¿Quieres insights más detallados?</div>
            <div class="muted">Revisa los KPIs para detectar riesgos y oportunidades.</div>
          </div>
          <a class="btn btn-primary" href="/KPIs.html">Abrir KPIs</a>
        </div>
      </section>
    </main>
  </div>

  <!-- Script último proyecto + Burnout -->
  <script>
  (async function(){
    let email = localStorage.getItem('userEmail') || prompt('Introduce tu email para obtener tu último proyecto:');
    if (!email) {
      const pname = document.getElementById('project-name');
      const pdays = document.getElementById('project-days');
      const levelEl = document.getElementById('burnout-risk-level');
      const iclEl = document.getElementById('burnout-icl');
      const msgEl = document.getElementById('burnout-msg');
      if (pname) pname.textContent = '-';
      if (pdays) pdays.textContent = '-';
      if (levelEl) levelEl.textContent = '-';
      if (iclEl) iclEl.textContent = '-';
      if (msgEl) msgEl.textContent = 'Email no proporcionado';
      return;
    }
    localStorage.setItem('userEmail', email);

    try {
      console.log('[Dashboard] Obteniendo usuario por email:', email);
      const resUser = await fetch('/usuarios/by-email?email=' + encodeURIComponent(email));
      if (!resUser.ok) {
        console.error('[Dashboard] Usuario no encontrado:', resUser.status);
        const msgEl = document.getElementById('burnout-msg');
        if (msgEl) msgEl.textContent = 'Usuario no encontrado';
        return;
      }
      const user = await resUser.json();
      console.log('[Dashboard] Usuario obtenido:', user);
      
      const userId = user.id || user.usuarioId || user.usuario_id;
      if (!userId) {
        console.error('[Dashboard] Usuario sin id válido:', user);
        const msgEl = document.getElementById('burnout-msg');
        if (msgEl) msgEl.textContent = 'ID de usuario inválido';
        return;
      }

      console.log('[Dashboard] Obteniendo proyectos del usuario:', userId);
      const res = await fetch('/proyectos/mios/' + encodeURIComponent(userId) + '/stats');
      if (!res.ok) {
        console.error('[Dashboard] Error al cargar proyectos:', res.status);
        const msgEl = document.getElementById('burnout-msg');
        if (msgEl) msgEl.textContent = 'Error cargando proyectos';
        return;
      }
      
      const projects = await res.json();
      console.log('[Dashboard] Proyectos obtenidos (cantidad):', projects.length);
      console.log('[Dashboard] Primer proyecto completo:', projects[0]);
      
      if (!Array.isArray(projects) || projects.length === 0) {
        console.warn('[Dashboard] Sin proyectos disponibles');
        const pname = document.getElementById('project-name');
        const pdays = document.getElementById('project-days');
        const msgEl = document.getElementById('burnout-msg');
        if (pname) pname.textContent = 'Sin proyectos';
        if (pdays) pdays.textContent = '-';
        if (msgEl) msgEl.textContent = 'Sin proyectos asignados';
        return;
      }

      const latest = projects.reduce((a, b) => ((a && a.id ? a.id : 0) > (b && b.id ? b.id : 0) ? a : b), projects[0]);
      console.log('[Dashboard] Último proyecto seleccionado:', latest);
      console.log('[Dashboard] Todas las propiedades del proyecto:', Object.keys(latest));

      const pnameEl = document.getElementById('project-name');
      const pdaysEl = document.getElementById('project-days');
      if (pnameEl) pnameEl.textContent = latest.projectName ?? latest.nombreProyecto ?? latest.name ?? 'Proyecto';

      function parseDateSafe(s) {
        if (!s) return null;
        const d = new Date(s);
        return isNaN(d.getTime()) ? null : d;
      }
      
      const endDate = parseDateSafe(latest.fechaFin || latest.fecha_fin || latest.endDate);
      if (pdaysEl) {
        if (!endDate) {
          pdaysEl.textContent = '-';
        } else {
          const now = new Date();
          const diffDays = Math.ceil((endDate - now) / (1000 * 60 * 60 * 24));
          pdaysEl.textContent = diffDays <= 0 ? '0' : String(diffDays);
        }
      }

      // Burnout Risk - buscar equipoId en TODAS las propiedades posibles
      const equipoId = latest.equipoId || 
                       latest.equipo_id || 
                       latest.teamId || 
                       latest.team_id ||
                       latest.idEquipo ||
                       latest.id_equipo ||
                       (latest.equipo && latest.equipo.id) ||
                       (latest.team && latest.team.id);
      
      console.log('[Dashboard] Búsqueda de equipo ID:');
      console.log('  - equipoId:', latest.equipoId);
      console.log('  - equipo_id:', latest.equipo_id);
      console.log('  - teamId:', latest.teamId);
      console.log('  - team_id:', latest.team_id);
      console.log('  - idEquipo:', latest.idEquipo);
      console.log('  - id_equipo:', latest.id_equipo);
      console.log('  - equipo objeto:', latest.equipo);
      console.log('  - team objeto:', latest.team);
      console.log('  - Equipo ID final seleccionado:', equipoId);
      
      if (!equipoId) {
        console.warn('[Dashboard] Proyecto sin equipo asignado. Intentando con equipos del usuario...');
        
        // Fallback: obtener el primer equipo del usuario
        try {
          const teamsRes = await fetch('/equipos/member/' + userId);
          if (teamsRes.ok) {
            const teams = await teamsRes.json();
            console.log('[Dashboard] Equipos del usuario:', teams);
            if (teams && teams.length > 0) {
              const fallbackTeamId = teams[0].id;
              console.log('[Dashboard] Usando equipo fallback:', fallbackTeamId);
              await loadICL(fallbackTeamId);
              return;
            }
          }
        } catch (e) {
          console.error('[Dashboard] Error obteniendo equipos del usuario:', e);
        }
        
        const levelEl = document.getElementById('burnout-risk-level');
        const iclEl = document.getElementById('burnout-icl');
        const msgEl = document.getElementById('burnout-msg');
        if (levelEl) levelEl.textContent = 'N/A';
        if (iclEl) iclEl.textContent = '0.00';
        if (msgEl) msgEl.textContent = 'Sin equipo asignado';
        return;
      }

      await loadICL(equipoId);

    } catch (err) {
      console.error('[Dashboard] Excepción general:', err);
      const msgEl = document.getElementById('burnout-msg');
      if (msgEl) msgEl.textContent = 'Error: ' + err.message;
    }
  })();

  async function loadICL(equipoId) {
    try {
      console.log('[Dashboard] Obteniendo ICL del equipo:', equipoId);
      const res2 = await fetch('/equipos/' + encodeURIComponent(equipoId) + '/icl');
      
      console.log('[Dashboard] Respuesta ICL status:', res2.status);
      
      if (!res2.ok) {
        const errorText = await res2.text();
        console.error('[Dashboard] Error HTTP al cargar ICL:', res2.status, errorText);
        const levelEl = document.getElementById('burnout-risk-level');
        const iclEl = document.getElementById('burnout-icl');
        const msgEl = document.getElementById('burnout-msg');
        if (levelEl) levelEl.textContent = 'Error';
        if (iclEl) iclEl.textContent = '0.00';
        if (msgEl) msgEl.textContent = 'Error HTTP ' + res2.status;
        return;
      }
      
      const iclData = await res2.json();
      console.log('[Dashboard] ICL obtenido exitosamente:', iclData);
      
      const levelEl = document.getElementById('burnout-risk-level');
      const iclEl = document.getElementById('burnout-icl');
      const msgEl = document.getElementById('burnout-msg');
      
      if (levelEl) {
        levelEl.textContent = iclData.risk ?? 'N/A';
        console.log('[Dashboard] Risk level mostrado:', iclData.risk);
      }
      if (iclEl) {
        const iclValue = (typeof iclData.icl === 'number') ? iclData.icl.toFixed(2) : '0.00';
        iclEl.textContent = iclValue;
        console.log('[Dashboard] ICL value mostrado:', iclValue);
      }
      if (msgEl) {
        msgEl.textContent = iclData.message ?? 'Sin datos';
        console.log('[Dashboard] Message mostrado:', iclData.message);
      }
      
    } catch (err) {
      console.error('[Dashboard] Excepción al recuperar ICL:', err);
      const levelEl = document.getElementById('burnout-risk-level');
      const iclEl = document.getElementById('burnout-icl');
      const msgEl = document.getElementById('burnout-msg');
      if (levelEl) levelEl.textContent = 'Error';
      if (iclEl) iclEl.textContent = '0.00';
      if (msgEl) msgEl.textContent = 'Error de conexión';
    }
  }
  </script>

  <!-- KPI Productividad -->
  <script>
  (async function(){
    let email = localStorage.getItem('userEmail') || prompt('Introduce tu email (X-User-Email) para calcular productividad:');
    if (!email) {
      const p = document.getElementById('productivity-percent');
      const s = document.getElementById('productivity-sub');
      if (p) p.textContent = '-';
      if (s) s.textContent = 'Email no proporcionado';
      return;
    }
    localStorage.setItem('userEmail', email);

    try {
      const res = await fetch('/api/tasks/productivity?email=' + encodeURIComponent(email));
      if (!res.ok) {
        console.error('Error al cargar productividad:', await res.text());
        const s = document.getElementById('productivity-sub');
        if (s) s.textContent = 'Error cargando datos';
        return;
      }
      const data = await res.json();
      const percentEl = document.getElementById('productivity-percent');
      const subEl = document.getElementById('productivity-sub');

      const pct = Math.round((data.productivityPercent ?? 0) * 100) / 100;
      if (percentEl) percentEl.textContent = (isNaN(pct) ? '-' : pct + '%');

      const totalAssigned = data.totalAssigned ?? 0;
      const totalCompleted = data.totalCompleted ?? 0;
      const planned = data.plannedHours ?? 0;
      const real = data.realHours ?? 0;
      if (subEl) {
        subEl.textContent = `${totalCompleted}/${totalAssigned} tareas · ${real.toFixed(1)}/${planned.toFixed(1)} horas`;
      }
    } catch (err) {
      console.error('Excepción al recuperar productividad:', err);
      const s = document.getElementById('productivity-sub');
      if (s) s.textContent = 'Excepción cargando datos';
    }
  })();
  </script>

  <!-- Tareas activas -->
  <script>
  (function(){
    const TOTAL_ID = 'total-tasks';
    const COMPLETED_ID = 'completed-tasks';
    const FETCH_TIMEOUT_MS = 10000;
    const POLL_INTERVAL_MS = 30000;

    const totalEl = document.getElementById(TOTAL_ID);
    const completedEl = document.getElementById(COMPLETED_ID);
    if (!totalEl && !completedEl) {
      console.warn('[TareasActivas] Elementos no encontrados');
      return;
    }

    function isCompleted(task) {
      try {
        const s = (task.status ?? task.estado ?? '').toString().toLowerCase();
        if (s.includes('hecho') || s.includes('done') || s.includes('completed')) return true;
        if (task.completedAt || task.completed_at || task.completed) return true;
        return false;
      } catch (e) { return false; }
    }

    async function fetchWithTimeout(url, options = {}, timeout = FETCH_TIMEOUT_MS) {
      const controller = new AbortController();
      const timer = setTimeout(() => controller.abort(), timeout);
      try {
        const res = await fetch(url, {...options, signal: controller.signal});
        clearTimeout(timer);
        return res;
      } catch (err) {
        clearTimeout(timer);
        throw err;
      }
    }

    let lastTotal = null;
    let lastCompleted = null;
    let pollingHandle = null;

    async function updateCountsOnce() {
      const email = localStorage.getItem('userEmail');
      if (!email) {
        if (totalEl) totalEl.textContent = '0';
        if (completedEl) completedEl.textContent = '0';
        return;
      }

      const url = '/api/tasks?email=' + encodeURIComponent(email);
      try {
        const res = await fetchWithTimeout(url, {}, FETCH_TIMEOUT_MS);
        if (!res.ok) {
          console.error('[TareasActivas] Error HTTP:', res.status, await res.text().catch(()=>'<no body>'));
          throw new Error('HTTP ' + res.status);
        }
        const tasks = await res.json();
        if (!Array.isArray(tasks)) {
          console.error('[TareasActivas] Formato inválido:', tasks);
          throw new Error('Formato inválido');
        }

        const totalActive = tasks.length;
        const completedCount = tasks.filter(t => isCompleted(t)).length;

        if (lastTotal !== totalActive) {
          if (totalEl) totalEl.textContent = String(totalActive);
          lastTotal = totalActive;
        }
        if (lastCompleted !== completedCount) {
          if (completedEl) completedEl.textContent = String(completedCount);
          lastCompleted = completedCount;
        }

      } catch (err) {
        console.warn('[TareasActivas] Error:', err);
      }
    }

    function startPolling() {
      if (pollingHandle) return;
      updateCountsOnce().catch(()=>{});
      pollingHandle = setInterval(() => {
        if (document.visibilityState === 'visible') {
          updateCountsOnce().catch(()=>{});
        }
      }, POLL_INTERVAL_MS);
    }
    function stopPolling() {
      if (pollingHandle) {
        clearInterval(pollingHandle);
        pollingHandle = null;
      }
    }

    document.addEventListener('visibilitychange', () => {
      if (document.visibilityState === 'visible') startPolling();
      else stopPolling();
    });

    startPolling();
    window.addEventListener('beforeunload', stopPolling);
  })();
  </script>

  <!-- Proyectos activos (con loading bar y sin flicker) -->
  <script>
  (function(){
    const container = document.getElementById('projects-list');
    if (!container) return console.warn('No existe #projects-list en el DOM');

    const POLL_INTERVAL_MS = 15000;
    const FETCH_TIMEOUT_MS = 10000;
    const USE_MOCK_ON_ERROR = true;

    let lastSerialized = null;
    let pollingId = null;
    let activeController = null;

    function showLoading() {
      container.innerHTML = `
        <div class="loading-bar-wrapper" id="projects-loading">
          <div class="loading-bar">
            <div class="loading-inner"></div>
          </div>
        </div>`;
    }
    function showError(msg) {
      container.innerHTML = `<div class="muted small error">${escapeHtml(msg)}</div>`;
    }
    function escapeHtml(str){
      if (!str) return '';
      return String(str)
        .replace(/&/g,'&amp;')
        .replace(/</g,'&lt;')
        .replace(/>/g,'&gt;')
        .replace(/"/g,'&quot;')
        .replace(/'/g,'&#39;');
    }

    function formatDateIsoLike(s){
      if (!s) return '-';
      try {
        const d = new Date(s);
        if (isNaN(d.getTime())) return String(s);
        return d.toLocaleDateString();
      } catch(e){ return String(s); }
    }

    function safeNumber(v, fallback = 0){
      const n = Number(v);
      return Number.isFinite(n) ? n : fallback;
    }

    function buildProjectCard(p){
      const id = p.id ?? p.projectId ?? p.proyectoId ?? null;
      const name = p.projectName ?? p.name ?? p.nombreProyecto ?? 'Proyecto';
      const start = p.fechaInicio ?? p.startDate ?? p.start_date ?? p.start ?? null;
      const end = p.fechaFin ?? p.endDate ?? p.end_date ?? p.end ?? null;
      const progress = safeNumber(p.progressPercent ?? p.progress ?? p.progress_percent, 0);
      const completedTasks = safeNumber(p.completedTasks ?? p.completed_tasks ?? p.completed, 0);
      const totalTasks = safeNumber(p.totalTasks ?? p.total_tasks ?? p.total, 0);

      const article = document.createElement('article');
      article.className = 'project';

      const titleRow = document.createElement('div');
      titleRow.className = 'row-sb';

      const strong = document.createElement('strong');
      strong.className = 'title';
      strong.textContent = name;

      const statusSpan = document.createElement('span');
      statusSpan.className = 'chip';
      const state = progress >= 100 ? 'Completado' : (progress >= 50 ? 'En Progreso' : 'Planificación');
      statusSpan.textContent = state;
      statusSpan.classList.add(progress >= 80 ? 'chip-success' : (progress >= 50 ? 'chip-warning' : 'chip-danger'));

      titleRow.appendChild(strong);
      titleRow.appendChild(statusSpan);

      const desc = document.createElement('p');
      desc.className = 'muted small';
      desc.textContent = `Inicio: ${formatDateIsoLike(start)} · Fin: ${formatDateIsoLike(end)}`;

      const progressBar = document.createElement('div');
      progressBar.className = 'progress';
      const span = document.createElement('span');
      span.style.width = Math.max(0, Math.min(100, progress)) + '%';
      span.setAttribute('aria-valuenow', String(Math.round(progress)));
      progressBar.appendChild(span);

      const tiny = document.createElement('div');
      tiny.className = 'muted tiny';
      tiny.textContent = `${Math.round(progress)}% completado · ${completedTasks}/${totalTasks} tareas`;

      article.appendChild(titleRow);
      article.appendChild(desc);
      article.appendChild(progressBar);
      article.appendChild(tiny);

      article.addEventListener('click', () => {
        if (id) {
          const href = `/projects.html?id=${encodeURIComponent(id)}`;
          window.location.href = href;
        } else {
          alert(`${name}\n\nInicio: ${formatDateIsoLike(start)}\nFin: ${formatDateIsoLike(end)}\n\n${Math.round(progress)}% completado`);
        }
      });

      return article;
    }

    function renderProjects(projects){
      container.innerHTML = '';
      if (!Array.isArray(projects) || projects.length === 0) {
        container.innerHTML = '<div class="muted small">No hay proyectos activos.</div>';
        return;
      }
      const sorted = projects.slice().sort((a,b)=>{
        const pa = safeNumber(a.progressPercent ?? a.progress ?? 0);
        const pb = safeNumber(b.progressPercent ?? b.progress ?? 0);
        if (pa !== pb) return pb - pa;
        return (b.id ?? 0) - (a.id ?? 0);
      });

      const fragment = document.createDocumentFragment();
      sorted.forEach(p => fragment.appendChild(buildProjectCard(p)));
      container.appendChild(fragment);
    }

    async function safeFetch(url, options = {}, timeout = FETCH_TIMEOUT_MS){
      if (activeController) {
        try { activeController.abort(); } catch(e) {}
      }
      activeController = new AbortController();
      const signal = activeController.signal;
      const timer = setTimeout(()=> activeController.abort(), timeout);

      try {
        const res = await fetch(url, {...options, signal});
        clearTimeout(timer);
        return res;
      } catch (err) {
        clearTimeout(timer);
        throw err;
      } finally {
        activeController = null;
      }
    }

    async function getUserIdFromEmail(email){
      const resUser = await safeFetch('/usuarios/by-email?email=' + encodeURIComponent(email));
      if (!resUser.ok) {
        const text = await resUser.text().catch(()=> '');
        throw new Error('No se pudo obtener usuario: ' + text);
      }
      const user = await resUser.json();
      return user.id ?? user.usuarioId ?? user.usuario_id ?? null;
    }

    async function fetchAndRender(){
      const email = localStorage.getItem('userEmail');
      if (!email) {
        showError('Inicia sesión para ver tus proyectos.');
        return;
      }

      // solo mostrar barra de loading la primera vez
      if (!lastSerialized) {
        showLoading();
      }

      try {
        const userId = await getUserIdFromEmail(email);
        if (!userId) {
          showError('Usuario inválido (sin id).');
          return;
        }

        const res = await safeFetch('/proyectos/mios/' + encodeURIComponent(userId) + '/stats');
        if (!res.ok) {
          const t = await res.text().catch(()=> '');
          throw new Error('Error cargando proyectos: ' + (t || res.statusText));
        }
        let payload = await res.json();

        if (!Array.isArray(payload)) {
          if (Array.isArray(payload.projects)) payload = payload.projects;
          else if (Array.isArray(payload.data)) payload = payload.data;
          else {
            const maybeArray = Object.values(payload).filter(v => v && typeof v === 'object');
            payload = maybeArray.length > 0 ? maybeArray : [];
          }
        }

        const serialized = JSON.stringify(payload, replacerSorted);
        if (serialized === lastSerialized && lastSerialized !== null) {
          // datos idénticos, dejamos el DOM como está
          return;
        }
        lastSerialized = serialized;

        renderProjects(payload);
      } catch (err) {
        console.error('Error fetchAndRender proyectos:', err);
        if (USE_MOCK_ON_ERROR) {
          const mock = [
            { id: 101, projectName: 'Proyecto DEMO A', fechaInicio: '2025-10-01', fechaFin: '2025-12-01', progressPercent: 64, completedTasks: 16, totalTasks: 25 },
            { id: 102, projectName: 'Proyecto DEMO B', fechaInicio: '2025-09-10', fechaFin: '2025-11-10', progressPercent: 40, completedTasks: 8, totalTasks: 20 },
          ];
          renderProjects(mock);
          const notice = document.createElement('div');
          notice.className = 'muted tiny';
          notice.textContent = 'Mostrando datos de ejemplo por fallo al obtener proyectos reales.';
          container.appendChild(notice);
        } else {
          showError('Excepción al cargar proyectos. Revisa consola.');
        }
      }
    }

    function replacerSorted(key, value){
      if (value && typeof value === 'object' && !Array.isArray(value)) {
        const ordered = {};
        Object.keys(value).sort().forEach(k => ordered[k] = value[k]);
        return ordered;
      }
      return value;
    }

    function startPolling(){
      if (pollingId) return;
      fetchAndRender();
      pollingId = setInterval(()=> {
        if (document.visibilityState === 'visible') fetchAndRender();
      }, POLL_INTERVAL_MS);
    }
    function stopPolling(){
      if (pollingId) { clearInterval(pollingId); pollingId = null; }
    }

    document.addEventListener('visibilitychange', ()=>{
      if (document.visibilityState === 'visible') startPolling();
      else stopPolling();
    });

    startPolling();
    window.addEventListener('beforeunload', () => {
      stopPolling();
      if (activeController) try { activeController.abort(); } catch(e){}
    });
  })();
  </script>

  <!-- Calendario semanal -->
  <script>
  (async function(){
    function parseDateAny(value){
      if (!value) return null;
      if (value instanceof Date) return value;
      if (typeof value === 'number') {
        return new Date(value > 1e12 ? value : value * 1000);
      }
      const d1 = new Date(value);
      if (!isNaN(d1.getTime())) return d1;
      const v2 = String(value).replace(' ', 'T');
      const d2 = new Date(v2);
      if (!isNaN(d2.getTime())) return d2;
      return null;
    }
    function startOfDay(date){
      const d = new Date(date);
      d.setHours(0,0,0,0);
      return d;
    }
    function addDays(d, n){ const x=new Date(d); x.setDate(x.getDate()+n); return x; }

    function findTaskDate(task){
      const keys = ['dueDate','fechaVencimiento','due_date','due','due_at','endDate','fechaFin','end_date','startDate','fechaInicio','start','fecha','date'];
      for (const k of keys){
        if (task[k]) return parseDateAny(task[k]);
        if (task.meta && task.meta[k]) return parseDateAny(task.meta[k]);
      }
      if (task.createdAt) return parseDateAny(task.createdAt);
      return null;
    }
    function findTaskTitle(task){
      return task.title || task.name || task.titulo || task.summary || task.subject || 'Tarea sin título';
    }

    function showTaskModal(task) {
      const dt = findTaskDate(task);
      const title = findTaskTitle(task);
      const desc = task.description || task.descripcion || task.detail || task.details || '';
      const status = task.status || task.estado || 'Sin estado';
      const priority = task.priority || task.prioridad || 'Sin prioridad';
      const assignee = task.assignee || task.asignado || task.assigned_to || 'Sin asignar';
      
      window.openTaskModal({
        title: title,
        date: dt ? dt.toLocaleString() : 'Sin fecha',
        description: desc,
        status: status,
        priority: priority,
        assignee: assignee
      });
    }

    const email = localStorage.getItem('userEmail');
    const calendarEl = document.getElementById('week-calendar');
    const weekLabel = document.getElementById('week-label');
    const loading = document.getElementById('calendar-loading');

    let curStartDay = startOfDay(new Date());

    function renderWeekLabel(startDay){
      const endDay = addDays(startDay, 2);
      const opts = { day: 'numeric', month: 'short' };
      weekLabel.textContent = `${startDay.toLocaleDateString(undefined,opts)} – ${endDay.toLocaleDateString(undefined,opts)}`;
    }

    function renderCalendar(tasks, startDay){
      if (!calendarEl) return;
      calendarEl.innerHTML = '';
      const today = new Date();
      today.setHours(0,0,0,0);
      
      for (let i=0; i<3; i++){
        const dayDate = addDays(startDay, i);
        const dayBox = document.createElement('div');
        dayBox.className = 'week-day' + (dayDate.getTime() === today.getTime() ? ' today' : '');
        
        const header = document.createElement('div');
        header.className = 'day-header';
        const dayName = document.createElement('div');
        dayName.textContent = dayDate.toLocaleDateString(undefined, { weekday:'long' }).replace('.', '');
        const dayNum = document.createElement('div');
        dayNum.className = 'date-num';
        dayNum.textContent = dayDate.getDate();
        header.appendChild(dayName);
        header.appendChild(dayNum);

        const tasksList = document.createElement('div');
        tasksList.className = 'tasks-list';

        const dayStart = new Date(dayDate);
        dayStart.setHours(0,0,0,0);
        const dayEnd = new Date(dayDate);
        dayEnd.setHours(23,59,59,999);
        
        const tasksForDay = tasks.filter(t => {
          const dt = findTaskDate(t);
          if (!dt) return false;
          return (dt >= dayStart && dt <= dayEnd);
        });

        if (tasksForDay.length === 0){
          const empty = document.createElement('div');
          empty.className='muted small';
          empty.textContent = 'Sin tareas';
          tasksList.appendChild(empty);
        } else {
          tasksForDay.sort((a,b) => {
            const da = findTaskDate(a) || 0;
            const db = findTaskDate(b) || 0;
            return da - db;
          });
          tasksForDay.forEach(t=>{
            const pill = document.createElement('div');
            pill.className = 'task-pill small';
            const titleWrap = document.createElement('div');
            titleWrap.className = 'task-title';
            const title = document.createElement('div');
            title.textContent = findTaskTitle(t);
            titleWrap.appendChild(title);
            pill.appendChild(titleWrap);

            pill.addEventListener('click', () => showTaskModal(t));

            tasksList.appendChild(pill);
          });
        }

        dayBox.appendChild(header);
        dayBox.appendChild(tasksList);
        calendarEl.appendChild(dayBox);
      }
    }

    function computeBlocked(tasks){
      return tasks.filter(t => {
        const s = (t.status || t.estado || '').toString().toLowerCase();
        if (s.includes('bloq') || s.includes('blocked')) return true;
        if (t.blocked === true || t.blocked === 'true') return true;
        return false;
      }).length;
    }

    async function refreshCalendar(){
      if (!calendarEl) return;
      if (!email) {
        calendarEl.innerHTML = '<div class="muted small">Inicia sesión (email) para ver tus tareas.</div>';
        return;
      }
      if (loading) loading.style.display = 'block';
      try {
        const res = await fetch('/api/tasks?email=' + encodeURIComponent(email));
        if (!res.ok) {
          console.error('Error fetch tasks', await res.text());
          calendarEl.innerHTML = '<div class="muted small">Error cargando tareas.</div>';
          return;
        }
        const tasks = await res.json();
        if (!Array.isArray(tasks)) {
          calendarEl.innerHTML = '<div class="muted small">Formato de tareas inválido.</div>';
          return;
        }

        renderWeekLabel(curStartDay);
        renderCalendar(tasks, curStartDay);

        const blocked = computeBlocked(tasks);
        const blockedEl = document.getElementById('blocked-count');
        if (blockedEl) blockedEl.textContent = `${blocked} tareas bloqueadas`;
      } catch (err) {
        console.error(err);
        calendarEl.innerHTML = '<div class="muted small">Excepción al cargar tareas.</div>';
      } finally {
        if (loading) loading.style.display = 'none';
      }
    }

    const prevBtn = document.getElementById('prev-week');
    const nextBtn = document.getElementById('next-week');
    if (prevBtn) prevBtn.addEventListener('click', ()=>{ curStartDay = addDays(curStartDay, -3); refreshCalendar(); });
    if (nextBtn) nextBtn.addEventListener('click', ()=>{ curStartDay = addDays(curStartDay, 3); refreshCalendar(); });

    await refreshCalendar();
    setInterval(refreshCalendar, 30000);
  })();
  </script>

  <!-- Próximas tareas -->
  <script>
  (function(){
    const container = document.getElementById('upcoming-tasks');
    const loading = document.getElementById('upcoming-loading');
    if (!container) return;

    const POLL_INTERVAL_MS = 30000;
    let pollingHandle = null;

    function parseDateAny(value){
      if (!value) return null;
      if (value instanceof Date) return value;
      if (typeof value === 'number') return new Date(value > 1e12 ? value : value * 1000);
      const d = new Date(value);
      if (!isNaN(d.getTime())) return d;
      const v2 = String(value).replace(' ', 'T');
      const d2 = new Date(v2);
      if (!isNaN(d2.getTime())) return d2;
      return null;
    }

    function findTaskDate(task){
      // Priorizar fechas de vencimiento sobre otras fechas
      const keys = ['dueDate','fechaVencimiento','due_date','due','due_at','endDate','fechaFin','end_date','startDate','fechaInicio','start','fecha','date','scheduledAt'];
      for (const k of keys){
        if (task[k]) return parseDateAny(task[k]);
        if (task.meta && task.meta[k]) return parseDateAny(task.meta[k]);
      }
      if (task.createdAt) return parseDateAny(task.createdAt);
      return null;
    }

    function findTaskTitle(task){
      return task.title || task.name || task.titulo || task.summary || task.subject || 'Tarea sin título';
    }

    function isCompleted(task) {
      try {
        const s = (task.status ?? task.estado ?? '').toString().toLowerCase();
        if (s.includes('hecho') || s.includes('done') || s.includes('completed') || s.includes('completado')) return true;
        if (task.completedAt || task.completed_at || task.completed) return true;
        return false;
      } catch (e) { return false; }
    }

    function formatShortDate(d){
      if (!d) return '';
      return d.toLocaleDateString(undefined, { weekday:'short', day:'numeric', month:'short' });
    }

    function getTimeUntilDue(dueDate) {
      if (!dueDate) return null;
      const now = new Date();
      const dueDateOnly = new Date(dueDate);
      dueDateOnly.setHours(0, 0, 0, 0);
      const nowDateOnly = new Date(now);
      nowDateOnly.setHours(0, 0, 0, 0);
      
      const diffMs = dueDateOnly - nowDateOnly;
      const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));
      
      if (diffDays === 0) return 'Hoy';
      if (diffDays === 1) return 'Mañana';
      if (diffDays < 7) return `${diffDays}d`;
      return formatShortDate(dueDate);
    }

    function showTaskModal(task) {
      const dt = findTaskDate(task);
      const title = findTaskTitle(task);
      const desc = task.description || task.descripcion || task.detail || task.notes || '';
      const status = task.status || task.estado || 'Sin estado';
      const priority = task.priority || task.prioridad || 'Sin prioridad';
      const assignee = task.assignee || task.asignado || task.assigned_to || 'Sin asignar';
      
      window.openTaskModal({
        title: title,
        date: dt ? dt.toLocaleString() : 'Sin fecha',
        description: desc,
        status: status,
        priority: priority,
        assignee: assignee
      });
    }

    function renderMiniCard(task){
      const date = findTaskDate(task);
      const title = findTaskTitle(task);
      const timeUntil = getTimeUntilDue(date);
      
      const wrapper = document.createElement('div');
      wrapper.className = 'mini-card';

      const left = document.createElement('div');
      left.className = 'mini-left';
      const strong = document.createElement('strong');
      strong.textContent = title;
      left.appendChild(strong);

      const right = document.createElement('div');
      right.className = 'mini-right';
      const muted = document.createElement('span');
      muted.className = 'muted small';
      muted.textContent = timeUntil || 'Sin fecha';
      
      right.appendChild(muted);

      wrapper.appendChild(left);
      wrapper.appendChild(right);

      wrapper.addEventListener('click', () => showTaskModal(task));

      return wrapper;
    }

    async function updateUpcomingTasks() {
      const email = localStorage.getItem('userEmail');
      if (!email) {
        container.innerHTML = '<div class="muted small">Inicia sesión (email) para ver tus próximas tareas.</div>';
        return;
      }

      try {
        const res = await fetch('/api/tasks?email=' + encodeURIComponent(email));
        if (!res.ok) {
          console.error('Error cargando tareas:', await res.text());
          container.innerHTML = '<div class="muted small">Error cargando tareas.</div>';
          return;
        }
        
        const tasks = await res.json();
        if (!Array.isArray(tasks) || tasks.length === 0) {
          container.innerHTML = '<div class="muted small">No tienes tareas asignadas.</div>';
          return;
        }

        const now = new Date();
        const todayStart = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 0, 0, 0, 0);
        
        // Filtrar tareas no completadas, con fecha de vencimiento >= hoy (desde las 00:00)
        const pendingTasks = tasks
          .filter(t => !isCompleted(t))
          .map(t => ({ task: t, dueDate: findTaskDate(t) }))
          .filter(x => {
            if (!x.dueDate) return false;
            // Comparar solo fechas, ignorando horas
            const taskDateOnly = new Date(x.dueDate);
            taskDateOnly.setHours(0, 0, 0, 0);
            return taskDateOnly >= todayStart;
          });

        if (pendingTasks.length === 0) {
          container.innerHTML = '<div class="muted small">No hay tareas pendientes próximas a vencer.</div>';
          return;
        }

        // Ordenar por fecha de vencimiento (más cercana primero)
        pendingTasks.sort((a, b) => a.dueDate - b.dueDate);

        // Tomar las 3 más próximas a vencer
        const upcomingThree = pendingTasks.slice(0, 3);

        container.innerHTML = '';
        upcomingThree.forEach(({ task }) => {
          container.appendChild(renderMiniCard(task));
        });

      } catch (err) {
        console.error('Excepción al cargar próximas tareas:', err);
        container.innerHTML = '<div class="muted small">Excepción al cargar próximas tareas.</div>';
      } finally {
        if (loading) loading.style.display = 'none';
      }
    }

    function startPolling() {
      if (pollingHandle) return;
      updateUpcomingTasks();
      pollingHandle = setInterval(() => {
        if (document.visibilityState === 'visible') {
          updateUpcomingTasks();
        }
      }, POLL_INTERVAL_MS);
    }

    function stopPolling() {
      if (pollingHandle) {
        clearInterval(pollingHandle);
        pollingHandle = null;
      }
    }

    document.addEventListener('visibilitychange', () => {
      if (document.visibilityState === 'visible') startPolling();
      else stopPolling();
    });

    startPolling();
    window.addEventListener('beforeunload', stopPolling);
  })();
  </script>

  <!-- Modal para vista de tarea -->
  <div class="modal-overlay" id="task-modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title" id="modal-task-title">Tarea</h2>
        <button class="modal-close" id="modal-close" aria-label="Cerrar">&times;</button>
      </div>
      <div class="modal-body">
        <div class="modal-field">
          <div class="modal-label">Fecha</div>
          <div class="modal-value" id="modal-task-date">-</div>
        </div>
        <div class="modal-field">
          <div class="modal-label">Estado</div>
          <div class="modal-value" id="modal-task-status">-</div>
        </div>
        <div class="modal-field">
          <div class="modal-label">Prioridad</div>
          <div class="modal-value" id="modal-task-priority">-</div>
        </div>
        <div class="modal-field">
          <div class="modal-label">Asignado a</div>
          <div class="modal-value" id="modal-task-assignee">-</div>
        </div>
        <div class="modal-field">
          <div class="modal-label">Descripción</div>
          <div class="modal-value" id="modal-task-description">Sin descripción</div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-outline" id="modal-close-btn">Cerrar</button>
      </div>
    </div>
  </div>

  <!-- Script del modal -->
  <script>
  (function() {
    const modal = document.getElementById('task-modal');
    const closeBtn = document.getElementById('modal-close');
    const closeFooterBtn = document.getElementById('modal-close-btn');

    function closeModal() {
      modal.classList.remove('active');
    }

    function openModal(taskData) {
      document.getElementById('modal-task-title').textContent = taskData.title || 'Tarea';
      document.getElementById('modal-task-date').textContent = taskData.date || 'Sin fecha';
      document.getElementById('modal-task-status').textContent = taskData.status || 'Sin estado';
      document.getElementById('modal-task-priority').textContent = taskData.priority || 'Sin prioridad';
      document.getElementById('modal-task-assignee').textContent = taskData.assignee || 'Sin asignar';
      
      const descEl = document.getElementById('modal-task-description');
      if (taskData.description && taskData.description.trim()) {
        descEl.textContent = taskData.description;
        descEl.classList.remove('empty');
      } else {
        descEl.textContent = 'Sin descripción';
        descEl.classList.add('empty');
      }
      
      modal.classList.add('active');
    }

    closeBtn.addEventListener('click', closeModal);
    closeFooterBtn.addEventListener('click', closeModal);
    
    modal.addEventListener('click', (e) => {
      if (e.target === modal) {
        closeModal();
      }
    });

    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape' && modal.classList.contains('active')) {
        closeModal();
      }
    });

    window.openTaskModal = openModal;
  })();
  </script>

</body>
</html>

