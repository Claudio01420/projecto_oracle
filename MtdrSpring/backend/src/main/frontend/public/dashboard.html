<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Dashboard</title>
  <link rel="stylesheet" href="Css/dashboard.css"/>
  <link href="https://api.fontshare.com/v2/css?f[]=panchang@500,600,700,800,900&display=swap" rel="stylesheet">

    <!-- Sprite de iconos -->
  <svg xmlns="http://www.w3.org/2000/svg" style="display:none">
  <!-- Dashboard -->
  <symbol id="i-dashboard" viewBox="0 0 24 24" fill="none" stroke="currentColor">
    <path stroke-width="1.6" d="M3 3h8v8H3zM13 3h8v5h-8zM13 10h8v11h-8zM3 13h8v8H3z"/>
  </symbol>
    <!-- Equipos -->
  <symbol id="i-users" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round">
    <path d="M17 21v-2a4 4 0 0 0-3-3.87"/>
    <path d="M7 21v-2a4 4 0 0 1 3-3.87"/>
    <circle cx="12" cy="7" r="4"/>
    <path d="M5.5 8a3.5 3.5 0 1 0 0 7"/>
    <path d="M18.5 8a3.5 3.5 0 1 1 0 7"/>
  </symbol>
  <!-- Proyectos -->
  <symbol id="i-folder" viewBox="0 0 24 24" fill="none" stroke="currentColor">
    <path stroke-width="1.6" d="M3 7h6l2 2h10v9a3 3 0 0 1-3 3H6a3 3 0 0 1-3-3z"/>
  </symbol>
  <!-- Tareas -->
  <symbol id="i-board" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
    <rect width="8" height="4" x="8" y="2" rx="1" ry="1"/>
    <path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"/>
    <path d="M12 11h4"/><path d="M12 16h4"/>
    <path d="M8 11h.01"/><path d="M8 16h.01"/>
  </symbol >
  <!-- KPIs -->
  <symbol id="i-chart" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round">
    <path d="M12 16v5"/>
    <path d="M16 14v7"/>
    <path d="M20 10v11"/>
    <path d="m22 3-8.646 8.646a.5.5 0 0 1-.708 0L9.354 8.354a.5.5 0 0 0-.707 0L2 15"/>
    <path d="M4 18v3"/>
    <path d="M8 14v7"/>
  </symbol>
  <!-- Chatbot -->
  <symbol id="i-bot" viewBox="0 0 24 24" fill="none" stroke="currentColor">
    <rect x="4" y="8" width="16" height="10" rx="4" stroke-width="1.6"/>
    <circle cx="9" cy="13" r="1" stroke-width="1.6"/>
    <circle cx="15" cy="13" r="1" stroke-width="1.6"/>
    <path stroke-width="1.6" d="M12 4v2m-7 6H4m16 0h1"/>
  </symbol>
  <!-- Notificaciones -->
  <symbol id="i-bell" viewBox="0 0 24 24" fill="none" stroke="currentColor">
    <path stroke-width="1.6" d="M18 8a6 6 0 1 0-12 0c0 7-3 7-3 7h18s-3 0-3-7"/>
    <path stroke-width="1.6" d="M13.73 21a2 2 0 0 1-3.46 0"/>
  </symbol>
  <!-- Ajustes -->
  <symbol id="i-gear" viewBox="0 0 24 24" fill="none" stroke="currentColor">
    <circle cx="12" cy="12" r="3"/>
    <path stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round" d="M9.671 4.136a2.34 2.34 0 0 1 4.659 0 2.34 2.34 0 0 0 3.319 1.915 2.34 2.34 0 0 1 2.33 4.033 2.34 2.34 0 0 0 0 3.831 2.34 2.34 0 0 1-2.33 4.033 2.34 2.34 0 0 0-3.319 1.915 2.34 2.34 0 0 1-4.659 0 2.34 2.34 0 0 0-3.32-1.915 2.34 2.34 0 0 1-2.33-4.033 2.34 2.34 0 0 0 0-3.831A2.34 2.34 0 0 1 6.35 6.051a2.34 2.34 0 0 0 3.319-1.915" />
  </symbol>
  <!-- Exit -->
  <symbol id="i-exit" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
    <path d="m16 17 5-5-5-5"/>
    <path d="M21 12H9"/>
    <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/>
  </symbol>
  <!-- Smile -->
  <symbol id="i-smile" viewBox="0 0 24 24" fill="none" stroke="currentColor">
    <circle cx="12" cy="12" r="10"/>
    <path stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" d="M8 14s1.5 2 4 2 4-2 4-2"/>
    <circle cx="9"  cy="9" r="1.2" fill="currentColor" stroke="none"/>
    <circle cx="15" cy="9" r="1.2" fill="currentColor" stroke="none"/>
  </symbol>
  <!-- Tareas activas -->
  <symbol id="i-board_clock" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
    <path d="M16 14v2.2l1.6 1"/>
    <path d="M16 4h2a2 2 0 0 1 2 2v.832"/>
    <path d="M8 4H6a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h2"/>
    <circle cx="16" cy="16" r="6"/>
    <rect x="8" y="2" width="8" height="4" rx="1"/>
  </symbol>
  <!-- Product -->>
  <symbol id="i-100_power" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
    <path d="M10 10v4"/>
    <path d="M14 10v4"/>
    <path d="M22 14v-4"/>
    <path d="M6 10v4"/>
    <rect x="2" y="6" width="16" height="12" rx="2"/>
  </symbol>
  <!-- Risk -->>
   <symbol id="i-heart" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
    <path d="M2 9.5a5.5 5.5 0 0 1 9.591-3.676.56.56 0 0 0 .818 0A5.49 5.49 0 0 1 22 9.5c0 2.29-1.5 4-3 5.5l-5.492 5.313a2 2 0 0 1-3 .019L5 15c-1.5-1.5-3-3.2-3-5.5"/>
  </symbol>
  <!-- Sprint -->>
   <symbol id="i-foot" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
    <path d="M4 16v-2.38C4 11.5 2.97 10.5 3 8c.03-2.72 1.49-6 4.5-6C9.37 2 10 3.8 10 5.5c0 3.11-2 5.66-2 8.68V16a2 2 0 1 1-4 0Z"/>
    <path d="M20 20v-2.38c0-2.12 1.03-3.12 1-5.62-.03-2.72-1.49-6-4.5-6C14.63 6 14 7.8 14 9.5c0 3.11 2 5.66 2 8.68V20a2 2 0 1 0 4 0Z"/>
    <path d="M16 17h4"/>
    <path d="M4 13h4"/>
  </symbol>

  </svg>
</head>



<body>

    <!-- Topbar -->
  <header class="topbar">
    <div class="brand">
      <h1 class="logo-text">TMDV</h1>
    </div>
    <div class="topbar-right">
      <div class="user-circle" title="Usuario">U</div>
      <a href="/index.html" class="logout-btn">
        <svg class="ico-sm" aria-hidden="true"><use href="#i-exit"/></svg>
        <span>Salir</span>
      </a>
    </div>
  </header>

  <div class="app">
    <!-- Sidebar -->
    <aside class="aside">
      <nav class="menu">
        <a class="mi active" href="#">
          <svg class="ico"><use href="#i-dashboard"/></svg>
          <span>Dashboard</span>
        </a>
        <a class="mi" href="/Equipos.html">
          <svg class="ico"><use href="#i-users"/></svg>
          <span>Equipos</span>
        </a>
        <a class="mi" href="/projects.html">
          <svg class="ico"><use href="#i-folder"/></svg>
          <span>Proyectos</span>
        </a>
        <a class="mi" href="/tarea.html">
          <svg class="ico"><use href="#i-board"/></svg>
          <span>Tareas</span>
        </a>
        <a class="mi" href="/KPIs.html">
          <svg class="ico"><use href="#i-chart"/></svg>
          <span>KPIs</span>
        </a>
        <a class="mi" href="/chatbot.html">
          <svg class="ico"><use href="#i-bot"/></svg>
          <span>Chatbot</span>
        </a>
        <a class="mi" href="/notifications.html">
          <svg class="ico"><use href="#i-bell"/></svg>
          <span>Notificaciones</span>
        </a>
        <a class="mi" href="/settings.html">
          <svg class="ico"><use href="#i-gear"/></svg>
          <span>Ajustes</span>
        </a>
      </nav>
    </aside>

    <!-- CONTENIDO -->
    <main class="main">
      <!-- Welcome / HERO del dashboard -->
      <section class="card card-soft">
        <h1 class="hero-title" style="margin:0">Bienvenido 
          <svg class="ico ico-smile"><use href="#i-smile"/></svg>
        </h1>
        <p class="hero-desc" style="margin:.25rem 0 1rem">
          Recorre los indicadores y atajos en orden. Te mostramos lo esencial primero.
        </p>
      </section>

      <!-- Banda: KPIs + Panel derecho -->
      <section class="band band-gap">
        <!-- KPIs -->
        <div class="stack">
          <article class="kpi kpi-pill">
            <div class="kpi-ico">
              <svg class="ico ico-100_power"><use href="#i-100_power"/></svg>
            </div>
            <div class="kpi-body">
              <div class="kpi-value">Productividad</div>
              <div class="kpi-title"><span id="productivity-percent">-</span></div>
              <div class="kpi-sub" id="productivity-sub">Cargando datos...</div>
            </div>
          </article>

          <article class="kpi kpi-pill">
            <div class="kpi-ico">
              <svg class="ico ico-board_clock"><use href="#i-board_clock"/></svg>
            </div>
            <div class="kpi-body">
              <div class="kpi-value">Tareas activas</div>
              <div class="kpi-title"><span id="total-tasks">0</span></div>
              <div class="kpi-sub"><span id="completed-tasks">0</span> completadas</div>
            </div>
          </article>

          <article class="kpi kpi-pill">
            <div class="kpi-ico">
              <svg class="ico ico-foot"><use href="#i-foot"/></svg>
            </div>
            <div class="kpi-body">
              <div class="kpi-value">Proyecto actual</div>
              <div class="kpi-title"><span id="project-name">-</span></div>
              <div class="kpi-sub"><span id="project-days">-</span> días restantes</div>
            </div>
          </article>

          <article class="kpi kpi-pill">
            <div class="kpi-ico">
              <svg class="ico ico-heart"><use href="#i-heart"/></svg>
            </div>
            <div class="kpi-body">
              <div class="kpi-value">Burnout Risk</div>
              <div class="kpi-title"><span id="burnout-risk-level">-</span></div>
              <div class="kpi-sub"><span id="burnout-icl">-</span> ICL · <span id="burnout-msg">Cargando...</span></div>
            </div>
          </article>
        </div>

        <!-- Panel derecho -->
        <aside class="panel card-soft">
          <div class="panel-title"><span class="dot"></span><h3>Semana en una mirada</h3></div>
          <div class="spark">
            <svg viewBox="0 0 100 40" preserveAspectRatio="none">
              <defs>
                <linearGradient id="fillRed" x1="0" x2="0" y1="0" y2="1">
                  <stop offset="0%" stop-color="rgba(225,38,28,0.28)"/>
                  <stop offset="100%" stop-color="rgba(225,38,28,0.02)"/>
                </linearGradient>
              </defs>
              <path d="M0,30 C12,16 22,24 34,18 C46,13 56,20 66,14 C76,10 86,22 100,12 L100,40 L0,40 Z" fill="url(#fillRed)"/>
              <path d="M0,30 C12,16 22,24 34,18 C46,13 56,20 66,14 C76,10 86,22 100,12" fill="none" stroke="#E1261C" stroke-width="2.4" stroke-linejoin="round" stroke-linecap="round"/>
            </svg>
            <div class="chip-row">
              <span class="chip chip-red">+5% productividad</span>
              <span class="chip">24 tareas</span>
            </div>
          </div>

          <hr class="sep"/>
          <div class="block-title"><strong>Próximos hitos</strong></div>
          <div class="mini-card">
            <div class="mini-left"><strong>Demo Sprint 12</strong></div>
            <div class="mini-right"><span class="muted small">Vie 20</span></div>
          </div>
          <div class="mini-card">
            <div class="mini-left"><strong>Release 2.0</strong></div>
            <div class="mini-right"><span class="muted small">Mar 24</span></div>
          </div>

          <hr class="sep"/>
          <div class="block-title danger"><strong>Riesgos del sprint</strong></div>
          <div class="row-sb small">
            <span>2 tareas bloqueadas</span>
            <span class="chip chip-red">Revisar hoy</span>
          </div>
        </aside>
      </section>

      <!-- Proyectos activos -->
      <section class="card">
        <div class="row-sb">
          <h2 class="h6">Proyectos activos</h2>
          <a class="link" href="/projects.html">Ir a proyectos ➜</a>
        </div>
        <div class="stack" id="projects-list">
          <!-- JS rellenará los proyectos del usuario aquí -->
          <div class="muted small" id="projects-loading">Cargando proyectos...</div>
        </div>
      </section>

      <!-- CTA final -->
      <section class="card">
        <div class="cta">
          <div>
            <div class="cta-title">¿Quieres insights más detallados?</div>
            <div class="muted">Revisa los KPIs para detectar riesgos y oportunidades.</div>
          </div>
          <a class="btn btn-primary" href="#">Abrir KPIs</a>
        </div>
      </section>
    </main>
  </div>

  <!-- Script para obtener último proyecto del usuario y actualizar contadores -->
<script>
(async function(){
  // Obtener email (usar localStorage si existe, sino pedir)
  let email = localStorage.getItem('userEmail') || prompt('Introduce tu email para obtener tu último proyecto:');
  if (!email) {
    const pname = document.getElementById('project-name');
    const pdays = document.getElementById('project-days');
    if (pname) pname.textContent = '-';
    if (pdays) pdays.textContent = '-';
    return;
  }
  localStorage.setItem('userEmail', email);

  try {
    // 1) Obtener usuario por email
    const resUser = await fetch('/usuarios/by-email?email=' + encodeURIComponent(email));
    if (!resUser.ok) {
      console.error('Usuario no encontrado:', await resUser.text());
      const pname = document.getElementById('project-name');
      const pdays = document.getElementById('project-days');
      if (pname) pname.textContent = '-';
      if (pdays) pdays.textContent = '-';
      return;
    }
    const user = await resUser.json();
    const userId = user.id || user.usuarioId || user.usuarioId;
    if (!userId) {
      console.error('Usuario sin id válido');
      const pname = document.getElementById('project-name');
      const pdays = document.getElementById('project-days');
      if (pname) pname.textContent = '-';
      if (pdays) pdays.textContent = '-';
      return;
    }

    // 2) Obtener proyectos del usuario con stats
    const res = await fetch('/proyectos/mios/' + encodeURIComponent(userId) + '/stats');
    if (!res.ok) {
      console.error('Error al cargar proyectos del usuario:', await res.text());
      const pname = document.getElementById('project-name');
      const pdays = document.getElementById('project-days');
      if (pname) pname.textContent = '-';
      if (pdays) pdays.textContent = '-';
      return;
    }
    const projects = await res.json();
    if (!Array.isArray(projects) || projects.length === 0) {
      const pname = document.getElementById('project-name');
      const pdays = document.getElementById('project-days');
      if (pname) pname.textContent = '-';
      if (pdays) pdays.textContent = '-';
      return;
    }

    // 3) Elegir "último" proyecto del usuario (fallback: mayor id)
    const latest = projects.reduce((a, b) => ((a && a.id ? a.id : 0) > (b && b.id ? b.id : 0) ? a : b), projects[0]);

    // Actualizar UI
    const pnameEl = document.getElementById('project-name');
    const pdaysEl = document.getElementById('project-days');
    if (pnameEl) pnameEl.textContent = latest.projectName ?? latest.nombreProyecto ?? latest.name ?? '-';

    // Calcular días restantes si hay fecha de fin
    function parseDateSafe(s) {
      if (!s) return null;
      const d = new Date(s);
      return isNaN(d.getTime()) ? null : d;
    }
    const endDate = parseDateSafe(latest.fechaFin || latest.fecha_fin || latest.endDate);
    if (pdaysEl) {
      if (!endDate) {
        pdaysEl.textContent = '-';
      } else {
        const now = new Date();
        const diffDays = Math.ceil((endDate - now) / (1000 * 60 * 60 * 24));
        pdaysEl.textContent = diffDays <= 0 ? '0' : String(diffDays);
      }
    }

    // Si el proyecto incluye equipoId, actualizar Burnout Risk (misma lógica previa)
    if (latest.equipoId) {
      try {
        const res2 = await fetch('/equipos/' + encodeURIComponent(latest.equipoId) + '/icl');
        if (res2.ok) {
          const iclData = await res2.json();
          const levelEl = document.getElementById('burnout-risk-level');
          const iclEl = document.getElementById('burnout-icl');
          const msgEl = document.getElementById('burnout-msg');
          if (levelEl) levelEl.textContent = iclData.risk ?? '-';
          if (iclEl) iclEl.textContent = (typeof iclData.icl === 'number') ? iclData.icl.toFixed(2) : '-';
          if (msgEl) msgEl.textContent = iclData.message ?? '';
        } else {
          console.error('Error al cargar ICL del equipo:', await res2.text());
          const msgEl = document.getElementById('burnout-msg');
          if (msgEl) msgEl.textContent = 'Error al cargar ICL';
        }
      } catch (err) {
        console.error('Excepción al recuperar ICL del equipo:', err);
        const msgEl = document.getElementById('burnout-msg');
        if (msgEl) msgEl.textContent = 'Excepción al cargar ICL';
      }
    } else {
      const msgEl = document.getElementById('burnout-msg');
      if (msgEl) msgEl.textContent = 'Equipo no definido';
    }

  } catch (err) {
    console.error('Excepción al recuperar último proyecto del usuario:', err);
  }
})();
</script>

<!-- Nuevo script: obtiene productividad del usuario y actualiza KPI -->
<script>
(async function(){
  // Obtener email (usa localStorage si existe, sino pide)
  let email = localStorage.getItem('userEmail') || prompt('Introduce tu email (X-User-Email) para calcular productividad:');
  if (!email) {
    // dejar valores por defecto si no hay email
    const p = document.getElementById('productivity-percent');
    const s = document.getElementById('productivity-sub');
    if (p) p.textContent = '-';
    if (s) s.textContent = 'Email no proporcionado';
    return;
  }
  localStorage.setItem('userEmail', email);

  try {
    const res = await fetch('/api/tasks/productivity?email=' + encodeURIComponent(email));
    if (!res.ok) {
      console.error('Error al cargar productividad:', await res.text());
      const s = document.getElementById('productivity-sub');
      if (s) s.textContent = 'Error cargando datos';
      return;
    }
    const data = await res.json();
    const percentEl = document.getElementById('productivity-percent');
    const subEl = document.getElementById('productivity-sub');

    // Mostrar porcentaje (entero)
    const pct = Math.round((data.productivityPercent ?? 0) * 100) / 100; // 2 decimales
    if (percentEl) percentEl.textContent = (isNaN(pct) ? '-' : pct + '%');

    // Subtexto: tareas completadas/assignadas y horas planificadas/real
    const totalAssigned = data.totalAssigned ?? 0;
    const totalCompleted = data.totalCompleted ?? 0;
    const planned = data.plannedHours ?? 0;
    const real = data.realHours ?? 0;
    if (subEl) {
      subEl.textContent = `${totalCompleted}/${totalAssigned} tareas · ${real.toFixed(1)}/${planned.toFixed(1)} horas`;
    }
  } catch (err) {
    console.error('Excepción al recuperar productividad:', err);
    const s = document.getElementById('productivity-sub');
    if (s) s.textContent = 'Excepción cargando datos';
  }
})();
</script>

<!-- Añadir script para cargar proyectos del usuario y renderizarlos -->
<script>
(async function(){
  // esperar que el DOM esté listo es implícito aquí (script al final del body)
  const container = document.getElementById('projects-list');
  if(!container) return;

  const email = localStorage.getItem('userEmail');
  if(!email) {
    container.innerHTML = '<div class="muted small">Inicia sesión para ver tus proyectos.</div>';
    return;
  }

  try {
    // 1) Obtener usuario por email (para conseguir su id)
    const resUser = await fetch('/usuarios/by-email?email=' + encodeURIComponent(email));
    if(!resUser.ok) {
      container.innerHTML = '<div class="muted small">No se pudo obtener el usuario.</div>';
      return;
    }
    const user = await resUser.json();
    const userId = user.id || user.usuarioId || user.usuarioId;

    if(!userId) {
      container.innerHTML = '<div class="muted small">Usuario inválido.</div>';
      return;
    }

    // 2) Obtener proyectos del usuario con stats
    const res = await fetch('/proyectos/mios/' + encodeURIComponent(userId) + '/stats');
    if(!res.ok) {
      container.innerHTML = '<div class="muted small">Error cargando proyectos.</div>';
      return;
    }
    const projects = await res.json();
    if(!Array.isArray(projects) || projects.length === 0) {
      container.innerHTML = '<div class="muted small">No hay proyectos activos.</div>';
      return;
    }

    // 3) Renderizar cada proyecto
    container.innerHTML = '';
    projects.forEach(p => {
      const article = document.createElement('article');
      article.className = 'project';
      const titleRow = document.createElement('div');
      titleRow.className = 'row-sb';
      const strong = document.createElement('strong');
      strong.className = 'title';
      strong.textContent = p.projectName || 'Proyecto';
      const statusSpan = document.createElement('span');
      statusSpan.className = 'chip chip-outline-red';
      // inferir estado por progreso
      const prog = Number(p.progressPercent ?? 0);
      statusSpan.textContent = prog >= 100 ? 'Completado' : (prog >= 50 ? 'En Progreso' : 'Planificación');
      titleRow.appendChild(strong);
      titleRow.appendChild(statusSpan);

      const desc = document.createElement('p');
      desc.className = 'muted small';
      // mostrar fechas si vienen
      const start = p.fechaInicio ? p.fechaInicio : '-';
      const end = p.fechaFin ? p.fechaFin : '-';
      desc.textContent = `Inicio: ${start} · Fin: ${end}`;

      const progressBar = document.createElement('div');
      progressBar.className = 'progress';
      const span = document.createElement('span');
      span.style.width = (Math.max(0, Math.min(100, prog))) + '%';
      progressBar.appendChild(span);

      const tiny = document.createElement('div');
      tiny.className = 'muted tiny';
      tiny.textContent = `${p.progressPercent ?? 0}% completado · ${p.completedTasks ?? 0}/${p.totalTasks ?? 0} tareas`;

      article.appendChild(titleRow);
      article.appendChild(desc);
      article.appendChild(progressBar);
      article.appendChild(tiny);
      container.appendChild(article);
    });

  } catch (err) {
    console.error('Error al cargar proyectos del usuario:', err);
    container.innerHTML = '<div class="muted small">Excepción al cargar proyectos.</div>';
  }
})();
</script>

<!-- NUEVO: Script que calcula y actualiza total-tasks y completed-tasks para el usuario logueado -->
<script>
(async function(){
  const totalEl = document.getElementById('total-tasks');
  const completedEl = document.getElementById('completed-tasks');
  if (!totalEl && !completedEl) return;

  const email = localStorage.getItem('userEmail');
  if (!email) {
    // si no hay email, mostrar 0
    if (totalEl) totalEl.textContent = '0';
    if (completedEl) completedEl.textContent = '0';
    return;
  }

  try {
    const res = await fetch('/api/tasks?email=' + encodeURIComponent(email));
    if (!res.ok) {
      console.error('Error al cargar tareas del usuario:', await res.text());
      if (totalEl) totalEl.textContent = '0';
      if (completedEl) completedEl.textContent = '0';
      return;
    }
    const tasks = await res.json();
    if (!Array.isArray(tasks) || tasks.length === 0) {
      if (totalEl) totalEl.textContent = '0';
      if (completedEl) completedEl.textContent = '0';
      return;
    }

    const totalActive = tasks.length;
    const completedCount = tasks.filter(t => {
      try {
        return (t.status && String(t.status).toLowerCase() === 'hecho') || (t.completedAt != null);
      } catch (e) {
        return false;
      }
    }).length;

    if (totalEl) totalEl.textContent = String(totalActive);
    if (completedEl) completedEl.textContent = String(completedCount);

  } catch (err) {
    console.error('Excepción al obtener tareas del usuario:', err);
    if (totalEl) totalEl.textContent = '0';
    if (completedEl) completedEl.textContent = '0';
  }
})();
</script>

</body>
</html>
