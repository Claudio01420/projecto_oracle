<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Dashboard</title>
  <link rel="stylesheet" href="Css/dashboard.css"/>
  <link href="https://api.fontshare.com/v2/css?f[]=panchang@500,600,700,800,900&display=swap" rel="stylesheet">

    <!-- Sprite de iconos -->
  <svg xmlns="http://www.w3.org/2000/svg" style="display:none">
  <!-- Dashboard -->
  <symbol id="i-dashboard" viewBox="0 0 24 24" fill="none" stroke="currentColor">
    <path stroke-width="1.6" d="M3 3h8v8H3zM13 3h8v5h-8zM13 10h8v11h-8zM3 13h8v8H3z"/>
  </symbol>
    <!-- Equipos -->
  <symbol id="i-users" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round">
    <path d="M17 21v-2a4 4 0 0 0-3-3.87"/>
    <path d="M7 21v-2a4 4 0 0 1 3-3.87"/>
    <circle cx="12" cy="7" r="4"/>
    <path d="M5.5 8a3.5 3.5 0 1 0 0 7"/>
    <path d="M18.5 8a3.5 3.5 0 1 1 0 7"/>
  </symbol>
  <!-- Proyectos -->
  <symbol id="i-folder" viewBox="0 0 24 24" fill="none" stroke="currentColor">
    <path stroke-width="1.6" d="M3 7h6l2 2h10v9a3 3 0 0 1-3 3H6a3 3 0 0 1-3-3z"/>
  </symbol>
  <!-- Tareas -->
  <symbol id="i-board" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
    <rect width="8" height="4" x="8" y="2" rx="1" ry="1"/>
    <path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"/>
    <path d="M12 11h4"/><path d="M12 16h4"/>
    <path d="M8 11h.01"/><path d="M8 16h.01"/>
  </symbol >
  <!-- KPIs -->
  <symbol id="i-chart" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round">
    <path d="M12 16v5"/>
    <path d="M16 14v7"/>
    <path d="M20 10v11"/>
    <path d="m22 3-8.646 8.646a.5.5 0 0 1-.708 0L9.354 8.354a.5.5 0 0 0-.707 0L2 15"/>
    <path d="M4 18v3"/>
    <path d="M8 14v7"/>
  </symbol>
  <!-- Chatbot -->
  <symbol id="i-bot" viewBox="0 0 24 24" fill="none" stroke="currentColor">
    <rect x="4" y="8" width="16" height="10" rx="4" stroke-width="1.6"/>
    <circle cx="9" cy="13" r="1" stroke-width="1.6"/>
    <circle cx="15" cy="13" r="1" stroke-width="1.6"/>
    <path stroke-width="1.6" d="M12 4v2m-7 6H4m16 0h1"/>
  </symbol>
  <!-- Notificaciones -->
  <symbol id="i-bell" viewBox="0 0 24 24" fill="none" stroke="currentColor">
    <path stroke-width="1.6" d="M18 8a6 6 0 1 0-12 0c0 7-3 7-3 7h18s-3 0-3-7"/>
    <path stroke-width="1.6" d="M13.73 21a2 2 0 0 1-3.46 0"/>
  </symbol>
  <!-- Ajustes -->
  <symbol id="i-gear" viewBox="0 0 24 24" fill="none" stroke="currentColor">
    <circle cx="12" cy="12" r="3"/>
    <path stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round" d="M9.671 4.136a2.34 2.34 0 0 1 4.659 0 2.34 2.34 0 0 0 3.319 1.915 2.34 2.34 0 0 1 2.33 4.033 2.34 2.34 0 0 0 0 3.831 2.34 2.34 0 0 1-2.33 4.033 2.34 2.34 0 0 0-3.319 1.915 2.34 2.34 0 0 1-4.659 0 2.34 2.34 0 0 0-3.32-1.915 2.34 2.34 0 0 1-2.33-4.033 2.34 2.34 0 0 0 0-3.831A2.34 2.34 0 0 1 6.35 6.051a2.34 2.34 0 0 0 3.319-1.915" />
  </symbol>
  <!-- Exit -->
  <symbol id="i-exit" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
    <path d="m16 17 5-5-5-5"/>
    <path d="M21 12H9"/>
    <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/>
  </symbol>
  <!-- Smile -->
  <symbol id="i-smile" viewBox="0 0 24 24" fill="none" stroke="currentColor">
    <circle cx="12" cy="12" r="10"/>
    <path stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" d="M8 14s1.5 2 4 2 4-2 4-2"/>
    <circle cx="9"  cy="9" r="1.2" fill="currentColor" stroke="none"/>
    <circle cx="15" cy="9" r="1.2" fill="currentColor" stroke="none"/>
  </symbol>
  <!-- Tareas activas -->
  <symbol id="i-board_clock" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
    <path d="M16 14v2.2l1.6 1"/>
    <path d="M16 4h2a2 2 0 0 1 2 2v.832"/>
    <path d="M8 4H6a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h2"/>
    <circle cx="16" cy="16" r="6"/>
    <rect x="8" y="2" width="8" height="4" rx="1"/>
  </symbol>
  <!-- Product -->>
  <symbol id="i-100_power" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
    <path d="M10 10v4"/>
    <path d="M14 10v4"/>
    <path d="M22 14v-4"/>
    <path d="M6 10v4"/>
    <rect x="2" y="6" width="16" height="12" rx="2"/>
  </symbol>
  <!-- Risk -->>
   <symbol id="i-heart" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
    <path d="M2 9.5a5.5 5.5 0 0 1 9.591-3.676.56.56 0 0 0 .818 0A5.49 5.49 0 0 1 22 9.5c0 2.29-1.5 4-3 5.5l-5.492 5.313a2 2 0 0 1-3 .019L5 15c-1.5-1.5-3-3.2-3-5.5"/>
  </symbol>
  <!-- Sprint -->>
   <symbol id="i-foot" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
    <path d="M4 16v-2.38C4 11.5 2.97 10.5 3 8c.03-2.72 1.49-6 4.5-6C9.37 2 10 3.8 10 5.5c0 3.11-2 5.66-2 8.68V16a2 2 0 1 1-4 0Z"/>
    <path d="M20 20v-2.38c0-2.12 1.03-3.12 1-5.62-.03-2.72-1.49-6-4.5-6C14.63 6 14 7.8 14 9.5c0 3.11 2 5.66 2 8.68V20a2 2 0 1 0 4 0Z"/>
    <path d="M16 17h4"/>
    <path d="M4 13h4"/>
  </symbol>

  </svg>
</head>

<body>

    <!-- Topbar -->
  <header class="topbar">
    <div class="brand">
      <h1 class="logo-text">TMDV</h1>
    </div>
    <div class="topbar-right">
      <div class="user-circle" title="Usuario">U</div>
      <a href="/index.html" class="logout-btn">
        <svg class="ico-sm" aria-hidden="true"><use href="#i-exit"/></svg>
        <span>Salir</span>
      </a>
    </div>
  </header>

  <div class="app">
    <!-- Sidebar -->
    <aside class="aside">
      <nav class="menu">
        <a class="mi active" href="#">
          <svg class="ico"><use href="#i-dashboard"/></svg>
          <span>Dashboard</span>
        </a>
        <a class="mi" href="/Equipos.html">
          <svg class="ico"><use href="#i-users"/></svg>
          <span>Equipos</span>
        </a>
        <a class="mi" href="/projects.html">
          <svg class="ico"><use href="#i-folder"/></svg>
          <span>Proyectos</span>
        </a>
        <a class="mi" href="/tarea.html">
          <svg class="ico"><use href="#i-board"/></svg>
          <span>Tareas</span>
        </a>
        <a class="mi" href="/KPIs.html">
          <svg class="ico"><use href="#i-chart"/></svg>
          <span>KPIs</span>
        </a>
        <a class="mi" href="/chatbot.html">
          <svg class="ico"><use href="#i-bot"/></svg>
          <span>Chatbot</span>
        </a>
        <a class="mi" href="/notifications.html">
          <svg class="ico"><use href="#i-bell"/></svg>
          <span>Notificaciones</span>
        </a>
        <a class="mi" href="/settings.html">
          <svg class="ico"><use href="#i-gear"/></svg>
          <span>Ajustes</span>
        </a>
      </nav>
    </aside>

    <!-- CONTENIDO -->
    <main class="main">
      <!-- Welcome / HERO del dashboard -->
      <section class="card card-soft">
        <h1 class="hero-title" style="margin:0">Bienvenido 
          <svg class="ico ico-smile"><use href="#i-smile"/></svg>
        </h1>
        <p class="hero-desc" style="margin:.25rem 0 1rem">
          Recorre los indicadores y atajos en orden. Te mostramos lo esencial primero.
        </p>
      </section>

      <!-- Banda: KPIs + Panel derecho -->
      <section class="band band-gap">
        <!-- KPIs -->
        <div class="stack">
          <article class="kpi kpi-pill">
            <div class="kpi-ico">
              <svg class="ico ico-100_power"><use href="#i-100_power"/></svg>
            </div>
            <div class="kpi-body">
              <div class="kpi-value">Productividad</div>
              <div class="kpi-title"><span id="productivity-percent">-</span></div>
              <div class="kpi-sub" id="productivity-sub">Cargando datos...</div>
            </div>
          </article>

          <article class="kpi kpi-pill">
            <div class="kpi-ico">
              <svg class="ico ico-board_clock"><use href="#i-board_clock"/></svg>
            </div>
            <div class="kpi-body">
              <div class="kpi-value">Tareas activas</div>
              <div class="kpi-title"><span id="total-tasks">0</span></div>
              <div class="kpi-sub"><span id="completed-tasks">0</span> completadas</div>
            </div>
          </article>

          <article class="kpi kpi-pill">
            <div class="kpi-ico">
              <svg class="ico ico-foot"><use href="#i-foot"/></svg>
            </div>
            <div class="kpi-body">
              <div class="kpi-value">Proyecto actual</div>
              <div class="kpi-title"><span id="project-name">-</span></div>
              <div class="kpi-sub"><span id="project-days">-</span> días restantes</div>
            </div>
          </article>

          <article class="kpi kpi-pill">
            <div class="kpi-ico">
              <svg class="ico ico-heart"><use href="#i-heart"/></svg>
            </div>
            <div class="kpi-body">
              <div class="kpi-value">Burnout Risk</div>
              <div class="kpi-title"><span id="burnout-risk-level">-</span></div>
              <div class="kpi-sub"><span id="burnout-icl">-</span> ICL · <span id="burnout-msg">Cargando...</span></div>
            </div>
          </article>
        </div>

        <!-- Panel derecho -->
        <aside id="calendar-panel" class="panel card-soft">
        <div class="panel-title"><span class="dot"></span><h3>Semana en una mirada</h3></div>

        <div class="calendar-controls">
          <button id="prev-week" class="btn-sm">←</button>
          <div class="calendar-week-label" id="week-label"></div>
          <button id="next-week" class="btn-sm">→</button>
        </div>

        <div id="week-calendar" class="week-calendar">
          <!-- JS rellenará el calendario -->
          <div class="loading muted small" id="calendar-loading">Cargando calendario...</div>
        </div>

        <hr class="sep"/>
        <div class="block-title"><strong>Próximas tareas</strong></div>
        <div id="upcoming-tasks" class="upcoming-tasks">
          <div class="muted small" id="upcoming-loading">Cargando próximas tareas...</div>
        </div>
        
      </aside>

      </section>

      <!-- Proyectos activos -->
      <section class="card">
        <div class="row-sb">
          <h2 class="h6">Proyectos activos</h2>
          <a class="link" href="/projects.html">Ir a proyectos ➜</a>
        </div>
        <div class="stack" id="projects-list">
          <!-- JS rellenará los proyectos del usuario aquí -->
          <div class="muted small" id="projects-loading">Cargando proyectos...</div>
        </div>
      </section>

      <!-- CTA final -->
      <section class="card">
        <div class="cta">
          <div>
            <div class="cta-title">¿Quieres insights más detallados?</div>
            <div class="muted">Revisa los KPIs para detectar riesgos y oportunidades.</div>
          </div>
          <a class="btn btn-primary" href="/KPIs.html">Abrir KPIs</a>
        </div>
      </section>
    </main>
  </div>

  <!-- Script para obtener último proyecto del usuario y actualizar contadores -->
<script>
(async function(){
  // Obtener email (usar localStorage si existe, sino pedir)
  let email = localStorage.getItem('userEmail') || prompt('Introduce tu email para obtener tu último proyecto:');
  if (!email) {
    const pname = document.getElementById('project-name');
    const pdays = document.getElementById('project-days');
    if (pname) pname.textContent = '-';
    if (pdays) pdays.textContent = '-';
    return;
  }
  localStorage.setItem('userEmail', email);

  try {
    // 1) Obtener usuario por email
    const resUser = await fetch('/usuarios/by-email?email=' + encodeURIComponent(email));
    if (!resUser.ok) {
      console.error('Usuario no encontrado:', await resUser.text());
      const pname = document.getElementById('project-name');
      const pdays = document.getElementById('project-days');
      if (pname) pname.textContent = '-';
      if (pdays) pdays.textContent = '-';
      return;
    }
    const user = await resUser.json();
    const userId = user.id || user.usuarioId || user.usuarioId;
    if (!userId) {
      console.error('Usuario sin id válido');
      const pname = document.getElementById('project-name');
      const pdays = document.getElementById('project-days');
      if (pname) pname.textContent = '-';
      if (pdays) pdays.textContent = '-';
      return;
    }

    // 2) Obtener proyectos del usuario con stats
    const res = await fetch('/proyectos/mios/' + encodeURIComponent(userId) + '/stats');
    if (!res.ok) {
      console.error('Error al cargar proyectos del usuario:', await res.text());
      const pname = document.getElementById('project-name');
      const pdays = document.getElementById('project-days');
      if (pname) pname.textContent = '-';
      if (pdays) pdays.textContent = '-';
      return;
    }
    const projects = await res.json();
    if (!Array.isArray(projects) || projects.length === 0) {
      const pname = document.getElementById('project-name');
      const pdays = document.getElementById('project-days');
      if (pname) pname.textContent = '-';
      if (pdays) pdays.textContent = '-';
      return;
    }

    // 3) Elegir "último" proyecto del usuario (fallback: mayor id)
    const latest = projects.reduce((a, b) => ((a && a.id ? a.id : 0) > (b && b.id ? b.id : 0) ? a : b), projects[0]);

    // Actualizar UI
    const pnameEl = document.getElementById('project-name');
    const pdaysEl = document.getElementById('project-days');
    if (pnameEl) pnameEl.textContent = latest.projectName ?? latest.nombreProyecto ?? latest.name ?? '-';

    // Calcular días restantes si hay fecha de fin
    function parseDateSafe(s) {
      if (!s) return null;
      const d = new Date(s);
      return isNaN(d.getTime()) ? null : d;
    }
    const endDate = parseDateSafe(latest.fechaFin || latest.fecha_fin || latest.endDate);
    if (pdaysEl) {
      if (!endDate) {
        pdaysEl.textContent = '-';
      } else {
        const now = new Date();
        const diffDays = Math.ceil((endDate - now) / (1000 * 60 * 60 * 24));
        pdaysEl.textContent = diffDays <= 0 ? '0' : String(diffDays);
      }
    }

    // Si el proyecto incluye equipoId, actualizar Burnout Risk (misma lógica previa)
    if (latest.equipoId) {
      try {
        const res2 = await fetch('/equipos/' + encodeURIComponent(latest.equipoId) + '/icl');
        if (res2.ok) {
          const iclData = await res2.json();
          const levelEl = document.getElementById('burnout-risk-level');
          const iclEl = document.getElementById('burnout-icl');
          const msgEl = document.getElementById('burnout-msg');
          if (levelEl) levelEl.textContent = iclData.risk ?? '-';
          if (iclEl) iclEl.textContent = (typeof iclData.icl === 'number') ? iclData.icl.toFixed(2) : '-';
          if (msgEl) msgEl.textContent = iclData.message ?? '';
        } else {
          console.error('Error al cargar ICL del equipo:', await res2.text());
          const msgEl = document.getElementById('burnout-msg');
          if (msgEl) msgEl.textContent = 'Error al cargar ICL';
        }
      } catch (err) {
        console.error('Excepción al recuperar ICL del equipo:', err);
        const msgEl = document.getElementById('burnout-msg');
        if (msgEl) msgEl.textContent = 'Excepción al cargar ICL';
      }
    } else {
      const msgEl = document.getElementById('burnout-msg');
      if (msgEl) msgEl.textContent = 'Equipo no definido';
    }

  } catch (err) {
    console.error('Excepción al recuperar último proyecto del usuario:', err);
  }
})();
</script>

<!-- Nuevo script: obtiene productividad del usuario y actualiza KPI -->
<script>
(async function(){
  // Obtener email (usa localStorage si existe, sino pide)
  let email = localStorage.getItem('userEmail') || prompt('Introduce tu email (X-User-Email) para calcular productividad:');
  if (!email) {
    // dejar valores por defecto si no hay email
    const p = document.getElementById('productivity-percent');
    const s = document.getElementById('productivity-sub');
    if (p) p.textContent = '-';
    if (s) s.textContent = 'Email no proporcionado';
    return;
  }
  localStorage.setItem('userEmail', email);

  try {
    const res = await fetch('/api/tasks/productivity?email=' + encodeURIComponent(email));
    if (!res.ok) {
      console.error('Error al cargar productividad:', await res.text());
      const s = document.getElementById('productivity-sub');
      if (s) s.textContent = 'Error cargando datos';
      return;
    }
    const data = await res.json();
    const percentEl = document.getElementById('productivity-percent');
    const subEl = document.getElementById('productivity-sub');

    // Mostrar porcentaje (entero)
    const pct = Math.round((data.productivityPercent ?? 0) * 100) / 100; // 2 decimales
    if (percentEl) percentEl.textContent = (isNaN(pct) ? '-' : pct + '%');

    // Subtexto: tareas completadas/assignadas y horas planificadas/real
    const totalAssigned = data.totalAssigned ?? 0;
    const totalCompleted = data.totalCompleted ?? 0;
    const planned = data.plannedHours ?? 0;
    const real = data.realHours ?? 0;
    if (subEl) {
      subEl.textContent = `${totalCompleted}/${totalAssigned} tareas · ${real.toFixed(1)}/${planned.toFixed(1)} horas`;
    }
  } catch (err) {
    console.error('Excepción al recuperar productividad:', err);
    const s = document.getElementById('productivity-sub');
    if (s) s.textContent = 'Excepción cargando datos';
  }
})();
</script>

<!-- Script: Actualiza "Tareas activas" (total-tasks y completed-tasks) -->
<script>
/* SCRIPT REEMPLAZO: Actualiza "Tareas activas" */
(function(){
  const TOTAL_ID = 'total-tasks';
  const COMPLETED_ID = 'completed-tasks';
  const FETCH_TIMEOUT_MS = 10000;
  const POLL_INTERVAL_MS = 30000; // actualiza cada 30s

  const totalEl = document.getElementById(TOTAL_ID);
  const completedEl = document.getElementById(COMPLETED_ID);
  if (!totalEl && !completedEl) {
    console.warn('[TareasActivas] No se encontraron elementos #' + TOTAL_ID + ' ni #' + COMPLETED_ID);
    return;
  }

  function safeNumber(v, fallback = 0) {
    const n = Number(v);
    return Number.isFinite(n) ? n : fallback;
  }
  function isCompleted(task) {
    try {
      const s = (task.status ?? task.estado ?? '').toString().toLowerCase();
      if (s.includes('hecho') || s.includes('done') || s.includes('completed')) return true;
      if (task.completedAt || task.completed_at || task.completed) return true;
      return false;
    } catch (e) { return false; }
  }

  async function fetchWithTimeout(url, options = {}, timeout = FETCH_TIMEOUT_MS) {
    const controller = new AbortController();
    const timer = setTimeout(() => controller.abort(), timeout);
    try {
      const res = await fetch(url, {...options, signal: controller.signal});
      clearTimeout(timer);
      return res;
    } catch (err) {
      clearTimeout(timer);
      throw err;
    }
  }

  let lastTotal = null;
  let lastCompleted = null;
  let pollingHandle = null;

  async function updateCountsOnce() {
    const email = localStorage.getItem('userEmail');
    if (!email) {
      if (totalEl) totalEl.textContent = '0';
      if (completedEl) completedEl.textContent = '0';
      console.info('[TareasActivas] userEmail no encontrado en localStorage');
      return;
    }

    const url = '/api/tasks?email=' + encodeURIComponent(email);
    try {
      const res = await fetchWithTimeout(url, {}, FETCH_TIMEOUT_MS);
      if (!res.ok) {
        console.error('[TareasActivas] Error HTTP al obtener tareas:', res.status, await res.text().catch(()=>'<no body>'));
        throw new Error('HTTP ' + res.status);
      }
      const tasks = await res.json();
      if (!Array.isArray(tasks)) {
        console.error('[TareasActivas] Formato de tareas inválido, se esperaba array:', tasks);
        throw new Error('Formato inválido');
      }

      const totalActive = tasks.length;
      const completedCount = tasks.filter(t => isCompleted(t)).length;

      if (lastTotal !== totalActive) {
        if (totalEl) totalEl.textContent = String(totalActive);
        lastTotal = totalActive;
      }
      if (lastCompleted !== completedCount) {
        if (completedEl) completedEl.textContent = String(completedCount);
        lastCompleted = completedCount;
      }

      return { totalActive, completedCount };
    } catch (err) {
      console.warn('[TareasActivas] Error al obtener/parsear tareas:', err);
      // no sobreescribimos valores si hubo error; intentaremos de nuevo después
      throw err;
    }
  }

  function startPolling() {
    if (pollingHandle) return;
    updateCountsOnce().catch(()=>{/* silent */});
    pollingHandle = setInterval(() => {
      if (document.visibilityState === 'visible') {
        updateCountsOnce().catch(()=>{/* silent */});
      }
    }, POLL_INTERVAL_MS);
  }
  function stopPolling() {
    if (pollingHandle) {
      clearInterval(pollingHandle);
      pollingHandle = null;
    }
  }

  document.addEventListener('visibilitychange', () => {
    if (document.visibilityState === 'visible') startPolling();
    else stopPolling();
  });

  startPolling();
  window.addEventListener('beforeunload', stopPolling);

})();
</script>


<!-- Añadir script para cargar proyectos del usuario y renderizarlos (auto-refresh cada 15s) -->
<script>
/* SCRIPT MEJORADO: Proyectos activos (reemplazar bloque antiguo) */
(function(){
  const container = document.getElementById('projects-list');
  if (!container) return console.warn('No existe #projects-list en el DOM');

  // ---------- CONFIG ----------
  const POLL_INTERVAL_MS = 15000; // 15s
  const FETCH_TIMEOUT_MS = 10000; // 10s
  const USE_MOCK_ON_ERROR = true; // si quieres ver UI aun cuando el backend falle (para depuración)
  // ----------------------------

  let lastSerialized = null;
  let pollingId = null;
  let activeController = null;

  function showLoading() {
    container.innerHTML = `<div class="muted small" id="projects-loading">Cargando proyectos...</div>`;
  }
  function showError(msg) {
    container.innerHTML = `<div class="muted small error">${escapeHtml(msg)}</div>`;
  }
  function escapeHtml(str){
    if (!str) return '';
    return String(str)
      .replace(/&/g,'&amp;')
      .replace(/</g,'&lt;')
      .replace(/>/g,'&gt;')
      .replace(/"/g,'&quot;')
      .replace(/'/g,'&#39;');
  }

  function formatDateIsoLike(s){
    if (!s) return '-';
    try {
      const d = new Date(s);
      if (isNaN(d.getTime())) return String(s);
      return d.toLocaleDateString();
    } catch(e){ return String(s); }
  }

  function safeNumber(v, fallback = 0){
    const n = Number(v);
    return Number.isFinite(n) ? n : fallback;
  }

  function buildProjectCard(p){
    // normalización de campos (soporta varios nombres)
    const id = p.id ?? p.projectId ?? p.proyectoId ?? null;
    const name = p.projectName ?? p.name ?? p.nombreProyecto ?? 'Proyecto';
    const start = p.fechaInicio ?? p.startDate ?? p.start_date ?? p.start ?? null;
    const end = p.fechaFin ?? p.endDate ?? p.end_date ?? p.end ?? null;
    const progress = safeNumber(p.progressPercent ?? p.progress ?? p.progress_percent, 0);
    const completedTasks = safeNumber(p.completedTasks ?? p.completed_tasks ?? p.completed, 0);
    const totalTasks = safeNumber(p.totalTasks ?? p.total_tasks ?? p.total, 0);

    // crear nodo
    const article = document.createElement('article');
    article.className = 'project';

    const titleRow = document.createElement('div');
    titleRow.className = 'row-sb';

    const strong = document.createElement('strong');
    strong.className = 'title';
    strong.textContent = name;

    const statusSpan = document.createElement('span');
    statusSpan.className = 'chip';
    const state = progress >= 100 ? 'Completado' : (progress >= 50 ? 'En Progreso' : 'Planificación');
    statusSpan.textContent = state;
    // color class según progreso
    statusSpan.classList.add(progress >= 80 ? 'chip-success' : (progress >= 50 ? 'chip-warning' : 'chip-danger'));

    titleRow.appendChild(strong);
    titleRow.appendChild(statusSpan);

    const desc = document.createElement('p');
    desc.className = 'muted small';
    desc.textContent = `Inicio: ${formatDateIsoLike(start)} · Fin: ${formatDateIsoLike(end)}`;

    const progressBar = document.createElement('div');
    progressBar.className = 'progress';
    const span = document.createElement('span');
    span.style.width = Math.max(0, Math.min(100, progress)) + '%';
    span.setAttribute('aria-valuenow', String(Math.round(progress)));
    progressBar.appendChild(span);

    const tiny = document.createElement('div');
    tiny.className = 'muted tiny';
    tiny.textContent = `${Math.round(progress)}% completado · ${completedTasks}/${totalTasks} tareas`;

    article.appendChild(titleRow);
    article.appendChild(desc);
    article.appendChild(progressBar);
    article.appendChild(tiny);

    // click abre detalles (puedes redirigir a página de proyecto si existe)
    article.addEventListener('click', () => {
      if (id) {
        // si tienes ruta /projects/{id} la puedes usar; solo la muestro como ejemplo
        const href = `/projects.html?id=${encodeURIComponent(id)}`;
        window.location.href = href;
      } else {
        alert(`${name}\n\nInicio: ${formatDateIsoLike(start)}\nFin: ${formatDateIsoLike(end)}\n\n${Math.round(progress)}% completado`);
      }
    });

    return article;
  }

  function renderProjects(projects){
    container.innerHTML = '';
    if (!Array.isArray(projects) || projects.length === 0) {
      container.innerHTML = '<div class="muted small">No hay proyectos activos.</div>';
      return;
    }
    // Renderizar en orden descendente por progreso y luego por id (opcional)
    const sorted = projects.slice().sort((a,b)=>{
      const pa = safeNumber(a.progressPercent ?? a.progress ?? 0);
      const pb = safeNumber(b.progressPercent ?? b.progress ?? 0);
      if (pa !== pb) return pb - pa; // mayor progreso primero
      return (b.id ?? 0) - (a.id ?? 0);
    });

    const fragment = document.createDocumentFragment();
    sorted.forEach(p => fragment.appendChild(buildProjectCard(p)));
    container.appendChild(fragment);
  }

  // Fetch con timeout y AbortController
  async function safeFetch(url, options = {}, timeout = FETCH_TIMEOUT_MS){
    if (activeController) {
      try { activeController.abort(); } catch(e) {}
    }
    activeController = new AbortController();
    const signal = activeController.signal;
    const timer = setTimeout(()=> activeController.abort(), timeout);

    try {
      const res = await fetch(url, {...options, signal});
      clearTimeout(timer);
      return res;
    } catch (err) {
      clearTimeout(timer);
      throw err;
    } finally {
      activeController = null;
    }
  }

  // Obtiene userId desde el servicio /usuarios/by-email
  async function getUserIdFromEmail(email){
    try {
      const resUser = await safeFetch('/usuarios/by-email?email=' + encodeURIComponent(email));
      if (!resUser.ok) {
        const text = await resUser.text().catch(()=> '');
        throw new Error('No se pudo obtener usuario: ' + text);
      }
      const user = await resUser.json();
      return user.id ?? user.usuarioId ?? user.usuario_id ?? null;
    } catch (err) {
      throw err;
    }
  }

  // Principal: obtener proyectos y renderizar
  async function fetchAndRender(){
    const email = localStorage.getItem('userEmail');
    if (!email) {
      showError('Inicia sesión para ver tus proyectos.');
      return;
    }

    showLoading();

    try {
      const userId = await getUserIdFromEmail(email);
      if (!userId) {
        showError('Usuario inválido (sin id).');
        return;
      }

      const res = await safeFetch('/proyectos/mios/' + encodeURIComponent(userId) + '/stats');
      if (!res.ok) {
        const t = await res.text().catch(()=> '');
        throw new Error('Error cargando proyectos: ' + (t || res.statusText));
      }
      let payload = await res.json();

      // Soportar respuesta envuelta: { projects: [...]} u otros wrappers
      if (!Array.isArray(payload)) {
        if (Array.isArray(payload.projects)) payload = payload.projects;
        else if (Array.isArray(payload.data)) payload = payload.data;
        else {
          // si es objeto con keys numéricas, convertir en array
          const maybeArray = Object.values(payload).filter(v => v && typeof v === 'object');
          if (maybeArray.length > 0) payload = maybeArray;
          else payload = [];
        }
      }

      // serializar para evitar rerender innecesario
      const serialized = JSON.stringify(payload, replacerSorted);
      if (serialized === lastSerialized) {
        const loader = document.getElementById('projects-loading');
        if (loader) loader.remove();
        return;
      }
      lastSerialized = serialized;

      renderProjects(payload);
    } catch (err) {
      console.error('Error fetchAndRender proyectos:', err);
      if (USE_MOCK_ON_ERROR) {
        // datos de ejemplo para depuración
        const mock = [
          { id: 101, projectName: 'Proyecto DEMO A', fechaInicio: '2025-10-01', fechaFin: '2025-12-01', progressPercent: 64, completedTasks: 16, totalTasks: 25 },
          { id: 102, projectName: 'Proyecto DEMO B', fechaInicio: '2025-09-10', fechaFin: '2025-11-10', progressPercent: 40, completedTasks: 8, totalTasks: 20 },
        ];
        renderProjects(mock);
        // mostrar mensaje leve
        const notice = document.createElement('div');
        notice.className = 'muted tiny';
        notice.textContent = 'Mostrando datos de ejemplo por fallo al obtener proyectos reales.';
        container.appendChild(notice);
      } else {
        showError('Excepción al cargar proyectos. Revisa consola.');
      }
    }
  }

  // JSON.stringify con claves ordenadas para comparación estable
  function replacerSorted(key, value){
    if (value && typeof value === 'object' && !Array.isArray(value)) {
      const ordered = {};
      Object.keys(value).sort().forEach(k => ordered[k] = value[k]);
      return ordered;
    }
    return value;
  }

  // Polling con Page Visibility (solo cuando la pestaña visible)
  function startPolling(){
    if (pollingId) return;
    fetchAndRender();
    pollingId = setInterval(()=> {
      if (document.visibilityState === 'visible') fetchAndRender();
    }, POLL_INTERVAL_MS);
  }
  function stopPolling(){
    if (pollingId) { clearInterval(pollingId); pollingId = null; }
  }

  document.addEventListener('visibilitychange', ()=>{
    if (document.visibilityState === 'visible') startPolling();
    else stopPolling();
  });

  // Inicializar
  startPolling();
  window.addEventListener('beforeunload', () => {
    stopPolling();
    if (activeController) try { activeController.abort(); } catch(e){}
  });

})();
</script>

<script>
/* Calendario semanal que muestra tareas del usuario */
(async function(){
  // --- utilidad de parseo de fechas robusto ---
  function parseDateAny(value){
    if (!value) return null;
    if (value instanceof Date) return value;
    // tratar números unix (segundos o ms)
    if (typeof value === 'number') {
      // si mayor a 10^12 probablemente ms, si no segundos
      return new Date(value > 1e12 ? value : value * 1000);
    }
    // intentar ISO
    const d1 = new Date(value);
    if (!isNaN(d1.getTime())) return d1;
    // intentar reemplazar espacios comunes
    const v2 = String(value).replace(' ', 'T');
    const d2 = new Date(v2);
    if (!isNaN(d2.getTime())) return d2;
    return null;
  }

  // --- calcular lunes de la semana (hora local) ---
  function startOfWeek(date){
    const d = new Date(date);
    const day = (d.getDay() + 6) % 7; // convertir para que lunes=0
    d.setHours(0,0,0,0);
    d.setDate(d.getDate() - day);
    return d;
  }
  function addDays(d, n){ const x=new Date(d); x.setDate(x.getDate()+n); return x; }

  // --- detectar posible campo fecha en tarea ---
  function findTaskDate(task){
    const keys = ['dueDate','fechaVencimiento','due_date','due','due_at','endDate','fechaFin','end_date','startDate','fechaInicio','start','fecha','date'];
    for (const k of keys){
      if (task[k]) return parseDateAny(task[k]);
      // también propiedades en objetos nested
      if (task.meta && task.meta[k]) return parseDateAny(task.meta[k]);
    }
    // si tiene timestamps
    if (task.createdAt) return parseDateAny(task.createdAt);
    return null;
  }

  // --- detectar título/name ---
  function findTaskTitle(task){
    return task.title || task.name || task.titulo || task.summary || task.subject || 'Tarea sin título';
  }

  // --- obtener email desde localStorage (como tus scripts anteriores) ---
  const email = localStorage.getItem('userEmail');
  const calendarEl = document.getElementById('week-calendar');
  const weekLabel = document.getElementById('week-label');
  const loading = document.getElementById('calendar-loading');

  // estado semana
  let curMonday = startOfWeek(new Date());

  // renderizar etiqueta semana (ej: 6 Oct - 12 Oct)
  function renderWeekLabel(monday){
    const end = addDays(monday,6);
    const opts = { day: 'numeric', month: 'short' };
    weekLabel.textContent = `${monday.toLocaleDateString(undefined,opts)} – ${end.toLocaleDateString(undefined,opts)}`;
  }

  // render calendario con tareas filtradas
  function renderCalendar(tasks, monday){
    if (!calendarEl) return;
    calendarEl.innerHTML = '';
    const today = new Date();
    for (let i=0;i<7;i++){
      const dayDate = addDays(monday, i);
      const dayBox = document.createElement('div');
      dayBox.className = 'week-day' + (dayDate.toDateString() === today.toDateString() ? ' today' : '');
      const header = document.createElement('div');
      header.className = 'day-header';
      const dayName = document.createElement('div');
      dayName.textContent = dayDate.toLocaleDateString(undefined,{ weekday:'short' }).replace('.', '');
      const dayNum = document.createElement('div');
      dayNum.className = 'date-num';
      dayNum.textContent = dayDate.getDate();
      header.appendChild(dayName);
      header.appendChild(dayNum);

      const tasksList = document.createElement('div');
      tasksList.className = 'tasks-list';

      // filtrar tareas para ese día
      const dayStart = new Date(dayDate); dayStart.setHours(0,0,0,0);
      const dayEnd = new Date(dayDate); dayEnd.setHours(23,59,59,999);
      const tasksForDay = tasks.filter(t => {
        const dt = findTaskDate(t);
        if (!dt) return false;
        return (dt >= dayStart && dt <= dayEnd);
      });

      if (tasksForDay.length === 0){
        const empty = document.createElement('div');
        empty.className='muted small';
        empty.textContent = 'Sin tareas';
        tasksList.appendChild(empty);
      } else {
        tasksForDay.sort((a,b) => {
          const da = findTaskDate(a) || 0;
          const db = findTaskDate(b) || 0;
          return da - db;
        });
        tasksForDay.forEach(t=>{
          const dt = findTaskDate(t);
          const pill = document.createElement('div');
          pill.className = 'task-pill small';
          const titleWrap = document.createElement('div');
          titleWrap.className = 'task-title';
          const title = document.createElement('div');
          title.textContent = findTaskTitle(t);
          const time = document.createElement('div');
          time.className = 'task-time';
          time.textContent = dt ? dt.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}) : '';
          titleWrap.appendChild(title);
          titleWrap.appendChild(time);
          pill.appendChild(titleWrap);

          // al hacer click mostrar detalles (modal simple alert — puedes cambiar por un modal)
          pill.addEventListener('click', ()=> {
            const desc = t.description || t.descripcion || t.detail || t.details || '';
            alert(`${findTaskTitle(t)}\n\nFecha: ${dt ? dt.toLocaleString() : 'N/A'}\n\n${desc}`);
          });

          tasksList.appendChild(pill);
        });
      }

      dayBox.appendChild(header);
      dayBox.appendChild(tasksList);
      calendarEl.appendChild(dayBox);
    }
  }

  // contador de tareas bloqueadas (si tu tareas tienen campo blocked/blockedReason o status)
  function computeBlocked(tasks){
    return tasks.filter(t => {
      const s = (t.status || t.estado || '').toString().toLowerCase();
      if (s.includes('bloq') || s.includes('blocked')) return true;
      // o campo explicit blocked
      if (t.blocked === true || t.blocked === 'true') return true;
      return false;
    }).length;
  }

  // fetch tareas y actualizar UI
  async function refreshCalendar(){
    if (!calendarEl) return;
    if (!email) {
      calendarEl.innerHTML = '<div class="muted small">Inicia sesión (email) para ver tus tareas.</div>';
      return;
    }
    if (loading) loading.style.display = 'block';
    try {
      const res = await fetch('/api/tasks?email=' + encodeURIComponent(email));
      if (!res.ok) {
        console.error('Error fetch tasks', await res.text());
        calendarEl.innerHTML = '<div class="muted small">Error cargando tareas.</div>';
        return;
      }
      const tasks = await res.json();
      if (!Array.isArray(tasks)) {
        calendarEl.innerHTML = '<div class="muted small">Formato de tareas inválido.</div>';
        return;
      }

      // renderizar
      renderWeekLabel(curMonday);
      renderCalendar(tasks, curMonday);

      // actualizar count bloqueadas
      const blocked = computeBlocked(tasks);
      const blockedEl = document.getElementById('blocked-count');
      if (blockedEl) blockedEl.textContent = `${blocked} tareas bloqueadas`;
    } catch (err) {
      console.error(err);
      calendarEl.innerHTML = '<div class="muted small">Excepción al cargar tareas.</div>';
    } finally {
      if (loading) loading.style.display = 'none';
    }
  }

  // controls prev/next
  const prevBtn = document.getElementById('prev-week');
  const nextBtn = document.getElementById('next-week');
  if (prevBtn) prevBtn.addEventListener('click', ()=>{ curMonday = addDays(curMonday, -7); refreshCalendar(); });
  if (nextBtn) nextBtn.addEventListener('click', ()=>{ curMonday = addDays(curMonday, 7); refreshCalendar(); });

  // inicial
  await refreshCalendar();

  // auto-refresh cada 30s
  setInterval(refreshCalendar, 30000);
})();
</script>

<script>
(async function(){
  // --- helpers internos (autónomos) ---
  function parseDateAny(value){
    if (!value) return null;
    if (value instanceof Date) return value;
    if (typeof value === 'number') return new Date(value > 1e12 ? value : value * 1000);
    const d = new Date(value);
    if (!isNaN(d.getTime())) return d;
    const v2 = String(value).replace(' ', 'T');
    const d2 = new Date(v2);
    if (!isNaN(d2.getTime())) return d2;
    return null;
  }
  function findTaskDate(task){
    const keys = ['dueDate','fechaVencimiento','due_date','due','due_at','endDate','fechaFin','end_date','startDate','fechaInicio','start','fecha','date','scheduledAt','completedAt'];
    for (const k of keys){
      if (task[k]) return parseDateAny(task[k]);
      if (task.meta && task.meta[k]) return parseDateAny(task.meta[k]);
    }
    if (task.createdAt) return parseDateAny(task.createdAt);
    return null;
  }
  function findTaskTitle(task){
    return task.title || task.name || task.titulo || task.summary || task.subject || 'Tarea sin título';
  }
  function formatShortDate(d){
    if (!d) return '';
    return d.toLocaleDateString(undefined, { weekday:'short', day:'numeric', month:'short' });
  }
  function formatTime(d){
    if (!d) return '';
    return d.toLocaleTimeString(undefined, { hour:'2-digit', minute:'2-digit' });
  }

  // --- UI elements ---
  const container = document.getElementById('upcoming-tasks');
  const loading = document.getElementById('upcoming-loading');
  if (!container) return;

  // recuperar email (misma convención que en tu app)
  const email = localStorage.getItem('userEmail');
  if (!email) {
    container.innerHTML = '<div class="muted small">Inicia sesión (email) para ver tus próximas tareas.</div>';
    return;
  }

  // render mini-card (misma clase que usas en el layout)
  function renderMiniCard(task){
    const date = findTaskDate(task);
    const title = findTaskTitle(task);
    const wrapper = document.createElement('div');
    wrapper.className = 'mini-card';

    const left = document.createElement('div');
    left.className = 'mini-left';
    const strong = document.createElement('strong');
    strong.textContent = title;
    left.appendChild(strong);

    const right = document.createElement('div');
    right.className = 'mini-right';
    const muted = document.createElement('span');
    muted.className = 'muted small';
    muted.textContent = date ? `${formatShortDate(date)} ${formatTime(date)}` : 'Sin fecha';
    right.appendChild(muted);

    wrapper.appendChild(left);
    wrapper.appendChild(right);

    // click -> mostrar detalles (puedes reemplazar alert por modal si quieres)
    wrapper.addEventListener('click', () => {
      const desc = task.description || task.descripcion || task.detail || task.notes || '';
      const dText = date ? date.toLocaleString() : 'N/A';
      const extra = desc ? `\n\n${desc}` : '';
      alert(`${title}\n\nFecha: ${dText}${extra}`);
    });

    return wrapper;
  }

  // fetch tareas y calcular próximas 3
  try {
    const res = await fetch('/api/tasks?email=' + encodeURIComponent(email));
    if (!res.ok) {
      console.error('Error cargando tareas:', await res.text());
      container.innerHTML = '<div class="muted small">Error cargando tareas.</div>';
      return;
    }
    const tasks = await res.json();
    if (!Array.isArray(tasks) || tasks.length === 0) {
      container.innerHTML = '<div class="muted small">No tienes tareas asignadas.</div>';
      return;
    }

    // filtrar tareas con fecha >= ahora (próximas)
    const now = new Date();
    const withDates = tasks.map(t => ({ t, dt: findTaskDate(t) })).filter(x => x.dt && x.dt >= new Date(now.getFullYear(), now.getMonth(), now.getDate(), 0,0,0));
    // ordenar por fecha ascendente
    withDates.sort((a,b) => a.dt - b.dt);

    // si no hay futuras (o son menos de 3) tomar próximas incluyendo pasadas recientes
    let selection = withDates.slice(0,3).map(x => x.t);
    if (selection.length < 3) {
      // incluir tareas sin fecha o pasadas, ordenadas por fecha si existe o por prioridad / id
      const others = tasks
        .filter(t => !selection.includes(t))
        .map(t => ({ t, dt: findTaskDate(t) }))
        .sort((a,b) => {
          if (a.dt && b.dt) return a.dt - b.dt;
          if (a.dt && !b.dt) return -1;
          if (!a.dt && b.dt) return 1;
          return 0;
        })
        .slice(0, 3 - selection.length)
        .map(x => x.t);
      selection = selection.concat(others);
    }

    // renderizar las tarjetas
    container.innerHTML = '';
    if (selection.length === 0) {
      container.innerHTML = '<div class="muted small">No hay próximas tareas detectadas.</div>';
    } else {
      selection.forEach(t => {
        container.appendChild(renderMiniCard(t));
      });
    }

  } catch (err) {
    console.error('Excepción al cargar próximas tareas:', err);
    container.innerHTML = '<div class="muted small">Excepción al cargar próximas tareas.</div>';
  }
})();
</script>



</body>
</html>
  