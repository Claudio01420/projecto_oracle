<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>KPIs</title>
  <link rel="stylesheet" href="Css/KPIs.css"/>
  <link href="https://api.fontshare.com/v2/css?f[]=panchang@500,600,700,800,900&display=swap" rel="stylesheet">

  <!-- Sprite de íconos -->
  <svg xmlns="http://www.w3.org/2000/svg" style="display:none">
  <!-- Dashboard -->
  <symbol id="i-dashboard" viewBox="0 0 24 24" fill="none" stroke="currentColor">
    <path stroke-width="1.6" d="M3 3h8v8H3zM13 3h8v5h-8zM13 10h8v11h-8zM3 13h8v8H3z"/>
  </symbol>
 <!-- Equipos -->
  <symbol id="i-users" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round">
    <path d="M17 21v-2a4 4 0 0 0-3-3.87"/>
    <path d="M7 21v-2a4 4 0 0 1 3-3.87"/>
    <circle cx="12" cy="7" r="4"/>
    <path d="M5.5 8a3.5 3.5 0 1 0 0 7"/>
    <path d="M18.5 8a3.5 3.5 0 1 1 0 7"/>
  </symbol>
  <!-- Proyectos -->
  <symbol id="i-folder" viewBox="0 0 24 24" fill="none" stroke="currentColor">
    <path stroke-width="1.6" d="M3 7h6l2 2h10v9a3 3 0 0 1-3 3H6a3 3 0 0 1-3-3z"/>
  </symbol>
  <!-- Tareas -->
  <symbol id="i-board" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
    <rect width="8" height="4" x="8" y="2" rx="1" ry="1"/>
    <path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"/>
    <path d="M12 11h4"/><path d="M12 16h4"/>
    <path d="M8 11h.01"/><path d="M8 16h.01"/>
  </symbol >
  <!-- KPIs -->
  <symbol id="i-chart" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round">
    <path d="M12 16v5"/>
    <path d="M16 14v7"/>
    <path d="M20 10v11"/>
    <path d="m22 3-8.646 8.646a.5.5 0 0 1-.708 0L9.354 8.354a.5.5 0 0 0-.707 0L2 15"/>
    <path d="M4 18v3"/>
    <path d="M8 14v7"/>
  </symbol>
  <!-- Chatbot -->
  <symbol id="i-bot" viewBox="0 0 24 24" fill="none" stroke="currentColor">
    <rect x="4" y="8" width="16" height="10" rx="4" stroke-width="1.6"/>
    <circle cx="9" cy="13" r="1" stroke-width="1.6"/>
    <circle cx="15" cy="13" r="1" stroke-width="1.6"/>
    <path stroke-width="1.6" d="M12 4v2m-7 6H4m16 0h1"/>
  </symbol>
  <!-- Notificaciones -->
  <symbol id="i-bell" viewBox="0 0 24 24" fill="none" stroke="currentColor">
    <path stroke-width="1.6" d="M18 8a6 6 0 1 0-12 0c0 7-3 7-3 7h18s-3 0-3-7"/>
    <path stroke-width="1.6" d="M13.73 21a2 2 0 0 1-3.46 0"/>
  </symbol>
  <!-- Ajustes -->
  <symbol id="i-gear" viewBox="0 0 24 24" fill="none" stroke="currentColor">
    <circle cx="12" cy="12" r="3" />
    <path stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round" d="M9.671 4.136a2.34 2.34 0 0 1 4.659 0 2.34 2.34 0 0 0 3.319 1.915 2.34 2.34 0 0 1 2.33 4.033 2.34 2.34 0 0 0 0 3.831 2.34 2.34 0 0 1-2.33 4.033 2.34 2.34 0 0 0-3.319 1.915 2.34 2.34 0 0 1-4.659 0 2.34 2.34 0 0 0-3.32-1.915 2.34 2.34 0 0 1-2.33-4.033 2.34 2.34 0 0 0 0-3.831A2.34 2.34 0 0 1 6.35 6.051a2.34 2.34 0 0 0 3.319-1.915" />
  </symbol>
  <!-- Exit -->
  <symbol id="i-exit" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
    <path d="m16 17 5-5-5-5"/>
    <path d="M21 12H9"/>
    <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/>
  </symbol>
  </svg>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>


<body>

    <!-- Topbar -->
  <header class="topbar">
    <div class="brand">
      <h1 class="logo-text">TMDV</h1>
    </div>
    <div class="topbar-right">
      <div class="user-circle" title="Usuario">U</div>
      <a href="/index.html" class="logout-btn">
        <svg class="ico-sm" aria-hidden="true"><use href="#i-exit"/></svg>
        <span>Salir</span>
      </a>
    </div>
  </header>

  <div class="app">
        <!-- Sidebar -->
    <aside class="aside">
      <nav class="menu">
        <a class="mi" href="/dashboard.html">
          <svg class="ico"><use href="#i-dashboard"/></svg>
          <span>Dashboard</span>
        </a>
        <a class="mi" href="/Equipos.html">
          <svg class="ico"><use href="#i-users"/></svg>
          <span>Equipos</span>
        </a>
        <a class="mi" href="/projects.html">
          <svg class="ico"><use href="#i-folder"/></svg>
          <span>Proyectos</span>
        </a>
        <a class="mi" href="/tarea.html">
          <svg class="ico"><use href="#i-board"/></svg>
          <span>Tareas</span>
        </a>
        <a class="mi active" href="#">
          <svg class="ico"><use href="#i-chart"/></svg>
          <span>KPIs</span>
        </a>
        <a class="mi" href="/chatbot.html">
          <svg class="ico"><use href="#i-bot"/></svg>
          <span>Chatbot</span>
        </a>
        <a class="mi" href="/notifications.html">
          <svg class="ico"><use href="#i-bell"/></svg>
          <span>Notificaciones</span>
        </a>
        <a class="mi" href="/settings.html">
          <svg class="ico"><use href="#i-gear"/></svg>
          <span>Ajustes</span>
        </a>
      </nav>
    </aside>

    <!-- Contenido principal -->
    <main class="main">
      <section class="card card-soft">
        <h1 class="h4">KPIs de productividad y calidad</h1>
        <div class="stats-grid">
          <div class="stat">
            <div id="taskCompletionValue" class="value">--%</div>
            <div class="label">Task Completion</div>
          </div>
          <div class="stat">
            <div id="avgResolutionValue" class="value">--h</div>
            <div class="label">Tiempo prom. resolución tareas</div>
          </div>
          <div class="stat">
            <div id="individualKpiValue" class="value">--h</div>
            <div class="label">Individual KPI Time</div>
          </div>
          <div class="stat"><div class="value">76%</div><div class="label">Uso de OCI</div></div>
        </div>
      </section>

      <section class="charts">
        <article class="card">
          <h3 class="h6">% tareas completadas por sprint</h3>
          <canvas id="barChart"></canvas>
        </article>
        <article class="card">
          <h3 class="h6">Horas reales vs planificadas</h3>
          <canvas id="lineChart"></canvas>
        </article>
      </section>
    </main>
  </div>

  <script>
    // Datos iniciales para los gráficos (se actualizan opcionalmente después)
    const donePct = [
      { sprint: "S1", pct: 60 }, { sprint: "S2", pct: 65 },
      { sprint: "S3", pct: 70 }, { sprint: "S4", pct: 75 }
    ];
    const hours = [
      { s: "S1", reales: 12, plan: 10 },
      { s: "S2", reales: 14, plan: 12 },
      { s: "S3", reales: 13, plan: 12 },
      { s: "S4", reales: 15, plan: 13 }
    ];

    // Crear charts y exponer instancias para poder actualizarlos después
    window.barChartInstance = new Chart(document.getElementById("barChart"), {
      type: "bar",
      data: {
        labels: donePct.map(d => d.sprint),
        datasets: [{
          label: "% completadas",
          data: donePct.map(d => d.pct),
          backgroundColor: "#E1261C"
        }]
      }
    });

    window.lineChartInstance = new Chart(document.getElementById("lineChart"), {
      type: "line",
      data: {
        labels: hours.map(d => d.s),
        datasets: [
          {
            label: "Reales",
            data: hours.map(d => d.reales),
            borderColor: "#E1261C",
            fill: false
          },
          {
            label: "Plan",
            data: hours.map(d => d.plan),
            borderColor: "#374151",
            borderDash: [5,5],
            fill: false
          }
        ]
      }
    });

    // Cálculo dinámico del % de tareas completadas desde /api/tasks
    async function loadTaskCompletion() {
      try {
        const userEmail = localStorage.getItem('userEmail');
        const headers = {};
        let url = '/api/tasks';
        let currentUser = null;
        if (userEmail) {
          headers['X-User-Email'] = userEmail;
          currentUser = userEmail;
        } else {
          const qEmail = new URLSearchParams(location.search).get('email');
          if (qEmail) {
            url += '?email=' + encodeURIComponent(qEmail);
            currentUser = qEmail;
          }
        }

        const res = await fetch(url, { headers });
        if (!res.ok) throw new Error('Error fetching tasks: ' + res.status);
        const tasks = await res.json();

        const total = Array.isArray(tasks) ? tasks.length : 0;
        const completedStatuses = ['done','completed','finalizado','completado','terminado','closed','hecho'];
        const completedTasks = (tasks || []).filter(t => {
          const s = (t.status || '').toString().toLowerCase();
          return completedStatuses.some(cs => s.includes(cs));
        });

        // Task Completion %
        const completed = completedTasks.length;
        const pct = total === 0 ? 0 : Math.round((completed / total) * 100);
        const pctEl = document.getElementById('taskCompletionValue');
        if (pctEl) pctEl.textContent = pct + '%';

        // Tiempo promedio de resolución (sobre tareas finalizadas retornadas)
        const sumRealHours = completedTasks.reduce((acc, t) => {
          const v = parseFloat(t.realHours);
          return acc + (Number.isFinite(v) ? v : 0);
        }, 0);
        const avg = completed === 0 ? 0 : (sumRealHours / completed);
        function formatHours(h) {
          if (!Number.isFinite(h)) return 'N/A';
          return (Math.round(h * 10) / 10) + 'h';
        }
        const avgEl = document.getElementById('avgResolutionValue');
        if (avgEl) avgEl.textContent = completed === 0 ? '0h' : formatHours(avg);

        // Individual KPI Time:
        // Determinar usuario para el KPI (preferir currentUser, si no intentar inferir)
        let userKey = null;
        if (currentUser) {
          userKey = currentUser.toString().toLowerCase();
        } else if (Array.isArray(tasks) && tasks.length === 1) {
          userKey = (tasks[0].assigneeId || tasks[0].userEmail || '').toString().toLowerCase();
        }
        // Filtrar tareas finalizadas asignadas al usuario
        const completedForUser = userKey
          ? completedTasks.filter(t => {
              const a = (t.assigneeId || t.userEmail || '').toString().toLowerCase();
              return a === userKey;
            })
          : []; // si no hay userKey, no podemos calcular individual
        const userCount = completedForUser.length;
        const userSum = completedForUser.reduce((acc, t) => {
          const v = parseFloat(t.realHours);
          return acc + (Number.isFinite(v) ? v : 0);
        }, 0);
        const userAvg = userCount === 0 ? 0 : (userSum / userCount);
        const individualEl = document.getElementById('individualKpiValue');
        if (individualEl) {
          individualEl.textContent = userCount === 0 ? '0h' : formatHours(userAvg);
        }

        // Actualizar último dato del bar chart con el porcentaje actual (si procede)
        if (window.barChartInstance) {
          const ds = window.barChartInstance.data.datasets[0];
          ds.data[ds.data.length - 1] = pct;
          window.barChartInstance.update();
        }
      } catch (err) {
        console.error(err);
        const pctEl = document.getElementById('taskCompletionValue');
        if (pctEl) pctEl.textContent = 'N/A';
        const avgEl = document.getElementById('avgResolutionValue');
        if (avgEl) avgEl.textContent = 'N/A';
        const individualEl = document.getElementById('individualKpiValue');
        if (individualEl) individualEl.textContent = 'N/A';
      }
    }

    // Ejecutar al cargar la página
    loadTaskCompletion();
  </script>
</body>
</html>
