<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Ajustes</title>
  <link rel="stylesheet" href="Css/settings.css"/>
  <link href="https://api.fontshare.com/v2/css?f[]=panchang@500,600,700,800,900&display=swap" rel="stylesheet">

  <!-- Sprite de íconos -->
  <svg xmlns="http://www.w3.org/2000/svg" style="display:none">
  <!-- Dashboard -->
  <symbol id="i-dashboard" viewBox="0 0 24 24" fill="none" stroke="currentColor">
    <path stroke-width="1.6" d="M3 3h8v8H3zM13 3h8v5h-8zM13 10h8v11h-8zM3 13h8v8H3z"/>
  </symbol>
  <!-- Equipos -->
  <symbol id="i-users" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round">
    <path d="M17 21v-2a4 4 0 0 0-3-3.87"/>
    <path d="M7 21v-2a4 4 0 0 1 3-3.87"/>
    <circle cx="12" cy="7" r="4"/>
    <path d="M5.5 8a3.5 3.5 0 1 0 0 7"/>
    <path d="M18.5 8a3.5 3.5 0 1 1 0 7"/>
  </symbol>
  <!-- Proyectos -->
  <symbol id="i-folder" viewBox="0 0 24 24" fill="none" stroke="currentColor">
    <path stroke-width="1.6" d="M3 7h6l2 2h10v9a3 3 0 0 1-3 3H6a3 3 0 0 1-3-3z"/>
  </symbol>
  <!-- Tareas -->
  <symbol id="i-board" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
    <rect width="8" height="4" x="8" y="2" rx="1" ry="1"/>
    <path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"/>
    <path d="M12 11h4"/><path d="M12 16h4"/>
    <path d="M8 11h.01"/><path d="M8 16h.01"/>
  </symbol >
  <!-- KPIs -->
  <symbol id="i-chart" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round">
    <path d="M12 16v5"/>
    <path d="M16 14v7"/>
    <path d="M20 10v11"/>
    <path d="m22 3-8.646 8.646a.5.5 0 0 1-.708 0L9.354 8.354a.5.5 0 0 0-.707 0L2 15"/>
    <path d="M4 18v3"/>
    <path d="M8 14v7"/>
  </symbol>
  <!-- Notificaciones -->
  <symbol id="i-bell" viewBox="0 0 24 24" fill="none" stroke="currentColor">
    <path stroke-width="1.6" d="M18 8a6 6 0 1 0-12 0c0 7-3 7-3 7h18s-3 0-3-7"/>
    <path stroke-width="1.6" d="M13.73 21a2 2 0 0 1-3.46 0"/>
  </symbol>
  <!-- Ajustes -->
  <symbol id="i-gear" viewBox="0 0 24 24" fill="none" stroke="currentColor">
    <circle cx="12" cy="12" r="3" />
    <path stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round" d="M9.671 4.136a2.34 2.34 0 0 1 4.659 0 2.34 2.34 0 0 0 3.319 1.915 2.34 2.34 0 0 1 2.33 4.033 2.34 2.34 0 0 0 0 3.831 2.34 2.34 0 0 1-2.33 4.033 2.34 2.34 0 0 0-3.319 1.915 2.34 2.34 0 0 1-4.659 0 2.34 2.34 0 0 0-3.32-1.915 2.34 2.34 0 0 1-2.33-4.033 2.34 2.34 0 0 0 0-3.831A2.34 2.34 0 0 1 6.35 6.051a2.34 2.34 0 0 0 3.319-1.915" />
  </symbol>
  </svg>
</head>


<body>


    <!-- Topbar -->
  <header class="topbar">
    <div class="brand">
      <h1 class="logo-text">TMDV</h1>
    </div>
    <div class="topbar-right">
      <div class="user-circle" title="Usuario">U</div>
      <a href="/index.html" class="logout-btn">
        <span>Salir</span>
      </a>
    </div>
  </header>

  <div class="app">
        <!-- Sidebar -->
    <aside class="aside">
      <nav class="menu">
        <a class="mi" href="/dashboard.html">
          <svg class="ico"><use href="#i-dashboard"/></svg>
          <span>Dashboard</span>
        </a>
        <a class="mi" href="/Equipos.html">
          <svg class="ico"><use href="#i-users"/></svg>
          <span>Equipos</span>
        </a>
        <a class="mi" href="/projects.html">
          <svg class="ico"><use href="#i-folder"/></svg>
          <span>Proyectos</span>
        </a>
        <a class="mi" href="/tarea.html">
          <svg class="ico"><use href="#i-board"/></svg>
          <span>Tareas</span>
        </a>
        <a class="mi" href="/KPIs.html">
          <svg class="ico"><use href="#i-chart"/></svg>
          <span>KPIs</span>
        </a>
        <a class="mi" href="/notifications.html">
          <svg class="ico"><use href="#i-bell"/></svg>
          <span>Notificaciones</span>
        </a>
        <a class="mi active" href="#">
          <svg class="ico"><use href="#i-gear"/></svg>
          <span>Ajustes</span>
        </a>
      </nav>
    </aside>

    <!-- Main -->
    <main class="main">
      <section class="card card-soft">
        <h1 class="h4">Ajustes</h1>

        <!-- Tabs simuladas -->
        <div class="tabs">
          <button class="tab active">Perfil</button>
          <button class="tab">Preferencias</button>
        </div>

        <!-- single-column profile (panel derecho eliminado) -->
        <div class="grid grid--single">
          <div class="col">
            <h3 class="h6">Perfil</h3>
            <div class="profile">
              <!-- Avatar: preview + upload -->
              <img id="avatarImg" src="/image/avatar.png" alt="Avatar" class="avatar"/>
              <div class="avatar-controls">
                <input id="avatarFile" type="file" accept="image/*" style="display:none"/>
                <button id="avatarUploadBtn" class="btn-outline" type="button">Subir avatar</button>
                <button id="avatarRemoveBtn" class="btn-outline" type="button">Restablecer</button>
              </div>

              <label>Nombre
                <input id="nameInput" type="text" value="Pedro A. Rodríguez"/>
              </label>
              <label>Email
                <input id="emailInput" type="email" value="pedro@ejemplo.com"/>
              </label>
              <label>Contraseña
                <input id="passwordInput" type="password" value="••••••••"/>
              </label>
              <button id="saveProfileBtn" class="btn-primary">Guardar</button>
            </div>
          </div>
        </div>

        <!-- Se eliminó la sección de Preferencias según solicitud -->
      </section>
    </main>
  </div>

  <!-- incluir helper de sesión + script de la página -->
  <script src="/Js/session.js"></script>

  <!-- Preview / default avatar logic -->
  <script>
  (function(){
    const DEFAULT = '/image/avatar.png';
    const avatarImg = document.getElementById('avatarImg');
    const avatarFile = document.getElementById('avatarFile');
    const uploadBtn = document.getElementById('avatarUploadBtn');
    const removeBtn = document.getElementById('avatarRemoveBtn');

    // Cargar avatar guardado en localStorage (si existe), si no usar imagen por defecto
    try {
      const saved = localStorage.getItem('userAvatar');
      if (saved) avatarImg.src = saved;
      else avatarImg.src = DEFAULT;
    } catch (e) {
      avatarImg.src = DEFAULT;
    }

    // Abrir selector al pulsar "Subir avatar"
    uploadBtn?.addEventListener('click', () => avatarFile?.click());

    // Cuando el usuario selecciona archivo, mostrar preview y almacenar en localStorage
    avatarFile?.addEventListener('change', (e) => {
      const file = e.target.files && e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = function(ev) {
        avatarImg.src = ev.target.result;
        try { localStorage.setItem('userAvatar', ev.target.result); } catch (_) {}
      };
      reader.readAsDataURL(file);
    });

    // Botón "Restablecer" para volver a la imagen por defecto
    removeBtn?.addEventListener('click', () => {
      avatarImg.src = DEFAULT;
      try { localStorage.removeItem('userAvatar'); } catch (_) {}
      // también limpiar input
      if (avatarFile) avatarFile.value = '';
    });
  })();
  </script>

  <script>
    document.addEventListener('DOMContentLoaded', async function () {
      // Asegura sesión y obtiene email
      const email = Session.ensureEmailOrRedirect();

      const nameEl = document.getElementById('nameInput');
      const emailEl = document.getElementById('emailInput');
      const passEl = document.getElementById('passwordInput');
      const avatarImg = document.getElementById('avatarImg');
      const avatarFileEl = document.getElementById('avatarFile');
      const avatarUploadBtn = document.getElementById('avatarUploadBtn');
      const saveBtn = document.getElementById('saveProfileBtn');
      const topbarCircle = document.querySelector('.user-circle');

      // Helper: derivar nombre a partir del email si no hay nombre
      function deriveNameFromEmail(em) {
        if (!em) return '';
        const local = em.split('@')[0] || em;
        // reemplaza . _ - por espacios y capitaliza cada palabra
        return local.replace(/[._-]+/g, ' ')
                    .split(' ')
                    .map(s => s ? s.charAt(0).toUpperCase() + s.slice(1) : '')
                    .join(' ');
      }

      // Cargar datos del usuario desde el backend
      try {
        const resp = await Session.apiFetch('/api/usuarios?email=' + encodeURIComponent(email));
        if (resp.ok) {
          const user = await resp.json();
          // Preferir user.nombre; si no existe, intentar otras propiedades o derivar del email
          const resolvedName = user.nombre || user.username || user.name || deriveNameFromEmail(email);
          nameEl.value = resolvedName || '';
          emailEl.value = user.email || email;
          // No mostrar contraseña real; si existe, mostrar marcador
          passEl.value = user.contrasenia ? '••••••••' : '';
          // Intentamos mostrar avatar servido por backend
          avatarImg.src = '/api/usuarios/avatar?email=' + encodeURIComponent(email) + '&_=' + Date.now();

          // Actualizar inicial en la topbar si existe
          if (topbarCircle) topbarCircle.textContent = (resolvedName && resolvedName.charAt(0).toUpperCase()) || email.charAt(0).toUpperCase();
        } else {
          // Si no hay usuario, al menos mostramos el email de la sesión y derivamos nombre
          emailEl.value = email;
          nameEl.value = deriveNameFromEmail(email);
          if (topbarCircle) topbarCircle.textContent = email.charAt(0).toUpperCase();
        }
      } catch (err) {
        console.error(err);
        emailEl.value = email;
        nameEl.value = deriveNameFromEmail(email);
        if (topbarCircle) topbarCircle.textContent = email.charAt(0).toUpperCase();
      }

      // Guardar perfil (actualiza nombre/email/contraseña)
      saveBtn.addEventListener('click', async function () {
        const payload = {
          nombre: nameEl.value,
          email: emailEl.value
        };
        // Si el usuario no cambió la contraseña (marcador), no la enviamos para no sobrescribir
        if (passEl.value && passEl.value !== '••••••••') {
          payload.contrasenia = passEl.value;
        }
        try {
          const r = await Session.apiFetch('/api/usuarios', {
            method: 'PUT',
            body: JSON.stringify(payload)
          });
          if (r.ok) {
            alert('Perfil guardado correctamente.');
            // actualizar inicial en topbar tras guardar
            if (topbarCircle) topbarCircle.textContent = (payload.nombre && payload.nombre.charAt(0).toUpperCase()) || payload.email.charAt(0).toUpperCase();
          } else {
            const txt = await r.text().catch(()=>null);
            alert('Error guardando perfil: ' + (txt || r.status));
          }
        } catch (e) {
          alert('Error al guardar perfil: ' + e.message);
        }
      });

      // Vista previa de avatar seleccionado
      avatarFileEl.addEventListener('change', function () {
        const f = avatarFileEl.files[0];
        if (f) avatarImg.src = URL.createObjectURL(f);
      });

      // Subir avatar al backend
      avatarUploadBtn.addEventListener('click', async function () {
        const file = avatarFileEl.files[0];
        if (!file) { alert('Selecciona un archivo de imagen.'); return; }
        const fd = new FormData();
        fd.append('avatar', file);
        fd.append('email', email); // por si el backend lo necesita
        try {
          const r = await Session.apiFetch('/api/usuarios/avatar', {
            method: 'POST',
            body: fd
          });
          if (r.ok) {
            alert('Avatar subido correctamente.');
            // Forzar refresco de la imagen
            avatarImg.src = '/api/usuarios/avatar?email=' + encodeURIComponent(email) + '&_=' + Date.now();
          } else {
            const txt = await r.text().catch(()=>null);
            alert('Error subiendo avatar: ' + (txt || r.status));
          }
        } catch (e) {
          alert('Error al subir avatar: ' + e.message);
        }
      });
    });
  </script>
</body>
</html>
