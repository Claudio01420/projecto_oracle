<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Proyectos</title>
  <link rel="stylesheet" href="Css/projects.css"/>
  <link href="https://api.fontshare.com/v2/css?f[]=panchang@500,600,700,800,900&display=swap" rel="stylesheet">

  <!-- Sprite de √≠conos -->
  <svg xmlns="http://www.w3.org/2000/svg" style="display:none">
    <symbol id="i-dashboard" viewBox="0 0 24 24" fill="none" stroke="currentColor">
      <path stroke-width="1.6" d="M3 3h8v8H3zM13 3h8v5h-8zM13 10h8v11h-8zM3 13h8v8H3z"/>
    </symbol>
    <symbol id="i-users" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round">
      <path d="M17 21v-2a4 4 0 0 0-3-3.87"/>
      <path d="M7 21v-2a4 4 0 0 1 3-3.87"/>
      <circle cx="12" cy="7" r="4"/>
      <path d="M5.5 8a3.5 3.5 0 1 0 0 7"/>
      <path d="M18.5 8a3.5 3.5 0 1 1 0 7"/>
    </symbol>
    <symbol id="i-folder" viewBox="0 0 24 24" fill="none" stroke="currentColor">
      <path stroke-width="1.6" d="M3 7h6l2 2h10v9a3 3 0 0 1-3 3H6a3 3 0 0 1-3-3z"/>
    </symbol>
    <symbol id="i-board" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <rect width="8" height="4" x="8" y="2" rx="1" ry="1"/>
      <path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"/>
      <path d="M12 11h4"/><path d="M12 16h4"/>
      <path d="M8 11h.01"/><path d="M8 16h.01"/>
    </symbol>
    <symbol id="i-chart" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round">
      <path d="M12 16v5"/>
      <path d="M16 14v7"/>
      <path d="M20 10v11"/>
      <path d="m22 3-8.646 8.646a.5.5 0 0 1-.708 0L9.354 8.354a.5.5 0 0 0-.707 0L2 15"/>
      <path d="M4 18v3"/>
      <path d="M8 14v7"/>
    </symbol>
    <symbol id="i-bot" viewBox="0 0 24 24" fill="none" stroke="currentColor">
      <rect x="4" y="8" width="16" height="10" rx="4" stroke-width="1.6"/>
      <circle cx="9" cy="13" r="1" stroke-width="1.6"/>
      <circle cx="15" cy="13" r="1" stroke-width="1.6"/>
      <path stroke-width="1.6" d="M12 4v2m-7 6H4m16 0h1"/>
    </symbol>
    <symbol id="i-bell" viewBox="0 0 24 24" fill="none" stroke="currentColor">
      <path stroke-width="1.6" d="M18 8a6 6 0 1 0-12 0c0 7-3 7-3 7h18s-3 0-3-7"/>
      <path stroke-width="1.6" d="M13.73 21a2 2 0 0 1-3.46 0"/>
    </symbol>
    <symbol id="i-gear" viewBox="0 0 24 24" fill="none" stroke="currentColor">
      <circle cx="12" cy="12" r="3" />
      <path stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round" d="M9.671 4.136a2.34 2.34 0 0 1 4.659 0 2.34 2.34 0 0 0 3.319 1.915 2.34 2.34 0 0 1 2.33 4.033 2.34 2.34 0 0 0 0 3.831 2.34 2.34 0 0 1-2.33 4.033 2.34 2.34 0 0 0-3.319 1.915 2.34 2.34 0 0 1-4.659 0 2.34 2.34 0 0 0-3.32-1.915 2.34 2.34 0 0 1-2.33-4.033 2.34 2.34 0 0 0 0-3.831A2.34 2.34 0 0 1 6.35 6.051a2.34 2.34 0 0 0 3.319-1.915" />
    </symbol>
    <symbol id="i-exit" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <path d="m16 17 5-5-5-5"/>
      <path d="M21 12H9"/>
      <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/>
    </symbol>
  </svg>

  <style>
    .modal-overlay { position: fixed; inset: 0; background: rgba(0, 0, 0, 0.4); display: none; justify-content: center; align-items: center; z-index: 999; }
    .modal { background: #fff; border-radius: 18px; padding: 20px 26px; width: 480px; max-width: 95%; box-shadow: 0 8px 32px rgba(0,0,0,.25); animation: fadeIn .2s ease-in-out; }
    @keyframes fadeIn { from{opacity:0; transform: translateY(-10px);} to{opacity:1; transform: translateY(0);} }
    .modal-buttons { display:flex; gap:10px; margin-top:14px; justify-content:flex-end }
    .chip.active { background: var(--brand); color:#fff; font-weight:700; box-shadow: 0 2px 8px rgba(225,38,28,.25); }

    .tasks-box { margin-top:14px; border:1px solid var(--line); border-radius:12px; padding:12px; background:#fafbfc; }
    .tasks-box h3 { margin:4px 0 10px 0; font-size:15px; }
    .task-item { border:1px solid var(--line); background:#fff; border-radius:10px; padding:8px 10px; margin:6px 0; display:flex; justify-content:space-between; gap:10px; }
    .task-title { font-weight:700; }
    .task-meta { font-size:12px; color:#64748b; }
    .badge { font-size:12px; border:1px solid var(--line); padding:2px 8px; border-radius:999px; background:#fff; }
    .badge.status.todo{ background:#fff4f3 }
    .badge.status.doing{ background:#fff8e6 }
    .badge.status.done{ background:#e9fff0 }

    .detail-head { display:flex; align-items:center; justify-content:space-between; gap:12px; padding:10px 12px; border-radius:12px; background: linear-gradient(180deg,#ffffff 0%,#fafbfc 100%); border:1px solid var(--line); margin-bottom:10px; }
    .detail-head .title { font-weight:900; font-size:16px; }
    .detail-actions { display:flex; gap:8px; align-items:center }

    .btn-ghost { display:inline-flex; align-items:center; gap:8px; padding:9px 12px; border-radius:12px; background:#fff; color:var(--dark); border:1px solid var(--line-2); font-weight:800; font-size:13px; text-decoration:none; cursor:pointer; box-shadow: var(--shadow-sm); transition: transform .08s ease, box-shadow .2s ease, border-color .2s ease, background .15s ease; }
    .btn-ghost:hover { transform: translateY(-1px); box-shadow: var(--shadow-md); border-color:#d9dde3; }
    .btn-ghost:active { transform: translateY(0); box-shadow: var(--shadow-sm); }
    .btn-ghost[disabled] { opacity:.5; pointer-events:none }
    .btn-ghost .ico { width:16px; height:16px; display:inline-block; }

    .table tbody tr { cursor: pointer; }

    /* === Estilos de validaci√≥n del formulario === */
    .field.invalid input, .field.invalid select { border-color:#E1261C; background:#fff6f5; }
    .field .msg { display:none; font-size:12px; color:#E1261C; margin-top:6px; }
    .field.invalid .msg { display:block; }

    /* ===== Picker / Autocomplete ===== */
    .search-wrap { position:relative; }
    .ac-wrap { position:absolute; left:0; right:0; top:calc(100% + 6px); background:#fff; border:1px solid var(--line); border-radius:12px; box-shadow: var(--shadow-md, 0 6px 24px rgba(16,24,40,.08)); display:none; z-index: 500; }
    .ac-wrap.open { display:block; }
    .ac-head { display:flex; align-items:center; justify-content:space-between; padding:8px 10px; border-bottom:1px solid var(--line); font-size:12px; color:#6b7280; }
    .ac-list { max-height:260px; overflow:auto; padding:4px; margin:0; list-style:none; }
    .ac-item { display:flex; align-items:flex-start; justify-content:space-between; gap:8px; padding:8px 10px; border-radius:10px; cursor:pointer; }
    .ac-item:hover { background:#f8fafc; }
    .ac-item.active { outline:2px solid #e5e7eb; background:#f1f5f9; }
    .ac-title { font-weight:800; margin-bottom:2px; }
    .ac-sub  { font-size:12px; color:#6b7280; }
    .ac-chip { font-size:12px; padding:2px 8px; border-radius:999px; border:1px solid var(--line); background:#fff; white-space:nowrap; }
  </style>
</head>

<body>
  <header class="topbar">
    <div class="brand">
      <h1 class="logo-text">TMDV</h1>
    </div>
    <div class="topbar-right">
      <div class="user-circle" title="Usuario">U</div>
      <a href="/index.html" class="logout-btn">
        <svg class="ico-sm" aria-hidden="true"><use href="#i-exit"/></svg>
        <span>Salir</span>
      </a>
    </div>
  </header>

  <div class="app">
    <aside class="aside">
      <nav class="menu">
        <a class="mi" href="/dashboard.html">
          <svg class="ico"><use href="#i-dashboard"/></svg>
          <span>Dashboard</span>
        </a>
        <a class="mi" href="/Equipos.html">
          <svg class="ico"><use href="#i-users"/></svg>
          <span>Equipos</span>
        </a>
        <a class="mi active" href="#">
          <svg class="ico"><use href="#i-folder"/></svg>
          <span>Proyectos</span>
        </a>
        <a class="mi" href="/tarea.html">
          <svg class="ico"><use href="#i-board"/></svg>
          <span>Tareas</span>
        </a>
        <a class="mi" href="/KPIs.html">
          <svg class="ico"><use href="#i-chart"/></svg>
          <span>KPIs</span>
        </a>
        <a class="mi" href="/chatbot.html">
          <svg class="ico"><use href="#i-bot"/></svg>
          <span>Chatbot</span>
        </a>
        <a class="mi" href="/notifications.html">
          <svg class="ico"><use href="#i-bell"/></svg>
          <span>Notificaciones</span>
        </a>
        <a class="mi" href="/settings.html">
          <svg class="ico"><use href="#i-gear"/></svg>
          <span>Ajustes</span>
        </a>
      </nav>
    </aside>

    <main class="main">
      <section class="card card-soft">
        <h1 class="h4">Proyectos</h1>
        <div class="toolbar">
          <!-- üîé Buscador con picker -->
          <div class="field search-wrap">
            <label for="buscar">Buscar</label>
            <input id="buscar" type="text" placeholder="Buscar proyecto‚Ä¶" autocomplete="off" />
            <!-- Panel de sugerencias -->
            <div id="ac-wrap" class="ac-wrap" aria-hidden="true">
              <div class="ac-head"><span>Coincidencias</span><span id="ac-count">0</span></div>
              <ul id="ac-list" class="ac-list"></ul>
            </div>
          </div>

          <div class="field">
            <label for="filtro">Filtrar</label>
            <select id="filtro">
              <option>Todos</option>
              <option>Pendiente</option>
              <option>En curso</option>
              <option>Finalizado</option>
            </select>
          </div>
          <a class="btn btn-primary" href="#!" id="btn-nuevo">+ Nuevo</a>
        </div>
      </section>

      <div class="grid">
        <section class="card">
          <div class="row-sb">
            <div class="muted small" id="resumen-lista"><strong>0</strong> resultado(s)</div>
            <div class="chips" id="chips">
              <span class="chip active" data-est="Todos">Todos</span>
              <span class="chip" data-est="Pendiente">Pendiente</span>
              <span class="chip" data-est="En curso">En curso</span>
              <span class="chip" data-est="Finalizado">Finalizado</span>
            </div>
          </div>

          <div class="table-wrap">
            <table class="table">
              <thead>
                <tr>
                  <th style="width:80px">ID</th>
                  <th style="width:180px">Equipo</th>
                  <th>Nombre</th>
                  <th style="width:130px">Estado</th>
                  <th style="width:200px">Avance</th>
                  <th style="width:140px">Acciones</th>
                </tr>
              </thead>
              <tbody id="projects-body"></tbody>
            </table>
          </div>
        </section>

        <aside class="card">
          <div class="detail-head">
            <div class="title">Detalle del Proyecto</div>
            <div class="detail-actions">
              <button id="btn-ir-homework" class="btn-ghost" disabled>
                <svg class="ico" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                  <path d="M5 12h14M13 5l7 7-7 7" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
                Ir a tareas (homework)
              </button>
            </div>
          </div>

          <div class="detail" id="detalle-proyecto">
            <div class="muted">Selecciona un proyecto para ver el detalle.</div>
            <hr class="sep">
            <div class="detail-item"><div class="label">Nombre</div><div class="value" id="d-nombre">‚Äî</div></div>
            <div class="detail-item"><div class="label">Descripci√≥n</div><div class="value" id="d-descripcion">‚Äî</div></div>
            <div class="detail-item"><div class="label">Equipo</div><div class="value" id="d-equipo">‚Äî</div></div>
            <div class="detail-item"><div class="label">Inicio</div><div class="value" id="d-inicio">‚Äî</div></div>
            <div class="detail-item"><div class="label">Fin</div><div class="value" id="d-fin">‚Äî</div></div>
            <div class="detail-item"><div class="label">Estado</div><div class="value" id="d-estado"><span class="chip">‚Äî</span></div></div>
            <div class="detail-item"><div class="label">Avance</div><div class="value"><div class="progress"><span id="d-avance" style="width:0%"></span></div></div></div>

            <div class="tasks-box" id="tasks-box" style="display:none;">
              <h3>Tareas de este proyecto</h3>
              <div id="tasks-list"></div>
              <div class="muted small" id="tasks-count"></div>
            </div>
          </div>
        </aside>
      </div>
    </main>
  </div>

  <div class="modal-overlay" id="modal-overlay">
    <div class="modal">
      <h2>Nuevo Proyecto</h2>

      <div class="field" id="f-nombre-field">
        <label>Nombre</label>
        <input id="f-nombre" type="text" placeholder="Ej. Reto Oracle Cloud">
        <div class="msg" id="msg-nombre">El nombre es obligatorio (m√≠n. 3 caracteres).</div>
      </div>

      <div class="field" id="f-desc-field">
        <label>Descripci√≥n</label>
        <input id="f-desc" type="text" placeholder="Breve descripci√≥n">
        <div class="msg" id="msg-desc">La descripci√≥n es obligatoria (m√≠n. 5 caracteres).</div>
      </div>

      <!-- SELECT de equipos donde eres ADMIN -->
      <div class="field" id="f-equipo-field">
        <label for="f-equipo">Equipo</label>
        <select id="f-equipo">
          <option value="">Cargando equipos‚Ä¶</option>
        </select>
        <small id="equipos-help" class="muted">Solo ver√°s equipos donde eres ADMIN.</small>
        <div class="msg" id="msg-equipo">Selecciona un equipo.</div>
      </div>

      <div class="field" id="f-inicio-field">
        <label>Fecha inicio</label>
        <input id="f-inicio" type="date">
        <div class="msg" id="msg-inicio">Indica una fecha de inicio v√°lida.</div>
      </div>

      <div class="field" id="f-fin-field">
        <label>Fecha fin</label>
        <input id="f-fin" type="date">
        <div class="msg" id="msg-fin">Indica una fecha de fin v√°lida (‚â• inicio).</div>
      </div>

      <div class="modal-buttons">
        <button class="btn btn-outline" id="btn-cancelar">Cancelar</button>
        <button class="btn btn-primary" id="btn-guardar">Guardar</button>
      </div>
    </div>
  </div>

  <div id="confirm-root"></div>

<script>
  // ===== Sesi√≥n
  const user = JSON.parse(localStorage.getItem("user") || "null");
  const $userInitial = document.querySelector(".user-circle");
  if ($userInitial && (user?.nombre || user?.email)) {
    const ch = (user?.nombre?.trim()?.[0] ?? user?.email?.trim()?.[0] ?? "U").toUpperCase();
    $userInitial.textContent = ch;
  }

  // ===== DOM
  const $tbody = document.getElementById("projects-body");
  const $buscar = document.getElementById("buscar");
  const $filtro = document.getElementById("filtro");
  const $resumen = document.getElementById("resumen-lista");
  const $chips = document.getElementById("chips");
  const $confirmRoot = document.getElementById("confirm-root");

  // Detalle
  const $dNombre = document.getElementById("d-nombre");
  const $dDesc   = document.getElementById("d-descripcion");
  const $dEquipo = document.getElementById("d-equipo");
  const $dIni    = document.getElementById("d-inicio");
  const $dFin    = document.getElementById("d-fin");
  const $dEstado = document.getElementById("d-estado");
  const $dAvance = document.getElementById("d-avance");
  const $btnIrHomework = document.getElementById("btn-ir-homework");

  // Panel de tareas
  const $tasksBox   = document.getElementById("tasks-box");
  const $tasksList  = document.getElementById("tasks-list");
  const $tasksCount = document.getElementById("tasks-count");

  // Modal
  const $modalOverlay = document.getElementById("modal-overlay");
  const $btnNuevo  = document.getElementById("btn-nuevo");
  const $btnGuardar= document.getElementById("btn-guardar");
  const $btnCancel = document.getElementById("btn-cancelar");

  // Form inputs
  const $fNombre = document.getElementById("f-nombre");
  const $fDesc   = document.getElementById("f-desc");
  const $fEquipo = document.getElementById("f-equipo");
  const $fInicio = document.getElementById("f-inicio");
  const $fFin    = document.getElementById("f-fin");

  // Form fields
  const $fNombreField = document.getElementById("f-nombre-field");
  const $fDescField   = document.getElementById("f-desc-field");
  const $fEquipoField = document.getElementById("f-equipo-field");
  const $fInicioField = document.getElementById("f-inicio-field");
  const $fFinField    = document.getElementById("f-fin-field");

  // ===== Picker / Autocomplete DOM
  const $acWrap  = document.getElementById("ac-wrap");
  const $acList  = document.getElementById("ac-list");
  const $acCount = document.getElementById("ac-count");

  // API
  const currentUserId = user?.id || null;
  const currentUserEmail = user?.email || "";
  const API_BASE    = "http://localhost:8080/proyectos";
  const TASKS_API   = "http://localhost:8080/api/tasks";   // <-- importante
  const EQUIPOS_API = "http://localhost:8080/equipos";
  const UE_API      = "http://localhost:8080/usuarios-equipos";
  const ROL_ADMIN   = "ADMIN";

  let proyectosCache = [];
  let selectedProjectId = null;

  /* === Cach√© de nombres de equipo === */
  const equipoNombreCache = new Map();
  async function fetchEquipoNombre(id){
    if (!id) return "-";
    if (equipoNombreCache.has(id)) return equipoNombreCache.get(id);
    try{
      const r = await fetch(`${EQUIPOS_API}/${encodeURIComponent(id)}`);
      if (!r.ok) throw 0;
      const data = await r.json();
      const name = data?.nombreEquipo || (`Equipo #${id}`);
      equipoNombreCache.set(id, name);
      return name;
    }catch{
      const fallback = `Equipo #${id}`;
      equipoNombreCache.set(id, fallback);
      return fallback;
    }
  }

  /* üîÅ Navegar a /homework-proyect.html */
  function goToHomework(id){
    if (!id) return;
    const url = `${window.location.origin}/homework-proyect.html?id=${encodeURIComponent(id)}`;
    window.location.href = url;
  }

  function estadoToChipClass(estado) {
    if (!estado) return "chip";
    switch ((estado || "").toLowerCase()) {
      case "pendiente":  return "chip state-pend";
      case "en curso":   return "chip state-run";
      case "finalizado": return "chip state-done";
      default:           return "chip";
    }
  }
  function estadoToAvance(estado) {
    switch ((estado || "").toLowerCase()) {
      case "pendiente":  return 0;
      case "en curso":   return 50;
      case "finalizado": return 100;
      default:           return 0;
    }
  }
  function formatFecha(iso) {
    if (!iso) return "‚Äî";
    const d = new Date(iso);
    return isNaN(d.getTime()) ? "‚Äî" : d.toLocaleDateString();
  }

  /* ========= PROGRESO REAL POR TAREAS (vista compartida) ========= */
  async function fetchTasksForProject(projectId){
    try{
      const res = await fetch(`${TASKS_API}?projectId=${encodeURIComponent(projectId)}`, {
        headers: { "X-User-Id": String(currentUserId || "") }
      });
      if (!res.ok) return [];
      return await res.json();
    }catch{ return []; }
  }
  function calcProgressFromTasks(tasks){
    const total = tasks.length;
    const done = tasks.filter(t => (t.status||"").toLowerCase()==="done" || t.completedAt != null || (t.status||"").toLowerCase()==="hecho").length;
    const pct = total === 0 ? 0 : Math.round((done/total)*100);
    return { total, done, pct };
  }

  async function persistProjectEstadoFromPct(p, pct){
    if (!p || !p.id) return;
    const nuevo = (pct===0) ? "Pendiente" : (pct===100 ? "Finalizado" : "En curso");
    if (p.estado === nuevo) return;

    const payload = {
      id: p.id,
      nombreProyecto: p.nombreProyecto,
      descripcion: p.descripcion,
      estado: nuevo,
      equipoId: p.equipoId,
      fechaInicio: p.fechaInicio || null,
      fechaFin: p.fechaFin || null,
      ultimoAcceso: p.ultimoAcceso || null
    };
    try{
      const res = await fetch(`${API_BASE}/${p.id}`, {
        method:"PUT",
        headers:{ "Content-Type":"application/json" },
        body: JSON.stringify(payload)
      });
      if (res.ok){
        const updated = await res.json();
        p.estado = updated.estado;
      }
    }catch(e){ /* no-op */ }
  }

  function updateRowProgress(projectId, pct){
    const row = $tbody.querySelector(`tr[data-id="${projectId}"]`);
    if (!row) return;
    const bar = row.querySelector(".progress > span");
    if (bar) bar.style.width = `${pct}%`;
    const estChip = row.querySelector("td:nth-child(4) .chip");
    if (estChip){
      const nuevo = pct===0 ? "Pendiente" : (pct===100 ? "Finalizado" : "En curso");
      estChip.textContent = nuevo;
      estChip.className = estadoToChipClass(nuevo);
    }
  }

  async function refreshProgressForAllProjects(){
    const promises = proyectosCache.map(async (p) => {
      const tasks = await fetchTasksForProject(p.id);
      const { pct } = calcProgressFromTasks(tasks);
      p._progress = pct;
      updateRowProgress(p.id, pct);
      await persistProjectEstadoFromPct(p, pct);
    });
    await Promise.all(promises);
    aplicarFiltros();
  }

  function setDetalle(p) {
    if (!p) return;
    selectedProjectId = p.id || null;
    if ($btnIrHomework) $btnIrHomework.disabled = !selectedProjectId;

    $dNombre.textContent = p.nombreProyecto ?? "‚Äî";
    $dDesc.textContent   = p.descripcion ?? "‚Äî";

    const cached = p.equipoId ? (equipoNombreCache.get(p.equipoId) || null) : null;
    $dEquipo.textContent = cached ?? (p.equipoId ?? "‚Äî");
    if (p.equipoId && !cached){
      fetchEquipoNombre(p.equipoId).then(name => {
        if (selectedProjectId === p.id) $dEquipo.textContent = name;
      });
    }

    $dIni.textContent    = formatFecha(p.fechaInicio);
    $dFin.textContent    = formatFecha(p.fechaFin);

    $dEstado.innerHTML   = `<span class="${estadoToChipClass(p.estado)}">${p.estado ?? "‚Äî"}</span>`;
    $dAvance.style.width = (typeof p._progress === "number" ? p._progress : estadoToAvance(p.estado)) + "%";

    loadProjectTasksAndProgress(p.id);
  }

  if ($btnIrHomework) {
    $btnIrHomework.addEventListener("click", () => {
      if (!selectedProjectId) return;
      goToHomework(selectedProjectId);
    });
  }

  async function loadProjectTasksAndProgress(projectId){
    $tasksBox.style.display = "block";
    $tasksList.innerHTML = `<div class="muted">Cargando tareas‚Ä¶</div>`;
    $tasksCount.textContent = '';

    const tasks = await fetchTasksForProject(projectId);

    if (!tasks.length) {
      $tasksList.innerHTML = `<div class="muted">Este proyecto no tiene tareas.</div>`;
      $tasksCount.textContent = `0 tareas`;
    } else {
      $tasksList.innerHTML = tasks.map(t => `
        <div class="task-item">
          <div>
            <div class="task-title">${escapeHtml(t.title || '')}</div>
            <div class="task-meta">Prio: ${escapeHtml(t.priority||'')} ¬∑ Est: ${t.estimatedHours??'-'}h ${t.realHours?(' ¬∑ Real: '+t.realHours+'h'):''}</div>
          </div>
          <div><span class="badge status ${escapeHtml((t.status||'todo').toLowerCase())}">${escapeHtml((t.status||'todo'))}</span></div>
        </div>
      `).join('');
      $tasksCount.textContent = `${tasks.length} tarea(s)`;
    }

    const { pct } = calcProgressFromTasks(tasks);
    $dAvance.style.width = `${pct}%`;
    const nuevoEstado = pct===0 ? "Pendiente" : (pct===100 ? "Finalizado" : "En curso");
    $dEstado.innerHTML = `<span class="${estadoToChipClass(nuevoEstado)}">${nuevoEstado}</span>`;

    updateRowProgress(projectId, pct);

    const idx = proyectosCache.findIndex(x => x.id === projectId);
    if (idx >= 0) proyectosCache[idx]._progress = pct;

    if (idx >= 0) {
      await persistProjectEstadoFromPct(proyectosCache[idx], pct);
      aplicarFiltros();
    }
  }

  function escapeHtml(s){ return String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])) }

  // ====== Cargar equipos donde soy ADMIN y llenar el <select> (crear proyecto)
  async function cargarEquiposAdminParaSelect() {
    const $select = document.getElementById("f-equipo");
    const $help   = document.getElementById("equipos-help");
    if (!$select) return;

    const renderOpciones = (equipos) => {
      if (!equipos?.length) {
        $select.innerHTML = `<option value="">No tienes equipos como ADMIN</option>`;
        if ($btnGuardar) $btnGuardar.disabled = true;
        if ($help) $help.textContent = "No apareces como ADMIN en ning√∫n equipo.";
        return;
      }
      $select.innerHTML = `<option value="">Selecciona un equipo‚Ä¶</option>` +
        equipos.map(e => `<option value="${e.id}">${escapeHtml(e.nombreEquipo || ("Equipo #" + e.id))}</option>`).join("");
      validarYActualizarEstado();
    };

    try {
      const direct = await fetch(`${EQUIPOS_API}?adminId=${encodeURIComponent(currentUserId)}`);
      if (direct.ok) {
        const data = await direct.json();
        renderOpciones(data);
        return;
      }
    } catch { /* no-op */ }

    $select.innerHTML = `<option value="">Error cargando equipos</option>`;
    if ($btnGuardar) $btnGuardar.disabled = true;
  }

  // ====== Validaci√≥n de formulario (crear proyecto)
  let formTriedSubmit = false;

  function setFieldState($fieldEl, isValid, show){
    if (!$fieldEl) return;
    if (!show){
      $fieldEl.classList.remove("invalid");
      return;
    }
    if (isValid) $fieldEl.classList.remove("invalid");
    else $fieldEl.classList.add("invalid");
  }

  function isNonEmpty(s){ return !!(s && s.trim().length > 0); }

  function validarFormulario(show=false){
    const nombreOK = isNonEmpty($fNombre.value) && $fNombre.value.trim().length >= 3;
    const descOK   = isNonEmpty($fDesc.value)   && $fDesc.value.trim().length >= 5;
    const equipoOK = isNonEmpty($fEquipo.value);

    const ini = $fInicio.value ? new Date($fInicio.value) : null;
    const fin = $fFin.value    ? new Date($fFin.value)    : null;

    const inicioOK = !!ini && !isNaN(ini.getTime());
    const finOK    = !!fin && !isNaN(fin.getTime());
    const rangoOK  = inicioOK && finOK && (ini.getTime() <= fin.getTime());

    setFieldState($fNombreField, nombreOK, show);
    setFieldState($fDescField,   descOK,   show);
    setFieldState($fEquipoField, equipoOK, show);
    setFieldState($fInicioField, inicioOK, show);
    setFieldState($fFinField,    finOK && rangoOK, show);

    const errors = [];
    if (!nombreOK) errors.push("‚Ä¢ Nombre (m√≠n. 3 caracteres)");
    if (!descOK)   errors.push("‚Ä¢ Descripci√≥n (m√≠n. 5 caracteres)");
    if (!equipoOK) errors.push("‚Ä¢ Equipo (selecciona uno)");
    if (!inicioOK) errors.push("‚Ä¢ Fecha inicio (v√°lida)");
    if (!finOK)    errors.push("‚Ä¢ Fecha fin (v√°lida)");
    else if (!rangoOK) errors.push("‚Ä¢ Rango de fechas (Fin ‚â• Inicio)");

    return { ok: nombreOK && descOK && equipoOK && inicioOK && finOK && rangoOK, errors };
  }

  function validarYActualizarEstado(){
    const { ok } = validarFormulario(false);
    if ($btnGuardar) $btnGuardar.disabled = !ok;
    return ok;
  }

  [$fNombre, $fDesc, $fEquipo, $fInicio, $fFin].forEach(el => {
    el.addEventListener("input", validarYActualizarEstado);
    el.addEventListener("change", validarYActualizarEstado);
  });

  function renderTabla(items) {
    if (!items.length) {
      $tbody.innerHTML = `<tr><td colspan="6">No hay proyectos.</td></tr>`;
      $resumen.innerHTML = `<strong>0</strong> resultado(s)`;
      return;
    }
    $resumen.innerHTML = `<strong>${items.length}</strong> resultado(s)`;
    $tbody.innerHTML = items.map(p => {
      const teamName = p.equipoId ? (equipoNombreCache.get(p.equipoId) ?? `Equipo #${p.equipoId}`) : "-";
      return `
      <tr data-id="${p.id}">
        <td>${p.id ?? "-"}</td>
        <td>${teamName}</td>
        <td>${p.nombreProyecto ?? "-"}</td>
        <td><span class="${estadoToChipClass(p.estado)}">${p.estado ?? "‚Äî"}</span></td>
        <td><div class="progress"><span style="width:${typeof p._progress==='number' ? p._progress : estadoToAvance(p.estado)}%"></span></div></td>
        <td>
          <button class="btn-danger btn-xs" onclick="borrarProyecto(${p.id}, event)" title="Borrar proyecto" onkeydown="event.stopPropagation()">Borrar</button>
        </td>
      </tr>`;
    }).join("");

    Array.from($tbody.querySelectorAll("tr")).forEach(tr => {
      tr.addEventListener("click", (e) => {
        if (e.target.closest('button')) return;
        const id = Number(tr.dataset.id);
        const p = proyectosCache.find(x => x.id === id);
        setDetalle(p);
      });

      tr.addEventListener("dblclick", (e) => {
        if (e.target.closest('button')) return;
        const id = Number(tr.dataset.id);
        if (id) goToHomework(id);
      });
    });
  }

  async function borrarProyecto(id, evt) {
    if (evt) evt.stopPropagation();
    mostrarConfirmacion("¬øSeguro que deseas borrar este proyecto?", async () => {
      await fetch(`${API_BASE}/${id}`, { method: "DELETE" });
      proyectosCache = proyectosCache.filter(p => p.id !== id);
      aplicarFiltros();
      $tasksBox.style.display = "none";
      selectedProjectId = null;
      if ($btnIrHomework) $btnIrHomework.disabled = true;
    });
  }
  window.borrarProyecto = borrarProyecto;

  async function crearProyecto() {
    if (!currentUserId) { alert("No hay usuario logueado. Inicia sesi√≥n primero."); return; }

    const result = validarFormulario(true);
    if (!result.ok) {
      alert("Completa correctamente todos los campos:\n\n" + result.errors.join("\n"));
      return;
    }

    const nuevo = {
      nombreProyecto: $fNombre.value.trim(),
      descripcion: $fDesc.value.trim(),
      estado: "Pendiente",
      equipoId: Number($fEquipo.value),
      fechaInicio: $fInicio.value,
      fechaFin: $fFin.value,
      creadorId: currentUserId
    };
    const res = await fetch(API_BASE, {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "X-User-Id": String(currentUserId)
      },
      body: JSON.stringify(nuevo)
    });
    if (res.ok) {
      const creado = await res.json();

      if (creado?.equipoId && !equipoNombreCache.has(creado.equipoId)) {
        await fetchEquipoNombre(creado.equipoId);
      }

      proyectosCache.push(creado);
      cerrarModal();
      aplicarFiltros();
      updateRowProgress(creado.id, 0);
    } else alert("Error al crear el proyecto.");
  }

  function aplicarFiltros() {
    const q = ($buscar.value || "").toLowerCase();
    const estSel = ($filtro.value || "Todos").toLowerCase();
    const chipActivo = (document.querySelector(".chip.active")?.dataset.est || "Todos").toLowerCase();

    let items = proyectosCache.filter(p =>
      (!q || (p.nombreProyecto || "").toLowerCase().includes(q)) &&
      (
        estSel === "todos" && chipActivo === "todos"
          ? true
          : (p.estado || "").toLowerCase() === estSel || (p.estado || "").toLowerCase() === chipActivo
      )
    );
    if (chipActivo !== "todos") items = items.filter(p => (p.estado || "").toLowerCase() === chipActivo);
    renderTabla(items);
  }

  // ===== Confirm UI
  function mostrarConfirmacion(mensaje, onYes) {
    const overlay = document.createElement("div");
    overlay.className = "confirm-overlay";
    overlay.innerHTML = `
      <div class="confirm-box">
        <h3>Confirmar acci√≥n</h3>
        <p>${mensaje}</p>
        <div class="confirm-buttons">
          <button class="confirm-btn confirm-cancel">Cancelar</button>
          <button class="confirm-btn confirm-yes">S√≠, borrar</button>
        </div>
      </div>
    `;
    $confirmRoot.appendChild(overlay);
    const close = () => overlay.remove();
    overlay.querySelector(".confirm-cancel").onclick = close;
    overlay.querySelector(".confirm-yes").onclick = () => { close(); onYes(); };
    overlay.addEventListener("click", (e) => { if (e.target === overlay) close(); });
    document.addEventListener("keydown", function esc(e){ if(e.key === "Escape"){ close(); document.removeEventListener("keydown", esc); }});
  }

  // =======================
  // CARGA DE PROYECTOS (visibles)
  // =======================
  async function getJsonOrNull(url){
    try{ const r = await fetch(url); if (!r.ok) return null; return await r.json(); }
    catch{ return null; }
  }

  async function fetchUserEquipoIds(userId){
    const rels = await getJsonOrNull(`http://localhost:8080/usuarios-equipos/usuario/${encodeURIComponent(userId)}`);
    if (!Array.isArray(rels)) return [];
    return rels
      .map(r => (r?.equipoId ?? r?.id?.equipoId))
      .filter(id => id != null);
  }

  async function fetchUserVisibleProjects(userId){
    const direct = await getJsonOrNull(`${API_BASE}/visibles/${encodeURIComponent(userId)}`);
    if (Array.isArray(direct)) return direct;

    const byId = new Map();
    const mine = await getJsonOrNull(`${API_BASE}/mios/${encodeURIComponent(userId)}`) || [];
    for (const p of mine) if (p?.id != null) byId.set(p.id, p);

    const equipoIds = await fetchUserEquipoIds(userId);
    for (const eid of equipoIds) {
      const arr = await getJsonOrNull(`${API_BASE}?equipoId=${encodeURIComponent(eid)}`) || [];
      for (const p of arr) if (p?.id != null) byId.set(p.id, p);
    }
    return Array.from(byId.values());
  }

  async function cargarProyectos() {
    try {
      if (!currentUserId) {
        $tbody.innerHTML = `<tr><td colspan="6">Inicia sesi√≥n para ver tus proyectos.</td></tr>`;
        return;
      }

      proyectosCache = await fetchUserVisibleProjects(currentUserId);

      const uniqueEquipoIds = [...new Set(proyectosCache.map(p => p.equipoId).filter(Boolean))];
      await Promise.all(uniqueEquipoIds.map(id => fetchEquipoNombre(id)));

      aplicarFiltros();
      await refreshProgressForAllProjects();

      if (proyectosCache[0]) setDetalle(proyectosCache[0]);

    } catch {
      $tbody.innerHTML = `<tr><td colspan="6">Error al cargar proyectos</td></tr>`;
    }
  }

  // Chips
  $chips.querySelectorAll(".chip").forEach(chip => {
    chip.addEventListener("click", () => {
      $chips.querySelectorAll(".chip").forEach(c => c.classList.remove("active"));
      chip.classList.add("active");
      aplicarFiltros();
    });
  });

  // Modal
  function abrirModal() {
    $modalOverlay.style.display = "flex";
    validarYActualizarEstado();
    cargarEquiposAdminParaSelect();
  }
  function cerrarModal() {
    $modalOverlay.style.display = "none";
    $fNombre.value = ""; $fDesc.value = ""; $fEquipo.value = "";
    $fInicio.value = ""; $fFin.value = "";
    [$fNombreField,$fDescField,$fEquipoField,$fInicioField,$fFinField].forEach(f=>f.classList.remove("invalid"));
    if ($btnGuardar) $btnGuardar.disabled = true;
  }

  $btnNuevo.addEventListener("click", e => { e.preventDefault(); abrirModal(); });
  $btnCancel.addEventListener("click", e => { e.preventDefault(); cerrarModal(); });
  $btnGuardar.addEventListener("click", e => { e.preventDefault(); crearProyecto(); });
  $modalOverlay.addEventListener("click", e => { if (e.target === $modalOverlay) cerrarModal(); });

  $buscar.addEventListener("input", aplicarFiltros);
  $filtro.addEventListener("change", aplicarFiltros);

  document.addEventListener("DOMContentLoaded", cargarProyectos);

  /* ===========================
     ==== Picker / Autocomplete
     =========================== */
  const acState = { open:false, index:-1, items:[] };

  function debounce(fn, ms){ let t; return (...args)=>{ clearTimeout(t); t=setTimeout(()=>fn(...args), ms); }; }

  function acOpen(){ if (!$acWrap) return; $acWrap.classList.add("open"); $acWrap.setAttribute("aria-hidden","false"); acState.open = true; }
  function acClose(){ if (!$acWrap) return; $acWrap.classList.remove("open"); $acWrap.setAttribute("aria-hidden","true"); acState.open = false; acState.index = -1; }
  function acRender(items){
    acState.items = items || [];
    $acCount.textContent = String(acState.items.length);
    $acList.innerHTML = acState.items.map((p,idx)=>`
      <li class="ac-item ${idx===acState.index?'active':''}" data-id="${p.id}">
        <div>
          <div class="ac-title">${escapeHtml(p.nombreProyecto || '')}</div>
          <div class="ac-sub">${escapeHtml(p.descripcion || '')}</div>
        </div>
        <div class="ac-chip">${escapeHtml(p.estado || '')}</div>
      </li>
    `).join('');
    if (!acState.items.length) {
      $acList.innerHTML = `<li class="ac-item" style="cursor:default;opacity:.7">Sin resultados‚Ä¶</li>`;
    }
  }

  function acHighlight(nextIndex){
    const n = acState.items.length;
    if (!n) return;
    if (nextIndex < 0) nextIndex = n - 1;
    if (nextIndex >= n) nextIndex = 0;
    acState.index = nextIndex;
    Array.from($acList.children).forEach((li,i)=>{
      if (li.classList.contains('ac-item')) {
        if (i===acState.index) li.classList.add('active'); else li.classList.remove('active');
      }
    });
    const active = $acList.children[acState.index];
    if (active && active.scrollIntoView) active.scrollIntoView({ block:'nearest' });
  }

  async function acFetch(q){
    if (!q || q.trim().length < 2) { acClose(); return; }
    const url = `${API_BASE}/buscar?q=${encodeURIComponent(q)}${currentUserId ? `&usuarioId=${encodeURIComponent(currentUserId)}`:''}`;
    try{
      const r = await fetch(url);
      if (!r.ok) { acRender([]); acOpen(); return; }
      const data = await r.json();
      acRender(Array.isArray(data) ? data : []);
      acOpen();
    }catch{
      acRender([]); acOpen();
    }
  }
  const acFetchDebounced = debounce(acFetch, 180);

  async function acChooseById(id){
    if (!id) return;
    // Opci√≥n A: NO tocar la tabla ni el cache. Solo mostrar detalle.
    const fromCache = proyectosCache.find(p => p.id === Number(id));
    if (fromCache) {
      setDetalle(fromCache);
      return;
    }
    try{
      const r = await fetch(`${API_BASE}/${encodeURIComponent(id)}`);
      if (!r.ok) return;
      const p = await r.json();
      if (p?.equipoId && !equipoNombreCache.has(p.equipoId)) {
        await fetchEquipoNombre(p.equipoId);
      }
      setDetalle(p);
    }catch{ /* no-op */ }
  }

  // Eventos del picker
  $buscar.addEventListener('input', (e)=>{
    const q = e.target.value || '';
    acFetchDebounced(q);
  });

  $buscar.addEventListener('keydown', (e)=>{
    if (!acState.open) return;
    if (e.key === 'ArrowDown') { e.preventDefault(); acHighlight(acState.index + 1); }
    else if (e.key === 'ArrowUp') { e.preventDefault(); acHighlight(acState.index - 1); }
    else if (e.key === 'Enter') {
      if (acState.index >= 0 && acState.index < acState.items.length) {
        const chosen = acState.items[acState.index];
        $buscar.value = chosen?.nombreProyecto || $buscar.value;
        acClose();
        acChooseById(chosen?.id);
      }
    } else if (e.key === 'Escape') {
      acClose();
    }
  });

  $acList.addEventListener('click', (e)=>{
    const li = e.target.closest('.ac-item[data-id]');
    if (!li) return;
    const id = Number(li.dataset.id);
    const it = acState.items.find(x => x.id === id);
    if (it) $buscar.value = it.nombreProyecto || $buscar.value;
    acClose();
    acChooseById(id);
  });

  document.addEventListener('click', (e)=>{
    if (!acState.open) return;
    if (e.target === $buscar) return;
    if (e.target.closest('.ac-wrap')) return;
    acClose();
  });
</script>

</body>
</html>

