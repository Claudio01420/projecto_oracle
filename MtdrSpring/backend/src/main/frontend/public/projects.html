<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Proyectos</title>
  <link rel="stylesheet" href="Css/projects.css"/>
  <style>
    .modal-overlay { position: fixed; inset: 0; background: rgba(0, 0, 0, 0.4); display: none; justify-content: center; align-items: center; z-index: 999; }
    .modal { background: #fff; border-radius: 18px; padding: 20px 26px; width: 480px; max-width: 95%; box-shadow: 0 8px 32px rgba(0,0,0,.25); animation: fadeIn .2s ease-in-out; }
    @keyframes fadeIn { from{opacity:0; transform: translateY(-10px);} to{opacity:1; transform: translateY(0);} }
    .modal-buttons { display:flex; gap:10px; margin-top:14px; justify-content:flex-end }
    .chip.active { background: var(--brand); color:#fff; font-weight:700; box-shadow: 0 2px 8px rgba(225,38,28,.25); }

    /* Panel de tareas del proyecto */
    .tasks-box { margin-top:14px; border:1px solid var(--line); border-radius:12px; padding:12px; background:#fafbfc; }
    .tasks-box h3 { margin:4px 0 10px 0; font-size:15px; }
    .task-item { border:1px solid var(--line); background:#fff; border-radius:10px; padding:8px 10px; margin:6px 0; display:flex; justify-content:space-between; gap:10px; }
    .task-title { font-weight:700; }
    .task-meta { font-size:12px; color:#64748b; }
    .badge { font-size:12px; border:1px solid var(--line); padding:2px 8px; border-radius:999px; background:#fff; }
    .badge.status.todo{ background:#fff4f3 }
    .badge.status.doing{ background:#fff8e6 }
    .badge.status.done{ background:#e9fff0 }
  </style>
</head>
<body>

  <!-- Topbar -->
  <header class="topbar">
    <div class="brand">
      <img src="image/Oracle_logo.png" alt="Oracle Logo" style="max-width:160px; height:auto;" />
    </div>
    <div class="topbar-right">
      <div class="user-circle" id="user-initial">U</div>
      <a href="/logout" class="logout-btn">‚èª Salir</a>
    </div>
  </header>

  <div class="app">
    <!-- Sidebar -->
    <aside class="aside">
      <nav class="menu">
        <a class="mi" href="/dashboard.html"><span>üìä</span> Dashboard</a>
        <a class="mi active" href="#"><span>üìÅ</span> Proyectos</a>
        <a class="mi" href="/tarea.html"><span>‚úÖ</span> Tareas</a>
        <a class="mi" href="/KPIs.html"><span>üìà</span> KPIs</a>
        <a class="mi" href="/chatbot.html"><span>ü§ñ</span> Chatbot</a>
        <a class="mi" href="/notifications.html"><span>üîî</span> Notificaciones</a>
        <a class="mi" href="/settings.html"><span>‚öôÔ∏è</span> Ajustes</a>
      </nav>
    </aside>

    <!-- Main -->
    <main class="main">
      <section class="card card-soft">
        <h1 class="h4">Proyectos</h1>
        <div class="toolbar">
          <div class="field">
            <label for="buscar">Buscar</label>
            <input id="buscar" type="text" placeholder="Buscar proyecto‚Ä¶">
          </div>
          <div class="field">
            <label for="filtro">Filtrar</label>
            <select id="filtro">
              <option>Todos</option>
              <option>Pendiente</option>
              <option>En curso</option>
              <option>Finalizado</option>
            </select>
          </div>
          <a class="btn btn-primary" href="#!" id="btn-nuevo">+ Nuevo</a>
        </div>
      </section>

      <div class="grid">
        <!-- Lista -->
        <section class="card">
          <div class="row-sb">
            <div class="muted small" id="resumen-lista"><strong>0</strong> resultado(s)</div>
            <div class="chips" id="chips">
              <span class="chip active" data-est="Todos">Todos</span>
              <span class="chip" data-est="Pendiente">Pendiente</span>
              <span class="chip" data-est="En curso">En curso</span>
              <span class="chip" data-est="Finalizado">Finalizado</span>
            </div>
          </div>

          <div class="table-wrap">
            <table class="table">
              <thead>
                <tr>
                  <th style="width:80px">ID</th>
                  <th style="width:90px">Equipo</th>
                  <th>Nombre</th>
                  <th style="width:130px">Estado</th>
                  <th style="width:200px">Avance</th>
                  <th style="width:140px">Acciones</th>
                </tr>
              </thead>
              <tbody id="projects-body"></tbody>
            </table>
          </div>
        </section>

        <!-- Detalle -->
        <aside class="card">
          <h2 class="h6">Detalle del Proyecto</h2>
          <div class="detail" id="detalle-proyecto">
            <div class="muted">Selecciona un proyecto para ver el detalle.</div>
            <hr class="sep">
            <div class="detail-item"><div class="label">Nombre</div><div class="value" id="d-nombre">‚Äî</div></div>
            <div class="detail-item"><div class="label">Descripci√≥n</div><div class="value" id="d-descripcion">‚Äî</div></div>
            <div class="detail-item"><div class="label">Equipo</div><div class="value" id="d-equipo">‚Äî</div></div>
            <div class="detail-item"><div class="label">Inicio</div><div class="value" id="d-inicio">‚Äî</div></div>
            <div class="detail-item"><div class="label">Fin</div><div class="value" id="d-fin">‚Äî</div></div>
            <div class="detail-item"><div class="label">Estado</div><div class="value" id="d-estado"><span class="chip">‚Äî</span></div></div>
            <div class="detail-item"><div class="label">Avance</div><div class="value"><div class="progress"><span id="d-avance" style="width:0%"></span></div></div></div>

            <!-- Recuadro de tareas del proyecto -->
            <div class="tasks-box" id="tasks-box" style="display:none;">
              <h3>Tareas de este proyecto</h3>
              <div id="tasks-list"></div>
              <div class="muted small" id="tasks-count"></div>
            </div>
          </div>
        </aside>
      </div>
    </main>
  </div>

  <!-- Modal (+ Nuevo) -->
  <div class="modal-overlay" id="modal-overlay">
    <div class="modal">
      <h2>Nuevo Proyecto</h2>
      <div class="field"><label>Nombre</label><input id="f-nombre" type="text" placeholder="Ej. Reto Oracle Cloud"></div>
      <div class="field"><label>Descripci√≥n</label><input id="f-desc" type="text" placeholder="Breve descripci√≥n"></div>
      <div class="field"><label>Equipo ID</label><input id="f-equipo" type="number" min="1" placeholder="Ej. 1"></div>
      <div class="field"><label>Fecha inicio</label><input id="f-inicio" type="date"></div>
      <div class="field"><label>Fecha fin</label><input id="f-fin" type="date"></div>
      <div class="modal-buttons">
        <button class="btn btn-outline" id="btn-cancelar">Cancelar</button>
        <button class="btn btn-primary" id="btn-guardar">Guardar</button>
      </div>
    </div>
  </div>

  <div id="confirm-root"></div>

  <script>
    // ===== Sesi√≥n
    const user = JSON.parse(localStorage.getItem("user") || "null");
    const currentUserId = user?.id || null;
    const currentUserEmail = user?.email || "";
    const $userInitial = document.getElementById("user-initial");
    if (user?.nombre) $userInitial.textContent = (user.nombre.trim()[0] || "U").toUpperCase();

    // ===== DOM
    const $tbody = document.getElementById("projects-body");
    const $buscar = document.getElementById("buscar");
    const $filtro = document.getElementById("filtro");
    const $resumen = document.getElementById("resumen-lista");
    const $chips = document.getElementById("chips");
    const $confirmRoot = document.getElementById("confirm-root");

    // Detalle
    const $dNombre = document.getElementById("d-nombre");
    const $dDesc = document.getElementById("d-descripcion");
    const $dEquipo = document.getElementById("d-equipo");
    const $dIni = document.getElementById("d-inicio");
    const $dFin = document.getElementById("d-fin");
    const $dEstado = document.getElementById("d-estado");
    const $dAvance = document.getElementById("d-avance");

    // Tareas del proyecto
    const $tasksBox = document.getElementById("tasks-box");
    const $tasksList = document.getElementById("tasks-list");
    const $tasksCount = document.getElementById("tasks-count");

    // Modal
    const $modalOverlay = document.getElementById("modal-overlay");
    const $btnNuevo = document.getElementById("btn-nuevo");
    const $btnGuardar = document.getElementById("btn-guardar");
    const $btnCancel = document.getElementById("btn-cancelar");

    // Form
    const $fNombre = document.getElementById("f-nombre");
    const $fDesc = document.getElementById("f-desc");
    const $fEquipo = document.getElementById("f-equipo");
    const $fInicio = document.getElementById("f-inicio");
    const $fFin = document.getElementById("f-fin");

    // API
    const API_BASE = "http://localhost:8080/proyectos";
    const API_MY = currentUserId ? `${API_BASE}/mios/${currentUserId}` : API_BASE;

    let proyectosCache = [];

    function estadoToChipClass(estado) {
      if (!estado) return "chip";
      switch ((estado || "").toLowerCase()) {
        case "pendiente": return "chip state-pend";
        case "en curso": return "chip state-run";
        case "finalizado": return "chip state-done";
        default: return "chip";
      }
    }
    function estadoToAvance(estado) {
      switch ((estado || "").toLowerCase()) {
        case "pendiente": return 0;
        case "en curso": return 50;
        case "finalizado": return 100;
        default: return 0;
      }
    }
    function formatFecha(iso) {
      if (!iso) return "‚Äî";
      const d = new Date(iso);
      return isNaN(d.getTime()) ? "‚Äî" : d.toLocaleDateString();
    }

    function setDetalle(p) {
      if (!p) return;
      $dNombre.textContent = p.nombreProyecto ?? "‚Äî";
      $dDesc.textContent   = p.descripcion ?? "‚Äî";
      $dEquipo.textContent = (p.equipoId ?? "‚Äî");
      $dIni.textContent    = formatFecha(p.fechaInicio);
      $dFin.textContent    = formatFecha(p.fechaFin);
      $dEstado.innerHTML   = `<span class="${estadoToChipClass(p.estado)}">${p.estado ?? "‚Äî"}</span>`;
      $dAvance.style.width = estadoToAvance(p.estado) + "%";

      // cargar tareas del proyecto
      loadProjectTasks(p.id);
    }

    async function loadProjectTasks(projectId){
      $tasksBox.style.display = "block";
      $tasksList.innerHTML = `<div class="muted">Cargando tareas‚Ä¶</div>`;
      $tasksCount.textContent = '';

      try {
        const res = await fetch(`/api/tasks?projectId=${encodeURIComponent(projectId)}`, {
          headers: { 'X-User-Email': currentUserEmail }
        });
        if (!res.ok) {
          $tasksList.innerHTML = `<div class="muted">No se pudieron cargar las tareas.</div>`;
          return;
        }
        const tasks = await res.json();
        if (!tasks.length) {
          $tasksList.innerHTML = `<div class="muted">Este proyecto no tiene tareas.</div>`;
          $tasksCount.textContent = `0 tareas`;
          return;
        }
        $tasksList.innerHTML = tasks.map(t => `
          <div class="task-item">
            <div>
              <div class="task-title">${escapeHtml(t.title || '')}</div>
              <div class="task-meta">Prio: ${escapeHtml(t.priority||'')} ¬∑ Est: ${t.estimatedHours??'-'}h ${t.realHours?(' ¬∑ Real: '+t.realHours+'h'):''}</div>
            </div>
            <div><span class="badge status ${escapeHtml((t.status||'todo').toLowerCase())}">${escapeHtml((t.status||'todo'))}</span></div>
          </div>
        `).join('');
        $tasksCount.textContent = `${tasks.length} tarea(s)`;
      } catch {
        $tasksList.innerHTML = `<div class="muted">Error de red.</div>`;
      }
    }

    function escapeHtml(s){ return String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])) }

    function renderTabla(items) {
      if (!items.length) {
        $tbody.innerHTML = `<tr><td colspan="6">No hay proyectos.</td></tr>`;
        $resumen.innerHTML = `<strong>0</strong> resultado(s)`;
        return;
      }
      $resumen.innerHTML = `<strong>${items.length}</strong> resultado(s)`;
      $tbody.innerHTML = items.map(p => `
        <tr data-id="${p.id}">
          <td>${p.id ?? "-"}</td>
          <td>${p.equipoId ?? "-"}</td>
          <td>${p.nombreProyecto ?? "-"}</td>
          <td><span class="${estadoToChipClass(p.estado)}">${p.estado ?? "‚Äî"}</span></td>
          <td><div class="progress"><span style="width:${estadoToAvance(p.estado)}%"></span></div></td>
          <td>
            <button class="btn-danger btn-xs" onclick="borrarProyecto(${p.id}, event)" title="Borrar proyecto">Borrar</button>
          </td>
        </tr>
      `).join("");

      Array.from($tbody.querySelectorAll("tr")).forEach(tr => {
        tr.addEventListener("click", () => {
          const id = Number(tr.dataset.id);
          const p = proyectosCache.find(x => x.id === id);
          setDetalle(p);
        });
      });
    }

    async function cargarProyectos() {
      try {
        if (!currentUserId) {
          $tbody.innerHTML = `<tr><td colspan="6">Inicia sesi√≥n para ver tus proyectos.</td></tr>`;
          return;
        }
        const res = await fetch(API_MY);
        proyectosCache = await res.json();
        aplicarFiltros();
        if (proyectosCache[0]) setDetalle(proyectosCache[0]);
      } catch {
        $tbody.innerHTML = `<tr><td colspan="6">Error al cargar proyectos</td></tr>`;
      }
    }

    // Confirmaci√≥n ‚Äúbonita‚Äù
    function mostrarConfirmacion(mensaje, onYes) {
      const overlay = document.createElement("div");
      overlay.className = "confirm-overlay";
      overlay.innerHTML = `
        <div class="confirm-box">
          <h3>Confirmar acci√≥n</h3>
          <p>${mensaje}</p>
          <div class="confirm-buttons">
            <button class="confirm-btn confirm-cancel">Cancelar</button>
            <button class="confirm-btn confirm-yes">S√≠, borrar</button>
          </div>
        </div>
      `;
      $confirmRoot.appendChild(overlay);
      const close = () => overlay.remove();
      overlay.querySelector(".confirm-cancel").onclick = close;
      overlay.querySelector(".confirm-yes").onclick = () => { close(); onYes(); };
      overlay.addEventListener("click", (e) => { if (e.target === overlay) close(); });
      document.addEventListener("keydown", function esc(e){ if(e.key === "Escape"){ close(); document.removeEventListener("keydown", esc); }});
    }

    async function borrarProyecto(id, evt) {
      if (evt) evt.stopPropagation();
      mostrarConfirmacion("¬øSeguro que deseas borrar este proyecto?", async () => {
        await fetch(`${API_BASE}/${id}`, { method: "DELETE" });
        proyectosCache = proyectosCache.filter(p => p.id !== id);
        aplicarFiltros();
        $tasksBox.style.display = "none";
      });
    }
    window.borrarProyecto = borrarProyecto;

    async function crearProyecto() {
      if (!currentUserId) { alert("No hay usuario logueado. Inicia sesi√≥n primero."); return; }
      const nuevo = {
        nombreProyecto: $fNombre.value.trim(),
        descripcion: $fDesc.value.trim(),
        estado: "Pendiente",
        equipoId: Number($fEquipo.value),
        fechaInicio: $fInicio.value || null,
        fechaFin: $fFin.value || null,
        creadorId: currentUserId
      };
      const res = await fetch(API_BASE, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "X-User-Id": String(currentUserId)
        },
        body: JSON.stringify(nuevo)
      });
      if (res.ok) {
        const creado = await res.json();
        proyectosCache.push(creado);
        cerrarModal();
        aplicarFiltros();
      } else alert("Error al crear el proyecto.");
    }

    function aplicarFiltros() {
      const q = ($buscar.value || "").toLowerCase();
      const estSel = ($filtro.value || "Todos").toLowerCase();
      const chipActivo = (document.querySelector(".chip.active")?.dataset.est || "Todos").toLowerCase();

      let items = proyectosCache.filter(p =>
        (!q || (p.nombreProyecto || "").toLowerCase().includes(q)) &&
        (
          estSel === "todos" && chipActivo === "todos"
            ? true
            : (p.estado || "").toLowerCase() === estSel || (p.estado || "").toLowerCase() === chipActivo
        )
      );
      if (chipActivo !== "todos") items = items.filter(p => (p.estado || "").toLowerCase() === chipActivo);
      renderTabla(items);
    }

    // Chips
    $chips.querySelectorAll(".chip").forEach(chip => {
      chip.addEventListener("click", () => {
        $chips.querySelectorAll(".chip").forEach(c => c.classList.remove("active"));
        chip.classList.add("active");
        aplicarFiltros();
      });
    });

    // Modal
    function abrirModal() { $modalOverlay.style.display = "flex"; }
    function cerrarModal() {
      $modalOverlay.style.display = "none";
      $fNombre.value = ""; $fDesc.value = ""; $fEquipo.value = "";
      $fInicio.value = ""; $fFin.value = "";
    }
    $btnNuevo.addEventListener("click", e => { e.preventDefault(); abrirModal(); });
    $btnCancel.addEventListener("click", e => { e.preventDefault(); cerrarModal(); });
    $btnGuardar.addEventListener("click", e => { e.preventDefault(); crearProyecto(); });
    $modalOverlay.addEventListener("click", e => { if (e.target === $modalOverlay) cerrarModal(); });

    // B√∫squeda / select
    $buscar.addEventListener("input", aplicarFiltros);
    $filtro.addEventListener("change", aplicarFiltros);

    // Init
    document.addEventListener("DOMContentLoaded", cargarProyectos);
  </script>
</body>
</html>
