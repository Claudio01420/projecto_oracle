<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Proyectos</title>
  <link rel="stylesheet" href="Css/projects.css"/>
  <style>
    .modal-overlay { position: fixed; inset: 0; background: rgba(0, 0, 0, 0.4); display: none; justify-content: center; align-items: center; z-index: 999; }
    .modal { background: #fff; border-radius: 18px; padding: 20px 26px; width: 480px; max-width: 95%; box-shadow: 0 8px 32px rgba(0,0,0,.25); animation: fadeIn .2s ease-in-out; }
    @keyframes fadeIn { from{opacity:0; transform: translateY(-10px);} to{opacity:1; transform: translateY(0);} }
    .modal-buttons { display:flex; gap:10px; margin-top:14px; justify-content:flex-end }
    .chip.active { background: var(--brand); color:#fff; font-weight:700; box-shadow: 0 2px 8px rgba(225,38,28,.25); }

    .tasks-box { margin-top:14px; border:1px solid var(--line); border-radius:12px; padding:12px; background:#fafbfc; }
    .tasks-box h3 { margin:4px 0 10px 0; font-size:15px; }
    .task-item { border:1px solid var(--line); background:#fff; border-radius:10px; padding:8px 10px; margin:6px 0; display:flex; justify-content:space-between; gap:10px; }
    .task-title { font-weight:700; }
    .task-meta { font-size:12px; color:#64748b; }
    .badge { font-size:12px; border:1px solid var(--line); padding:2px 8px; border-radius:999px; background:#fff; }
    .badge.status.todo{ background:#fff4f3 }
    .badge.status.doing{ background:#fff8e6 }
    .badge.status.done{ background:#e9fff0 }

    .detail-head { display:flex; align-items:center; justify-content:space-between; gap:12px; padding:10px 12px; border-radius:12px; background: linear-gradient(180deg,#ffffff 0%,#fafbfc 100%); border:1px solid var(--line); margin-bottom:10px; }
    .detail-head .title { font-weight:900; font-size:16px; }
    .detail-actions { display:flex; gap:8px; align-items:center }

    .btn-ghost { display:inline-flex; align-items:center; gap:8px; padding:9px 12px; border-radius:12px; background:#fff; color:var(--dark); border:1px solid var(--line-2); font-weight:800; font-size:13px; text-decoration:none; cursor:pointer; box-shadow: var(--shadow-sm); transition: transform .08s ease, box-shadow .2s ease, border-color .2s ease, background .15s ease; }
    .btn-ghost:hover { transform: translateY(-1px); box-shadow: var(--shadow-md); border-color:#d9dde3; }
    .btn-ghost:active { transform: translateY(0); box-shadow: var(--shadow-sm); }
    .btn-ghost[disabled] { opacity:.5; pointer-events:none }
    .btn-ghost .ico { width:16px; height:16px; display:inline-block; }

    .table tbody tr { cursor: pointer; }
  </style>
</head>
<body>

  <header class="topbar">
    <div class="brand">
      <img src="image/Oracle_logo.png" alt="Oracle Logo" style="max-width:160px; height:auto;" />
    </div>
    <div class="topbar-right">
      <div class="user-circle" id="user-initial">U</div>
      <a href="/logout" class="logout-btn">‚èª Salir</a>
    </div>
  </header>

  <div class="app">
    <aside class="aside">
      <nav class="menu">
        <a class="mi" href="/dashboard.html"><span>üìä</span> Dashboard</a>
        <a class="mi active" href="#"><span>üìÅ</span> Proyectos</a>
        <a class="mi" href="/tarea.html"><span>‚úÖ</span> Tareas</a>
        <a class="mi" href="/KPIs.html"><span>üìà</span> KPIs</a>
        <a class="mi" href="/chatbot.html"><span>ü§ñ</span> Chatbot</a>
        <a class="mi" href="/notifications.html"><span>üîî</span> Notificaciones</a>
        <a class="mi" href="/settings.html"><span>‚öôÔ∏è</span> Ajustes</a>
      </nav>
    </aside>

    <main class="main">
      <section class="card card-soft">
        <h1 class="h4">Proyectos</h1>
        <div class="toolbar">
          <div class="field">
            <label for="buscar">Buscar</label>
            <input id="buscar" type="text" placeholder="Buscar proyecto‚Ä¶">
          </div>
          <div class="field">
            <label for="filtro">Filtrar</label>
            <select id="filtro">
              <option>Todos</option>
              <option>Pendiente</option>
              <option>En curso</option>
              <option>Finalizado</option>
            </select>
          </div>
          <a class="btn btn-primary" href="#!" id="btn-nuevo">+ Nuevo</a>
        </div>
      </section>

      <div class="grid">
        <section class="card">
          <div class="row-sb">
            <div class="muted small" id="resumen-lista"><strong>0</strong> resultado(s)</div>
            <div class="chips" id="chips">
              <span class="chip active" data-est="Todos">Todos</span>
              <span class="chip" data-est="Pendiente">Pendiente</span>
              <span class="chip" data-est="En curso">En curso</span>
              <span class="chip" data-est="Finalizado">Finalizado</span>
            </div>
          </div>

          <div class="table-wrap">
            <table class="table">
              <thead>
                <tr>
                  <th style="width:80px">ID</th>
                  <th style="width:90px">Equipo</th>
                  <th>Nombre</th>
                  <th style="width:130px">Estado</th>
                  <th style="width:200px">Avance</th>
                  <th style="width:140px">Acciones</th>
                </tr>
              </thead>
              <tbody id="projects-body"></tbody>
            </table>
          </div>
        </section>

        <aside class="card">
          <div class="detail-head">
            <div class="title">Detalle del Proyecto</div>
            <div class="detail-actions">
              <button id="btn-ir-homework" class="btn-ghost" disabled>
                <svg class="ico" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                  <path d="M5 12h14M13 5l7 7-7 7" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
                Ir a tareas (homework)
              </button>
            </div>
          </div>

          <div class="detail" id="detalle-proyecto">
            <div class="muted">Selecciona un proyecto para ver el detalle.</div>
            <hr class="sep">
            <div class="detail-item"><div class="label">Nombre</div><div class="value" id="d-nombre">‚Äî</div></div>
            <div class="detail-item"><div class="label">Descripci√≥n</div><div class="value" id="d-descripcion">‚Äî</div></div>
            <div class="detail-item"><div class="label">Equipo</div><div class="value" id="d-equipo">‚Äî</div></div>
            <div class="detail-item"><div class="label">Inicio</div><div class="value" id="d-inicio">‚Äî</div></div>
            <div class="detail-item"><div class="label">Fin</div><div class="value" id="d-fin">‚Äî</div></div>
            <div class="detail-item"><div class="label">Estado</div><div class="value" id="d-estado"><span class="chip">‚Äî</span></div></div>
            <div class="detail-item"><div class="label">Avance</div><div class="value"><div class="progress"><span id="d-avance" style="width:0%"></span></div></div></div>

            <div class="tasks-box" id="tasks-box" style="display:none;">
              <h3>Tareas de este proyecto</h3>
              <div id="tasks-list"></div>
              <div class="muted small" id="tasks-count"></div>
            </div>
          </div>
        </aside>
      </div>
    </main>
  </div>

  <div class="modal-overlay" id="modal-overlay">
    <div class="modal">
      <h2>Nuevo Proyecto</h2>
      <div class="field"><label>Nombre</label><input id="f-nombre" type="text" placeholder="Ej. Reto Oracle Cloud"></div>
      <div class="field"><label>Descripci√≥n</label><input id="f-desc" type="text" placeholder="Breve descripci√≥n"></div>
      <div class="field"><label>Equipo ID</label><input id="f-equipo" type="number" min="1" placeholder="Ej. 1"></div>
      <div class="field"><label>Fecha inicio</label><input id="f-inicio" type="date"></div>
      <div class="field"><label>Fecha fin</label><input id="f-fin" type="date"></div>
      <div class="modal-buttons">
        <button class="btn btn-outline" id="btn-cancelar">Cancelar</button>
        <button class="btn btn-primary" id="btn-guardar">Guardar</button>
      </div>
    </div>
  </div>

  <div id="confirm-root"></div>

  <script>
    // ===== Sesi√≥n
    const user = JSON.parse(localStorage.getItem("user") || "null");
    const currentUserId = user?.id || null;
    const currentUserEmail = user?.email || "";
    const $userInitial = document.getElementById("user-initial");
    if (user?.nombre) $userInitial.textContent = (user.nombre.trim()[0] || "U").toUpperCase();

    // ===== DOM
    const $tbody = document.getElementById("projects-body");
    const $buscar = document.getElementById("buscar");
    const $filtro = document.getElementById("filtro");
    const $resumen = document.getElementById("resumen-lista");
    const $chips = document.getElementById("chips");
    const $confirmRoot = document.getElementById("confirm-root");

    // Detalle
    const $dNombre = document.getElementById("d-nombre");
    const $dDesc   = document.getElementById("d-descripcion");
    const $dEquipo = document.getElementById("d-equipo");
    const $dIni    = document.getElementById("d-inicio");
    const $dFin    = document.getElementById("d-fin");
    const $dEstado = document.getElementById("d-estado");
    const $dAvance = document.getElementById("d-avance");
    const $btnIrHomework = document.getElementById("btn-ir-homework");

    // Tareas del proyecto (panel detalle)
    const $tasksBox   = document.getElementById("tasks-box");
    const $tasksList  = document.getElementById("tasks-list");
    const $tasksCount = document.getElementById("tasks-count");

    // Modal
    const $modalOverlay = document.getElementById("modal-overlay");
    const $btnNuevo  = document.getElementById("btn-nuevo");
    const $btnGuardar= document.getElementById("btn-guardar");
    const $btnCancel = document.getElementById("btn-cancelar");

    // Form
    const $fNombre = document.getElementById("f-nombre");
    const $fDesc   = document.getElementById("f-desc");
    const $fEquipo = document.getElementById("f-equipo");
    const $fInicio = document.getElementById("f-inicio");
    const $fFin    = document.getElementById("f-fin");

    // API
    const API_BASE = "http://localhost:8080/proyectos";
    const API_MY   = currentUserId ? `${API_BASE}/mios/${currentUserId}` : API_BASE;
    const TASKS_API = "/api/tasks";

    let proyectosCache = [];
    let selectedProjectId = null;

    /* üîÅ Navegar a /homework-proyect.html */
    function goToHomework(id){
      if (!id) return;
      const url = `${window.location.origin}/homework-proyect.html?id=${encodeURIComponent(id)}`;
      window.location.href = url;
    }

    function estadoToChipClass(estado) {
      if (!estado) return "chip";
      switch ((estado || "").toLowerCase()) {
        case "pendiente":  return "chip state-pend";
        case "en curso":   return "chip state-run";
        case "finalizado": return "chip state-done";
        default:           return "chip";
      }
    }
    function estadoToAvance(estado) {
      switch ((estado || "").toLowerCase()) {
        case "pendiente":  return 0;
        case "en curso":   return 50;
        case "finalizado": return 100;
        default:           return 0;
      }
    }
    function formatFecha(iso) {
      if (!iso) return "‚Äî";
      const d = new Date(iso);
      return isNaN(d.getTime()) ? "‚Äî" : d.toLocaleDateString();
    }

    /* ========= PROGRESO REAL POR TAREAS ========= */
    async function fetchTasksForProject(projectId){
      try{
        const res = await fetch(`${TASKS_API}?projectId=${encodeURIComponent(projectId)}`, {
          headers: { "X-User-Email": currentUserEmail }
        });
        if (!res.ok) return [];
        return await res.json();
      }catch{ return []; }
    }
    function calcProgressFromTasks(tasks){
      const total = tasks.length;
      const done = tasks.filter(t => (t.status||"").toLowerCase()==="done" || t.completedAt != null).length;
      const pct = total === 0 ? 0 : Math.round((done/total)*100);
      return { total, done, pct };
    }

    // === NUEVO: persistir estado del proyecto seg√∫n % ===
    async function persistProjectEstadoFromPct(p, pct){
      if (!p || !p.id) return;
      const nuevo = (pct===0) ? "Pendiente" : (pct===100 ? "Finalizado" : "En curso");
      if (p.estado === nuevo) return; // nada que guardar

      const payload = {
        id: p.id,
        nombreProyecto: p.nombreProyecto,
        descripcion: p.descripcion,
        estado: nuevo,
        equipoId: p.equipoId,
        fechaInicio: p.fechaInicio || null,
        fechaFin: p.fechaFin || null,
        ultimoAcceso: p.ultimoAcceso || null
      };
      try{
        const res = await fetch(`${API_BASE}/${p.id}`, {
          method:"PUT",
          headers:{ "Content-Type":"application/json" },
          body: JSON.stringify(payload)
        });
        if (res.ok){
          const updated = await res.json();
          p.estado = updated.estado;
        }
      }catch(e){
        // Silencioso: si falla, solo no se actualizar√° el filtro hasta el pr√≥ximo intento
      }
    }

    // Actualiza la barra de la tabla para un proyecto (vista)
    function updateRowProgress(projectId, pct){
      const row = $tbody.querySelector(`tr[data-id="${projectId}"]`);
      if (!row) return;
      const bar = row.querySelector(".progress > span");
      if (bar) bar.style.width = `${pct}%`;
      const estCell = row.querySelector("td:nth-child(4) .chip");
      if (estCell){
        let nuevo = pct===0 ? "Pendiente" : (pct===100 ? "Finalizado" : "En curso");
        estCell.textContent = nuevo;
        estCell.className = estadoToChipClass(nuevo);
      }
    }

    // Recalcula progreso para TODOS y actualiza tabla + PERSISTE estado
    async function refreshProgressForAllProjects(){
      const promises = proyectosCache.map(async (p) => {
        const tasks = await fetchTasksForProject(p.id);
        const { pct } = calcProgressFromTasks(tasks);
        p._progress = pct; // cache local
        updateRowProgress(p.id, pct);
        await persistProjectEstadoFromPct(p, pct); // << guarda en BD si cambi√≥
      });
      await Promise.all(promises);
      // Reaplicar filtros por si alg√∫n estado cambi√≥
      aplicarFiltros();
    }

    function setDetalle(p) {
      if (!p) return;
      selectedProjectId = p.id || null;
      if ($btnIrHomework) $btnIrHomework.disabled = !selectedProjectId;

      $dNombre.textContent = p.nombreProyecto ?? "‚Äî";
      $dDesc.textContent   = p.descripcion ?? "‚Äî";
      $dEquipo.textContent = (p.equipoId ?? "‚Äî");
      $dIni.textContent    = formatFecha(p.fechaInicio);
      $dFin.textContent    = formatFecha(p.fechaFin);

      $dEstado.innerHTML   = `<span class="${estadoToChipClass(p.estado)}">${p.estado ?? "‚Äî"}</span>`;
      $dAvance.style.width = (typeof p._progress === "number" ? p._progress : estadoToAvance(p.estado)) + "%";

      // Cargar tareas y actualizar progreso/estado real (con persistencia)
      loadProjectTasksAndProgress(p.id);
    }

    if ($btnIrHomework) {
      $btnIrHomework.addEventListener("click", () => {
        if (!selectedProjectId) return;
        goToHomework(selectedProjectId);
      });
    }

    // Carga tareas del panel detalle + progreso real + PERSISTE estado
    async function loadProjectTasksAndProgress(projectId){
      $tasksBox.style.display = "block";
      $tasksList.innerHTML = `<div class="muted">Cargando tareas‚Ä¶</div>`;
      $tasksCount.textContent = '';

      const tasks = await fetchTasksForProject(projectId);

      if (!tasks.length) {
        $tasksList.innerHTML = `<div class="muted">Este proyecto no tiene tareas.</div>`;
        $tasksCount.textContent = `0 tareas`;
      } else {
        $tasksList.innerHTML = tasks.map(t => `
          <div class="task-item">
            <div>
              <div class="task-title">${escapeHtml(t.title || '')}</div>
              <div class="task-meta">Prio: ${escapeHtml(t.priority||'')} ¬∑ Est: ${t.estimatedHours??'-'}h ${t.realHours?(' ¬∑ Real: '+t.realHours+'h'):''}</div>
            </div>
            <div><span class="badge status ${escapeHtml((t.status||'todo').toLowerCase())}">${escapeHtml((t.status||'todo'))}</span></div>
          </div>
        `).join('');
        $tasksCount.textContent = `${tasks.length} tarea(s)`;
      }

      const { pct } = calcProgressFromTasks(tasks);
      $dAvance.style.width = `${pct}%`;
      const nuevoEstado = pct===0 ? "Pendiente" : (pct===100 ? "Finalizado" : "En curso");
      $dEstado.innerHTML = `<span class="${estadoToChipClass(nuevoEstado)}">${nuevoEstado}</span>`;

      updateRowProgress(projectId, pct);

      const idx = proyectosCache.findIndex(x => x.id === projectId);
      if (idx >= 0) proyectosCache[idx]._progress = pct;

      // Persistir en BD para que el filtro funcione
      if (idx >= 0) {
        await persistProjectEstadoFromPct(proyectosCache[idx], pct);
        aplicarFiltros();
      }
    }

    function escapeHtml(s){ return String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])) }

    function renderTabla(items) {
      if (!items.length) {
        $tbody.innerHTML = `<tr><td colspan="6">No hay proyectos.</td></tr>`;
        $resumen.innerHTML = `<strong>0</strong> resultado(s)`;
        return;
      }
      $resumen.innerHTML = `<strong>${items.length}</strong> resultado(s)`;
      $tbody.innerHTML = items.map(p => `
        <tr data-id="${p.id}">
          <td>${p.id ?? "-"}</td>
          <td>${p.equipoId ?? "-"}</td>
          <td>${p.nombreProyecto ?? "-"}</td>
          <td><span class="${estadoToChipClass(p.estado)}">${p.estado ?? "‚Äî"}</span></td>
          <td><div class="progress"><span style="width:${typeof p._progress==='number' ? p._progress : estadoToAvance(p.estado)}%"></span></div></td>
          <td>
            <button class="btn-danger btn-xs" onclick="borrarProyecto(${p.id}, event)" title="Borrar proyecto" onkeydown="event.stopPropagation()">Borrar</button>
          </td>
        </tr>
      `).join("");

      Array.from($tbody.querySelectorAll("tr")).forEach(tr => {
        tr.addEventListener("click", (e) => {
          if (e.target.closest('button')) return;
          const id = Number(tr.dataset.id);
          const p = proyectosCache.find(x => x.id === id);
          setDetalle(p);
        });

        tr.addEventListener("dblclick", (e) => {
          if (e.target.closest('button')) return;
          const id = Number(tr.dataset.id);
          if (id) goToHomework(id);
        });
      });
    }

    async function cargarProyectos() {
      try {
        if (!currentUserId) {
          $tbody.innerHTML = `<tr><td colspan="6">Inicia sesi√≥n para ver tus proyectos.</td></tr>`;
          return;
        }
        const res = await fetch(API_MY);
        proyectosCache = await res.json();

        // Render inicial (usa estado para ancho mientras calculamos progreso real)
        aplicarFiltros();

        // Carga progreso real por tareas para todos y actualiza tabla + BD
        await refreshProgressForAllProjects();

        // Selecciona primero si existe y pinta detalle (ya con progreso cacheado)
        if (proyectosCache[0]) setDetalle(proyectosCache[0]);

      } catch {
        $tbody.innerHTML = `<tr><td colspan="6">Error al cargar proyectos</td></tr>`;
      }
    }

    function mostrarConfirmacion(mensaje, onYes) {
      const overlay = document.createElement("div");
      overlay.className = "confirm-overlay";
      overlay.innerHTML = `
        <div class="confirm-box">
          <h3>Confirmar acci√≥n</h3>
          <p>${mensaje}</p>
          <div class="confirm-buttons">
            <button class="confirm-btn confirm-cancel">Cancelar</button>
            <button class="confirm-btn confirm-yes">S√≠, borrar</button>
          </div>
        </div>
      `;
      $confirmRoot.appendChild(overlay);
      const close = () => overlay.remove();
      overlay.querySelector(".confirm-cancel").onclick = close;
      overlay.querySelector(".confirm-yes").onclick = () => { close(); onYes(); };
      overlay.addEventListener("click", (e) => { if (e.target === overlay) close(); });
      document.addEventListener("keydown", function esc(e){ if(e.key === "Escape"){ close(); document.removeEventListener("keydown", esc); }});
    }

    async function borrarProyecto(id, evt) {
      if (evt) evt.stopPropagation();
      mostrarConfirmacion("¬øSeguro que deseas borrar este proyecto?", async () => {
        await fetch(`${API_BASE}/${id}`, { method: "DELETE" });
        proyectosCache = proyectosCache.filter(p => p.id !== id);
        aplicarFiltros();
        $tasksBox.style.display = "none";
        selectedProjectId = null;
        if ($btnIrHomework) $btnIrHomework.disabled = true;
      });
    }
    window.borrarProyecto = borrarProyecto;

    async function crearProyecto() {
      if (!currentUserId) { alert("No hay usuario logueado. Inicia sesi√≥n primero."); return; }
      const nuevo = {
        nombreProyecto: $fNombre.value.trim(),
        descripcion: $fDesc.value.trim(),
        estado: "Pendiente",
        equipoId: Number($fEquipo.value),
        fechaInicio: $fInicio.value || null,
        fechaFin: $fFin.value || null,
        creadorId: currentUserId
      };
      const res = await fetch(API_BASE, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "X-User-Id": String(currentUserId)
        },
        body: JSON.stringify(nuevo)
      });
      if (res.ok) {
        const creado = await res.json();
        proyectosCache.push(creado);
        cerrarModal();
        aplicarFiltros();
        updateRowProgress(creado.id, 0);
      } else alert("Error al crear el proyecto.");
    }

    function aplicarFiltros() {
      const q = ($buscar.value || "").toLowerCase();
      const estSel = ($filtro.value || "Todos").toLowerCase();
      const chipActivo = (document.querySelector(".chip.active")?.dataset.est || "Todos").toLowerCase();

      let items = proyectosCache.filter(p =>
        (!q || (p.nombreProyecto || "").toLowerCase().includes(q)) &&
        (
          estSel === "todos" && chipActivo === "todos"
            ? true
            : (p.estado || "").toLowerCase() === estSel || (p.estado || "").toLowerCase() === chipActivo
        )
      );
      if (chipActivo !== "todos") items = items.filter(p => (p.estado || "").toLowerCase() === chipActivo);
      renderTabla(items);
    }

    // Chips
    $chips.querySelectorAll(".chip").forEach(chip => {
      chip.addEventListener("click", () => {
        $chips.querySelectorAll(".chip").forEach(c => c.classList.remove("active"));
        chip.classList.add("active");
        aplicarFiltros();
      });
    });

    // Modal
    function abrirModal() { $modalOverlay.style.display = "flex"; }
    function cerrarModal() {
      $modalOverlay.style.display = "none";
      $fNombre.value = ""; $fDesc.value = ""; $fEquipo.value = "";
      $fInicio.value = ""; $fFin.value = "";
    }
    $btnNuevo.addEventListener("click", e => { e.preventDefault(); abrirModal(); });
    $btnCancel.addEventListener("click", e => { e.preventDefault(); cerrarModal(); });
    $btnGuardar.addEventListener("click", e => { e.preventDefault(); crearProyecto(); });
    $modalOverlay.addEventListener("click", e => { if (e.target === $modalOverlay) cerrarModal(); });

    $buscar.addEventListener("input", aplicarFiltros);
    $filtro.addEventListener("change", aplicarFiltros);

    document.addEventListener("DOMContentLoaded", cargarProyectos);
  </script>
</body>
</html>
