<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Proyectos</title>
  <link rel="stylesheet" href="Css/projects.css"/>
  <link href="https://api.fontshare.com/v2/css?f[]=panchang@500,600,700,800,900&display=swap" rel="stylesheet">

  <!-- Sprite de Ã­conos -->
  <svg xmlns="http://www.w3.org/2000/svg" style="display:none">
    <symbol id="i-dashboard" viewBox="0 0 24 24" fill="none" stroke="currentColor">
      <path stroke-width="1.6" d="M3 3h8v8H3zM13 3h8v5h-8zM13 10h8v11h-8zM3 13h8v8H3z"/>
    </symbol>
    <symbol id="i-users" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round">
      <path d="M17 21v-2a4 4 0 0 0-3-3.87"/>
      <path d="M7 21v-2a4 4 0 0 1 3-3.87"/>
      <circle cx="12" cy="7" r="4"/>
      <path d="M5.5 8a3.5 3.5 0 1 0 0 7"/>
      <path d="M18.5 8a3.5 3.5 0 1 1 0 7"/>
    </symbol>
    <symbol id="i-folder" viewBox="0 0 24 24" fill="none" stroke="currentColor">
      <path stroke-width="1.6" d="M3 7h6l2 2h10v9a3 3 0 0 1-3 3H6a3 3 0 0 1-3-3z"/>
    </symbol>
    <symbol id="i-board" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <rect width="8" height="4" x="8" y="2" rx="1" ry="1"/>
      <path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"/>
      <path d="M12 11h4"/><path d="M12 16h4"/>
      <path d="M8 11h.01"/><path d="M8 16h.01"/>
    </symbol>
    <symbol id="i-chart" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round">
      <path d="M12 16v5"/>
      <path d="M16 14v7"/>
      <path d="M20 10v11"/>
      <path d="m22 3-8.646 8.646a.5.5 0 0 1-.708 0L9.354 8.354a.5.5 0 0 0-.707 0L2 15"/>
      <path d="M4 18v3"/>
      <path d="M8 14v7"/>
    </symbol>
    <symbol id="i-bell" viewBox="0 0 24 24" fill="none" stroke="currentColor">
      <path stroke-width="1.6" d="M18 8a6 6 0 1 0-12 0c0 7-3 7-3 7h18s-3 0-3-7"/>
      <path stroke-width="1.6" d="M13.73 21a2 2 0 0 1-3.46 0"/>
    </symbol>
    <symbol id="i-gear" viewBox="0 0 24 24" fill="none" stroke="currentColor">
      <circle cx="12" cy="12" r="3" />
      <path stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round" d="M9.671 4.136a2.34 2.34 0 0 1 4.659 0 2.34 2.34 0 0 0 3.319 1.915 2.34 2.34 0 0 1 2.33 4.033 2.34 2.34 0 0 0 0 3.831 2.34 2.34 0 0 1-2.33 4.033 2.34 2.34 0 0 0-3.319 1.915 2.34 2.34 0 0 1-4.659 0 2.34 2.34 0 0 0-3.32-1.915 2.34 2.34 0 0 1-2.33-4.033 2.34 2.34 0 0 0 0-3.831A2.34 2.34 0 0 1 6.35 6.051a2.34 2.34 0 0 0 3.319-1.915" />
    </symbol>
    <symbol id="i-exit" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <path d="m16 17 5-5-5-5"/>
      <path d="M21 12H9"/>
      <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/>
    </symbol>
  </svg>

</head>

<body>
  <!-- TOPBAR -->
  <header class="topbar">
    <div class="brand"><h1 class="logo-text">TMDV</h1></div>
    <div class="topbar-right">
      <div class="user-circle" title="Usuario">U</div>
      <a href="/index.html" class="logout-btn">Salir</a>
    </div>
  </header>

  <div class="app">
    <!-- SIDEBAR -->
    <aside class="aside">
      <nav class="menu">
        <a class="mi" href="/dashboard.html"><svg class="ico"><use href="#i-dashboard"/></svg><span>Dashboard</span></a>
        <a class="mi" href="/Equipos.html"><svg class="ico"><use href="#i-users"/></svg><span>Equipos</span></a>
        <a class="mi active" href="#"><svg class="ico"><use href="#i-folder"/></svg><span>Proyectos</span></a>
        <a class="mi" href="/tarea.html"><svg class="ico"><use href="#i-board"/></svg><span>Mis Tareas</span></a>
        <a class="mi" href="/KPIs.html"><svg class="ico"><use href="#i-chart"/></svg><span>KPIs</span></a>
        <a class="mi" href="/notifications.html"><svg class="ico"><use href="#i-bell"/></svg><span>Notificaciones</span></a>
        <a class="mi" href="/settings.html"><svg class="ico"><use href="#i-gear"/></svg><span>Ajustes</span></a>
      </nav>
    </aside>

    <main class="main">
      <section class="card card-soft">
        <h1 class="h4">Proyectos</h1>
        <div class="toolbar">
          <!-- ðŸ”Ž Buscador con picker -->
          <div class="field search-wrap">
            <label for="buscar">Buscar</label>
            <input id="buscar" type="text" placeholder="Buscar proyectoâ€¦" autocomplete="off" />
            <!-- Panel de sugerencias -->
            <div id="ac-wrap" class="ac-wrap" aria-hidden="true">
              <div class="ac-head"><span>Coincidencias</span><span id="ac-count">0</span></div>
              <ul id="ac-list" class="ac-list"></ul>
            </div>
          </div>

          <div class="field">
            <label for="filtro">Filtrar</label>
            <select id="filtro">
              <option>Todos</option>
              <option>Pendiente</option>
              <option>En curso</option>
              <option>Finalizado</option>
            </select>
          </div>
          <button class="btn-create-sweep" id="btn-nuevo" type="button">
            <svg class="ico-sm" viewBox="0 0 24 24" aria-hidden="true">
              <path d="M12 5v14M5 12h14" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round"/>
            </svg>
            <span>Nuevo proyecto</span>
          </button>
        </div>
      </section>

      <div class="grid">
        <section class="card">
          <div class="row-sb">
            <div class="muted small" id="resumen-lista"><strong>0</strong> resultado(s)</div>

            <!-- NUEVO CONTROL ESTADOS -->
            <div class="radio-input" id="estado-toggle">
              <label>
                <input type="radio" name="estado-radio" value="Todos" checked />
                <span>Todos</span>
              </label>
              <label>
                <input type="radio" name="estado-radio" value="Pendiente" />
                <span>Pendiente</span>
              </label>
              <label>
                <input type="radio" name="estado-radio" value="En curso" />
                <span>En curso</span>
              </label>
              <label>
                <input type="radio" name="estado-radio" value="Finalizado" />
                <span>Finalizado</span>
              </label>
              <span class="selection"></span>
            </div>
          </div>

          <div class="table-wrap">
            <table class="table">
              <thead>
                <tr>
                  <th style="width:80px">ID</th>
                  <th style="width:180px">Equipo</th>
                  <th>Nombre</th>
                  <th style="width:130px">Estado</th>
                  <th style="width:200px">Avance</th>
                  <th style="width:140px">Acciones</th>
                </tr>
              </thead>
              <tbody id="projects-body"></tbody>
            </table>
          </div>
        </section>

        <aside class="card">
          <div class="detail-head">
            <div class="title">Detalle del Proyecto</div>
            <div class="detail-actions">
              <button id="btn-ir-homework" class="Btn" disabled>
                Editar
                <svg viewBox="0 0 512 512" class="svg">
                  <path
                    d="M410.3 231l11.3-11.3-33.9-33.9-62.1-62.1L291.7 89.8l-11.3 11.3-22.6 22.6L58.6 322.9c-10.4 10.4-18 23.3-22.2 37.4L1 480.7c-2.5 8.4-.2 17.5 6.1 23.7s15.3 8.5 23.7 6.1l120.3-35.4c14.1-4.2 27-11.8 37.4-22.2L387.7 253.7 410.3 231zM160 399.4l-9.1 22.7c-4 3.1-8.5 5.4-13.3 6.9L59.4 452l23-78.1c1.4-4.9 3.8-9.4 6.9-13.3l22.7-9.1v32c0 8.8 7.2 16 16 16h32zM362.7 18.7L348.3 33.2 325.7 55.8 314.3 67.1l33.9 33.9 62.1 62.1 33.9 33.9 11.3-11.3 22.6-22.6 14.5-14.5c25-25 25-65.5 0-90.5L453.3 18.7c-25-25-65.5-25-90.5 0zm-47.4 168l-144 144c-6.2 6.2-16.4 6.2-22.6 0s-6.2-16.4 0-22.6l144-144c6.2-6.2 16.4-6.2 22.6 0s6.2 16.4 0 22.6z"
                  ></path>
                </svg>
              </button>
            </div>
          </div>

          <div class="detail" id="detalle-proyecto">
            <div class="muted">Selecciona un proyecto para ver el detalle.</div>
            <hr class="sep">
            <div class="detail-item"><div class="label">Nombre</div><div class="value" id="d-nombre">â€”</div></div>
            <div class="detail-item"><div class="label">DescripciÃ³n</div><div class="value" id="d-descripcion">â€”</div></div>
            <div class="detail-item"><div class="label">Equipo</div><div class="value" id="d-equipo">â€”</div></div>
            <div class="detail-item"><div class="label">Inicio</div><div class="value" id="d-inicio">â€”</div></div>
            <div class="detail-item"><div class="label">Fin</div><div class="value" id="d-fin">â€”</div></div>
            <div class="detail-item"><div class="label">Estado</div><div class="value" id="d-estado"><span class="chip">â€”</span></div></div>
            <div class="detail-item"><div class="label">Avance</div><div class="value"><div class="progress"><span id="d-avance" style="width:0%"></span></div></div></div>

            <div class="tasks-box" id="tasks-box">
              <h3>Tareas de este proyecto</h3>
              <div id="tasks-list"></div>
              <div class="muted small" id="tasks-count"></div>
            </div>
          </div>
        </aside>
      </div>
    </main>
  </div>

  <!-- Modal: Nuevo Proyecto -->
  <div class="modal-overlay" id="modal-overlay">
    <div class="modal">
      <h2>Nuevo Proyecto</h2>

      <div class="field" id="f-nombre-field">
        <label>Nombre</label>
        <input id="f-nombre" type="text" placeholder="Ej. Reto Oracle Cloud">
        <div class="msg" id="msg-nombre">El nombre es obligatorio (mÃ­n. 3 caracteres).</div>
      </div>

      <div class="field" id="f-desc-field">
        <label>DescripciÃ³n</label>
        <input id="f-desc" type="text" placeholder="Breve descripciÃ³n">
        <div class="msg" id="msg-desc">La descripciÃ³n es obligatoria (mÃ­n. 5 caracteres).</div>
      </div>

      <!-- SELECT de equipos donde eres ADMIN (con fallback a equipos donde participas) -->
      <div class="field" id="f-equipo-field">
        <label for="f-equipo">Equipo</label>
        <select id="f-equipo">
          <option value="">Cargando equiposâ€¦</option>
        </select>
        <div class="msg" id="msg-equipo">Selecciona un equipo.</div>
      </div>

      <div class="field" id="f-inicio-field">
        <label>Fecha inicio</label>
        <input id="f-inicio" type="date">
        <div class="msg" id="msg-inicio">Indica una fecha de inicio vÃ¡lida.</div>
      </div>

      <div class="field" id="f-fin-field">
        <label>Fecha fin</label>
        <input id="f-fin" type="date">
        <div class="msg" id="msg-fin">Indica una fecha de fin vÃ¡lida (â‰¥ inicio).</div>
      </div>

      <div class="modal-buttons">
        <button class="btn btn-outline" id="btn-cancelar">Cancelar</button>
        <button class="btn btn-primary" id="btn-guardar" disabled>Guardar</button>
      </div>
    </div>
  </div>

  <div id="confirm-root"></div>

<script>
 // ===== SesiÃ³n / Iniciales de usuario =====
const user = JSON.parse(localStorage.getItem("user") || "null");
const $userInitial = document.querySelector(".user-circle");
if ($userInitial && (user?.nombre || user?.email)) {
  const ch = (user?.nombre?.trim()?.[0] ?? user?.email?.trim()?.[0] ?? "U").toUpperCase();
  $userInitial.textContent = ch;
}

// ===== DOM refs =====
const $tbody = document.getElementById("projects-body");
const $buscar = document.getElementById("buscar");
const $filtro = document.getElementById("filtro");
const $resumen = document.getElementById("resumen-lista");
const $confirmRoot = document.getElementById("confirm-root");

// Detalle
const $dNombre = document.getElementById("d-nombre");
const $dDesc   = document.getElementById("d-descripcion");
const $dEquipo = document.getElementById("d-equipo");
const $dIni    = document.getElementById("d-inicio");
const $dFin    = document.getElementById("d-fin");
const $dEstado = document.getElementById("d-estado");
const $dAvance = document.getElementById("d-avance");
const $btnIrHomework = document.getElementById("btn-ir-homework");

// Panel de tareas
const $tasksBox   = document.getElementById("tasks-box");
const $tasksList  = document.getElementById("tasks-list");
const $tasksCount = document.getElementById("tasks-count");

// Modal Proyecto
const $modalOverlay = document.getElementById("modal-overlay");
const $btnNuevo  = document.getElementById("btn-nuevo");
const $btnGuardar= document.getElementById("btn-guardar");
const $btnCancel = document.getElementById("btn-cancelar");

// Form Proyecto inputs
const $fNombre = document.getElementById("f-nombre");
const $fDesc   = document.getElementById("f-desc");
const $fEquipo = document.getElementById("f-equipo");
const $fInicio = document.getElementById("f-inicio");
const $fFin    = document.getElementById("f-fin");

// Form Proyecto fields
const $fNombreField = document.getElementById("f-nombre-field");
const $fDescField   = document.getElementById("f-desc-field");
const $fEquipoField = document.getElementById("f-equipo-field");
const $fInicioField = document.getElementById("f-inicio-field");
const $fFinField    = document.getElementById("f-fin-field");

// Picker / Autocomplete DOM (si lo usas mÃ¡s adelante)
const $acWrap  = document.getElementById("ac-wrap");
const $acList  = document.getElementById("ac-list");
const $acCount = document.getElementById("ac-count");

// ===== API =====
const currentUserId = user?.id ?? user?.usuarioId ?? null;
const currentUserEmail = user?.email || "";
const API_BASE    = "http://localhost:8080/proyectos";
const TASKS_API   = "http://localhost:8080/api/tasks";
const EQUIPOS_API = "http://localhost:8080/equipos";
const UE_API      = "http://localhost:8080/usuarios-equipos";

let proyectosCache = [];
let selectedProjectId = null;
const equipoNombreCache = new Map();

// ===== Helpers API y UI =====
async function fetchEquipoNombre(id){
  if (!id) return "-";
  if (equipoNombreCache.has(id)) return equipoNombreCache.get(id);
  try{
    const r = await fetch(`${EQUIPOS_API}/${encodeURIComponent(id)}`);
    if (!r.ok) throw 0;
    const data = await r.json();
    const name = data?.nombreEquipo || (`Equipo #${id}`);
    equipoNombreCache.set(id, name);
    return name;
  }catch{
    const fallback = `Equipo #${id}`;
    equipoNombreCache.set(id, fallback);
    return fallback;
  }
}

function goToHomework(id){
  if (!id) return;
  window.location.href = `/homework-proyect.html?id=${encodeURIComponent(id)}`;
}

function estadoToChipClass(estado) {
  if (!estado) return "chip";
  switch (estado.toLowerCase()) {
    case "pendiente":  return "chip state-pend";
    case "en curso":   return "chip state-run";
    case "finalizado": return "chip state-done";
    default:           return "chip";
  }
}
function estadoToAvance(estado) {
  switch ((estado || "").toLowerCase()) {
    case "pendiente":  return 0;
    case "en curso":   return 50;
    case "finalizado": return 100;
    default:           return 0;
  }
}
function formatFecha(iso) {
  if (!iso) return "â€”";
  const d = new Date(iso);
  return isNaN(d.getTime()) ? "â€”" : d.toLocaleDateString();
}

async function fetchTasksForProject(projectId){
  try{
    const res = await fetch(`${TASKS_API}?projectId=${encodeURIComponent(projectId)}`, {
      headers: { "X-User-Id": String(currentUserId ?? "") }
    });
    if (!res.ok) return [];
    return await res.json();
  }catch{ return []; }
}
function calcProgressFromTasks(tasks){
  const total = tasks.length;
  const done = tasks.filter(t => (t.status || "").toLowerCase() === "done" || t.completedAt != null).length;
  const pct = total === 0 ? 0 : Math.round((done/total)*100);
  return { total, done, pct };
}
async function persistProjectEstadoFromPct(p, pct){
  if (!p || !p.id) return;
  const nuevo = (pct===0) ? "Pendiente" : (pct===100 ? "Finalizado" : "En curso");
  if (p.estado === nuevo) return;
  const payload = { ...p, estado: nuevo };
  try{ await fetch(`${API_BASE}/${p.id}`, {method:"PUT", headers:{ "Content-Type":"application/json" }, body: JSON.stringify(payload)}); }
  catch{}
}

// Actualiza solo la fila de la tabla
function updateRowProgress(projectId, pct){
  const row = $tbody.querySelector(`tr[data-id="${projectId}"]`);
  if (!row) return;
  const bar = row.querySelector(".progress > span");
  if (bar) { bar.style.width = `${pct}%`; bar.classList.remove('loading'); }
  const estChip = row.querySelector("td:nth-child(4) .chip");
  if (estChip){
    const nuevo = pct===0 ? "Pendiente" : (pct===100 ? "Finalizado" : "En curso");
    estChip.textContent = nuevo;
    estChip.className = estadoToChipClass(nuevo);
  }
}

// Carga tareas y progreso del panel derecho
async function loadProjectTasksAndProgress(projectId){
  $tasksBox.style.display = "block";
  $tasksList.innerHTML = `<div class="muted">Cargando tareasâ€¦</div>`;
  $tasksCount.textContent = '';

  const tasks = await fetchTasksForProject(projectId);

  if (!tasks.length) {
    $tasksList.innerHTML = `<div class="muted">Este proyecto no tiene tareas.</div>`;
    $tasksCount.textContent = `0 tareas`;
  } else {
    $tasksList.innerHTML = tasks.map(t => {
      const asig = t.assigneeName && t.assigneeName.trim()
        ? t.assigneeName
        : (t.assigneeId || '-');
      return `
        <div class="task-item">
          <div>
            <div class="task-title">${escapeHtml(t.title || '')}</div>
            <div class="task-meta">
              Prio: ${escapeHtml(t.priority||'')}
              Â· Est: ${t.estimatedHours??'-'}h
              Â· Asig: ${escapeHtml(asig)}
              ${t.realHours?(' Â· Real: '+t.realHours+'h'):''}
              ${t.fechaLimite?(' Â· Vence: '+new Date(t.fechaLimite).toLocaleDateString()):''}
            </div>
          </div>
          <div><span class="badge status ${escapeHtml((t.status||'todo').toLowerCase())}">${escapeHtml((t.status||'todo'))}</span></div>
        </div>
      `;
    }).join('');
    $tasksCount.textContent = `${tasks.length} tarea(s)`;
  }

  const { pct } = calcProgressFromTasks(tasks);
  $dAvance.style.width = `${pct}%`;
  const nuevoEstado = pct===0 ? "Pendiente" : (pct===100 ? "Finalizado" : "En curso");
  $dEstado.innerHTML = `<span class="${estadoToChipClass(nuevoEstado)}">${nuevoEstado}</span>`;

  updateRowProgress(projectId, pct);

  const idx = proyectosCache.findIndex(x => x.id === projectId);
  if (idx >= 0) {
    proyectosCache[idx]._progress = pct;
    await persistProjectEstadoFromPct(proyectosCache[idx], pct);
  }
}

function escapeHtml(s){ return String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])) }

function setDetalle(p) {
  if (!p) return;
  selectedProjectId = p.id;

  const prev = $tbody.querySelector(".row-selected");
  if (prev) prev.classList.remove("row-selected");
  const now = $tbody.querySelector(`tr[data-id="${p.id}"]`);
  if (now) now.classList.add("row-selected");

  $dNombre.textContent = p.nombreProyecto ?? "â€”";
  $dDesc.textContent   = p.descripcion ?? "â€”";

  const cached = p.equipoId ? (equipoNombreCache.get(p.equipoId) || null) : null;
  $dEquipo.textContent = cached ?? (p.equipoId ?? "â€”");
  if (p.equipoId && !cached){
    fetchEquipoNombre(p.equipoId).then(name => {
      if (selectedProjectId === p.id) $dEquipo.textContent = name;
    });
  }

  $dIni.textContent    = formatFecha(p.fechaInicio);
  $dFin.textContent    = formatFecha(p.fechaFin);

  $dEstado.innerHTML   = `<span class="${estadoToChipClass(p.estado)}">${p.estado ?? "â€”"}</span>`;
  $dAvance.style.width = (typeof p._progress === "number" ? p._progress : estadoToAvance(p.estado)) + "%";

  loadProjectTasksAndProgress(p.id);
  $btnIrHomework.disabled = false;
}

if ($btnIrHomework) {
  $btnIrHomework.addEventListener("click", () => {
    if (selectedProjectId) goToHomework(selectedProjectId);
  });
}

// ===== Render tabla =====
function renderTabla(items) {
  if (!items.length) {
    $tbody.innerHTML = `<tr><td colspan="6">No hay proyectos.</td></tr>`;
    $resumen.innerHTML = `<strong>0</strong> resultado(s)`;
    return;
  }

  $resumen.innerHTML = `<strong>${items.length}</strong> resultado(s)`;

  $tbody.innerHTML = items.map(p => {
    const teamName = p.equipoId ? (equipoNombreCache.get(p.equipoId) ?? `Equipo #${p.equipoId}`) : "-";
    const hasReal = typeof p._progress === "number";
    const pct = hasReal ? p._progress : 0; // inicia en 0 y se verÃ¡ animaciÃ³n "loading"
    const loadingClass = hasReal ? "" : "loading";
    return `
      <tr data-id="${p.id}">
        <td>${p.id ?? "-"}</td>
        <td>${teamName}</td>
        <td>${p.nombreProyecto ?? "-"}</td>
        <td><span class="${estadoToChipClass(p.estado)}">${p.estado ?? "â€”"}</span></td>
        <td><div class="progress"><span class="${loadingClass}" style="width:${pct}%"></span></div></td>
        <td>
            <button
              class="btn-round-anim delete-team-button"
              onclick="borrarProyecto(${p.id}, event)"
              title="Eliminar proyecto"
            >
              <svg viewBox="0 0 448 512" aria-hidden="true">
                <path d="M135.2 17.7L128 32H32C14.3 32 0 46.3 0 64S14.3 96 32 96H416c17.7 0 32-14.3 32-32s-14.3-32-32-32H320l-7.2-14.3C307.4 6.8 296.3 0 284.2 0H163.8c-12.1 0-23.2 6.8-28.6 17.7zM416 128H32L53.2 467c1.6 25.3 22.6 45 47.9 45H346.9c25.3 0 46.3-19.7 47.9-45L416 128z"></path>
              </svg>
            </button>
        </td>
      </tr>`;
  }).join("");

  Array.from($tbody.querySelectorAll("tr")).forEach(tr => {
    tr.addEventListener("click", (e) => {
      if (e.target.closest('button')) return;
      const prev = $tbody.querySelector(".row-selected");
      if (prev) prev.classList.remove("row-selected");
      tr.classList.add("row-selected");
      const id = Number(tr.dataset.id);
      const p = proyectosCache.find(x => x.id === id);
      setDetalle(p);
    });

    tr.addEventListener("dblclick", (e) => {
      if (e.target.closest('button')) return;
      const id = Number(tr.dataset.id);
      if (id) goToHomework(id);
    });
  });
}

// ===== Select de equipos (donde eres admin o miembro) =====
async function buscarEquiposParaSelect() {
  const $select = document.getElementById("f-equipo");
  const $help   = document.getElementById("equipos-help");
  if (!$select) return;

  const renderOpciones = (equipos) => {
    if (!equipos?.length) {
      $select.innerHTML = `<option value="">No tienes equipos disponibles</option>`;
      $btnGuardar.disabled = true;
      if ($help) $help.textContent = "No apareces en ningÃºn equipo.";
      return;
    }
    $select.innerHTML = `<option value="">Selecciona un equipoâ€¦</option>` +
      equipos.map(e => `<option value="${e.id}">${escapeHtml(e.nombreEquipo || ("Equipo #" + e.id))}</option>`).join("");
    validarYActualizarEstado();
  };

  try {
    const direct = await fetch(`${EQUIPOS_API}?adminId=${encodeURIComponent(currentUserId)}`);
    if (direct.ok) {
      const data = await direct.json();
      if (Array.isArray(data) && data.length) {
        renderOpciones(data);
        return;
      }
    }
  } catch {}

  try {
    const resp = await fetch(`${EQUIPOS_API}/member/${encodeURIComponent(currentUserId)}`);
    if (resp.ok) {
      const data2 = await resp.json();
      renderOpciones(Array.isArray(data2) ? data2 : []);
      return;
    }
  } catch {}

  $select.innerHTML = `<option value="">Error cargando equipos</option>`;
  $btnGuardar.disabled = true;
  if ($help) $help.textContent = "No se pudieron cargar los equipos.";
}

// ===== ValidaciÃ³n formulario =====
function setFieldState($fieldEl, isValid, show){
  if (!$fieldEl) return;
  if (!show){ $fieldEl.classList.remove("invalid"); return; }
  if (isValid) $fieldEl.classList.remove("invalid"); else $fieldEl.classList.add("invalid");
}
function isNonEmpty(s){ return !!(s && s.trim().length > 0); }

function validarFormulario(show=false){
  const nombreOK = isNonEmpty($fNombre.value) && $fNombre.value.trim().length >= 3;
  const descOK   = isNonEmpty($fDesc.value)   && $fDesc.value.trim().length >= 5;
  const equipoOK = isNonEmpty($fEquipo.value);

  const ini = $fInicio.value ? new Date($fInicio.value) : null;
  const fin = $fFin.value    ? new Date($fFin.value)    : null;

  const inicioOK = !!(ini && !isNaN(ini.getTime()));
  const finOK    = !!(fin && !isNaN(fin.getTime()));
  const rangoOK  = inicioOK && finOK && (ini.getTime() <= fin.getTime());

  setFieldState($fNombreField, nombreOK, show);
  setFieldState($fDescField,   descOK,   show);
  setFieldState($fEquipoField, equipoOK, show);
  setFieldState($fInicioField, inicioOK, show);
  setFieldState($fFinField,    finOK && rangoOK, show);

  return { ok: nombreOK && descOK && equipoOK && inicioOK && finOK && rangoOK };
}

function validarYActualizarEstado(){
  const { ok } = validarFormulario(false);
  $btnGuardar.disabled = !ok;
  return ok;
}

// ===== Restricciones de fecha =====
function toLocalDateInputValue(date){
  const off = date.getTimezoneOffset();
  const d = new Date(date.getTime() - off*60*1000);
  return d.toISOString().slice(0,10);
}
const TODAY_STR = toLocalDateInputValue(new Date());
$fInicio.setAttribute('min', TODAY_STR);
$fFin.setAttribute('min', TODAY_STR);

$fInicio.addEventListener('change', () => {
  if ($fInicio.value && $fInicio.value < TODAY_STR) {
    $fInicio.value = TODAY_STR;
  }
  $fFin.min = $fInicio.value || TODAY_STR;
  if ($fFin.value && $fFin.value < $fFin.min) {
    $fFin.value = $fFin.min;
  }
  validarYActualizarEstado();
});

const _validarFormularioOriginal = validarFormulario;
validarFormulario = function(show=false){
  const res = _validarFormularioOriginal(show);
  const today = new Date(); today.setHours(0,0,0,0);
  const ini = $fInicio.value ? new Date($fInicio.value) : null;

  if (!ini || ini.getTime() < today.getTime()) {
    res.ok = false;
    setFieldState($fInicioField, false, show);
  }
  if ($fFin.value && $fInicio.value && ($fFin.value < $fInicio.value)) {
    res.ok = false;
    setFieldState($fFinField, false, show);
  }
  $btnGuardar.disabled = !res.ok;
  return res;
};

document.addEventListener('DOMContentLoaded', () => {
  $fInicio.min = TODAY_STR;
  $fFin.min = $fInicio.value || TODAY_STR;
});

// ===== Fetch helpers =====
async function getJsonOrNull(url){
  try{ const r = await fetch(url); if (!r.ok) return null; return await r.json(); }
  catch{ return null; }
}

async function fetchUserEquipoIds(userId){
  const rels = await getJsonOrNull(`${UE_API}/usuario/${encodeURIComponent(userId)}`);
  if (!Array.isArray(rels)) return [];
  return rels
    .map(r => (r?.equipoId ?? r?.id?.equipoId))
    .filter(id => id != null);
}

async function fetchUserVisibleProjects(userId){
  const direct = await getJsonOrNull(`${API_BASE}/visibles/${encodeURIComponent(userId)}`);
  if (Array.isArray(direct)) return direct;

  const byId = new Map();
  const mine = await getJsonOrNull(`${API_BASE}/mios/${encodeURIComponent(userId)}`) || [];
  for (const p of mine) if (p?.id != null) byId.set(p.id, p);

  const equipoIds = await fetchUserEquipoIds(userId);
  for (const eid of equipoIds) {
    const arr = await getJsonOrNull(`${API_BASE}?equipoId=${encodeURIComponent(eid)}`) || [];
    for (const p of arr) if (p?.id != null) byId.set(p.id, p);
  }
  return Array.from(byId.values());
}

async function parseJsonSafe(res){
  const ct = (res.headers.get('content-type') || '').toLowerCase();
  if (ct.includes('application/json')) {
    try { return await res.json(); } catch { return null; }
  }
  return null;
}

async function fetchCreatedFallback(){
  const ult = await getJsonOrNull(`${API_BASE}/ultimo`);
  if (ult && ult.id != null) return ult;
  return null;
}

// ===== Crear proyecto =====
async function crearProyecto() {
  if (!currentUserId) { return alert("No hay usuario logueado."); }
  const { ok } = validarFormulario(true);
  if (!ok) return;

  const nuevo = {
    nombreProyecto: $fNombre.value.trim(),
    descripcion: $fDesc.value.trim(),
    estado: "Pendiente",
    equipoId: Number($fEquipo.value),
    fechaInicio: $fInicio.value,
    fechaFin: $fFin.value,
    creadorId: currentUserId
  };

  const prevDisabled = $btnGuardar.disabled;
  $btnGuardar.disabled = true;

  try {
    const res = await fetch(API_BASE, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(nuevo)
    });

    if (!res.ok) {
      alert(`Error al crear el proyecto. CÃ³digo: ${res.status}`);
      return;
    }

    let creado = await parseJsonSafe(res);
    if (!creado) {
      creado = await fetchCreatedFallback();
    }

    if (!creado) {
      proyectosCache = await fetchUserVisibleProjects(currentUserId);
      cerrarModal();
      applyFilters();
      return;
    }

    if (creado?.equipoId && !equipoNombreCache.has(creado.equipoId)) {
      await fetchEquipoNombre(creado.equipoId);
    }

    proyectosCache.push(creado);
    cerrarModal();
    applyFilters();
    updateRowProgress(creado.id, 0);

  } catch (e) {
    console.error("POST /proyectos fallÃ³:", e);
    alert("No se pudo contactar al servidor (revisa CORS/red). El proyecto probablemente sÃ­ se creÃ³.");
    try {
      proyectosCache = await fetchUserVisibleProjects(currentUserId);
      applyFilters();
    } catch {}
  } finally {
    $btnGuardar.disabled = prevDisabled;
  }
}

// ===== Helper: leer estado desde el toggle =====
function getEstadoDesdeToggle() {
  const checked = document.querySelector('.radio-input input[name="estado-radio"]:checked');
  return (checked?.value || "Todos").toLowerCase();
}

// ===== Filtros / bÃºsqueda =====
function applyFilters() {
  const q = ($buscar.value || "").toLowerCase();
  const estSelSelect = ($filtro?.value || "Todos").toLowerCase(); // sigue usando el select
  const estToggle = getEstadoDesdeToggle();                      // nuevo control

  let items = proyectosCache.filter(p => {
    const nombreOk = !q || (p.nombreProyecto || "").toLowerCase().includes(q);
    const estProyecto = (p.estado || "").toLowerCase();

    let estadoOk = true;

    if (estSelSelect !== "todos") {
      estadoOk = estadoOk && estProyecto === estSelSelect;
    }
    if (estToggle !== "todos") {
      estadoOk = estadoOk && estProyecto === estToggle;
    }

    return nombreOk && estadoOk;
  });

  renderTabla(items);
}

// ===== Modal =====
function abrirModal() {
  $modalOverlay.style.display = "flex";
  validarYActualizarEstado();
  buscarEquiposParaSelect();
}
function cerrarModal() {
  $modalOverlay.style.display = "none";
  $fNombre.value = ""; $fDesc.value = ""; $fEquipo.value = "";
  $fInicio.value = ""; $fFin.value = "";
  [$fNombreField,$fDescField,$fEquipoField,$fInicioField,$fFinField].forEach(f=>f.classList.remove("invalid"));
  $btnGuardar.disabled = true;
  $fInicio.min = TODAY_STR;
  $fFin.min = $fInicio.value || TODAY_STR;
}

$btnNuevo.addEventListener("click", e => { e.preventDefault(); abrirModal(); });
$btnCancel.addEventListener("click", e => { e.preventDefault(); cerrarModal(); });
$btnGuardar.addEventListener("click", e => { e.preventDefault(); crearProyecto(); });
$modalOverlay.addEventListener("click", e => { if (e.target === $modalOverlay) cerrarModal(); });

$buscar.addEventListener("input", applyFilters);
$filtro.addEventListener("change", applyFilters);
document.querySelectorAll('.radio-input input[name="estado-radio"]').forEach(input => {
  input.addEventListener("change", applyFilters);
});

// ===== ConfirmaciÃ³n borrar =====
function mostrarConfirmacion(mensaje, onYes) {
  const overlay = document.createElement("div");
  overlay.className = "confirm-overlay";
  overlay.innerHTML = `
    <div class="confirm-box">
      <h3>Confirmar acciÃ³n</h3>
      <p>${mensaje}</p>
      <div class="confirm-buttons">
        <button class="confirm-btn confirm-cancel">Cancelar</button>
        <button class="confirm-btn confirm-yes">SÃ­, borrar</button>
      </div>
    </div>
  `;
  $confirmRoot.appendChild(overlay);
  const close = () => overlay.remove();
  overlay.querySelector(".confirm-cancel").onclick = close;
  overlay.querySelector(".confirm-yes").onclick = () => { close(); onYes(); };
  overlay.addEventListener("click", (e) => { if (e.target === overlay) close(); });
}

async function borrarProyecto(id, evt) {
  if (evt) evt.stopPropagation();
  mostrarConfirmacion("Â¿Seguro que deseas borrar este proyecto?", async () => {
    await fetch(`${API_BASE}/${id}`, { method: "DELETE" });
    proyectosCache = proyectosCache.filter(p => p.id !== id);
    applyFilters();
    $tasksBox.style.display = "none";
    selectedProjectId = null;
    $btnIrHomework.disabled = true;
  });
}
window.borrarProyecto = borrarProyecto;

// ===== Precarga de progreso para todas las filas =====
async function hydrateProgressAll(concurrency = 4) {
  const queue = [...proyectosCache];
  const work = async () => {
    while (queue.length) {
      const p = queue.shift();
      if (!p?.id) continue;
      try {
        const tasks = await fetchTasksForProject(p.id);
        const { pct } = calcProgressFromTasks(tasks);
        p._progress = pct;
        updateRowProgress(p.id, pct);
        await persistProjectEstadoFromPct(p, pct);
      } catch {}
    }
  };
  const workers = Array.from({ length: Math.min(concurrency, queue.length) }, work);
  await Promise.all(workers);
}

// ===== Carga inicial =====
async function cargarProyectos() {
  try {
    if (!currentUserId) {
      $tbody.innerHTML = `<tr><td colspan="6">Inicia sesiÃ³n para ver tus proyectos.</td></tr>`;
      return;
    }
    proyectosCache = await fetchUserVisibleProjects(currentUserId);

    const uniqueEquipoIds = [...new Set(proyectosCache.map(p => p.equipoId).filter(Boolean))];
    await Promise.all(uniqueEquipoIds.map(id => fetchEquipoNombre(id)));

    applyFilters();                 // 1) pinta la tabla (barras en modo "loading")
    hydrateProgressAll(4);          // 2) obtiene % reales y actualiza filas
    if (proyectosCache[0]) setDetalle(proyectosCache[0]); // opcional: autoselecciÃ³n
  } catch {
    $tbody.innerHTML = `<tr><td colspan="6">Error al cargar proyectos</td></tr>`;
  }
}

document.addEventListener("DOMContentLoaded", cargarProyectos);

// ===== Inputs del formulario: validar al escribir/cambiar =====
[$fNombre, $fDesc, $fEquipo, $fInicio, $fFin].forEach(el => {
  el.addEventListener("input", validarYActualizarEstado);
  el.addEventListener("change", validarYActualizarEstado);
});

</script>

</body>
</html>
