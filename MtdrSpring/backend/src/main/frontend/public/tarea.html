<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Tareas</title>
  <link rel="stylesheet" href="Css/tarea.css" />
  <link href="https://api.fontshare.com/v2/css?f[]=panchang@500,600,700,800,900&display=swap" rel="stylesheet">

  <!-- Íconos -->
  <svg xmlns="http://www.w3.org/2000/svg" style="display:none">
    <symbol id="i-dashboard" viewBox="0 0 24 24" fill="none" stroke="currentColor"><path stroke-width="1.6" d="M3 3h8v8H3zM13 3h8v5h-8zM13 10h8v11h-8zM3 13h8v8H3z"/></symbol>
    <symbol id="i-users" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"><path d="M17 21v-2a4 4 0 0 0-3-3.87"/><path d="M7 21v-2a4 4 0 0 1 3-3.87"/><circle cx="12" cy="7" r="4"/><path d="M5.5 8a3.5 3.5 0 1 0 0 7"/><path d="M18.5 8a3.5 3.5 0 1 1 0 7"/></symbol>
    <symbol id="i-folder" viewBox="0 0 24 24" fill="none" stroke="currentColor"><path stroke-width="1.6" d="M3 7h6l2 2h10v9a3 3 0 0 1-3 3H6a3 3 0 0 1-3-3z"/></symbol>
    <symbol id="i-board" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect width="8" height="4" x="8" y="2" rx="1" ry="1"/><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0  0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"/><path d="M12 11h4"/><path d="M12 16h4"/><path d="M8 11h.01"/><path d="M8 16h.01"/></symbol>
    <symbol id="i-chart" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"><path d="M12 16v5"/><path d="M16 14v7"/><path d="M20 10v11"/><path d="m22 3-8.646 8.646a.5.5 0 0 1-.708 0L9.354 8.354a.5.5 0 0 0-.707 0L2 15"/><path d="M4 18v3"/><path d="M8 14v7"/></symbol>
    <symbol id="i-bot" viewBox="0 0 24 24" fill="none" stroke="currentColor"><rect x="4" y="8" width="16" height="10" rx="4" stroke-width="1.6"/><circle cx="9" cy="13" r="1" stroke-width="1.6"/><circle cx="15" cy="13" r="1" stroke-width="1.6"/><path stroke-width="1.6" d="M12 4v2m-7 6H4m16 0h1"/></symbol>
    <symbol id="i-bell" viewBox="0 0 24 24" fill="none" stroke="currentColor"><path stroke-width="1.6" d="M18 8a6 6 0 1 0-12 0c0 7-3 7-3 7h18s-3 0-3-7"/><path stroke-width="1.6" d="M13.73 21a2 2 0 0 1-3.46 0"/></symbol>
    <symbol id="i-gear" viewBox="0 0 24 24" fill="none" stroke="currentColor"><circle cx="12" cy="12" r="3"/><path stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round" d="M9.671 4.136a2.34 2.34 0 0 1 4.659 0 2.34 2.34 0 0 0 3.319 1.915 2.34 2.34 0 0 1 2.33 4.033 2.34 2.34 0 0 0 0 3.831 2.34 2.34 0 0 1-2.33 4.033 2.34 2.34 0 0 0-3.319 1.915 2.34 2.34 0 0 1-4.659 0 2.34 2.34 0  0 0-3.32-1.915 2.34 2.34 0 0 1-2.33-4.033 2.34 2.34 0 0 0 0-3.831A2.34 2.34 0 0 1 6.35 6.051a2.34 2.34 0 0 0 3.319-1.915"/></symbol>
    <symbol id="i-exit" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m16 17 5-5-5-5"/><path d="M21 12H9"/><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/></symbol>
  </svg>

  <style>
    .filters{display:flex;gap:14px;align-items:flex-end;flex-wrap:wrap;margin-top:10px}
    .field{display:flex;flex-direction:column;gap:6px}
    .field label{font-size:12px;color:#6b7280}
    .select{padding:10px 12px;border:1px solid #e5e7eb;border-radius:12px;min-width:260px;background:#fff}
    .task-actions{display:flex;gap:6px;margin-top:8px;flex-wrap:wrap}
    .btn-xs{font-size:12px;padding:4px 8px;border:1px solid var(--line);background:#fff;border-radius:8px;cursor:pointer}
    .btn-xs.complete{background:#e6ffed;border-color:#b7f0c0}
    .btn-xs.delete{background:#fff5f5;border-color:#ffd2d2}
    .btn-xs.edit{background:#eef2ff;border-color:#c7d2fe}
    .btn-xs:hover{filter:brightness(.97)}
    .task.selected{outline:2px solid var(--brand);outline-offset:2px}
    .drop-target{outline:2px dashed #cbd5e1;background:#f8fafc}
    .details{display:none}.details.open{display:block}
    .details-head{display:flex;gap:10px;align-items:center;justify-content:space-between;margin-bottom:10px}
    .badges{display:flex;gap:8px;flex-wrap:wrap}
    .badge{font-size:12px;padding:3px 8px;border-radius:999px;border:1px solid var(--line)}
    .badge.status.todo{background:#fff4f3}
    .badge.status.doing{background:#fff8e6}
    .badge.status.done{background:#e9fff0}
    .details-grid{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:12px}
    .details-item{background:#fafbfc;border:1px solid var(--line-2);border-radius:12px;padding:12px}
    .details-label{font-size:12px;color:#6b7280;margin-bottom:6px}
    .details-value{font-weight:700;color:#334155}
    .desc-box{margin-top:10px;background:#fff;border:1px solid var(--line);border-radius:12px;padding:12px}
  </style>
  <script src="/session.js"></script>
</head>

<body>
  <!-- Topbar -->
  <header class="topbar">
    <div class="brand"><h1 class="logo-text">TMDV</h1></div>
    <div class="topbar-right">
      <div class="user-circle" title="Usuario">U</div>
      <a href="/index.html" class="logout-btn"><svg class="ico-sm" aria-hidden="true"><use href="#i-exit"/></svg><span>Salir</span></a>
    </div>
  </header>

  <div class="app">
    <!-- Sidebar COMPLETO -->
    <aside class="aside">
      <nav class="menu">
        <a class="mi" href="/dashboard.html">
          <svg class="ico"><use href="#i-dashboard"/></svg><span>Dashboard</span>
        </a>
        <a class="mi" href="/Equipos.html">
          <svg class="ico"><use href="#i-users"/></svg><span>Equipos</span>
        </a>
        <a class="mi" href="/projects.html">
          <svg class="ico"><use href="#i-folder"/></svg><span>Proyectos</span>
        </a>
        <a class="mi active" href="#">
          <svg class="ico"><use href="#i-board"/></svg><span>Tareas</span>
        </a>
        <a class="mi" href="/KPIs.html">
          <svg class="ico"><use href="#i-chart"/></svg><span>KPIs</span>
        </a>
        <a class="mi" href="/chatbot.html">
          <svg class="ico"><use href="#i-bot"/></svg><span>Chatbot</span>
        </a>
        <a class="mi" href="/notifications.html">
          <svg class="ico"><use href="#i-bell"/></svg><span>Notificaciones</span>
        </a>
        <a class="mi" href="/settings.html">
          <svg class="ico"><use href="#i-gear"/></svg><span>Ajustes</span>
        </a>
      </nav>
    </aside>

    <!-- Main -->
    <main class="main">
      <section class="card card-soft">
        <div style="display:flex;align-items:center;justify-content:space-between">
          <h1 class="h4" style="margin:0">Tareas</h1>
        </div>

        <!-- Filtro -->
        <div class="filters">
          <div class="field">
            <label for="filterProject">Proyecto (por nombre)</label>
            <select id="filterProject" class="select">
              <option value="">Todos los proyectos</option>
            </select>
          </div>
        </div>

        <div class="progress-row" style="margin-top:10px">
          <div class="label">Avance general</div>
          <div class="progress"><span id="progressBar" style="width:0%"></span></div>
          <div class="percent" id="progressPct">0%</div>
        </div>
      </section>

      <!-- Kanban -->
      <section class="board">
        <article class="col" id="dropTodo" data-status="todo"><header class="col-head">Por hacer</header><div id="colTodo"></div></article>
        <article class="col" id="dropDoing" data-status="doing"><header class="col-head">En progreso</header><div id="colDoing"></div></article>
        <article class="col" id="dropDone" data-status="done"><header class="col-head">Hecho</header><div id="colDone"></div></article>
      </section>

      <!-- Detalles -->
      <section id="detailsCard" class="card details">
        <div class="details-head">
          <div>
            <div id="d_title" class="h4" style="margin:0 0 4px 0">—</div>
            <div class="badges"><span id="d_status" class="badge status">status</span></div>
          </div>
          <div class="badges">
            <button id="d_edit_btn" class="btn-xs edit" title="Editar tarea">Editar…</button>
            <button id="d_complete_btn" class="btn-xs complete" title="Marcar como hecha">Completar…</button>
            <button id="d_delete_btn" class="btn-xs delete" title="Eliminar tarea">Eliminar…</button>
          </div>
        </div>

        <div class="details-grid">
          <div class="details-item"><div class="details-label">Proyecto</div><div class="details-value" id="d_project">—</div></div>
          <div class="details-item"><div class="details-label">Asignado a</div><div class="details-value" id="d_assignee">—</div></div>
          <div class="details-item"><div class="details-label">Horas (Est / Real)</div><div class="details-value"><span id="d_est">0</span> h / <span id="d_real">0</span> h</div></div>
          <div class="details-item"><div class="details-label">Creada</div><div class="details-value" id="d_created">—</div></div>
          <div class="details-item"><div class="details-label">Completada</div><div class="details-value" id="d_completed">—</div></div>
        </div>

        <div class="desc-box">
          <div class="details-label" style="margin-bottom:6px">Descripción</div>
          <div id="d_desc" style="white-space:pre-wrap">—</div>
        </div>
      </section>
    </main>
  </div>

  <script>
    // ===== CONFIG
    const TASKS_API    = 'http://localhost:8080/api/tasks';
    const PROJECTS_API = 'http://localhost:8080/proyectos';
    const user = JSON.parse(localStorage.getItem('user') || 'null');
    const USER_ID    = user?.id || null;
    const USER_EMAIL = user?.email || '';

    // ===== DOM
    const colTodo  = document.getElementById('colTodo');
    const colDoing = document.getElementById('colDoing');
    const colDone  = document.getElementById('colDone');
    const dropTodo = document.getElementById('dropTodo');
    const dropDoing= document.getElementById('dropDoing');
    const dropDone = document.getElementById('dropDone');

    const progressBar = document.getElementById('progressBar');
    const progressPct = document.getElementById('progressPct');
    const filterProject = document.getElementById('filterProject');

    const detailsCard = document.getElementById('detailsCard');
    const d_title = document.getElementById('d_title');
    const d_status= document.getElementById('d_status');
    const d_project=document.getElementById('d_project');
    const d_assignee=document.getElementById('d_assignee');
    const d_est=document.getElementById('d_est');
    const d_real=document.getElementById('d_real');
    const d_created=document.getElementById('d_created');
    const d_completed=document.getElementById('d_completed');
    const d_desc=document.getElementById('d_desc');
    const d_complete_btn=document.getElementById('d_complete_btn');
    const d_delete_btn=document.getElementById('d_delete_btn');
    const d_edit_btn=document.getElementById('d_edit_btn');

    // ===== ESTADO
    let masterTasks = [];
    let allTasks = [];
    let selectedId = null;
    let draggingId = null; // única
    const PROJECTS_BY_ID = new Map(); // id(string) -> nombre

    // ===== HELPERS
    const authHeaders = () => {
      const h = {};
      if (USER_EMAIL) h['X-User-Email'] = USER_EMAIL;
      if (USER_ID != null) h['X-User-Id'] = String(USER_ID);
      return h;
    };
    function escapeHtml(s){return String(s).replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]))}
    const fmt = (iso)=>{ if(!iso) return '—'; const d=new Date(iso); return isNaN(d)?'—':d.toLocaleString(); };
    const getProjectName = id => id==null ? '—' : (PROJECTS_BY_ID.get(String(id)) || `Proyecto #${id}`);

    function populateProjectSelect(){
      const prev = filterProject.value;
      const entries = [...PROJECTS_BY_ID.entries()].sort((a,b)=> String(a[1]).localeCompare(String(b[1])));
      filterProject.innerHTML = `<option value="">Todos los proyectos</option>` + entries.map(([id,name])=>`<option value="${id}">${escapeHtml(name)}</option>`).join('');
      if ([...filterProject.options].some(o=>o.value===prev)) filterProject.value = prev;
    }

    async function loadVisibleProjectsForUser(){
      if (!USER_ID) return;
      try{
        const r = await fetch(`${PROJECTS_API}/visibles/${encodeURIComponent(USER_ID)}`, { headers: authHeaders() });
        if (!r.ok) return;
        const arr = await r.json();
        let changed=false;
        (arr||[]).forEach(p=>{
          if (p?.id!=null){
            const key=String(p.id), name=String(p.nombreProyecto||`Proyecto #${p.id}`);
            if (PROJECTS_BY_ID.get(key)!==name){ PROJECTS_BY_ID.set(key,name); changed=true; }
          }
        });
        if (changed){ populateProjectSelect(); renderBoard(allTasks); if(selectedId){const sel=allTasks.find(t=>t.id===selectedId); if(sel) showDetails(sel);} }
      }catch{}
    }

    async function ensureProjectName(id){
      const key=String(id);
      if (!id || PROJECTS_BY_ID.has(key)) return;
      try{
        const r = await fetch(`${PROJECTS_API}/${encodeURIComponent(id)}`, { headers: authHeaders() });
        if (!r.ok) return;
        const p = await r.json();
        if (p && p.id!=null){
          PROJECTS_BY_ID.set(String(p.id), String(p.nombreProyecto || `Proyecto #${p.id}`));
          populateProjectSelect(); renderBoard(allTasks);
          if (selectedId){ const sel=allTasks.find(t=>t.id===selectedId); if(sel) showDetails(sel); }
        }
      }catch{}
    }

    async function loadAllTasks(){
      const url = USER_ID ? `${TASKS_API}?userId=${encodeURIComponent(USER_ID)}` : TASKS_API;
      const r = await fetch(url, { headers: authHeaders() });
      if (!r.ok) return [];
      const data = await r.json();
      return Array.isArray(data)?data:[];
    }

    function enableColumnDnD(colEl){
      colEl.addEventListener('dragover', ev=>{ev.preventDefault();colEl.classList.add('drop-target');});
      colEl.addEventListener('dragleave', ()=>colEl.classList.remove('drop-target'));
      colEl.addEventListener('drop', async ev=>{
        ev.preventDefault(); colEl.classList.remove('drop-target');
        const toStatus=colEl.dataset.status, id=draggingId; draggingId=null;
        if (!id || !toStatus) return;
        try{
          const res = await fetch(`${TASKS_API}/${id}/status`, { method:'PATCH', headers:{'Content-Type':'application/json', ...authHeaders()}, body: JSON.stringify({ status: toStatus }) });
          if (!res.ok){ alert('No se pudo mover la tarea'); return; }
          await loadBoard();
          if (selectedId==id) showDetails(allTasks.find(t=>t.id==id));
        }catch{ alert('Error de red'); }
      });
    }
    enableColumnDnD(dropTodo); enableColumnDnD(dropDoing); enableColumnDnD(dropDone);

    function taskCard(t){
      const div=document.createElement('div');
      div.className='task';
      if (t.id===selectedId) div.classList.add('selected');
      div.setAttribute('draggable','true');
      div.addEventListener('dragstart', ev=>{ draggingId=t.id; ev.dataTransfer.setData('text/plain', String(t.id)); });

      const pname=getProjectName(t.projectId);
      div.innerHTML=`
        <div class="task-title">${escapeHtml(t.title||'')}</div>
        <div class="task-meta">Est: ${t.estimatedHours??'-'}h${t.realHours?(' · Real: '+t.realHours+'h'):''} · Proy: ${escapeHtml(pname)}</div>
        <div class="task-meta">${escapeHtml(t.assigneeName||'')} (${escapeHtml(t.assigneeId||'')})</div>
      `;

      const actions=document.createElement('div'); actions.className='task-actions';
      const bEdit=document.createElement('button'); bEdit.className='btn-xs edit'; bEdit.textContent='Editar…'; bEdit.onclick=e=>{e.stopPropagation();openEdit(t);}; actions.appendChild(bEdit);
      if ((t.status||'').toLowerCase()!=='done'){ const bComplete=document.createElement('button'); bComplete.className='btn-xs complete'; bComplete.textContent='Completar…'; bComplete.onclick=e=>{e.stopPropagation();openComplete(t.id);}; actions.appendChild(bComplete); }
      const bDelete=document.createElement('button'); bDelete.className='btn-xs delete'; bDelete.textContent='Eliminar…'; bDelete.onclick=e=>{e.stopPropagation();openDelete(t.id,t.title);}; actions.appendChild(bDelete);

      div.appendChild(actions);
      div.onclick=()=>{ selectedId=t.id; renderBoard(allTasks); showDetails(t); };
      return div;
    }

    function showDetails(t){
      if (!t){ detailsCard.classList.remove('open'); return; }
      detailsCard.classList.add('open');
      d_title.textContent=t.title||'—';

      const st=(t.status||'todo').toLowerCase();
      d_status.textContent=st;
      d_status.className=`badge status ${st}`;

      d_project.textContent=getProjectName(t.projectId);
      d_assignee.textContent=`${t.assigneeName||'—'} ${t.assigneeId?('('+t.assigneeId+')'):''}`;
      d_est.textContent=t.estimatedHours??0;
      d_real.textContent=t.realHours??0;
      d_created.textContent=fmt(t.createdAt);
      d_completed.textContent=fmt(t.completedAt);
      d_desc.textContent=t.description||'—';

      d_edit_btn.onclick=()=>openEdit(t);
      if (st==='done'){ d_complete_btn.style.display='none'; }
      else { d_complete_btn.style.display='inline-block'; d_complete_btn.onclick=()=>openComplete(t.id); }
      d_delete_btn.onclick=()=>openDelete(t.id,t.title);
    }

    function renderBoard(list){
      colTodo.innerHTML=''; colDoing.innerHTML=''; colDone.innerHTML='';
      let doneCount=0;
      list.forEach(t=>{
        const s=(t.status||'todo').toLowerCase();
        if (s==='done') doneCount++;
        const card=taskCard(t);
        if (s==='doing') colDoing.appendChild(card);
        else if (s==='done') colDone.appendChild(card);
        else colTodo.appendChild(card);
      });
      const pct=list.length?Math.round((doneCount/list.length)*100):0;
      progressBar.style.width=pct+'%';
      progressPct.textContent=pct+'%';

      if (selectedId){
        const sel=list.find(x=>x.id===selectedId);
        if (sel) showDetails(sel); else { selectedId=null; detailsCard.classList.remove('open'); }
      }
    }

    // Placeholders para modales (si ya tienes los tuyos, reemplázalos)
    function openEdit(t){ alert('Implementa tu modal de edición (ID: '+t.id+').'); }
    function openComplete(id){ alert('Implementa tu modal de completar (ID: '+id+').'); }
    function openDelete(id,title){
      if (confirm(`¿Eliminar "${title}"?`)){
        fetch(`${TASKS_API}/${id}`, { method:'DELETE', headers: authHeaders() }).then(()=>loadBoard());
      }
    }

    // CARGA
    async function loadBoard(){
      masterTasks = await loadAllTasks();

      // Añade placeholders solo si faltan
      const ids=new Set();
      for (const t of masterTasks){
        if (t.projectId!=null){
          const key=String(t.projectId); ids.add(key);
          if (!PROJECTS_BY_ID.has(key)) PROJECTS_BY_ID.set(key, `Proyecto #${t.projectId}`);
        }
      }
      populateProjectSelect();

      const selId = filterProject.value;
      allTasks = selId ? masterTasks.filter(t=>String(t.projectId)===selId) : masterTasks;
      renderBoard(allTasks);

      await loadVisibleProjectsForUser();
      await Promise.all([...ids].map(id=>ensureProjectName(id)));
    }

    filterProject.onchange=loadBoard;
    document.addEventListener('DOMContentLoaded', loadBoard);
  </script>
</body>
</html>
