<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Detalle del Proyecto</title>
  <link rel="stylesheet" href="Css/homework-project.css"/>
  <link href="https://api.fontshare.com/v2/css?f[]=panchang@500,600,700,800,900&display=swap" rel="stylesheet">

  <!-- Sprite de √≠conos -->
  <svg xmlns="http://www.w3.org/2000/svg" style="display:none">
    <symbol id="i-dashboard" viewBox="0 0 24 24" fill="none" stroke="currentColor">
      <path stroke-width="1.6" d="M3 3h8v8H3zM13 3h8v5h-8zM13 10h8v11h-8zM3 13h8v8H3z"/>
    </symbol>
    <symbol id="i-users" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round">
      <path d="M17 21v-2a4 4 0 0 0-3-3.87"/>
      <path d="M7 21v-2a4 4 0 0 1 3-3.87"/>
      <circle cx="12" cy="7" r="4"/>
      <path d="M5.5 8a3.5 3.5 0 1 0 0 7"/>
      <path d="M18.5 8a3.5 3.5 0 1 1 0 7"/>
    </symbol>
    <symbol id="i-folder" viewBox="0 0 24 24" fill="none" stroke="currentColor">
      <path stroke-width="1.6" d="M3 7h6l2 2h10v9a3 3 0 0 1-3 3H6a3 3 0 0 1-3-3z"/>
    </symbol>
    <symbol id="i-board" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <rect width="8" height="4" x="8" y="2" rx="1" ry="1"/>
      <path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"/>
      <path d="M12 11h4"/><path d="M12 16h4"/>
      <path d="M8 11h.01"/><path d="M8 16h.01"/>
    </symbol>
    <symbol id="i-chart" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round">
      <path d="M12 16v5"/><path d="M16 14v7"/><path d="M20 10v11"/>
      <path d="m22 3-8.646 8.646a.5.5 0 0 1-.708 0L9.354 8.354a.5.5 0 0 0-.707 0L2 15"/>
      <path d="M4 18v3"/><path d="M8 14v7"/>
    </symbol>
    <symbol id="i-bot" viewBox="0 0 24 24" fill="none" stroke="currentColor">
      <rect x="4" y="8" width="16" height="10" rx="4" stroke-width="1.6"/>
      <circle cx="9" cy="13" r="1" stroke-width="1.6"/>
      <circle cx="15" cy="13" r="1" stroke-width="1.6"/>
      <path stroke-width="1.6" d="M12 4v2m-7 6H4m16 0h1"/>
    </symbol>
    <symbol id="i-bell" viewBox="0 0 24 24" fill="none" stroke="currentColor">
      <path stroke-width="1.6" d="M18 8a6 6 0 1 0-12 0c0 7-3 7-3 7h18s-3 0-3-7"/>
      <path stroke-width="1.6" d="M13.73 21a2 2 0 0 1-3.46 0"/>
    </symbol>
    <symbol id="i-gear" viewBox="0 0 24 24" fill="none" stroke="currentColor">
      <circle cx="12" cy="12" r="3" />
      <path stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round" d="M9.671 4.136a2.34 2.34 0 0 1 4.659 0 2.34 2.34 0 0 0 3.319 1.915 2.34 2.34 0 0 1 2.33 4.033 2.34 2.34 0 0 0 0 3.831 2.34 2.34 0 0 1-2.33 4.033 2.34 2.34 0 0 0-3.319 1.915 2.34 2.34 0 0 1-4.659 0 2.34 2.34 0 0 0-3.32-1.915 2.34 2.34 0 0 1-2.33-4.033 2.34 2.34 0 0 0 0-3.831A2.34 2.34 0 0 1 6.35 6.051a2.34 2.34 0 0 0 3.319-1.915" />
    </symbol>
    <symbol id="i-exit" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <path d="m16 17 5-5-5-5"/>
      <path d="M21 12H9"/>
      <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/>
    </symbol>
    <symbol id="i-edit" viewBox="0 0 24 24" fill="none" stroke="currentColor">
      <path stroke-width="1.6" d="M12 20h9"/><path stroke-width="1.6" d="M16.5 3.5a2.1 2.1 0 0 1 3 3L7 19l-4 1 1-4 12.5-12.5z"/>
    </symbol>
    <symbol id="i-trash" viewBox="0 0 24 24" fill="none" stroke="currentColor">
      <path d="M3 6h18" stroke-width="1.6"/>
      <path d="M8 6V4h8v2" stroke-width="1.6"/>
      <rect x="6" y="6" width="12" height="14" rx="2" stroke-width="1.6"/>
      <path d="M10 11v6M14 11v6" stroke-width="1.6"/>
    </symbol>
    <symbol id="i-plus" viewBox="0 0 24 24" fill="none" stroke="currentColor">
      <path stroke-width="2" d="M12 5v14M5 12h14"/>
    </symbol>
  </svg>

  <style>
    .page-actions{ display:flex; align-items:center; justify-content:space-between; gap:10px; margin-bottom:14px }
    .page-actions .right-actions{ display:flex; gap:10px; align-items:center }
    .btn-fab .ico{ width:18px; height:18px }
    .member-item { display:flex; align-items:center; justify-content:space-between; padding:8px 10px; border:1px solid var(--line); border-radius:10px; margin:6px 0; background:#fff }
    .member-name { font-weight:700 }
    .role-badge { font-size:12px; padding:2px 8px; border-radius:999px; border:1px solid var(--line); background:#f8fafc }
    .role-badge.admin { background:#fff4f3 }
    .role-badge.super { background:#fff8e6 }
    .role-badge.user  { background:#e9fff0 }
    .confirm-overlay{ position:fixed; inset:0; background:rgba(0,0,0,.4); display:none; align-items:center; justify-content:center; z-index:9999 }
    .confirm-overlay.open{ display:flex }
    .confirm-box{ width:420px; max-width:95%; background:#fff; border-radius:16px; padding:18px 20px; box-shadow:0 8px 32px rgba(0,0,0,.25) }
    .confirm-title{ font-weight:800; font-size:16px; margin-bottom:6px }
    .confirm-msg{ color:#334155; font-size:14px }
    .confirm-actions{ margin-top:14px; display:flex; justify-content:flex-end; gap:10px }
  </style>
</head>

<body>
  <!-- Topbar -->
  <header class="topbar">
    <div class="brand">
      <h1 class="logo-text">TMDV</h1>
    </div>
    <div class="topbar-right">
      <div class="user-circle" title="Usuario">U</div>
      <a href="/index.html" class="logout-btn">
        <svg class="ico-sm" aria-hidden="true"><use href="#i-exit"/></svg>
        <span>Salir</span>
      </a>
    </div>
  </header>

  <div class="app">
    <aside class="aside">
      <nav class="menu">
        <a class="mi" href="/dashboard.html"><svg class="ico"><use href="#i-dashboard"/></svg><span>Dashboard</span></a>
        <a class="mi" href="/Equipos.html"><svg class="ico"><use href="#i-users"/></svg><span>Equipos</span></a>
        <a class="mi active" href="/projects.html"><svg class="ico"><use href="#i-folder"/></svg><span>Proyectos</span></a>
        <a class="mi" href="/tarea.html"><svg class="ico"><use href="#i-board"/></svg><span>Tareas</span></a>
        <a class="mi" href="/KPIs.html"><svg class="ico"><use href="#i-chart"/></svg><span>KPIs</span></a>
        <a class="mi" href="/chatbot.html"><svg class="ico"><use href="#i-bot"/></svg><span>Chatbot</span></a>
        <a class="mi" href="/notifications.html"><svg class="ico"><use href="#i-bell"/></svg><span>Notificaciones</span></a>
        <a class="mi" href="/settings.html"><svg class="ico"><use href="#i-gear"/></svg><span>Ajustes</span></a>
      </nav>
    </aside>

    <main class="container container-wide">
      <div class="page-actions">
        <a href="projects.html" class="btn btn-outline">‚Üê Volver</a>
        <div class="right-actions">
          <button id="btn-editar" class="btn btn-primary">Editar proyecto</button>
        </div>
      </div>

      <!-- Hero Proyecto -->
      <section class="card hero-card">
        <div class="hero-head">
          <h1 class="project-title" id="vm-nombre">Nombre del proyecto</h1>
          <div class="meta-row">
            <span id="vm-desc" class="project-desc">Descripci√≥n del proyecto‚Ä¶</span>
            <span class="team-pill">Equipo <strong id="vm-equipo">‚Äî</strong></span>
          </div>
        </div>

        <div class="status-advance">
          <div class="status-chip-wrap">
            <span id="vm-estado-chip" class="chip">‚Äî</span>
          </div>

          <div class="progress-layout">
            <div class="radial-wrap">
              <div id="vm-radial" class="radial-progress" style="--p:0">
                <span id="vm-percent">0%</span>
              </div>
            </div>

            <div class="board">
              <div class="stat-card">
                <div class="label">Inicio</div>
                <div class="value" id="vm-inicio">‚Äî</div>
              </div>
              <div class="stat-card">
                <div class="label">Fin</div>
                <div class="value" id="vm-fin">‚Äî</div>
              </div>
              <div class="stat-card" style="grid-column: 1 / -1">
                <div class="label">Avance por tareas</div>
                <div class="progress" style="margin-top:8px"><span id="vm-bar" style="width:0%"></span></div>
                <div class="tiny muted" id="tasks-summary" style="margin-top:6px">0/0 completadas</div>
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- Tareas + Integrantes -->
      <section class="two-col">
        <div class="col">
          <section class="tasks-card">
            <div class="tasks-head">
              <h2 class="h6">Tareas del proyecto</h2>
              <button id="btn-open-task-modal" class="btn-fab">
                <svg class="ico" aria-hidden="true"><use href="#i-plus"/></svg>
                Crear tarea
              </button>
            </div>
            <div id="tasks-list" class="tasks-list">
              <div class="muted" style="padding:6px 0 12px">Cargando tareas‚Ä¶</div>
            </div>
          </section>
        </div>

        <aside class="col">
          <section class="card members-card">
            <div class="members-head">
              <h2 class="h6">Integrantes del equipo</h2>
              <span id="members-count" class="tiny muted">‚Äî</span>
            </div>
            <div id="members-list" class="members-list">
              <div class="muted">Cargando integrantes‚Ä¶</div>
            </div>
          </section>
        </aside>
      </section>
    </main>
  </div>

  <div id="toast-stack" class="toast-stack" aria-live="polite" aria-atomic="true"></div>

  <!-- Confirmaci√≥n -->
  <div id="confirm-overlay" class="confirm-overlay" aria-hidden="true">
    <div class="confirm-box" role="dialog" aria-modal="true" aria-labelledby="confirm-title">
      <div class="confirm-title" id="confirm-title">Confirmar acci√≥n</div>
      <div id="confirm-msg" class="confirm-msg">¬øSeguro que deseas borrar esta tarea?</div>
      <div class="confirm-actions">
        <button id="confirm-cancel" class="btn btn-outline">Cancelar</button>
        <button id="confirm-yes" class="btn btn-danger">S√≠, borrar</button>
      </div>
    </div>
  </div>

  <!-- Modal Edici√≥n Proyecto -->
  <div id="edit-modal-overlay" class="edit-modal-overlay" aria-hidden="true">
    <div class="edit-modal" role="dialog" aria-modal="true" aria-labelledby="edit-modal-title">
      <div class="edit-modal-header">
        <h2 class="h6" id="edit-modal-title">Editar proyecto <span id="p-id">‚Äî</span></h2>
        <button id="btn-close-modal" class="icon-btn" aria-label="Cerrar">‚úï</button>
      </div>
      <div class="edit-modal-body">
        <div class="grid2">
          <div class="field">
            <label>Nombre</label>
            <input id="p-nombre" type="text" placeholder="Nombre del proyecto">
          </div>
          <div class="field">
            <label>Equipo ID</label>
            <input id="p-equipo" type="number" min="1" placeholder="Ej. 1">
          </div>
          <div class="field field-full">
            <label>Descripci√≥n</label>
            <input id="p-desc" type="text" placeholder="Breve descripci√≥n">
          </div>
          <div class="field">
            <label>Inicio</label>
            <input id="p-inicio" type="date">
          </div>
          <div class="field">
            <label>Fin</label>
            <input id="p-fin" type="date">
          </div>
        </div>
      </div>
      <div class="edit-modal-footer" style="display:flex; justify-content:flex-end; gap:10px; margin-top:10px;">
        <button id="btn-cancelar" class="btn btn-outline">Cancelar</button>
        <button id="btn-guardar" class="btn btn-primary">Guardar</button>
      </div>
    </div>
  </div>

  <!-- Modal Crear Tarea -->
  <div id="task-create-overlay" class="edit-modal-overlay task-modal" aria-hidden="true">
    <div class="edit-modal" role="dialog" aria-modal="true" aria-labelledby="task-create-title">
      <div class="edit-modal-header">
        <h2 class="h6" id="task-create-title">Crear tarea</h2>
        <button id="btn-close-task-create" class="icon-btn" aria-label="Cerrar">‚úï</button>
      </div>
      <div class="edit-modal-body">
        <div class="grid2">
          <div class="field field-full">
            <label>T√≠tulo <span class="tiny muted">(obligatorio)</span></label>
            <input id="ct-title" type="text" placeholder="Ej. Dise√±ar mockups de login">
          </div>

          <div class="field">
            <label>Horas estimadas (‚â§ 4)</label>
            <input id="ct-estimated" type="number" step="0.5" min="0" max="4" placeholder="Ej. 2">
          </div>

          <div class="field">
            <label>Prioridad</label>
            <select id="ct-priority">
              <option value="">Seleccionar</option>
              <option>Alta</option>
              <option>Media</option>
              <option>Baja</option>
            </select>
          </div>

          <!-- (opcional en UI) Fecha l√≠mite -->
          <div class="field">
            <label>Fecha l√≠mite (vencimiento)</label>
            <input id="ct-due" type="date" />
          </div>

          <!-- Asignado a -->
          <div class="field field-full">
            <label>Asignado a</label>
            <select id="ct-assignee">
              <option value="">Seleccionar miembro del equipo</option>
            </select>
            <div class="hint tiny muted">Solo se muestra nombre y rol.</div>
          </div>

          <div class="field field-full">
            <label>Descripci√≥n <span class="tiny muted">(m√°x. 300)</span></label>
            <textarea id="ct-desc" placeholder="Breve detalle de la tarea‚Ä¶" rows="4"></textarea>
          </div>
        </div>
      </div>
      <div class="edit-modal-footer" style="display:flex; justify-content:flex-end; gap:10px;">
        <button id="btn-cancel-task-create" class="btn btn-outline">Cancelar</button>
        <button id="btn-save-task-create" class="btn btn-primary">Crear</button>
      </div>
    </div>
  </div>

  <!-- Modal Editar Tarea -->
  <div id="task-edit-overlay" class="edit-modal-overlay task-modal" aria-hidden="true">
    <div class="edit-modal" role="dialog" aria-modal="true" aria-labelledby="task-edit-title">
      <div class="edit-modal-header">
        <h2 class="h6" id="task-edit-title">Editar tarea <span id="et-id">‚Äî</span></h2>
        <button id="btn-close-task-edit" class="icon-btn" aria-label="Cerrar">‚úï</button>
      </div>
      <div class="edit-modal-body">
        <div class="grid2">
          <div class="field field-full">
            <label>T√≠tulo</label>
            <input id="et-title" type="text" placeholder="T√≠tulo de la tarea">
          </div>

          <div class="field">
            <label>Horas estimadas (‚â§ 4)</label>
            <input id="et-estimated" type="number" step="0.5" min="0" max="4" placeholder="Ej. 2">
          </div>

          <div class="field">
            <label>Prioridad</label>
            <select id="et-priority">
              <option value="">Seleccionar</option>
              <option>Alta</option>
              <option>Media</option>
              <option>Baja</option>
            </select>
          </div>

          <!-- (opcional en UI) Fecha l√≠mite -->
          <div class="field">
            <label>Fecha l√≠mite (vencimiento)</label>
            <input id="et-due" type="date" />
          </div>

          <div class="field field-full">
            <label>Asignado a</label>
            <select id="et-assignee">
              <option value="">Seleccionar miembro del equipo</option>
            </select>
          </div>

          <div class="field field-full">
            <label>Descripci√≥n</label>
            <textarea id="et-desc" placeholder="Breve detalle‚Ä¶" rows="4"></textarea>
          </div>
        </div>
      </div>
      <div class="edit-modal-footer" style="display:flex; justify-content:flex-end; gap:10px;">
        <button id="btn-cancel-task-edit" class="btn btn-outline">Cancelar</button>
        <button id="btn-save-task-edit" class="btn btn-primary">Guardar</button>
      </div>
    </div>
  </div>

  <script>
    /* ================== CONFIG ================== */
    const API_BASE     = "http://localhost:8080/proyectos";
    const TASKS_API    = "http://localhost:8080/api/tasks";
    const EQUIPOS_API  = "http://localhost:8080/equipos";
    const USUARIOS_API = "http://localhost:8080/usuarios";

    /* ========= UTIL ========= */
    function qs(name){ return new URL(window.location.href).searchParams.get(name); }
    function estadoToChipClass(estado){
      switch((estado||"").toLowerCase()){
        case "pendiente": return "chip state-pend";
        case "en curso":  return "chip state-run";
        case "finalizado":return "chip state-done";
        default: return "chip";
      }
    }
    function fmtFecha(iso){ if(!iso) return "‚Äî"; const d = new Date(iso); return isNaN(d.getTime()) ? iso : d.toLocaleDateString(); }
    function toISODateInput(iso){ if(!iso) return ""; const d = new Date(iso); if (isNaN(d.getTime())) return iso; const yy=d.getFullYear(),mm=String(d.getMonth()+1).padStart(2,"0"),dd=String(d.getDate()).padStart(2,"0"); return `${yy}-${mm}-${dd}`; }
    function escapeHtml(s){ return String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]) ); }
    function easeInOut(t){ return t<.5 ? 2*t*t : 1 - Math.pow(-2*t+2,2)/2; }
    function getRadialPercent(el){ const v = getComputedStyle(el).getPropertyValue('--p').trim(); const n = parseFloat(v||'0'); return isNaN(n)?0:n; }
    function setRadialAnimated(el, toPercent, labelEl, duration=600){
      const from = getRadialPercent(el); const to = Math.max(0, Math.min(100, toPercent|0));
      if (from === to){ if(labelEl) labelEl.textContent = to + "%"; el.style.setProperty('--p', to); return; }
      const start = performance.now();
      function step(now){ const t = Math.min(1, (now-start)/duration); const eased = easeInOut(t);
        const val = Math.round(from + (to-from)*eased);
        el.style.setProperty('--p', val); if (labelEl) labelEl.textContent = val + "%";
        if (t<1) requestAnimationFrame(step);
      }
      requestAnimationFrame(step);
    }
    function addDays(d, n){ const c = new Date(d); c.setDate(c.getDate()+n); return c; }
    function fmtYMD(d){ const yy=d.getFullYear(),mm=String(d.getMonth()+1).padStart(2,"0"),dd=String(d.getDate()).padStart(2,"0"); return `${yy}-${mm}-${dd}`; }
    function isValidYMD(s){
      if(!/^\d{4}-\d{2}-\d{2}$/.test(s)) return false;
      const [y,m,dd] = s.split("-").map(Number);
      const d = new Date(s+"T00:00:00");
      return d.getFullYear()===y && (d.getMonth()+1)===m && d.getDate()===dd;
    }

    /* ========= SESI√ìN ========= */
    const sessionUser  = JSON.parse(localStorage.getItem("user") || "null");
    const sessionEmail = sessionUser?.email || "";
    const $userInitial = document.querySelector(".user-circle");
    if ($userInitial && (sessionUser?.nombre || sessionUser?.email)) {
      const ch = (sessionUser?.nombre?.trim()?.[0] ?? sessionUser?.email?.trim()?.[0] ?? "U").toUpperCase();
      $userInitial.textContent = ch;
    }
    function mustHaveEmail(){
      if(!sessionEmail){ showToast({type:"error", title:"Sesi√≥n requerida", message:"Inicia sesi√≥n para gestionar tareas."}); throw new Error("No session email"); }
    }

    /* ========= TOASTS ========= */
    const $toastStack = document.getElementById('toast-stack');
    function showToast({type="success", title="Listo", message="", timeout=3000}={}){
      const item = document.createElement('div');
      item.className = `toast ${type}`;
      item.innerHTML = `
        <div class="toast-icon">${type==="success"?"‚úÖ":type==="error"?"‚ö†Ô∏è":"‚ÑπÔ∏è"}</div>
        <div class="toast-body">
          <div class="toast-title">${title}</div>
          ${message?`<div class="toast-msg">${message}</div>`:""}
          <div class="toast-progress"></div>
        </div>
        <button class="toast-close" aria-label="Cerrar">‚úï</button>
      `;
      $toastStack.appendChild(item);
      const dismiss = ()=>{ item.classList.remove('show'); setTimeout(()=> item.remove(), 180); };
      item.querySelector('.toast-close').onclick = dismiss;
      setTimeout(()=> item.classList.add('show'), 10);
      const bar = item.querySelector('.toast-progress');
      bar.style.animationDuration = `${timeout}ms`;
      const auto = setTimeout(dismiss, timeout);
      item.addEventListener('mouseenter', ()=>{ bar.style.animationPlayState="paused"; clearTimeout(auto); });
      item.addEventListener('mouseleave', ()=>{ bar.style.animationPlayState="running"; setTimeout(dismiss, 1200); });
    }

    /* ========= REFS VISTA ========= */
    const $vmNombre = document.getElementById("vm-nombre");
    const $vmEquipo = document.getElementById("vm-equipo");
    const $vmDesc   = document.getElementById("vm-desc");
    const $vmEstadoChip = document.getElementById("vm-estado-chip");
    const $vmRadial = document.getElementById("vm-radial");
    const $vmPercent= document.getElementById("vm-percent");
    const $vmBar    = document.getElementById("vm-bar");
    const $vmIni    = document.getElementById("vm-inicio");
    const $vmFin    = document.getElementById("vm-fin");
    const $tasksSummary = document.getElementById("tasks-summary");

    const $btnEditar = document.getElementById("btn-editar");
    const $tasksListEl  = document.getElementById("tasks-list");

    // Crear Tarea
    const $taskCreateOverlay = document.getElementById("task-create-overlay");
    const $btnOpenTaskModal  = document.getElementById("btn-open-task-modal");
    const $btnCloseTaskCreate= document.getElementById("btn-close-task-create");
    const $btnCancelTaskCreate= document.getElementById("btn-cancel-task-create");
    const $btnSaveTaskCreate = document.getElementById("btn-save-task-create");
    const $ctTitle     = document.getElementById("ct-title");
    const $ctEstimated = document.getElementById("ct-estimated");
    const $ctPriority  = document.getElementById("ct-priority");
    const $ctDesc      = document.getElementById("ct-desc");
    const $ctAssignee  = document.getElementById("ct-assignee");

    // Editar Tarea
    const $taskEditOverlay = document.getElementById("task-edit-overlay");
    const $btnCloseTaskEdit= document.getElementById("btn-close-task-edit");
    const $btnCancelTaskEdit= document.getElementById("btn-cancel-task-edit");
    const $btnSaveTaskEdit = document.getElementById("btn-save-task-edit");
    const $etId = document.getElementById("et-id");
    const $etTitle     = document.getElementById("et-title");
    const $etEstimated = document.getElementById("et-estimated");
    const $etPriority  = document.getElementById("et-priority");
    const $etDesc      = document.getElementById("et-desc");
    const $etAssignee  = document.getElementById("et-assignee");

    /* ========= ESTADO ========= */
    let proyectoActual = null;
    let tareasCache = [];
    let teamMembersCache = []; // [{usuarioId, rol, nombre, email}]
    let isTeamAdmin = false;   // üîë

    /* ========= MODALES ========= */
    function openEl(ov){ ov.classList.add("open"); ov.setAttribute("aria-hidden","false"); }
    function closeEl(ov){ ov.classList.remove("open"); ov.setAttribute("aria-hidden","true"); }

    $btnOpenTaskModal?.addEventListener("click", ()=>{ populateAssigneeSelect($ctAssignee); openEl($taskCreateOverlay); });
    $btnCloseTaskCreate?.addEventListener("click", ()=> closeEl($taskCreateOverlay));
    $btnCancelTaskCreate?.addEventListener("click", (e)=>{ e.preventDefault(); closeEl($taskCreateOverlay); });

    $btnCloseTaskEdit?.addEventListener("click", ()=> closeEl($taskEditOverlay));
    $btnCancelTaskEdit?.addEventListener("click", (e)=>{ e.preventDefault(); closeEl($taskEditOverlay); });

    /* ========= CONFIRM DIALOG ========= */
    const $confirm = document.getElementById('confirm-overlay');
    function confirmDialog(message="¬øSeguro que deseas continuar?"){
      return new Promise(resolve=>{
        document.getElementById('confirm-msg').textContent = message;
        openEl($confirm);
        const onYes = ()=>{ cleanup(); resolve(true); };
        const onNo  = ()=>{ cleanup(); resolve(false); };
        function cleanup(){
          document.getElementById('confirm-yes').removeEventListener('click', onYes);
          document.getElementById('confirm-cancel').removeEventListener('click', onNo);
          closeEl($confirm);
        }
        document.getElementById('confirm-yes').addEventListener('click', onYes, {once:true});
        document.getElementById('confirm-cancel').addEventListener('click', onNo, {once:true});
        $confirm.addEventListener('click', (e)=>{ if(e.target===$confirm) onNo(); }, {once:true});
        document.addEventListener('keydown', function esc(e){ if(e.key==='Escape'){ onNo(); document.removeEventListener('keydown', esc); } }, {once:true});
      });
    }

    /* ========= MODAL HORAS (DIN√ÅMICO) ========= */
    function ensureHoursModal(){
      let el = document.getElementById('hours-overlay');
      if (el) return el;
      const tpl = document.createElement('div');
      tpl.id = 'hours-overlay';
      tpl.className = 'edit-modal-overlay';
      tpl.setAttribute('aria-hidden','true');
      tpl.innerHTML = `
        <div class="edit-modal" role="dialog" aria-modal="true" aria-labelledby="hours-title" style="max-width:420px">
          <div class="edit-modal-header">
            <h2 class="h6" id="hours-title">¬øCu√°ntas horas reales te tom√≥?</h2>
            <button id="hours-close" class="icon-btn" aria-label="Cerrar">‚úï</button>
          </div>
          <div class="edit-modal-body">
            <div class="field">
              <label>Horas reales (0 - 12)</label>
              <input id="hours-input" type="number" step="0.25" min="0" max="12" placeholder="Ej. 2.5">
            </div>
            <div class="tiny muted" style="margin-top:8px">Este dato se guardar√° junto con el estado "done".</div>
          </div>
          <div class="edit-modal-footer" style="display:flex; justify-content:flex-end; gap:10px;">
            <button id="hours-cancel" class="btn btn-outline">Cancelar</button>
            <button id="hours-ok" class="btn btn-primary">Guardar</button>
          </div>
        </div>
      `;
      document.body.appendChild(tpl);
      return tpl;
    }
    function askRealHours(){
      return new Promise(resolve=>{
        const ov = ensureHoursModal();
        const $inp = ov.querySelector('#hours-input');
        const $ok = ov.querySelector('#hours-ok');
        const $cancel = ov.querySelector('#hours-cancel');
        const $close = ov.querySelector('#hours-close');
        $inp.value = '';
        openEl(ov);
        function done(v){ cleanup(); resolve(v); }
        function cleanup(){
          $ok.removeEventListener('click', onOk);
          $cancel.removeEventListener('click', onCancel);
          $close.removeEventListener('click', onCancel);
          ov.removeEventListener('click', onBg);
          closeEl(ov);
        }
        function onOk(){
          const num = Number($inp.value);
          if (Number.isNaN(num) || num < 0 || num > 12){
            showToast({type:"error", title:"Horas inv√°lidas", message:"Ingresa un n√∫mero entre 0 y 12."});
            return;
          }
          done(num);
        }
        function onCancel(){ done(null); }
        function onBg(e){ if (e.target===ov) onCancel(); }
        $ok.addEventListener('click', onOk);
        $cancel.addEventListener('click', onCancel);
        $close.addEventListener('click', onCancel);
        ov.addEventListener('click', onBg);
        setTimeout(()=> $inp.focus(), 50);
      });
    }

    /* ========= PROYECTO ========= */
    async function fetchEquipoNombre(equipoId){
      if (equipoId == null) return "‚Äî";
      try{ const res = await fetch(`${EQUIPOS_API}/${equipoId}`); if(!res.ok) return `Equipo #${equipoId}`;
        const eq = await res.json(); return eq.nombreEquipo || `Equipo #${equipoId}`;
      }catch(_){ return `Equipo #${equipoId}`; }
    }

    async function pintarView(p){
      $vmNombre.textContent = p.nombreProyecto || "‚Äî";
      $vmDesc.textContent   = p.descripcion || "‚Äî";
      $vmEstadoChip.className = estadoToChipClass(p.estado);
      $vmEstadoChip.textContent = p.estado || "‚Äî";
      $vmIni.textContent = fmtFecha(p.fechaInicio);
      $vmFin.textContent = fmtFecha(p.fechaFin);
      const teamName = await fetchEquipoNombre(p.equipoId);
      $vmEquipo.textContent = teamName;
      const initialPct = (p.estado==="Finalizado") ? 100 : (p.estado==="En curso" ? 50 : 0);
      setRadialAnimated($vmRadial, initialPct, $vmPercent, 600);
      $vmBar.style.width = initialPct + "%";
    }

    async function cargarProyecto(){
      const id = qs("id");
      if(!id){ showToast({type:"error", title:"Falta el id", message:"No se encontr√≥ ?id en la URL"}); window.location.href = "projects.html"; return; }
      try{
        const res = await fetch(`${API_BASE}/${id}`);
        if(!res.ok) throw new Error("No encontrado");
        const p = await res.json();
        proyectoActual = p;
        await pintarView(p);
        await loadTeamMembers(p.equipoId);
        await loadTasks(p.id);
        await renderMembersList();
      }catch(e){
        showToast({type:"error", title:"No se pudo cargar", message:"Intenta de nuevo m√°s tarde"});
        window.location.href = "projects.html";
      }
    }

    /* ========= EDITAR PROYECTO ========= */
    const $overlay = document.getElementById("edit-modal-overlay");
    const $btnCancelar = document.getElementById("btn-cancelar");
    const $btnGuardar = document.getElementById("btn-guardar");
    const $pId = document.getElementById("p-id");
    const $nombre = document.getElementById("p-nombre");
    const $equipo = document.getElementById("p-equipo");
    const $descP  = document.getElementById("p-desc");
    const $inicio = document.getElementById("p-inicio");
    const $fin    = document.getElementById("p-fin");

    function openModal(){
      if(!proyectoActual) return;
      const p = proyectoActual;
      $pId.textContent = `#${p.id}`;
      $nombre.value = p.nombreProyecto || "";
      $equipo.value = (p.equipoId ?? "");
      $descP.value  = p.descripcion || "";
      $inicio.value = toISODateInput(p.fechaInicio);
      $fin.value    = toISODateInput(p.fechaFin);
      openEl($overlay);
    }
    function closeModal(){ closeEl($overlay); }
    $btnEditar.addEventListener("click", openModal);
    document.getElementById("btn-close-modal").addEventListener("click", closeModal);
    $overlay.addEventListener("click", (e) => { if (e.target === $overlay) closeModal(); });
    $btnCancelar.addEventListener("click", (e) => { e.preventDefault(); closeModal(); });
    $btnGuardar.addEventListener("click", async () => {
      if (!proyectoActual) return;
      const payload = {
        id: proyectoActual.id,
        nombreProyecto: $nombre.value.trim(),
        descripcion: $descP.value.trim(),
        estado: proyectoActual.estado,
        equipoId: Number($equipo.value||0),
        fechaInicio: $inicio.value || null,
        fechaFin: $fin.value || null,
        ultimoAcceso: proyectoActual.ultimoAcceso || null
      };
      try{
        const res = await fetch(`${API_BASE}/${proyectoActual.id}`, {
          method:"PUT", headers:{ "Content-Type":"application/json" }, body: JSON.stringify(payload)
        });
        if (res.ok){
          proyectoActual = await res.json();
          await pintarView(proyectoActual);
          closeModal();
          showToast({type:"success", title:"Cambios guardados", message:"El proyecto se actualiz√≥ correctamente."});
          updateProgressFromTasks();
          await loadTeamMembers(proyectoActual.equipoId);
          await renderMembersList();
        } else {
          showToast({type:"error", title:"Error al guardar", message:"Revisa los datos e int√©ntalo nuevamente."});
        }
      }catch(err){
        showToast({type:"error", title:"Error de red", message:"No se pudo conectar con el servidor."});
      }
    });
    document.addEventListener("keydown", (e)=>{ if(e.key==="Escape"){ closeModal(); closeEl($taskCreateOverlay); closeEl($taskEditOverlay); } });

    /* ========= ESTADO POR % ========= */
    async function persistProjectEstadoFromPct(pct){
      if (!proyectoActual?.id) return;
      const nuevo = (pct===0) ? "Pendiente" : (pct===100 ? "Finalizado" : "En curso");
      if (proyectoActual.estado === nuevo) return;
      const payload = {
        id: proyectoActual.id,
        nombreProyecto: proyectoActual.nombreProyecto,
        descripcion: proyectoActual.descripcion,
        estado: nuevo,
        equipoId: proyectoActual.equipoId,
        fechaInicio: proyectoActual.fechaInicio || null,
        fechaFin: proyectoActual.fechaFin || null,
        ultimoAcceso: proyectoActual.ultimoAcceso || null
      };
      try{
        const res = await fetch(`${API_BASE}/${proyectoActual.id}`, {
          method:"PUT", headers:{ "Content-Type":"application/json" }, body: JSON.stringify(payload)
        });
        if (res.ok){
          const updated = await res.json();
          proyectoActual.estado = updated.estado;
          $vmEstadoChip.className = estadoToChipClass(updated.estado);
          $vmEstadoChip.textContent = updated.estado;
        }
      }catch(e){}
    }

    /* ========= INTEGRANTES ========= */
    async function loadTeamMembers(equipoId){
      teamMembersCache = [];
      isTeamAdmin = false;
      if (!equipoId) return;
      try{
        const res = await fetch(`${EQUIPOS_API}/${equipoId}/miembros`);
        if(!res.ok) throw new Error('No se pudo obtener miembros');
        const miembros = await res.json();

        const isGlobalAdmin = ["Super Admin","Scrum Master"].includes(String(sessionUser?.rol||""));

        for (const m of miembros){
          const uid = m.id?.usuarioId ?? m.usuarioId;
          let nombre = 'Usuario #' + uid;
          let email  = null;

          try{
            const ru = await fetch(`${USUARIOS_API}/public/${uid}`);
            if(ru.ok){
              const u = await ru.json();
              nombre = u?.nombre || (u?.email ? u.email.split('@')[0] : nombre);
              email  = u?.email || null;
            }
          }catch(_){}

          teamMembersCache.push({
            usuarioId: uid,
            rol: m.rol,
            nombre,
            email
          });
        }
        const row = teamMembersCache.find(x => String(x.usuarioId) === String(sessionUser?.id));
        isTeamAdmin = isGlobalAdmin || (row && String(row.rol).toUpperCase()==="ADMIN");

        populateAssigneeSelect($ctAssignee);
        populateAssigneeSelect($etAssignee);
      }catch(_){
        teamMembersCache = [];
      }
    }

    function tinyRoleBadge(rolRaw){
      const rol = (rolRaw||'').toUpperCase();
      const cls = rol === 'ADMIN' ? 'admin' : (rol === 'USUARIO_SUPERIOR' ? 'super' : 'user');
      const text = rol === 'ADMIN' ? 'ADMIN' : (rol === 'USUARIO_SUPERIOR' ? 'USUARIO SUP.' : 'USUARIO');
      return `<span class="role-badge ${cls}">${text}</span>`;
    }

    async function renderMembersList(){
      const wrap = document.getElementById('members-list');
      const counter = document.getElementById('members-count');
      if (!wrap) return;
      if (!teamMembersCache.length){
        wrap.innerHTML = `<div class="muted">Este equipo a√∫n no tiene integrantes.</div>`;
        if (counter) counter.textContent = '0';
        return;
      }
      wrap.innerHTML = teamMembersCache.map(m => `
        <div class="member-item">
          <div class="member-name">${escapeHtml(m.nombre)}</div>
          ${tinyRoleBadge(m.rol)}
        </div>
      `).join('');
      if (counter) counter.textContent = String(teamMembersCache.length);
    }

    function populateAssigneeSelect(selectEl){
      if (!selectEl) return;
      const prev = selectEl.value || "";
      selectEl.innerHTML = `<option value="">Seleccionar miembro del equipo</option>` +
        teamMembersCache
          .map(m => `<option value="${m.usuarioId}" data-nombre="${escapeHtml(m.nombre||'')}" data-email="${escapeHtml(m.email||'')}">${escapeHtml(m.nombre||('#'+m.usuarioId))} ‚Äî ${(m.rol||'').toUpperCase()}</option>`)
          .join('');
      if (prev) selectEl.value = prev;
    }

    function resolveAssigneeNameFromTask(t){
      if (t.assigneeName) return t.assigneeName;
      if (t.assigneeId)   return t.assigneeId;
      return '-';
    }

    /* ========= TAREAS ========= */
    function canDeleteTask(t){
      if (isTeamAdmin) return true;
      return String(t.assigneeId||"").toLowerCase() === String(sessionEmail||"").toLowerCase();
    }

    function tareaRow(t){
      const isDone = (t.status||"").toLowerCase()==="done" || (t.completedAt != null) || (t.status||"").toLowerCase()==="hecho";
      const descHtml = escapeHtml(t.description || t.longDescription || "");
      const asigName = resolveAssigneeNameFromTask(t);
      return `
        <div class="task-item" data-id="${t.id}">
          <input type="checkbox" class="t-check" ${isDone ? "checked" : ""} title="Completar / Reabrir">
          <div>
            <div class="task-title">${escapeHtml(t.title || '')}</div>
            <div class="task-meta">
              Prio: ${escapeHtml(t.priority||'-')}
              ¬∑ Est: ${t.estimatedHours ?? '-'}h
              ${t.realHours ? (' ¬∑ Real: '+t.realHours+'h') : ''}
              ${t.fechaLimite?(' ¬∑ Vence: '+fmtFecha(t.fechaLimite)):''}
              ¬∑ Asig: ${escapeHtml(asigName)}
            </div>
          </div>
          <div class="task-actions">
            <span class="badge status ${isDone?'done':'todo'}">${isDone?'done':'todo'}</span>
            ${descHtml ? `<button class="desc-btn" type="button">Ver descripci√≥n</button>` : ""}
            <button class="btn-xs t-edit" title="Editar">
              <svg class="ico-sm" aria-hidden="true"><use href="#i-edit"/></svg> Editar
            </button>
            ${canDeleteTask(t) ? `
              <button class="btn-danger btn-xs t-del" title="Borrar">
                <svg class="ico-sm" aria-hidden="true"><use href="#i-trash"/></svg> Borrar
              </button>` : ""}
          </div>
          ${descHtml ? `<div class="task-desc">${descHtml}</div>` : ""}
        </div>
      `;
    }

    function updateProgressFromTasks(){
      const total = tareasCache.length;
      const done  = tareasCache.filter(t => (t.status||"").toLowerCase()==="done" || t.completedAt != null || (t.status||"").toLowerCase()==="hecho").length;
      document.getElementById("tasks-summary").textContent = `${done}/${total} completadas`;
      const pct = total === 0 ? 0 : Math.round((done/total)*100);
      setRadialAnimated($vmRadial, pct, $vmPercent, 500);
      $vmBar.style.width = pct + "%";
      persistProjectEstadoFromPct(pct);
    }

    function renderTareas(arr){
      if(!arr.length){
        $tasksListEl.innerHTML = `<div class="muted" style="padding:6px 0 12px">No hay tareas a√∫n. ¬°Crea la primera! üöÄ</div>`;
      } else {
        $tasksListEl.innerHTML = arr.map(tareaRow).join("");
      }

      $tasksListEl.querySelectorAll(".t-check").forEach(chk => {
        chk.addEventListener("change", async (e)=>{
          const row = e.target.closest(".task-item");
          const id = Number(row.dataset.id);
          const goingDone = e.target.checked;
          if (goingDone){
            const hrs = await askRealHours();
            if (hrs === null){
              e.target.checked = false;
              return;
            }
            await toggleTaskStatus(id, true, hrs);
          } else {
            await toggleTaskStatus(id, false, null);
          }
        });
      });

      $tasksListEl.querySelectorAll(".t-del").forEach(btn => {
        btn.addEventListener("click", async (e)=>{
          const row = e.target.closest(".task-item");
          const id = Number(row.dataset.id);
          const ok = await confirmDialog("¬øSeguro que deseas borrar esta tarea?");
          if (ok) await deleteTask(id);
        });
      });

      $tasksListEl.querySelectorAll(".desc-btn").forEach(btn => {
        btn.addEventListener("click", (e)=>{
          const row = e.target.closest(".task-item");
          const desc = row.querySelector(".task-desc");
          if (!desc) return;
          desc.classList.toggle("show");
          e.target.textContent = desc.classList.contains("show") ? "Ocultar descripci√≥n" : "Ver descripci√≥n";
        });
      });

      $tasksListEl.querySelectorAll(".t-edit").forEach(btn => {
        btn.addEventListener("click", (e)=>{
          const row = e.target.closest(".task-item");
          const id = Number(row.dataset.id);
          const t = tareasCache.find(x => x.id === id);
          if (!t) return;
          openTaskEditModal(t);
        });
      });

      updateProgressFromTasks();
    }

    async function loadTasks(projectId){
      try{
        const res = await fetch(`${TASKS_API}?projectId=${encodeURIComponent(projectId)}`, {
          headers: { "X-User-Id": String(sessionUser?.id || "") }
        });
        if(!res.ok) throw new Error("Error listando tareas");
        tareasCache = await res.json();
        renderTareas(tareasCache);
      }catch(err){
        $tasksListEl.innerHTML = `<div class="muted" style="padding:6px 0 12px">No se pudieron cargar las tareas.</div>`;
      }
    }

    // ==== NUEVO MENSAJE: prompt de vencimiento para CREAR tarea ====
    async function askDueDateYMD(msg = "üìÖ Ingresa la fecha de vencimiento de la tarea (formato YYYY-MM-DD)") {
      const def = fmtYMD(addDays(new Date(), 3));
      let v = window.prompt(`${msg}\nEjemplo sugerido: ${def}`, def);
      if (v == null) return null;
      v = v.trim();
      if (!isValidYMD(v)){
        showToast({type:"error", title:"Fecha inv√°lida", message:"Usa el formato YYYY-MM-DD"});
        return await askDueDateYMD(msg);
      }
      return v;
    }

    // Crear Tarea ‚Äî incluye fechaLimite requerida por backend
    async function createTask(projectId){
      mustHaveEmail();
      const title = ($ctTitle.value||"").trim();
      const description = ($ctDesc.value||"").trim();
      const estimatedHours = $ctEstimated.value ? Number($ctEstimated.value) : null;
      const priority = ($ctPriority.value||"").trim() || null;

      const assigneeSelect = $ctAssignee;
      const selectedOpt = assigneeSelect?.selectedOptions?.[0];
      const assigneeEmail = selectedOpt?.dataset?.email || sessionEmail;
      const assigneeName  = selectedOpt?.dataset?.nombre || (sessionUser?.nombre || sessionEmail);

      if (!title){ showToast({type:"error", title:"Falta t√≠tulo"}); return; }
      if ((description||"").length > 300){ showToast({type:"error", title:"Descripci√≥n muy larga", message:"M√°ximo 300 caracteres."}); return; }
      if (estimatedHours != null && estimatedHours > 4){ showToast({type:"error", title:"M√°ximo 4 horas"}); return; }

      // üîî mensaje personalizado SOLO para crear
      const fechaLimite = await askDueDateYMD("üìÖ Fecha de vencimiento (obligatoria). Formato YYYY-MM-DD");
      if (fechaLimite == null){ showToast({type:"error", title:"Creaci√≥n cancelada"}); return; }

      const payload = { 
        title, description, projectId: Number(projectId), 
        estimatedHours, priority,
        assigneeId: assigneeEmail,
        assigneeName: assigneeName,
        fechaLimite
      };
      try{
        const res = await fetch(TASKS_API, {
          method: "POST",
          headers: { "Content-Type": "application/json", "X-User-Email": sessionEmail },
          body: JSON.stringify(payload)
        });
        if (res.status === 201){
          const created = await res.json();
          tareasCache.unshift(created);
          renderTareas(tareasCache);
          $ctTitle.value = ""; $ctEstimated.value = ""; $ctPriority.value = ""; $ctDesc.value = ""; $ctAssignee.value = "";
          closeEl($taskCreateOverlay);
          showToast({type:"success", title:"Tarea creada"});
        } else {
          const text = await res.text();
          showToast({type:"error", title:"No se cre√≥", message:text || "Valida los datos."});
        }
      }catch(err){
        showToast({type:"error", title:"Error de red", message:"No se pudo crear la tarea."});
      }
    }
    document.getElementById("btn-save-task-create")?.addEventListener("click", ()=>{ if (!proyectoActual?.id) return; createTask(proyectoActual.id); });

    // ======== BORRAR TAREA (PARCHEADO) ========
    async function deleteTask(id){
      mustHaveEmail();
      const url = `${TASKS_API}/${Number(id)}`;

      // Solo headers con valores reales:
      const headers = {};
      if (sessionEmail) headers["X-User-Email"] = sessionEmail;
      if (sessionUser?.rol) headers["X-User-Role"] = String(sessionUser.rol);
      if (sessionUser?.id != null) headers["X-User-Id"] = String(sessionUser.id);

      try{
        const res = await fetch(url, {
          method: "DELETE",
          headers,
          credentials: "include" // necesario si hay sesi√≥n/cookies
        });

        if (res.status === 204){
          tareasCache = tareasCache.filter(t => t.id !== id);
          renderTareas(tareasCache);
          showToast({type:"success", title:"Tarea eliminada"});
          return;
        }

        const text = await res.text().catch(()=> "");
        const msg = `Error ${res.status}${text ? `: ${text}` : ""}`;
        console.error("DELETE /tasks error ‚Üí", msg);
        showToast({type:"error", title:"No se pudo borrar", message: text || "Revisa permisos/CORS/CSRF"});
      }catch(err){
        console.error("DELETE /tasks network error ‚Üí", err);
        showToast({type:"error", title:"Error de red"});
      }
    }

    async function toggleTaskStatus(id, toDone, realHours){
      mustHaveEmail();
      const newStatus = toDone ? "done" : "todo";
      const payload = toDone 
        ? { status: newStatus, realHours: Number(realHours), completedAt: new Date().toISOString() }
        : { status: newStatus, realHours: null, completedAt: null };

      try{
        const res = await fetch(`${TASKS_API}/${id}/status`, {
          method: "PATCH",
          headers: { "Content-Type": "application/json", "X-User-Email": sessionEmail },
          body: JSON.stringify(payload)
        });
        if (res.ok){
          const updated = await res.json();
          const idx = tareasCache.findIndex(t => t.id === id);
          if (idx >= 0) tareasCache[idx] = updated;
          renderTareas(tareasCache);
        } else {
          const text = await res.text().catch(()=> "");
          showToast({type:"error", title:"No se pudo actualizar estado", message:text});
          const chk = $tasksListEl.querySelector(`.task-item[data-id="${id}"] .t-check`);
          if (chk) chk.checked = !toDone;
        }
      }catch(err){
        showToast({type:"error", title:"Error de red", message:"No se pudo actualizar estado"});
        const chk = $tasksListEl.querySelector(`.task-item[data-id="${id}"] .t-check`);
        if (chk) chk.checked = !toDone;
      }
    }

    function openTaskEditModal(t){
      document.getElementById("et-id").textContent = `#${t.id}`;
      document.getElementById("et-title").value = t.title || "";
      document.getElementById("et-estimated").value = t.estimatedHours ?? "";
      document.getElementById("et-priority").value = t.priority || "";
      document.getElementById("et-desc").value = t.description || t.longDescription || "";
      populateAssigneeSelect(document.getElementById("et-assignee"));
      const etAssignee = document.getElementById("et-assignee");
      if (t.assigneeId) {
        const opt = [...etAssignee.options].find(o => o.dataset.email && o.dataset.email.toLowerCase() === String(t.assigneeId).toLowerCase());
        if (opt) etAssignee.value = opt.value;
      }
      openEl($taskEditOverlay);
      $btnSaveTaskEdit.onclick = () => saveTaskEdits(t.id);
    }

    async function saveTaskEdits(taskId){
      mustHaveEmail();
      const title = (document.getElementById("et-title").value||"").trim();
      const description = (document.getElementById("et-desc").value||"").trim();
      const estimatedHours = document.getElementById("et-estimated").value ? Number(document.getElementById("et-estimated").value) : null;
      const priority = (document.getElementById("et-priority").value||"").trim() || null;

      const assigneeSelect = document.getElementById("et-assignee");
      const selectedOpt = assigneeSelect?.selectedOptions?.[0];
      const assigneeEmail = selectedOpt?.dataset?.email || null;
      const assigneeName  = selectedOpt?.dataset?.nombre || null;

      if (!title){ showToast({type:"error", title:"Falta t√≠tulo"}); return; }
      if ((description||"").length > 300){ showToast({type:"error", title:"Descripci√≥n muy larga", message:"M√°ximo 300 caracteres."}); return; }
      if (estimatedHours != null && estimatedHours > 4){ showToast({type:"error", title:"M√°ximo 4 horas"}); return; }

      let fechaLimite = null;
      const changeDue = confirm("¬øQuieres actualizar la fecha l√≠mite? (Aceptar = s√≠)");
      if (changeDue){
        const v = await askDueDateYMD();
        if (v == null){ showToast({type:"info", title:"Sin cambios de fecha"}); }
        else fechaLimite = v;
      }

      const payload = { 
        title, description, estimatedHours, priority,
        assigneeId: assigneeEmail || undefined, 
        assigneeName: assigneeName || undefined,
        ...(fechaLimite ? { fechaLimite } : {})
      };
      try{
        const res = await fetch(`${TASKS_API}/${taskId}`, {
          method: "PUT",
          headers: { "Content-Type": "application/json", "X-User-Email": sessionEmail },
          body: JSON.stringify(payload)
        });
        if (res.ok){
          const updated = await res.json();
          const idx = tareasCache.findIndex(t => t.id === taskId);
          if (idx >= 0) tareasCache[idx] = updated;
          renderTareas(tareasCache);
          closeEl($taskEditOverlay);
          showToast({type:"success", title:"Tarea actualizada"});
        } else {
          const text = await res.text();
          showToast({type:"error", title:"No se pudo actualizar", message:text || ""});
        }
      }catch(err){
        showToast({type:"error", title:"Error de red"});
      }
    }

    /* ========= INICIO ========= */
    document.addEventListener("DOMContentLoaded", cargarProyecto);
  </script>
</body>
</html>
