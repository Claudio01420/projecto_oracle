<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Detalle del Proyecto</title>
  <link rel="stylesheet" href="Css/homework-project.css"/>
  <link href="https://api.fontshare.com/v2/css?f[]=panchang@500,600,700,800,900&display=swap" rel="stylesheet">

  <!-- Sprite de íconos -->
  <svg xmlns="http://www.w3.org/2000/svg" style="display:none">
    <symbol id="i-dashboard" viewBox="0 0 24 24" fill="none" stroke="currentColor">
      <path stroke-width="1.6" d="M3 3h8v8H3zM13 3h8v5h-8zM13 10h8v11h-8zM3 13h8v8H3z"/>
    </symbol>
    <symbol id="i-users" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round">
      <path d="M17 21v-2a4 4 0 0 0-3-3.87"/>
      <path d="M7 21v-2a4 4 0 0 1 3-3.87"/>
      <circle cx="12" cy="7" r="4"/>
      <path d="M5.5 8a3.5 3.5 0 1 0 0 7"/>
      <path d="M18.5 8a3.5 3.5 0 1 1 0 7"/>
    </symbol>
    <symbol id="i-folder" viewBox="0 0 24 24" fill="none" stroke="currentColor">
      <path stroke-width="1.6" d="M3 7h6l2 2h10v9a3 3 0 0 1-3 3H6a3 3 0 0 1-3-3z"/>
    </symbol>
    <symbol id="i-board" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <rect width="8" height="4" x="8" y="2" rx="1" ry="1"/>
      <path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"/>
      <path d="M12 11h4"/><path d="M12 16h4"/>
      <path d="M8 11h.01"/><path d="M8 16h.01"/>
    </symbol>
    <symbol id="i-chart" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round">
      <path d="M12 16v5"/><path d="M16 14v7"/><path d="M20 10v11"/>
      <path d="m22 3-8.646 8.646a.5.5 0 0 1-.708 0L9.354 8.354a.5.5 0 0 0-.707 0L2 15"/>
      <path d="M4 18v3"/><path d="M8 14v7"/>
    </symbol>
    <symbol id="i-bell" viewBox="0 0 24 24" fill="none" stroke="currentColor">
      <path stroke-width="1.6" d="M18 8a6 6 0 1 0-12 0c0 7-3 7-3 7h18s-3 0-3-7"/>
      <path stroke-width="1.6" d="M13.73 21a2 2 0 0 1-3.46 0"/>
    </symbol>
    <symbol id="i-gear" viewBox="0 0 24 24" fill="none" stroke="currentColor">
      <circle cx="12" cy="12" r="3" />
      <path stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round" d="M9.671 4.136a2.34 2.34 0 0 1 4.659 0 2.34 2.34 0 0 0 3.319 1.915 2.34 2.34 0 0 1 2.33 4.033 2.34 2.34 0 0 0 0 3.831 2.34 2.34 0 0 1-2.33 4.033 2.34 2.34 0 0 0-3.319 1.915 2.34 2.34 0 0 1-4.659 0 2.34 2.34 0 0 0-3.32-1.915 2.34 2.34 0 0 1-2.33-4.033 2.34 2.34 0 0 0 0-3.831A2.34 2.34 0 0 1 6.35 6.051a2.34 2.34 0 0 0 3.319-1.915" />
    </symbol>
    <symbol id="i-exit" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <path d="m16 17 5-5-5-5"/>
      <path d="M21 12H9"/>
      <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/>
    </symbol>
    <symbol id="i-edit" viewBox="0 0 24 24" fill="none" stroke="currentColor">
      <path stroke-width="1.6" d="M12 20h9"/><path stroke-width="1.6" d="M16.5 3.5a2.1 2.1 0 0 1 3 3L7 19l-4 1 1-4 12.5-12.5z"/>
    </symbol>
    <symbol id="i-trash" viewBox="0 0 24 24" fill="none" stroke="currentColor">
      <path d="M3 6h18" stroke-width="1.6"/>
      <path d="M8 6V4h8v2" stroke-width="1.6"/>
      <rect x="6" y="6" width="12" height="14" rx="2" stroke-width="1.6"/>
      <path d="M10 11v6M14 11v6" stroke-width="1.6"/>
    </symbol>
    <symbol id="i-plus" viewBox="0 0 24 24" fill="none" stroke="currentColor">
      <path stroke-width="2" d="M12 5v14M5 12h14"/>
    </symbol>
  </svg>

</head>

<body>
  <!-- Topbar -->
  <header class="topbar">
    <div class="brand">
      <h1 class="logo-text">TMDV</h1>
    </div>
    <div class="topbar-right">
      <div class="user-circle" title="Usuario">U</div>
      <a href="/index.html" class="logout-btn">
        <span>Salir</span>
      </a>
    </div>
  </header>

  <div class="app">
    <aside class="aside">
      <nav class="menu">
        <a class="mi" href="/dashboard.html"><svg class="ico"><use href="#i-dashboard"/></svg><span>Dashboard</span></a>
        <a class="mi" href="/Equipos.html"><svg class="ico"><use href="#i-users"/></svg><span>Equipos</span></a>
        <a class="mi active" href="/projects.html"><svg class="ico"><use href="#i-folder"/></svg><span>Proyectos</span></a>
        <a class="mi" href="/tarea.html"><svg class="ico"><use href="#i-board"/></svg><span>Tareas</span></a>
        <a class="mi" href="/KPIs.html"><svg class="ico"><use href="#i-chart"/></svg><span>KPIs</span></a>
        <a class="mi" href="/notifications.html"><svg class="ico"><use href="#i-bell"/></svg><span>Notificaciones</span></a>
        <a class="mi" href="/settings.html"><svg class="ico"><use href="#i-gear"/></svg><span>Ajustes</span></a>
      </nav>
    </aside>

    <main class="container container-wide">
      <div class="page-actions">
        <a href="projects.html" class="btn btn-outline">← Volver</a>
        <div class="right-actions">
          <button id="btn-editar" class="btn btn-primary">Editar proyecto</button>
        </div>
      </div>

      <!-- Hero Proyecto -->
      <section class="card hero-card">
        <div class="hero-head">
          <h1 class="project-title" id="vm-nombre">Nombre del proyecto</h1>
          <div class="meta-row">
            <span id="vm-desc" class="project-desc">Descripción del proyecto…</span>
            <span class="team-pill">Equipo <strong id="vm-equipo">—</strong></span>
          </div>
        </div>

        <div class="status-advance">
          <div class="status-chip-wrap">
            <span id="vm-estado-chip" class="chip">—</span>
          </div>

          <div class="progress-layout">
            <div class="radial-wrap">
              <div id="vm-radial" class="radial-progress" style="--p:0">
                <span id="vm-percent">0%</span>
              </div>
            </div>

            <div class="board">
              <div class="stat-card">
                <div class="label">Inicio</div>
                <div class="value" id="vm-inicio">—</div>
              </div>
              <div class="stat-card">
                <div class="label">Fin</div>
                <div class="value" id="vm-fin">—</div>
              </div>
              <div class="stat-card" style="grid-column: 1 / -1">
                <div class="label">Avance del proyecto</div>
                <div class="progress" style="margin-top:8px"><span id="vm-bar" style="width:0%"></span></div>
                <div class="tiny muted" id="tasks-summary" style="margin-top:6px">0/0 completadas</div>
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- Sprints + Integrantes -->
      <section class="two-col">
        <div class="col">
          <!-- SPRINTS -->
          <section class="tasks-card">
            <div class="tasks-head">
              <h2 class="h6">Sprints del proyecto</h2>
              <div class="sprints-actions">
                <button id="btn-new-sprint" class="btn btn-primary">
                  <svg class="ico" aria-hidden="true"><use href="#i-plus"/></svg>
                  Nuevo sprint
                </button>
              </div>
            </div>
            <div id="sprints-list" class="sprints-list">
              <div class="muted" style="padding:6px 0 12px">Cargando sprints…</div>
            </div>
          </section>
        </div>

        <aside class="col">
          <section class="card members-card">
            <div class="members-head">
              <h2 class="h6">Integrantes del equipo</h2>
              <span id="members-count" class="tiny muted">—</span>
            </div>
            <div id="members-list" class="members-list">
              <div class="muted">Cargando integrantes…</div>
            </div>
          </section>
        </aside>
      </section>
    </main>
  </div>

  <div id="toast-stack" class="toast-stack" aria-live="polite" aria-atomic="true"></div>

  <!-- Confirmación -->
  <div id="confirm-overlay" class="confirm-overlay" aria-hidden="true">
    <div class="confirm-box" role="dialog" aria-modal="true" aria-labelledby="confirm-title">
      <div class="confirm-title" id="confirm-title">Confirmar acción</div>
      <div id="confirm-msg" class="confirm-msg">¿Seguro que deseas borrar esta tarea?</div>
      <div class="confirm-actions">
        <button id="confirm-cancel" class="btn btn-outline">Cancelar</button>
        <button id="confirm-yes" class="btn btn-danger">Sí, borrar</button>
      </div>
    </div>
  </div>

  <!-- Modal Edición Proyecto -->
  <div id="edit-modal-overlay" class="edit-modal-overlay" aria-hidden="true">
    <div class="edit-modal" role="dialog" aria-modal="true" aria-labelledby="edit-modal-title">
      <div class="edit-modal-header">
        <h2 class="h6" id="edit-modal-title">Editar proyecto <span id="p-id">—</span></h2>
        <button id="btn-close-modal" class="icon-btn" aria-label="Cerrar">✕</button>
      </div>
      <div class="edit-modal-body">
        <div class="grid2">
          <div class="field">
            <label>Nombre</label>
            <input id="p-nombre" type="text" placeholder="Nombre del proyecto">
          </div>
          <div class="field">
            <label>Equipo ID</label>
            <input id="p-equipo" type="number" min="1" placeholder="Ej. 1">
          </div>
          <div class="field field-full">
            <label>Descripción</label>
            <input id="p-desc" type="text" placeholder="Breve descripción">
          </div>
          <div class="field">
            <label>Inicio</label>
            <input id="p-inicio" type="date">
          </div>
          <div class="field">
            <label>Fin</label>
            <input id="p-fin" type="date">
          </div>
        </div>
      </div>
      <div class="edit-modal-footer" style="display:flex; justify-content:flex-end; gap:10px; margin-top:10px;">
        <button id="btn-cancelar" class="btn btn-outline">Cancelar</button>
        <button id="btn-guardar" class="btn btn-primary">Guardar</button>
      </div>
    </div>
  </div>

  <!-- Modal NUEVO SPRINT (cuestionario emergente) -->
  <div id="sprint-create-overlay" class="edit-modal-overlay task-modal" aria-hidden="true">
    <div class="edit-modal" role="dialog" aria-modal="true" aria-labelledby="sprint-create-title">
      <div class="edit-modal-header">
        <h2 class="h6" id="sprint-create-title">Nuevo sprint</h2>
        <button id="btn-close-sprint-create" class="icon-btn" aria-label="Cerrar">✕</button>
      </div>
      <div class="edit-modal-body">
        <div class="grid2">
          <div class="field field-full">
            <label>Nombre / título del sprint <span class="tiny muted">(obligatorio)</span></label>
            <input id="sc-name" type="text" placeholder="Ej. Sprint 1 - Diseño">
          </div>
          <div class="field field-full">
            <label>Descripción</label>
            <textarea id="sc-desc" rows="3" placeholder="Breve descripción del objetivo del sprint..."></textarea>
          </div>
          <div class="field">
            <label>Fecha de inicio <span class="tiny muted">(obligatoria)</span></label>
            <input id="sc-start" type="date">
          </div>
          <div class="field">
            <label>Duración (días) <span class="tiny muted">(obligatoria)</span></label>
            <input id="sc-duration" type="number" min="1" max="60" step="1" placeholder="Ej. 7">
            <div class="tiny muted">Se calculará la fecha de fin automáticamente.</div>
          </div>
          <div class="field">
            <label>Número de sprint <span class="tiny muted">(obligatorio)</span></label>
            <input id="sc-number" type="number" min="1" step="1" placeholder="Ej. 1">
          </div>
        </div>
      </div>
      <div class="edit-modal-footer" style="display:flex; justify-content:flex-end; gap:10px;">
        <button id="btn-cancel-sprint-create" class="btn btn-outline">Cancelar</button>
        <button id="btn-save-sprint-create" class="btn btn-primary">Crear sprint</button>
      </div>
    </div>
  </div>

  <!-- Modal EDITAR SPRINT -->
  <div id="sprint-edit-overlay" class="edit-modal-overlay task-modal" aria-hidden="true">
    <div class="edit-modal" role="dialog" aria-modal="true" aria-labelledby="sprint-edit-title">
      <div class="edit-modal-header">
        <h2 class="h6" id="sprint-edit-title">Editar sprint <span id="se-id">—</span></h2>
        <button id="btn-close-sprint-edit" class="icon-btn" aria-label="Cerrar">✕</button>
      </div>
      <div class="edit-modal-body">
        <div class="grid2">
          <div class="field field-full">
            <label>Nombre del sprint</label>
            <input id="se-name" type="text" placeholder="Ej. Sprint 1 - Diseño">
          </div>
          <div class="field field-full">
            <label>Descripción</label>
            <textarea id="se-desc" rows="3" placeholder="Descripción del sprint..."></textarea>
          </div>
          <div class="field">
            <label>Fecha de inicio</label>
            <input id="se-start" type="date">
          </div>
          <div class="field">
            <label>Fecha de fin</label>
            <input id="se-end" type="date">
          </div>
        </div>
      </div>
      <div class="edit-modal-footer" style="display:flex; justify-content:flex-end; gap:10px;">
        <button id="btn-cancel-sprint-edit" class="btn btn-outline">Cancelar</button>
        <button id="btn-save-sprint-edit" class="btn btn-primary">Guardar cambios</button>
      </div>
    </div>
  </div>

  <!-- Modal Crear Tarea -->
  <div id="task-create-overlay" class="edit-modal-overlay task-modal" aria-hidden="true">
    <div class="edit-modal" role="dialog" aria-modal="true" aria-labelledby="task-create-title">
      <div class="edit-modal-header">
        <h2 class="h6" id="task-create-title">Crear tarea</h2>
        <button id="btn-close-task-create" class="icon-btn" aria-label="Cerrar">✕</button>
      </div>
      <div class="edit-modal-body">
        <div class="grid2">
          <div class="field field-full">
            <label>Título <span class="tiny muted">(obligatorio)</span></label>
            <input id="ct-title" type="text" placeholder="Ej. Diseñar mockups de login">
          </div>

          <div class="field">
            <label>Horas estimadas (≤ 4)</label>
            <input id="ct-estimated" type="number" step="0.5" min="0" max="4" placeholder="Ej. 2">
          </div>

          <div class="field">
            <label>Prioridad</label>
            <select id="ct-priority" class="select-dark">
              <option value="">Seleccionar</option>
              <option>Alta</option>
              <option>Media</option>
              <option>Baja</option>
            </select>
          </div>

          <div class="field">
            <label>Fecha límite (vencimiento)</label>
            <input id="ct-due" type="date" />
          </div>

          <div class="field field-full">
            <label>Asignado a</label>
            <select id="ct-assignee">
              <option value="">Seleccionar miembro del equipo</option>
            </select>
            <div class="hint tiny muted">Solo se muestra nombre y rol.</div>
          </div>

          <div class="field field-full">
            <label>Descripción <span class="tiny muted">(máx. 300)</span></label>
            <textarea id="ct-desc" placeholder="Breve detalle de la tarea…" rows="4"></textarea>
          </div>
        </div>
      </div>
      <div class="edit-modal-footer" style="display:flex; justify-content:flex-end; gap:10px;">
        <button id="btn-cancel-task-create" class="btn btn-outline">Cancelar</button>
        <button id="btn-save-task-create" class="btn btn-primary">Crear</button>
      </div>
    </div>
  </div>

  <!-- Modal Editar Tarea -->
  <div id="task-edit-overlay" class="edit-modal-overlay task-modal" aria-hidden="true">
    <div class="edit-modal" role="dialog" aria-modal="true" aria-labelledby="task-edit-title">
      <div class="edit-modal-header">
        <h2 class="h6" id="task-edit-title">Editar tarea <span id="et-id">—</span></h2>
        <button id="btn-close-task-edit" class="icon-btn" aria-label="Cerrar">✕</button>
      </div>
      <div class="edit-modal-body">
        <div class="grid2">
          <div class="field field-full">
            <label>Título</label>
            <input id="et-title" type="text" placeholder="Título de la tarea">
          </div>

          <div class="field">
            <label>Horas estimadas (≤ 4)</label>
            <input id="et-estimated" type="number" step="0.5" min="0" max="4" placeholder="Ej. 2">
          </div>

          <div class="field">
            <label>Prioridad</label>
            <select id="et-priority" class="select-dark">
              <option value="">Seleccionar</option>
              <option>Alta</option>
              <option>Media</option>
              <option>Baja</option>
            </select>
          </div>

          <div class="field">
            <label>Fecha límite (vencimiento)</label>
            <input id="et-due" type="date" />
          </div>

          <div class="field field-full">
            <label>Asignado a</label>
            <select id="et-assignee">
              <option value="">Seleccionar miembro del equipo</option>
            </select>
          </div>

          <div class="field field-full">
            <label>Descripción</label>
            <textarea id="et-desc" placeholder="Breve detalle…" rows="4"></textarea>
          </div>
        </div>
      </div>
      <div class="edit-modal-footer" style="display:flex; justify-content:flex-end; gap:10px;">
        <button id="btn-cancel-task-edit" class="btn btn-outline">Cancelar</button>
        <button id="btn-save-task-edit" class="btn btn-primary">Guardar</button>
      </div>
    </div>
  </div>

<script>
  /* ================== CONFIG ================== */
  const API_BASE      = "http://localhost:8080/proyectos";
  const TASKS_API     = "http://localhost:8080/api/tasks";
  const EQUIPOS_API   = "http://localhost:8080/equipos";
  const USUARIOS_API  = "http://localhost:8080/usuarios";
  const SPRINTS_API   = "http://localhost:8080/sprints";

  /* ========= UTIL ========= */
  function qs(name){ return new URL(window.location.href).searchParams.get(name); }

  function estadoToChipClass(estado){
    switch((estado||"").toLowerCase()){
      case "pendiente": return "chip state-pend";
      case "en curso":  return "chip state-run";
      case "finalizado":return "chip state-done";
      default: return "chip";
    }
  }

  function fmtFecha(iso){
    if(!iso) return "—";
    const d = new Date(iso);
    return isNaN(d.getTime()) ? iso : d.toLocaleDateString();
  }

  function toISODateInput(iso){
    if(!iso) return "";
    const d = new Date(iso);
    if (isNaN(d.getTime())) return iso;
    const yy=d.getFullYear(),mm=String(d.getMonth()+1).padStart(2,"0"),dd=String(d.getDate()).padStart(2,"0");
    return `${yy}-${mm}-${dd}`;
  }

  function escapeHtml(s){
    return String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]) );
  }

  function easeInOut(t){ return t<.5 ? 2*t*t : 1 - Math.pow(-2*t+2,2)/2; }

  function getRadialPercent(el){
    const v = getComputedStyle(el).getPropertyValue('--p').trim();
    const n = parseFloat(v||'0');
    return isNaN(n)?0:n;
  }

  function setRadialAnimated(el, toPercent, labelEl, duration=600){
    const from = getRadialPercent(el);
    const to = Math.max(0, Math.min(100, toPercent|0));
    if (from === to){
      if(labelEl) labelEl.textContent = to + "%";
      el.style.setProperty('--p', to);
      return;
    }
    const start = performance.now();
    function step(now){
      const t = Math.min(1, (now-start)/duration);
      const eased = easeInOut(t);
      const val = Math.round(from + (to-from)*eased);
      el.style.setProperty('--p', val);
      if (labelEl) labelEl.textContent = val + "%";
      if (t<1) requestAnimationFrame(step);
    }
    requestAnimationFrame(step);
  }

  function addDays(d, n){ const c = new Date(d); c.setDate(c.getDate()+n); return c; }

  function fmtYMD(d){
    const yy=d.getFullYear(),mm=String(d.getMonth()+1).padStart(2,"0"),dd=String(d.getDate()).padStart(2,"0");
    return `${yy}-${mm}-${dd}`;
  }

  function isValidYMD(s){
    if(!/^\d{4}-\d{2}-\d{2}$/.test(s)) return false;
    const [y,m,dd] = s.split("-").map(Number);
    const d = new Date(s+"T00:00:00");
    return d.getFullYear()===y && (d.getMonth()+1)===m && d.getDate()===dd;
  }

  // Convierte YYYY-MM-DD o ISO a Date seguro
  function parseDateSafe(value){
    if (!value) return null;
    const d1 = new Date(value);
    if (!isNaN(d1.getTime())) return d1;
    if (/^\d{4}-\d{2}-\d{2}$/.test(value)) {
      const [y,m,dd] = value.split("-").map(Number);
      const d2 = new Date(y, m - 1, dd, 0, 0, 0, 0);
      if (!isNaN(d2.getTime())) return d2;
    }
    return null;
  }

  // Aplicar min = hoy a todos los calendarios de la vista
  function applyMinTodayToCalendars(){
    const today = new Date();
    const ymd = fmtYMD(today);
    document.querySelectorAll('input[type="date"]').forEach(inp => {
      if (!inp.dataset.allowPast) {
        inp.min = ymd;
      }
    });
  }

  /* ========= SESIÓN ========= */
  const sessionUser  = JSON.parse(localStorage.getItem("user") || "null");
  const sessionEmail = sessionUser?.email || "";
  const $userInitial = document.querySelector(".user-circle");
  if ($userInitial && (sessionUser?.nombre || sessionUser?.email)) {
    const ch = (sessionUser?.nombre?.trim()?.[0] ?? sessionUser?.email?.trim()?.[0] ?? "U").toUpperCase();
    $userInitial.textContent = ch;
  }
  function mustHaveEmail(){
    if(!sessionEmail){
      showToast({type:"error", title:"Sesión requerida", message:"Inicia sesión para gestionar tareas."});
      throw new Error("No session email");
    }
  }

  /* ========= TOASTS ========= */
  const $toastStack = document.getElementById('toast-stack');
  function showToast({type="success", title="Listo", message="", timeout=3000}={}){
    const item = document.createElement('div');
    item.className = `toast ${type}`;
    item.innerHTML = `
      <div class="toast-icon">${type==="success"?"✅":type==="error"?"⚠️":"ℹ️"}</div>
      <div class="toast-body">
        <div class="toast-title">${title}</div>
        ${message?`<div class="toast-msg">${message}</div>`:""}
        <div class="toast-progress"></div>
      </div>
      <button class="toast-close" aria-label="Cerrar">✕</button>
    `;
    $toastStack.appendChild(item);
    const dismiss = ()=>{
      item.classList.remove('show');
      setTimeout(()=> item.remove(), 180);
    };
    item.querySelector('.toast-close').onclick = dismiss;
    setTimeout(()=> item.classList.add('show'), 10);
    const bar = item.querySelector('.toast-progress');
    bar.style.animationDuration = `${timeout}ms`;
    const auto = setTimeout(dismiss, timeout);
    item.addEventListener('mouseenter', ()=>{
      bar.style.animationPlayState="paused";
      clearTimeout(auto);
    });
    item.addEventListener('mouseleave', ()=>{
      bar.style.animationPlayState="running";
      setTimeout(dismiss, 1200);
    });
  }

  /* ========= REFS VISTA ========= */
  const $vmNombre = document.getElementById("vm-nombre");
  const $vmEquipo = document.getElementById("vm-equipo");
  const $vmDesc   = document.getElementById("vm-desc");
  const $vmEstadoChip = document.getElementById("vm-estado-chip");
  const $vmRadial = document.getElementById("vm-radial");
  const $vmPercent= document.getElementById("vm-percent");
  const $vmBar    = document.getElementById("vm-bar");
  const $vmIni    = document.getElementById("vm-inicio");
  const $vmFin    = document.getElementById("vm-fin");
  const $tasksSummary = document.getElementById("tasks-summary");

  const $btnEditar = document.getElementById("btn-editar");
  const $sprintsList = document.getElementById("sprints-list");
  const $btnNewSprint = document.getElementById("btn-new-sprint");

  // Crear Tarea
  const $taskCreateOverlay = document.getElementById("task-create-overlay");
  const $btnCloseTaskCreate= document.getElementById("btn-close-task-create");
  const $btnCancelTaskCreate= document.getElementById("btn-cancel-task-create");
  const $btnSaveTaskCreate = document.getElementById("btn-save-task-create");
  const $ctTitle     = document.getElementById("ct-title");
  const $ctEstimated = document.getElementById("ct-estimated");
  const $ctPriority  = document.getElementById("ct-priority");
  const $ctDesc      = document.getElementById("ct-desc");
  const $ctAssignee  = document.getElementById("ct-assignee");
  const $ctDue       = document.getElementById("ct-due");

  // Editar Tarea
  const $taskEditOverlay = document.getElementById("task-edit-overlay");
  const $btnCloseTaskEdit= document.getElementById("btn-close-task-edit");
  const $btnCancelTaskEdit= document.getElementById("btn-cancel-task-edit");
  const $btnSaveTaskEdit = document.getElementById("btn-save-task-edit");
  const $etId = document.getElementById("et-id");
  const $etTitle     = document.getElementById("et-title");
  const $etEstimated = document.getElementById("et-estimated");
  const $etPriority  = document.getElementById("et-priority");
  const $etDesc      = document.getElementById("et-desc");
  const $etAssignee  = document.getElementById("et-assignee");
  const $etDue       = document.getElementById("et-due");

  // Crear Sprint (modal)
  const $sprintCreateOverlay   = document.getElementById("sprint-create-overlay");
  const $btnCloseSprintCreate  = document.getElementById("btn-close-sprint-create");
  const $btnCancelSprintCreate = document.getElementById("btn-cancel-sprint-create");
  const $btnSaveSprintCreate   = document.getElementById("btn-save-sprint-create");
  const $scName      = document.getElementById("sc-name");
  const $scDesc      = document.getElementById("sc-desc");
  const $scStart     = document.getElementById("sc-start");
  const $scDuration  = document.getElementById("sc-duration");
  const $scNumber    = document.getElementById("sc-number");

  // Editar Sprint (modal)
  const $sprintEditOverlay   = document.getElementById("sprint-edit-overlay");
  const $btnCloseSprintEdit  = document.getElementById("btn-close-sprint-edit");
  const $btnCancelSprintEdit = document.getElementById("btn-cancel-sprint-edit");
  const $btnSaveSprintEdit   = document.getElementById("btn-save-sprint-edit");
  const $seId   = document.getElementById("se-id");
  const $seName = document.getElementById("se-name");
  const $seDesc = document.getElementById("se-desc");
  const $seStart= document.getElementById("se-start");
  const $seEnd  = document.getElementById("se-end");

  /* ========= ESTADO ========= */
  let proyectoActual = null;
  let tareasCache = [];
  let teamMembersCache = [];
  let isTeamAdmin = false;
  let sprintsCache = [];
  let currentSprintIdForTaskCreate = null;
  let pendingProjectIdForSprint = null;

  // Roles dentro del equipo / sistema (usando valores del backend: SUPER_ADMIN, SCRUM_MASTER, DEVELOPER)
  let currentTeamRole = null;   // "ADMIN" | "USUARIO_SUPERIOR" | "USUARIO" | null
  let isGlobalAdmin = false;    // SUPER_ADMIN / SCRUM_MASTER

  function isAdminRole() {
    return String(currentTeamRole || "").toUpperCase() === "ADMIN";
  }
  function isSuperiorRole() {
    return String(currentTeamRole || "").toUpperCase() === "USUARIO_SUPERIOR";
  }
  function isUserRole() {
    return String(currentTeamRole || "").toUpperCase() === "USUARIO";
  }

  // ¿Puede editar datos del PROYECTO?
  function canEditProject() {
    return isGlobalAdmin || isAdminRole();
  }

  // ¿Puede crear/editar/borrar sprints?
  function canManageSprints() {
    return isGlobalAdmin || isAdminRole() || isSuperiorRole();
  }

  // ¿Puede asignar una tarea a ese email?
  function canAssignTaskTo(email) {
    if (!email) return false;
    const me = (sessionEmail || "").toLowerCase();
    const target = String(email).toLowerCase();

    // Admin y usuario_superior pueden asignar a cualquiera
    if (isGlobalAdmin || isAdminRole() || isSuperiorRole()) return true;

    // Usuario normal solo a sí mismo
    return target === me;
  }

  // ¿Puede editar una tarea?
  function canEditTask(task) {
    if (isGlobalAdmin || isAdminRole() || isSuperiorRole()) return true;
    const assignee = String(task.assigneeId || "").toLowerCase();
    const me = (sessionEmail || "").toLowerCase();
    return assignee && assignee === me;
  }

  // ¿Puede borrar una tarea?
  function canDeleteTask(task) {
    if (isGlobalAdmin || isAdminRole() || isSuperiorRole()) return true;
    const assignee = String(task.assigneeId || "").toLowerCase();
    const me = (sessionEmail || "").toLowerCase();
    return assignee && assignee === me;
  }

  // ¿Puede completar / reabrir una tarea?
  function canToggleTask(task) {
    return canEditTask(task);
  }

  // Ajustar visibilidad de botones globales
  function applyRoleUIVisibility() {
    if ($btnEditar) {
      $btnEditar.style.display = canEditProject() ? "" : "none";
    }
    if ($btnNewSprint) {
      $btnNewSprint.style.display = canManageSprints() ? "" : "none";
    }
  }

  /* ========= MODALES ========= */
  function openEl(ov){ ov && ov.classList.add("open"); ov && ov.setAttribute("aria-hidden","false"); }
  function closeEl(ov){ ov && ov.classList.remove("open"); ov && ov.setAttribute("aria-hidden","true"); }

  // Crear tarea
  $btnCloseTaskCreate?.addEventListener("click", ()=>{
    currentSprintIdForTaskCreate = null;
    closeEl($taskCreateOverlay);
  });
  $btnCancelTaskCreate?.addEventListener("click", (e)=>{
    e.preventDefault();
    currentSprintIdForTaskCreate = null;
    closeEl($taskCreateOverlay);
  });

  // Editar tarea
  $btnCloseTaskEdit?.addEventListener("click", ()=> closeEl($taskEditOverlay));
  $btnCancelTaskEdit?.addEventListener("click", (e)=>{
    e.preventDefault();
    closeEl($taskEditOverlay);
  });

  // Crear sprint modal
  function openSprintModal(projectId){
    pendingProjectIdForSprint = projectId;

    const today = new Date();
    if ($scStart)    $scStart.value = fmtYMD(today);
    if ($scDuration) $scDuration.value = 7;

    // Número de sprint automático
    let nextNumber = 1;
    if (Array.isArray(sprintsCache) && sprintsCache.length){
      const nums = sprintsCache
        .filter(s => Number(s.projectId || proyectoActual?.id || projectId) === Number(projectId))
        .map(s => Number(s.numero || 0))
        .filter(n => Number.isFinite(n));
      if (nums.length){
        nextNumber = Math.max(...nums) + 1;
      }
    }
    if ($scNumber){
      $scNumber.value = String(nextNumber);
      $scNumber.readOnly = true;  // para que no lo cambien
    }

    if ($scName)     $scName.value = "";
    if ($scDesc)     $scDesc.value = "";
    openEl($sprintCreateOverlay);
  }

  $btnCloseSprintCreate?.addEventListener("click", ()=> closeEl($sprintCreateOverlay));
  $btnCancelSprintCreate?.addEventListener("click", (e)=>{
    e.preventDefault();
    closeEl($sprintCreateOverlay);
  });
  $sprintCreateOverlay?.addEventListener("click", (e)=>{
    if(e.target === $sprintCreateOverlay) closeEl($sprintCreateOverlay);
  });

  function handleSaveSprintClick(){
    const projectId = pendingProjectIdForSprint || proyectoActual?.id;
    if (!projectId) return;
    if (!canManageSprints()) {
      showToast({type:"error", title:"Sin permiso", message:"No puedes crear sprints."});
      return;
    }
    createSprintFromForm(projectId);
  }
  $btnSaveSprintCreate?.addEventListener("click", (e)=>{
    e.preventDefault();
    handleSaveSprintClick();
  });

  // Editar sprint modal
  function openSprintEditModal(sprint){
    if (!sprint) return;
    if (!canManageSprints()) {
      showToast({type:"error", title:"Sin permiso", message:"No puedes editar sprints."});
      return;
    }
    $seId.textContent = `#${sprint.id}`;
    $seName.value = sprint.tituloSprint || "";
    $seDesc.value = sprint.descripcionSprint || "";
    $seStart.value = sprint.fechaInicio ? toISODateInput(sprint.fechaInicio) : "";
    $seEnd.value   = sprint.duracion ? toISODateInput(sprint.duracion) : "";
    openEl($sprintEditOverlay);
    $btnSaveSprintEdit.onclick = (e)=>{
      e.preventDefault();
      updateSprintFromForm(sprint.id);
    };
  }
  function closeSprintEditModal(){ closeEl($sprintEditOverlay); }
  $btnCloseSprintEdit?.addEventListener("click", closeSprintEditModal);
  $btnCancelSprintEdit?.addEventListener("click", (e)=>{
    e.preventDefault();
    closeSprintEditModal();
  });
  $sprintEditOverlay?.addEventListener("click", (e)=>{
    if(e.target === $sprintEditOverlay) closeSprintEditModal();
  });

  /* ========= CONFIRM DIALOG ========= */
  const $confirm = document.getElementById('confirm-overlay');
  function confirmDialog(message="¿Seguro que deseas continuar?"){
    return new Promise(resolve=>{
      document.getElementById('confirm-msg').textContent = message;
      openEl($confirm);
      const onYes = ()=>{ cleanup(); resolve(true); };
      const onNo  = ()=>{ cleanup(); resolve(false); };
      function cleanup(){
        document.getElementById('confirm-yes').removeEventListener('click', onYes);
        document.getElementById('confirm-cancel').removeEventListener('click', onNo);
        closeEl($confirm);
      }
      document.getElementById('confirm-yes').addEventListener('click', onYes, {once:true});
      document.getElementById('confirm-cancel').addEventListener('click', onNo, {once:true});
      $confirm.addEventListener('click', (e)=>{ if(e.target===$confirm) onNo(); }, {once:true});
      document.addEventListener('keydown', function esc(e){
        if(e.key==='Escape'){
          onNo();
          document.removeEventListener('keydown', esc);
        }
      }, {once:true});
    });
  }

  /* ========= MODAL HORAS ========= */
  function ensureHoursModal(){
    let el = document.getElementById('hours-overlay');
    if (el) return el;
    const tpl = document.createElement('div');
    tpl.id = 'hours-overlay';
    tpl.className = 'edit-modal-overlay';
    tpl.setAttribute('aria-hidden','true');
    tpl.innerHTML = `
      <div class="edit-modal" role="dialog" aria-modal="true" aria-labelledby="hours-title" style="max-width:420px">
        <div class="edit-modal-header">
          <h2 class="h6" id="hours-title">¿Cuántas horas reales te tomó?</h2>
          <button id="hours-close" class="icon-btn" aria-label="Cerrar">✕</button>
        </div>
        <div class="edit-modal-body">
          <div class="field">
            <label>Horas reales (0 - 12)</label>
            <input id="hours-input" type="number" step="0.25" min="0" max="12" placeholder="Ej. 2.5">
          </div>
          <div class="tiny muted" style="margin-top:8px">Este dato se guardará junto con el estado "done".</div>
        </div>
        <div class="edit-modal-footer" style="display:flex; justify-content:flex-end; gap:10px;">
          <button id="hours-cancel" class="btn btn-outline">Cancelar</button>
          <button id="hours-ok" class="btn btn-primary">Guardar</button>
        </div>
      </div>
    `;
    document.body.appendChild(tpl);
    return tpl;
  }
  function askRealHours(){
    return new Promise(resolve=>{
      const ov = ensureHoursModal();
      const $inp = ov.querySelector('#hours-input');
      const $ok = ov.querySelector('#hours-ok');
      const $cancel = ov.querySelector('#hours-cancel');
      const $close = ov.querySelector('#hours-close');
      $inp.value = '';
      openEl(ov);
      function done(v){ cleanup(); resolve(v); }
      function cleanup(){
        $ok.removeEventListener('click', onOk);
        $cancel.removeEventListener('click', onCancel);
        $close.removeEventListener('click', onCancel);
        ov.removeEventListener('click', onBg);
        closeEl(ov);
      }
      function onOk(){
        const num = Number($inp.value);
        if (Number.isNaN(num) || num < 0 || num > 12){
          showToast({type:"error", title:"Horas inválidas", message:"Ingresa un número entre 0 y 12."});
          return;
        }
        done(num);
      }
      function onCancel(){ done(null); }
      function onBg(e){ if (e.target===ov) onCancel(); }
      $ok.addEventListener('click', onOk);
      $cancel.addEventListener('click', onCancel);
      $close.addEventListener('click', onCancel);
      ov.addEventListener('click', onBg);
      setTimeout(()=> $inp.focus(), 50);
    });
  }

  /* ========= PROYECTO ========= */
  async function fetchEquipoNombre(equipoId){
    if (equipoId == null) return "—";
    try{
      const res = await fetch(`${EQUIPOS_API}/${equipoId}`);
      if(!res.ok) return `Equipo #${equipoId}`;
      const eq = await res.json();
      return eq.nombreEquipo || `Equipo #${equipoId}`;
    }catch(_){ return `Equipo #${equipoId}`; }
  }

  async function pintarView(p){
    $vmNombre.textContent = p.nombreProyecto || "—";
    $vmDesc.textContent   = p.descripcion || "—";
    $vmEstadoChip.className = estadoToChipClass(p.estado);
    $vmEstadoChip.textContent = p.estado || "—";
    $vmIni.textContent = fmtFecha(p.fechaInicio);
    $vmFin.textContent = fmtFecha(p.fechaFin);
    const teamName = await fetchEquipoNombre(p.equipoId);
    $vmEquipo.textContent = teamName;
    const initialPct = (p.estado==="Finalizado") ? 100 : (p.estado==="En curso" ? 50 : 0);
    setRadialAnimated($vmRadial, initialPct, $vmPercent, 600);
    $vmBar.style.width = initialPct + "%";
  }

  async function cargarProyecto(){
    const id = qs("id");
    if(!id){
      showToast({type:"error", title:"Falta el id", message:"No se encontró ?id en la URL"});
      window.location.href = "projects.html";
      return;
    }
    try{
      const res = await fetch(`${API_BASE}/${id}`);
      if(!res.ok) throw new Error("No encontrado");
      const p = await res.json();
      proyectoActual = p;

      await pintarView(p);

      await Promise.all([
        loadTeamMembers(p.equipoId),
        loadSprints(p.id),
        loadTasks(p.id)
      ]);

      // Mover tareas atrasadas al sprint activo antes de pintar
      await autoReassignOverdueTasks();

      await renderMembersList();
      renderSprints();
    }catch(e){
      console.error(e);
      showToast({type:"error", title:"No se pudo cargar", message:"Intenta de nuevo más tarde"});
      window.location.href = "projects.html";
    }
  }

  /* ========= EDITAR PROYECTO ========= */
  const $overlay = document.getElementById("edit-modal-overlay");
  const $btnCancelar = document.getElementById("btn-cancelar");
  const $btnGuardar = document.getElementById("btn-guardar");
  const $pId = document.getElementById("p-id");
  const $nombre = document.getElementById("p-nombre");
  const $equipo = document.getElementById("p-equipo");
  const $descP  = document.getElementById("p-desc");
  const $inicio = document.getElementById("p-inicio");
  const $fin    = document.getElementById("p-fin");

  function openModal(){
    if(!proyectoActual) return;
    if (!canEditProject()) {
      showToast({type:"error", title:"Sin permiso", message:"No puedes editar este proyecto."});
      return;
    }
    const p = proyectoActual;
    $pId.textContent = `#${p.id}`;
    $nombre.value = p.nombreProyecto || "";
    $equipo.value = (p.equipoId ?? "");
    $descP.value  = p.descripcion || "";
    $inicio.value = toISODateInput(p.fechaInicio);
    $fin.value    = toISODateInput(p.fechaFin);
    openEl($overlay);
  }
  function closeModal(){ closeEl($overlay); }
  $btnEditar.addEventListener("click", openModal);
  document.getElementById("btn-close-modal").addEventListener("click", closeModal);
  $overlay.addEventListener("click", (e) => {
    if (e.target === $overlay) closeModal();
  });
  $btnCancelar.addEventListener("click", (e) => {
    e.preventDefault();
    closeModal();
  });
  $btnGuardar.addEventListener("click", async () => {
    if (!proyectoActual) return;
    if (!canEditProject()) {
      showToast({type:"error", title:"Sin permiso", message:"No puedes editar este proyecto."});
      return;
    }
    const payload = {
      id: proyectoActual.id,
      nombreProyecto: $nombre.value.trim(),
      descripcion: $descP.value.trim(),
      estado: proyectoActual.estado,
      equipoId: Number($equipo.value||0),
      fechaInicio: $inicio.value || null,
      fechaFin: $fin.value || null,
      ultimoAcceso: proyectoActual.ultimoAcceso || null
    };
    try{
      const res = await fetch(`${API_BASE}/${proyectoActual.id}`, {
        method:"PUT",
        headers:{ "Content-Type":"application/json" },
        body: JSON.stringify(payload)
      });
      if (res.ok){
        proyectoActual = await res.json();
        await pintarView(proyectoActual);
        closeModal();
        showToast({type:"success", title:"Cambios guardados", message:"El proyecto se actualizó correctamente."});
        recomputeProjectProgress();
        await loadTeamMembers(proyectoActual.equipoId);
        await renderMembersList();
      } else {
        showToast({type:"error", title:"Error al guardar", message:"Revisa los datos e inténtalo nuevamente."});
      }
    }catch(err){
      showToast({type:"error", title:"Error de red", message:"No se pudo conectar con el servidor."});
    }
  });

  document.addEventListener("keydown", (e)=>{
    if(e.key==="Escape"){
      closeModal();
      closeEl($taskCreateOverlay);
      closeEl($taskEditOverlay);
      closeEl($sprintCreateOverlay);
      closeEl($sprintEditOverlay);
    }
  });

  /* ========= ESTADO POR % ========= */
  async function persistProjectEstadoFromPct(pct){
    if (!proyectoActual?.id) return;
    const nuevo = (pct===0) ? "Pendiente" : (pct===100 ? "Finalizado" : "En curso");
    if (proyectoActual.estado === nuevo) return;
    const payload = {
      id: proyectoActual.id,
      nombreProyecto: proyectoActual.nombreProyecto,
      descripcion: proyectoActual.descripcion,
      estado: nuevo,
      equipoId: proyectoActual.equipoId,
      fechaInicio: proyectoActual.fechaInicio || null,
      fechaFin: proyectoActual.fechaFin || null,
      ultimoAcceso: proyectoActual.ultimoAcceso || null
    };
    try{
      const res = await fetch(`${API_BASE}/${proyectoActual.id}`, {
        method:"PUT",
        headers:{ "Content-Type":"application/json" },
        body: JSON.stringify(payload)
      });
      if (res.ok){
        const updated = await res.json();
        proyectoActual.estado = updated.estado;
        $vmEstadoChip.className = estadoToChipClass(updated.estado);
        $vmEstadoChip.textContent = updated.estado;
      }
    }catch(e){}
  }

  /* ========= INTEGRANTES ========= */
  async function loadTeamMembers(equipoId){
    teamMembersCache = [];
    isTeamAdmin = false;
    currentTeamRole = null;
    isGlobalAdmin = false;

    if (!equipoId) return;
    try{
      const res = await fetch(`${EQUIPOS_API}/${equipoId}/miembros`);
      if(!res.ok) throw new Error('No se pudo obtener miembros');
      const miembros = await res.json();

      // Roles globales según backend (SUPER_ADMIN, SCRUM_MASTER)
      const backendRol = String(sessionUser?.rol || "").toUpperCase();
      isGlobalAdmin = (backendRol === "SUPER_ADMIN" || backendRol === "SCRUM_MASTER");

      const detallePromesas = miembros.map(async (m) => {
        const uid = m.id?.usuarioId ?? m.usuarioId;
        let nombre = 'Usuario #' + uid;
        let email  = null;

        try{
          // Endpoint público del UsuarioController
          const ru = await fetch(`${USUARIOS_API}/public/${uid}`);
          if(ru.ok){
            const u = await ru.json();
            nombre = u?.nombre || (u?.email ? u.email.split('@')[0] : nombre);
            email  = u?.email || null;
          }
        }catch(_){}

        return { usuarioId: uid, rol: m.rol, nombre, email };
      });

      teamMembersCache = await Promise.all(detallePromesas);

      const row = teamMembersCache.find(x => String(x.usuarioId) === String(sessionUser?.id));

      currentTeamRole = row ? String(row.rol || "").toUpperCase() : null;
      if (isGlobalAdmin && !currentTeamRole) {
        currentTeamRole = "ADMIN"; // Global se comporta como admin de equipo
      }

      isTeamAdmin = isGlobalAdmin || isAdminRole();

      populateAssigneeSelect($ctAssignee);
      populateAssigneeSelect($etAssignee);

      applyRoleUIVisibility();
    }catch(_){
      teamMembersCache = [];
    }
  }

  function tinyRoleBadge(rolRaw){
    const rol = (rolRaw||'').toUpperCase();
    const cls = rol === 'ADMIN' ? 'admin' : (rol === 'USUARIO_SUPERIOR' ? 'super' : 'user');
    const text = rol === 'ADMIN' ? 'ADMIN' : (rol === 'USUARIO_SUPERIOR' ? 'USUARIO SUP.' : 'USUARIO');
    return `<span class="role-badge ${cls}">${text}</span>`;
  }

  async function renderMembersList(){
    const wrap = document.getElementById('members-list');
    const counter = document.getElementById('members-count');
    if (!wrap) return;
    if (!teamMembersCache.length){
      wrap.innerHTML = `<div class="muted">Este equipo aún no tiene integrantes.</div>`;
      if (counter) counter.textContent = '0';
      return;
    }
    wrap.innerHTML = teamMembersCache.map(m => `
      <div class="member-item">
        <div class="member-left">
          <div class="member-avatar">${escapeHtml((m.nombre||'U').charAt(0).toUpperCase())}</div>
          <div class="member-name">${escapeHtml(m.nombre)}</div>
          ${tinyRoleBadge(m.rol)}
        </div>
      </div>
    `).join('');
    if (counter) counter.textContent = String(teamMembersCache.length);
  }

  function populateAssigneeSelect(selectEl){
    if (!selectEl) return;

    const prev = selectEl.value || "";
    let html = `<option value="">Seleccionar miembro del equipo</option>`;

    // Admin / superior: pueden asignar a cualquiera
    if (isGlobalAdmin || isAdminRole() || isSuperiorRole()) {
      html += teamMembersCache
        .map(m => `<option value="${m.usuarioId}" data-nombre="${escapeHtml(m.nombre||'')}" data-email="${escapeHtml(m.email||'')}">${escapeHtml(m.nombre||('#'+m.usuarioId))} — ${(m.rol||'').toUpperCase()}</option>`)
        .join('');
      selectEl.disabled = false;
    } else {
      // Usuario normal: solo a él mismo
      const self = teamMembersCache.find(m => String(m.usuarioId) === String(sessionUser?.id));
      const nombre = self?.nombre || (sessionUser?.nombre || sessionEmail || "Yo");
      const email  = self?.email || sessionEmail || "";

      if (email) {
        html += `<option value="${sessionUser?.id || email}" data-nombre="${escapeHtml(nombre)}" data-email="${escapeHtml(email)}">${escapeHtml(nombre)} — MIS TAREAS</option>`;
        selectEl.disabled = true;
      } else {
        selectEl.disabled = true;
      }
    }

    selectEl.innerHTML = html;
    if (prev) selectEl.value = prev;
  }

  function resolveAssigneeNameFromTask(t){
    if (t.assigneeName) return t.assigneeName;
    if (t.assigneeId)   return t.assigneeId;
    return '-';
  }

  /* ========= SPRINTS ========= */
  async function loadSprints(projectId){
    sprintsCache = [];
    if (!$sprintsList) return;
    try{
      const res = await fetch(`${SPRINTS_API}?projectId=${encodeURIComponent(projectId)}`);
      if (!res.ok) throw new Error("Error listando sprints");
      sprintsCache = await res.json();
    }catch(err){
      console.error(err);
      sprintsCache = [];
      $sprintsList.innerHTML = `<div class="muted" style="padding:6px 0 12px">No se pudieron cargar los sprints.</div>`;
    }
  }

  function isTaskDone(t){
    const st = (t.status||"").toLowerCase();
    return st==="done" || st==="hecho" || t.completedAt != null;
  }

  function isSprintDone(s){
    const sid = s.id;
    const sprintTasks = tareasCache.filter(t => Number(t.sprintId) === Number(sid));
    if (sprintTasks.length){
      return sprintTasks.every(isTaskDone);
    }
    const est = (s.estado || s.status || "").toLowerCase();
    return est==="finalizado" || est==="completado" || est==="done";
  }

  function recomputeProjectProgress(){
    if (sprintsCache.length){
      const total = sprintsCache.length;
      let completed = 0;
      sprintsCache.forEach(s => { if (isSprintDone(s)) completed++; });
      const pct = total ? Math.round((completed/total)*100) : 0;
      setRadialAnimated($vmRadial, pct, $vmPercent, 500);
      $vmBar.style.width = pct + "%";
      $tasksSummary.textContent = `${completed}/${total} sprints completos`;
      persistProjectEstadoFromPct(pct);
    } else {
      const total = tareasCache.length;
      const done  = tareasCache.filter(isTaskDone).length;
      const pct = total ? Math.round((done/total)*100) : 0;
      setRadialAnimated($vmRadial, pct, $vmPercent, 500);
      $vmBar.style.width = pct + "%";
      $tasksSummary.textContent = `${done}/${total} tareas completadas`;
      persistProjectEstadoFromPct(pct);
    }
  }

  // === Sprint activo + reasignación de tareas atrasadas ===
  function getActiveSprint(){
    if (!Array.isArray(sprintsCache) || !sprintsCache.length) return null;

    const today = new Date();
    today.setHours(0, 0, 0, 0);

    const sorted = [...sprintsCache].sort((a, b) => {
      const na = Number(a.numero || a.numeroSprint || 0);
      const nb = Number(b.numero || b.numeroSprint || 0);
      if (!Number.isNaN(na) && !Number.isNaN(nb) && na !== nb) return na - nb;
      return (a.id || 0) - (b.id || 0);
    });

    // 1) Sprint cuyo rango incluye hoy
    for (const s of sorted){
      const start = parseDateSafe(s.fechaInicio);
      const end   = parseDateSafe(s.duracion);
      if (!start || !end) continue;
      const s0 = new Date(start); s0.setHours(0,0,0,0);
      const e0 = new Date(end);   e0.setHours(0,0,0,0);
      if (s0 <= today && today <= e0) return s;
    }

    // 2) Próximo sprint que aún no empieza
    const upcoming = sorted.find(s => {
      const start = parseDateSafe(s.fechaInicio);
      if (!start) return false;
      const s0 = new Date(start); s0.setHours(0,0,0,0);
      return s0 >= today;
    });
    if (upcoming) return upcoming;

    // 3) Último sprint como fallback
    return sorted[sorted.length - 1];
  }

  async function moveTaskToSprint(task, newSprintId){
    if (!task?.id) return task;

    const payload = {
      title: task.title,
      description: task.description || task.longDescription || "",
      estimatedHours: task.estimatedHours,
      priority: task.priority,
      assigneeId: task.assigneeId,
      assigneeName: task.assigneeName,
      sprintId: newSprintId,
      fechaLimite: task.fechaLimite
    };

    try{
      const res = await fetch(`${TASKS_API}/${task.id}`, {
        method: "PUT",
        headers: {
          "Content-Type": "application/json",
          "X-User-Email": sessionEmail || ""
        },
        body: JSON.stringify(payload)
      });

      if (res.ok){
        const updated = await res.json();
        const idx = tareasCache.findIndex(t => t.id === task.id);
        if (idx >= 0) tareasCache[idx] = updated;
        return updated;
      } else {
        const text = await res.text().catch(() => "");
        console.warn("No se pudo mover tarea", task.id, text);
        return task;
      }
    }catch(err){
      console.error("Error moviendo tarea", task.id, err);
      return task;
    }
  }

  async function autoReassignOverdueTasks(){
    if (!sessionEmail) return; // si no hay sesión, no tocamos nada
    if (!Array.isArray(tareasCache) || !tareasCache.length) return;
    if (!Array.isArray(sprintsCache) || !sprintsCache.length) return;

    const active = getActiveSprint();
    if (!active || !active.id) return;

    const today = new Date();
    today.setHours(0, 0, 0, 0);

    const sprintById = new Map(sprintsCache.map(s => [s.id, s]));

    const toMove = tareasCache.filter(t => {
      if (isTaskDone(t)) return false; // solo pendientes
      if (Number(t.sprintId) === Number(active.id)) return false; // ya en sprint activo

      // 1) Vencida por fecha límite
      let overdueByDueDate = false;
      const dLim = parseDateSafe(t.fechaLimite);
      if (dLim){
        const dl = new Date(dLim); dl.setHours(0,0,0,0);
        if (dl < today) overdueByDueDate = true;
      }

      // 2) Sprint de la tarea ya terminó
      let expiredSprint = false;
      if (t.sprintId != null){
        const s = sprintById.get(t.sprintId);
        if (s && s.duracion){
          const end = parseDateSafe(s.duracion);
          if (end){
            const e0 = new Date(end); e0.setHours(0,0,0,0);
            if (e0 < today) expiredSprint = true;
          }
        }
      }

      return overdueByDueDate || expiredSprint;
    });

    if (!toMove.length) return;

    try{
      await Promise.all(toMove.map(task => moveTaskToSprint(task, active.id)));
    }catch(err){
      console.error("autoReassignOverdueTasks error", err);
    }
  }

  /* ========= ORDEN DE TAREAS ========= */
  function getPriorityRank(prio){
    const p = (prio || "").toLowerCase();
    if (p === "alta")  return 1;
    if (p === "media") return 2;
    if (p === "baja")  return 3;
    return 4;
  }

  function sortTasksForView(tasks){
    return [...tasks].sort((a, b) => {
      const da = parseDateSafe(a.fechaLimite);
      const db = parseDateSafe(b.fechaLimite);

      const hasA = !!da;
      const hasB = !!db;
      if (hasA && hasB){
        const diff = da.getTime() - db.getTime();
        if (diff !== 0) return diff;
      } else if (hasA && !hasB){
        return -1;
      } else if (!hasA && hasB){
        return 1;
      }

      const ra = getPriorityRank(a.priority);
      const rb = getPriorityRank(b.priority);
      if (ra !== rb) return ra - rb;

      return (a.id || 0) - (b.id || 0);
    });
  }

  /* ========= HTML DE TAREAS ========= */
  function buildTaskHtml(t){
    const isDone   = isTaskDone(t);
    const descHtml = escapeHtml(t.description || t.longDescription || "");
    const asigName = resolveAssigneeNameFromTask(t);

    const canEdit   = canEditTask(t);
    const canDel    = canDeleteTask(t);
    const canTog    = canToggleTask(t);

    return `
      <div class="task-item ${isDone ? 'task-done' : ''}" data-id="${t.id}">
        <input
          type="checkbox"
          class="t-check"
          ${isDone ? "checked" : ""}
          ${canTog ? "" : "disabled"}
          title="Completar / Reabrir"
        >
        <div>
          <div class="task-title">${escapeHtml(t.title || '')}</div>
          <div class="task-meta">
            Prio: ${escapeHtml(t.priority||'-')}
            · Est: ${t.estimatedHours ?? '-'}h
            ${t.realHours ? (' · Real: '+t.realHours+'h') : ''}
            ${t.fechaLimite?(' · Vence: '+fmtFecha(t.fechaLimite)):''}
            · Asig: ${escapeHtml(asigName)}
          </div>
        </div>
        <div class="task-actions">
          <span class="badge status ${isDone?'done':'todo'}">${isDone?'done':'todo'}</span>
          ${descHtml ? `<button class="desc-btn" type="button">Ver descripción</button>` : ""}
          ${canEdit ? `
            <button class="btn-xs t-edit" title="Editar">
              <svg class="ico-sm" aria-hidden="true"><use href="#i-edit"/></svg> Editar
            </button>` : ""}
          ${canDel ? `
            <button class="btn-danger btn-xs t-del" title="Borrar">
              <svg class="ico-sm" aria-hidden="true"><use href="#i-trash"/></svg> Borrar
            </button>` : ""}
        </div>
        ${descHtml ? `<div class="task-desc">${descHtml}</div>` : ""}
      </div>
    `;
  }

  /* ========= RENDER SPRINTS ========= */
  function renderSprints(){
    if (!$sprintsList) return;

    // Sprints ordenados por número
    const sprintsSorted = [...sprintsCache].sort((a, b) => {
      const na = Number(a.numero || a.numeroSprint || 0);
      const nb = Number(b.numero || b.numeroSprint || 0);
      if (!Number.isNaN(na) && !Number.isNaN(nb) && na !== nb) return na - nb;
      return (a.id || 0) - (b.id || 0);
    });

    if (!sprintsSorted.length){
      if (!tareasCache.length){
        $sprintsList.innerHTML = `<div class="muted" style="padding:6px 0 12px">Aún no hay sprints ni tareas. Crea un sprint para comenzar. 🚀</div>`;
      } else {
        const tasksHtml = sortTasksForView(tareasCache).map(buildTaskHtml).join("");
        $sprintsList.innerHTML = `
          <div class="muted tiny" style="padding:6px 0 12px">
            No hay sprints definidos. Mostrando tareas sueltas del proyecto.
          </div>
          <div class="sprint-item">
            <div class="sprint-head">
              <div>
                <h3 class="h6 sprint-title">Tareas del proyecto</h3>
              </div>
            </div>
            <div class="sprint-body">
              <div class="sprint-tasks">
                ${tasksHtml}
              </div>
            </div>
          </div>
        `;
      }
    } else {
      let html = "";
      sprintsSorted.forEach(s => {
        const sid = s.id;
        const sprintTasksRaw = tareasCache.filter(t => Number(t.sprintId) === Number(sid));
        const sprintTasks = sortTasksForView(sprintTasksRaw);

        const total = sprintTasks.length;
        const done  = sprintTasks.filter(isTaskDone).length;
        const pct   = total ? Math.round((done/total)*100) : 0;

        const titulo = s.tituloSprint || (`Sprint ${s.numero ?? ""}`.trim());
        const inicio = fmtFecha(s.fechaInicio);
        const fin    = fmtFecha(s.duracion);

        html += `
      <div class="sprint-item" data-sid="${sid}">
        <div class="sprint-head">
          <div>
            <h3 class="h6 sprint-title">
              ${escapeHtml(titulo)}
              <span class="tiny muted">#${sid}</span>
            </h3>

            ${s.descripcionSprint ? `
              <div class="sprint-desc tiny">
                ${escapeHtml(s.descripcionSprint)}
              </div>
            ` : ""}

            <div class="sprint-meta tiny muted">
              ${inicio !== "—" || fin !== "—" ? `Del ${inicio} al ${fin} · ` : ""}
              ${total} tareas · ${done} completadas
            </div>
          </div>
          <div class="sprint-right">
            <div class="sprint-progress">
              <div class="tiny muted">Progreso</div>
              <div class="progress"><span style="width:${pct}%"></span></div>
            </div>
            <div class="sprint-actions">
              <button class="btn-xs s-toggle" type="button" data-sid="${sid}" data-hidden="0">
                Ocultar tareas
              </button>

              ${canManageSprints() ? `
                <button class="btn-xs s-edit" type="button" data-sid="${sid}">
                  Editar
                </button>
                <button class="btn-xs btn-danger s-del" type="button" data-sid="${sid}">
                  Borrar
                </button>
              ` : ""}

              <button class="btn-fab btn-fab-sm" type="button" data-action="add-task" data-sid="${sid}">
                <svg class="ico" aria-hidden="true"><use href="#i-plus"/></svg>
                Nueva tarea
              </button>
            </div>
          </div>
        </div>
        <div class="sprint-body">
          <div class="sprint-tasks">
            ${total ? sprintTasks.map(buildTaskHtml).join("") : `<div class="muted tiny" style="padding:6px 0 10px">Este sprint aún no tiene tareas.</div>`}
          </div>
        </div>
      </div>
    `;
      });

      const orphanRaw = tareasCache.filter(t => !t.sprintId);
      const orphan = sortTasksForView(orphanRaw);
      if (orphan.length){
        html += `
          <div class="sprint-item">
            <div class="sprint-head">
              <div>
                <h3 class="h6 sprint-title">Tareas sin sprint</h3>
                <div class="sprint-meta tiny muted">${orphan.length} tarea(s) sin sprint asignado.</div>
              </div>
            </div>
            <div class="sprint-body">
              <div class="sprint-tasks">
                ${orphan.map(buildTaskHtml).join("")}
              </div>
            </div>
          </div>
        `;
      }

      $sprintsList.innerHTML = html;
    }

    // Eventos tareas + botón "Nueva tarea"
    $sprintsList.querySelectorAll(".t-check").forEach(chk => {
      chk.addEventListener("change", async (e)=>{
        const row = e.target.closest(".task-item");
        const id = Number(row.dataset.id);
        const goingDone = e.target.checked;
        const t = tareasCache.find(x => x.id === id);
        if (!t || !canToggleTask(t)) {
          e.target.checked = !goingDone;
          showToast({type:"error", title:"Sin permiso", message:"No puedes cambiar esta tarea."});
          return;
        }
        if (goingDone){
          const hrs = await askRealHours();
          if (hrs === null){
            e.target.checked = false;
            return;
          }
          await toggleTaskStatus(id, true, hrs);
        } else {
          await toggleTaskStatus(id, false, null);
        }
      });
    });

    $sprintsList.querySelectorAll(".t-del").forEach(btn => {
      btn.addEventListener("click", async (e)=>{
        const row = e.target.closest(".task-item");
        const id = Number(row.dataset.id);
        const ok = await confirmDialog("¿Seguro que deseas borrar esta tarea?");
        if (ok) await deleteTask(id);
      });
    });

    $sprintsList.querySelectorAll(".desc-btn").forEach(btn => {
      btn.addEventListener("click", (e)=>{
        const row = e.target.closest(".task-item");
        const desc = row.querySelector(".task-desc");
        if (!desc) return;
        desc.classList.toggle("show");
        e.target.textContent = desc.classList.contains("show") ? "Ocultar descripción" : "Ver descripción";
      });
    });

    $sprintsList.querySelectorAll(".t-edit").forEach(btn => {
      btn.addEventListener("click", (e)=>{
        const row = e.target.closest(".task-item");
        const id = Number(row.dataset.id);
        const t = tareasCache.find(x => x.id === id);
        if (!t) return;
        openTaskEditModal(t);
      });
    });

    $sprintsList.querySelectorAll("[data-action='add-task']").forEach(btn => {
      btn.addEventListener("click", ()=>{
        const sid = Number(btn.dataset.sid);
        currentSprintIdForTaskCreate = sid;
        populateAssigneeSelect($ctAssignee);
        openEl($taskCreateOverlay);
      });
    });

    // Toggle mostrar/ocultar tareas del sprint
    $sprintsList.querySelectorAll(".s-toggle").forEach(btn => {
      btn.addEventListener("click", ()=>{
        const item = btn.closest(".sprint-item");
        if (!item) return;
        const body = item.querySelector(".sprint-body");
        if (!body) return;
        const hidden = btn.dataset.hidden === "1";
        if (hidden){
          body.style.display = "";
          btn.dataset.hidden = "0";
          btn.textContent = "Ocultar tareas";
        } else {
          body.style.display = "none";
          btn.dataset.hidden = "1";
          btn.textContent = "Ver tareas";
        }
      });
    });

    // Editar sprint
    $sprintsList.querySelectorAll(".s-edit").forEach(btn => {
      btn.addEventListener("click", ()=>{
        const sid = Number(btn.dataset.sid);
        const sprint = sprintsCache.find(s => s.id === sid);
        if (sprint) openSprintEditModal(sprint);
      });
    });

    // Borrar sprint
    $sprintsList.querySelectorAll(".s-del").forEach(btn => {
      btn.addEventListener("click", async ()=>{
        const sid = Number(btn.dataset.sid);
        await deleteSprint(sid);
      });
    });

    recomputeProjectProgress();
  }

  /* ========= CREAR SPRINT DESDE FORM ========= */
  function createSprintFromForm(projectId){
    const nombre       = ($scName?.value || "").trim();
    const descripcion  = ($scDesc?.value || "").trim();
    let   fechaInicio  = $scStart?.value || "";
    let   diasDuracion = $scDuration?.value ? Number($scDuration.value) : 0;

    // número automático (usamos el valor calculado en openSprintModal, y si no, lo recomputamos)
    let numero = $scNumber?.value ? Number($scNumber.value) : NaN;
    if (!Number.isInteger(numero) || numero <= 0){
      let nextNumber = 1;
      if (Array.isArray(sprintsCache) && sprintsCache.length){
        const nums = sprintsCache
          .filter(s => Number(s.projectId || proyectoActual?.id || projectId) === Number(projectId))
          .map(s => Number(s.numero || 0))
          .filter(n => Number.isFinite(n));
        if (nums.length){
          nextNumber = Math.max(...nums) + 1;
        }
      }
      numero = nextNumber;
    }

    if (!nombre){
      showToast({type:"error", title:"Falta título del sprint"});
      return;
    }

    if (!fechaInicio){
      showToast({type:"error", title:"Falta fecha de inicio"});
      return;
    }
    if (!isValidYMD(fechaInicio)){
      showToast({type:"error", title:"Fecha inválida", message:"Usa formato YYYY-MM-DD."});
      return;
    }

    if (!diasDuracion || diasDuracion <= 0){
      showToast({type:"error", title:"Duración inválida", message:"Debe ser mayor a 0 días."});
      return;
    }

    const startDate = new Date(fechaInicio + "T00:00:00");
    const endDate   = addDays(startDate, diasDuracion);
    const fechaFin  = fmtYMD(endDate);

    const payload = {
      projectId: Number(projectId),
      tituloSprint: nombre,
      descripcionSprint: descripcion,
      fechaInicio: fechaInicio,
      duracion: fechaFin,   // fecha fin en columna DURACION
      numero: numero
    };

    fetch(SPRINTS_API, {
      method: "POST",
      headers: { "Content-Type":"application/json" },
      body: JSON.stringify(payload)
    })
    .then(async res => {
      if (res.status === 201 || res.ok){
        const created = await res.json();
        sprintsCache.push(created);
        renderSprints();
        closeEl($sprintCreateOverlay);
        pendingProjectIdForSprint = null;
        showToast({type:"success", title:"Sprint creado"});
      }else{
        const text = await res.text().catch(()=> "");
        showToast({type:"error", title:"No se pudo crear el sprint", message:text || ""});
      }
    })
    .catch(err=>{
      console.error(err);
      showToast({type:"error", title:"Error de red", message:"No se pudo crear el sprint."});
    });
  }

  // Actualizar sprint desde modal de edición
  function updateSprintFromForm(sprintId){
    if (!canManageSprints()) {
      showToast({type:"error", title:"Sin permiso", message:"No puedes editar sprints."});
      return;
    }

    const s = sprintsCache.find(x => x.id === sprintId);
    if (!s) return;

    const nombre      = ($seName.value||"").trim();
    const descripcion = ($seDesc.value||"").trim();
    const fechaInicio = $seStart.value || null;
    const fechaFin    = $seEnd.value || null;

    if (!nombre){
      showToast({type:"error", title:"Falta nombre del sprint"});
      return;
    }

    const payload = {
      tituloSprint: nombre,
      descripcionSprint: descripcion,
      projectId: Number(proyectoActual?.id || s.projectId || 0),
      fechaInicio: fechaInicio,
      duracion: fechaFin,
      numero: s.numero
    };

    fetch(`${SPRINTS_API}/${sprintId}`, {
      method:"PUT",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify(payload)
    })
    .then(async res=>{
      if (res.ok){
        const updated = await res.json();
        const idx = sprintsCache.findIndex(x => x.id === sprintId);
        if (idx>=0) sprintsCache[idx] = updated;
        renderSprints();
        closeSprintEditModal();
        showToast({type:"success", title:"Sprint actualizado"});
      }else{
        const text = await res.text().catch(()=> "");
        showToast({type:"error", title:"No se pudo actualizar el sprint", message:text});
      }
    })
    .catch(err=>{
      console.error(err);
      showToast({type:"error", title:"Error de red", message:"No se pudo actualizar el sprint."});
    });
  }

  // Borrar sprint
  async function deleteSprint(id){
    if (!canManageSprints()) {
      showToast({type:"error", title:"Sin permiso", message:"No puedes borrar sprints."});
      return;
    }

    const ok = await confirmDialog("¿Seguro que deseas borrar este sprint? Las tareas asociadas seguirán existiendo, pero sin sprint.");
    if (!ok) return;

    try{
      const res = await fetch(`${SPRINTS_API}/${id}`, { method:"DELETE" });
      if (res.status === 204 || res.ok){
        sprintsCache = sprintsCache.filter(s => s.id !== id);
        renderSprints();
        showToast({type:"success", title:"Sprint eliminado"});
      }else{
        const text = await res.text().catch(()=> "");
        showToast({type:"error", title:"No se pudo borrar el sprint", message:text});
      }
    }catch(err){
      console.error(err);
      showToast({type:"error", title:"Error de red", message:"No se pudo borrar el sprint."});
    }
  }

  // Botón "Nuevo sprint"
  $btnNewSprint?.addEventListener("click", () => {
    if (!proyectoActual?.id) return;
    if (!canManageSprints()) {
      showToast({type:"error", title:"Sin permiso", message:"No puedes crear sprints."});
      return;
    }
    openSprintModal(proyectoActual.id);
  });

  /* ========= TAREAS ========= */
  async function loadTasks(projectId){
    try{
      const res = await fetch(`${TASKS_API}?projectId=${encodeURIComponent(projectId)}`, {
        headers: { "X-User-Id": String(sessionUser?.id || "") }
      });
      if(!res.ok) throw new Error("Error listando tareas");
      tareasCache = await res.json();
    }catch(err){
      console.error(err);
      tareasCache = [];
    }
  }

  async function askDueDateYMD(msg = "📅 Ingresa la fecha de vencimiento de la tarea (formato YYYY-MM-DD)") {
    const def = fmtYMD(addDays(new Date(), 3));
    let v = window.prompt(`${msg}\nEjemplo sugerido: ${def}`, def);
    if (v == null) return null;
    v = v.trim();
    if (!isValidYMD(v)){
      showToast({type:"error", title:"Fecha inválida", message:"Usa el formato YYYY-MM-DD"});
      return await askDueDateYMD(msg);
    }
    return v;
  }

  async function createTask(projectId){
    mustHaveEmail();
    const title = ($ctTitle.value||"").trim();
    const description = ($ctDesc.value||"").trim();
    const estimatedHours = $ctEstimated.value ? Number($ctEstimated.value) : null;
    const priority = ($ctPriority.value||"").trim() || null;

    const assigneeSelect = $ctAssignee;
    const selectedOpt = assigneeSelect?.selectedOptions?.[0];

    let assigneeEmail = selectedOpt?.dataset?.email || sessionEmail;
    let assigneeName  = selectedOpt?.dataset?.nombre || (sessionUser?.nombre || sessionEmail);

    // Usuario normal SOLO puede crear tareas para él mismo
    if (!(isGlobalAdmin || isAdminRole() || isSuperiorRole())) {
      assigneeEmail = sessionEmail;
      assigneeName  = (sessionUser?.nombre || sessionEmail);
    }

    if (!title){
      showToast({type:"error", title:"Falta título"});
      return;
    }
    if ((description||"").length > 300){
      showToast({type:"error", title:"Descripción muy larga", message:"Máximo 300 caracteres."});
      return;
    }
    if (estimatedHours != null && estimatedHours > 4){
      showToast({type:"error", title:"Máximo 4 horas"});
      return;
    }

    let fechaLimite = $ctDue.value || null;
    if (!fechaLimite){
      fechaLimite = await askDueDateYMD("📅 Fecha de vencimiento (obligatoria). Formato YYYY-MM-DD");
      if (fechaLimite == null){
        showToast({type:"error", title:"Creación cancelada"});
        return;
      }
    }

    const payload = {
      title,
      description,
      projectId: Number(projectId),
      estimatedHours,
      priority,
      assigneeId: assigneeEmail,
      assigneeName: assigneeName,
      sprintId: currentSprintIdForTaskCreate || null,
      fechaLimite
    };

    try{
      const res = await fetch(TASKS_API, {
        method: "POST",
        headers: { "Content-Type": "application/json", "X-User-Email": sessionEmail },
        body: JSON.stringify(payload)
      });
      if (res.status === 201){
        const created = await res.json();
        tareasCache.unshift(created);
        $ctTitle.value = ""; $ctEstimated.value = ""; $ctPriority.value = ""; $ctDesc.value = ""; $ctAssignee.value = ""; $ctDue.value = "";
        currentSprintIdForTaskCreate = null;
        closeEl($taskCreateOverlay);
        showToast({type:"success", title:"Tarea creada"});
        renderSprints();
      } else {
        const text = await res.text();
        showToast({type:"error", title:"No se creó", message:text || "Valida los datos."});
      }
    }catch(err){
      showToast({type:"error", title:"Error de red", message:"No se pudo crear la tarea."});
    }
  }
  document.getElementById("btn-save-task-create")?.addEventListener("click", ()=>{
    if (!proyectoActual?.id) return;
    createTask(proyectoActual.id);
  });

  async function deleteTask(id){
    mustHaveEmail();

    const task = tareasCache.find(t => t.id === id);
    if (!task || !canDeleteTask(task)) {
      showToast({type:"error", title:"Sin permiso", message:"No puedes borrar esta tarea."});
      return;
    }

    const url = `${TASKS_API}/${Number(id)}`;

    const headers = {};
    if (sessionEmail) headers["X-User-Email"] = sessionEmail;
    if (sessionUser?.rol) headers["X-User-Role"] = String(sessionUser.rol);
    if (sessionUser?.id != null) headers["X-User-Id"] = String(sessionUser.id);

    try{
      const res = await fetch(url, {
        method: "DELETE",
        headers,
        credentials: "include"
      });

      if (res.status === 204){
        tareasCache = tareasCache.filter(t => t.id !== id);
        renderSprints();
        showToast({type:"success", title:"Tarea eliminada"});
        return;
      }

      const text = await res.text().catch(()=> "");
      const msg = `Error ${res.status}${text ? `: ${text}` : ""}`;
      console.error("DELETE /tasks error →", msg);
      showToast({type:"error", title:"No se pudo borrar", message: text || "Revisa permisos/CORS/CSRF"});
    }catch(err){
      console.error("DELETE /tasks network error →", err);
      showToast({type:"error", title:"Error de red"});
    }
  }

  async function toggleTaskStatus(id, toDone, realHours){
    mustHaveEmail();

    const task = tareasCache.find(t => t.id === id);
    if (!task || !canToggleTask(task)) {
      showToast({type:"error", title:"Sin permiso", message:"No puedes cambiar el estado de esta tarea."});
      return;
    }

    const newStatus = toDone ? "done" : "todo";
    const payload = toDone
      ? { status: newStatus, realHours: Number(realHours), completedAt: new Date().toISOString() }
      : { status: newStatus, realHours: null, completedAt: null };

    try{
      const res = await fetch(`${TASKS_API}/${id}/status`, {
        method: "PATCH",
        headers: { "Content-Type": "application/json", "X-User-Email": sessionEmail },
        body: JSON.stringify(payload)
      });
      if (res.ok){
        const updated = await res.json();
        const idx = tareasCache.findIndex(t => t.id === id);
        if (idx >= 0) tareasCache[idx] = updated;
        renderSprints();
      } else {
        const text = await res.text().catch(()=> "");
        showToast({type:"error", title:"No se pudo actualizar estado", message:text});
      }
    }catch(err){
      showToast({type:"error", title:"Error de red", message:"No se pudo actualizar estado"});
    }
  }

  function openTaskEditModal(t){
    if (!canEditTask(t)) {
      showToast({type:"error", title:"Sin permiso", message:"No puedes editar esta tarea."});
      return;
    }

    $etId.textContent = `#${t.id}`;
    $etTitle.value = t.title || "";
    $etEstimated.value = t.estimatedHours ?? "";
    $etPriority.value = t.priority || "";
    $etDesc.value = t.description || t.longDescription || "";
    $etDue.value = t.fechaLimite ? toISODateInput(t.fechaLimite) : "";
    populateAssigneeSelect($etAssignee);

    if (t.assigneeId) {
      const opt = [...$etAssignee.options].find(o => o.dataset.email && o.dataset.email.toLowerCase() === String(t.assigneeId).toLowerCase());
      if (opt) $etAssignee.value = opt.value;
    }

    openEl($taskEditOverlay);
    $btnSaveTaskEdit.onclick = () => saveTaskEdits(t.id);
  }

  async function saveTaskEdits(taskId){
    mustHaveEmail();

    const existing = tareasCache.find(t => t.id === taskId);
    if (!existing) return;
    if (!canEditTask(existing)) {
      showToast({type:"error", title:"Sin permiso", message:"No puedes editar esta tarea."});
      return;
    }

    const title = ($etTitle.value||"").trim();
    const description = ($etDesc.value||"").trim();
    const estimatedHours = $etEstimated.value ? Number($etEstimated.value) : null;
    const priority = ($etPriority.value||"").trim() || null;
    let fechaLimite = $etDue.value || null;

    const assigneeSelect = $etAssignee;
    const selectedOpt = assigneeSelect?.selectedOptions?.[0];
    let assigneeEmail = selectedOpt?.dataset?.email || existing.assigneeId || null;
    let assigneeName  = selectedOpt?.dataset?.nombre || existing.assigneeName || null;

    if (!(isGlobalAdmin || isAdminRole() || isSuperiorRole())) {
      assigneeEmail = existing.assigneeId || sessionEmail;
      assigneeName  = existing.assigneeName || sessionUser?.nombre || sessionEmail;
    }

    if (!title){
      showToast({type:"error", title:"Falta título"});
      return;
    }
    if ((description||"").length > 300){
      showToast({type:"error", title:"Descripción muy larga", message:"Máximo 300 caracteres."});
      return;
    }
    if (estimatedHours != null && estimatedHours > 4){
      showToast({type:"error", title:"Máximo 4 horas"});
      return;
    }

    const sprintId = existing?.sprintId ?? null;

    const payload = {
      title,
      description,
      estimatedHours,
      priority,
      assigneeId: assigneeEmail || undefined,
      assigneeName: assigneeName || undefined,
      sprintId,
      fechaLimite
    };
    try{
      const res = await fetch(`${TASKS_API}/${taskId}`, {
        method: "PUT",
        headers: { "Content-Type": "application/json", "X-User-Email": sessionEmail },
        body: JSON.stringify(payload)
      });
      if (res.ok){
        const updated = await res.json();
        const idx = tareasCache.findIndex(t => t.id === taskId);
        if (idx >= 0) tareasCache[idx] = updated;
        renderSprints();
        closeEl($taskEditOverlay);
        showToast({type:"success", title:"Tarea actualizada"});
      } else {
        const text = await res.text();
        showToast({type:"error", title:"No se pudo actualizar", message:text || ""});
      }
    }catch(err){
      showToast({type:"error", title:"Error de red"});
    }
  }

  /* ========= INICIO ========= */
  document.addEventListener("DOMContentLoaded", ()=>{
    applyMinTodayToCalendars();
    cargarProyecto();
  });
</script>



</body>
</html>
