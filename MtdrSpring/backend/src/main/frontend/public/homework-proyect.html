<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Detalle del Proyecto</title>
  <link rel="stylesheet" href="Css/projects.css"/>
  <link rel="stylesheet" href="Css/homework-project.css"/>

    <!-- Sprite de √≠conos -->
  <svg xmlns="http://www.w3.org/2000/svg" style="display:none">
    <!-- Dashboard -->
    <symbol id="i-dashboard" viewBox="0 0 24 24" fill="none" stroke="currentColor">
      <path stroke-width="1.6" d="M3 3h8v8H3zM13 3h8v5h-8zM13 10h8v11h-8zM3 13h8v8H3z"/>
    </symbol>
    <!-- Equipos -->
    <symbol id="i-users" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round">
      <path d="M17 21v-2a4 4 0 0 0-3-3.87"/>
      <path d="M7 21v-2a4 4 0 0 1 3-3.87"/>
      <circle cx="12" cy="7" r="4"/>
      <path d="M5.5 8a3.5 3.5 0 1 0 0 7"/>
      <path d="M18.5 8a3.5 3.5 0 1 1 0 7"/>
    </symbol>
    <!-- Proyectos -->
    <symbol id="i-folder" viewBox="0 0 24 24" fill="none" stroke="currentColor">
      <path stroke-width="1.6" d="M3 7h6l2 2h10v9a3 3 0 0 1-3 3H6a3 3 0 0 1-3-3z"/>
    </symbol>
    <!-- Tareas -->
    <symbol id="i-board" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <rect width="8" height="4" x="8" y="2" rx="1" ry="1"/>
      <path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"/>
      <path d="M12 11h4"/><path d="M12 16h4"/>
      <path d="M8 11h.01"/><path d="M8 16h.01"/>
    </symbol>
    <!-- KPIs -->
    <symbol id="i-chart" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round">
      <path d="M12 16v5"/>
      <path d="M16 14v7"/>
      <path d="M20 10v11"/>
      <path d="m22 3-8.646 8.646a.5.5 0 0 1-.708 0L9.354 8.354a.5.5 0 0 0-.707 0L2 15"/>
      <path d="M4 18v3"/>
      <path d="M8 14v7"/>
    </symbol>
    <!-- Chatbot -->
    <symbol id="i-bot" viewBox="0 0 24 24" fill="none" stroke="currentColor">
      <rect x="4" y="8" width="16" height="10" rx="4" stroke-width="1.6"/>
      <circle cx="9" cy="13" r="1" stroke-width="1.6"/>
      <circle cx="15" cy="13" r="1" stroke-width="1.6"/>
      <path stroke-width="1.6" d="M12 4v2m-7 6H4m16 0h1"/>
    </symbol>
    <!-- Notificaciones -->
    <symbol id="i-bell" viewBox="0 0 24 24" fill="none" stroke="currentColor">
      <path stroke-width="1.6" d="M18 8a6 6 0 1 0-12 0c0 7-3 7-3 7h18s-3 0-3-7"/>
      <path stroke-width="1.6" d="M13.73 21a2 2 0 0 1-3.46 0"/>
    </symbol>
    <!-- Ajustes -->
    <symbol id="i-gear" viewBox="0 0 24 24" fill="none" stroke="currentColor">
      <circle cx="12" cy="12" r="3" />
      <path stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round" d="M9.671 4.136a2.34 2.34 0 0 1 4.659 0 2.34 2.34 0 0 0 3.319 1.915 2.34 2.34 0 0 1 2.33 4.033 2.34 2.34 0 0 0 0 3.831 2.34 2.34 0 0 1-2.33 4.033 2.34 2.34 0 0 0-3.319 1.915 2.34 2.34 0 0 1-4.659 0 2.34 2.34 0 0 0-3.32-1.915 2.34 2.34 0 0 1-2.33-4.033 2.34 2.34 0 0 0 0-3.831A2.34 2.34 0  0 1 6.35 6.051a2.34 2.34 0 0 0 3.319-1.915" />
    </symbol>
    <!-- Exit -->
    <symbol id="i-exit" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <path d="m16 17 5-5-5-5"/>
      <path d="M21 12H9"/>
      <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/>
    </symbol>
  </svg>

  <style>
    body{ background:
      radial-gradient(1200px 600px at -10% -20%, rgba(225,38,28,.06), transparent 60%),
      radial-gradient(1200px 600px at 110% -10%, rgba(16,24,40,.06), transparent 55%),
      var(--bg);
    }
    .container-wide{ padding:26px }
    .page-actions{ display:flex; gap:10px; align-items:center; margin-bottom:14px }
    .hero-card{
      padding:20px; border-radius:24px;
      background: linear-gradient(180deg, #ffffff 0%, #fafbfc 100%),
                 radial-gradient(600px 180px at 20% -40%, rgba(225,38,28,.08), transparent 60%);
      border:1px solid var(--line); box-shadow:0 16px 40px rgba(17,24,39,.06);
    }
    .hero-head{ display:flex; flex-direction:column; gap:6px }
    .project-title{ margin:0; font-weight:900; letter-spacing:.2px; font-size: clamp(22px, 3.2vw, 28px) }
    .meta-row{ display:flex; gap:10px; align-items:center; flex-wrap:wrap }
    .project-desc{ color:var(--muted-2); background:#fff; border:1px solid var(--line); padding:6px 10px; border-radius:12px }
    .team-pill{ background:#fff; border:1px solid var(--line); padding:6px 10px; border-radius:999px; font-size:12px }
    .status-advance{ margin-top:12px }
    .status-chip-wrap{ display:flex; gap:8px }
    .progress-layout{ display:grid; gap:16px; grid-template-columns: 210px 1fr; align-items:center; margin-top:8px; }
    @media (max-width: 980px){ .progress-layout{ grid-template-columns: 1fr } }
    .board{ display:grid; gap:12px; grid-template-columns: repeat(2, minmax(0,1fr)); }
    @media (max-width: 720px){ .board{ grid-template-columns: 1fr } }
    .stat-card{ background:#fff; border:1px solid var(--line); border-radius:16px; padding:12px 14px; display:flex; flex-direction:column; gap:8px; }
    .stat-card .label{ font-size:12px; color:var(--muted-2); font-weight:700 }
    .stat-card .value{ font-weight:900 }
    .radial-wrap{ display:flex; align-items:center; justify-content:center; background:#fff; border:1px solid var(--line); border-radius:18px; padding:16px; }
    .radial-progress{ --p:0; width:150px; height:150px; border-radius:50%;
      background: conic-gradient(var(--brand) calc(var(--p)*1%), #eef1f6 0);
      display:grid; place-items:center; color:#111; position:relative; box-shadow: inset 0 0 0 1px #f3f4f6;
    }
    .radial-progress::after{ content:""; position:absolute; inset:12px; background:#fff; border-radius:50%; box-shadow: inset 0 0 0 1px var(--line); }
    .radial-progress > span{ position:relative; font-weight:900; font-size:22px }
    .tasks-card{ border-radius:24px; border:1px solid var(--line); background:linear-gradient(180deg,#fff 0%, #fbfcff 100%); box-shadow: var(--shadow-md); }
    .tasks-head{ display:flex; align-items:center; justify-content:space-between; padding:14px 16px; border-bottom:1px solid var(--line); }
    .tasks-head h2{ margin:0; font-size:18px; font-weight:900 }
    .task-form{ padding:14px 16px; display:grid; gap:10px; grid-template-columns: 1.2fr .8fr .7fr auto; align-items:start }
    .task-form textarea{ min-height:38px; height:38px; resize:vertical; max-height:140px }
    @media (max-width: 980px){ .task-form{ grid-template-columns: 1fr 1fr } .task-form .span-2{ grid-column: 1 / -1 } }
    .field{ display:flex; flex-direction:column; gap:6px }
    .field label{ font-size:12px; color:var(--muted) }
    .field input, .field select, .field textarea{ border:1px solid var(--line-2); border-radius:12px; padding:9px 12px; background:#fff; color:#111; outline:none; transition:border-color .12s ease, box-shadow .12s ease; }
    .field input:focus, .field select:focus, .field textarea:focus{ border-color:#d4dae1; box-shadow:0 0 0 4px rgba(225,38,28,.08) }
    .hint{ font-size:11px; color:#6b7280 }
    .hint .ok{ color:#0a7a2e; font-weight:700 }
    .hint .bad{ color:#b42318; font-weight:700 }
    .tasks-list{ padding:6px 16px 16px 16px }
    .task-item{ border:1px solid var(--line); border-radius:14px; background:#fff; padding:10px 12px; margin:10px 0; display:grid; grid-template-columns: auto 1fr auto; gap:10px; align-items:center; box-shadow: var(--shadow-sm); }
    .task-title{ font-weight:900 }
    .task-meta{ font-size:12px; color:#64748b }
    .task-actions{ display:flex; gap:6px; align-items:center }
    .badge{ font-size:12px; border:1px solid var(--line); padding:2px 8px; border-radius:999px; background:#fff }
    .badge.status.todo{ background:#fff4f3 }
    .badge.status.done{ background:#e9fff0 }
    .desc-toggle{ cursor:pointer; font-size:12px; color:#1a56db; text-decoration:underline; background:none; border:none; padding:0 }
    .task-desc{ grid-column: 2 / -1; margin-top:-4px; margin-bottom:2px; padding:10px; border-radius:10px; background:#f8fafc; color:#334155; border:1px dashed #e6e9ef; display:none; }
    .task-desc.show{ display:block }
    .btn-danger.btn-xs{ padding:6px 10px; border-radius:10px; font-size:11px }
    .btn-ghost{ display:inline-flex; align-items:center; gap:8px; padding:9px 12px; border-radius:12px; background:#fff; color:var(--dark); border:1px solid var(--line-2); font-weight:800; font-size:13px; text-decoration:none; cursor:pointer; box-shadow: var(--shadow-sm); }
    .btn-ghost:hover{ transform: translateY(-1px); box-shadow: var(--shadow-md); border-color:#d9dde3; }
  </style>
</head>

<body>

      <!-- Topbar -->
  <header class="topbar">
    <div class="brand">
      <h1 class="logo-text">TMDV</h1>
    </div>
    <div class="topbar-right">
      <div class="user-circle" title="Usuario">U</div>
      <a href="/index.html" class="logout-btn">
        <svg class="ico-sm" aria-hidden="true"><use href="#i-exit"/></svg>
        <span>Salir</span>
      </a>
    </div>
  </header>

  <div class="app">
        <!-- Sidebar -->
    <aside class="aside">
      <nav class="menu">
        <a class="mi" href="/dashboard.html">
          <svg class="ico"><use href="#i-dashboard"/></svg>
          <span>Dashboard</span>
        </a>
        <a class="mi" href="/Equipos.html">
          <svg class="ico"><use href="#i-users"/></svg>
          <span>Equipos</span>
        </a>
        <a class="mi active" href="/projects.html">
          <svg class="ico"><use href="#i-folder"/></svg>
          <span>Proyectos</span>
        </a>
        <a class="mi" href="/tarea.html">
          <svg class="ico"><use href="#i-board"/></svg>
          <span>Tareas</span>
        </a>
        <a class="mi" href="/KPIs.html">
          <svg class="ico"><use href="#i-chart"/></svg>
          <span>KPIs</span>
        </a>
        <a class="mi" href="/chatbot.html">
          <svg class="ico"><use href="#i-bot"/></svg>
          <span>Chatbot</span>
        </a>
        <a class="mi" href="/notifications.html">
          <svg class="ico"><use href="#i-bell"/></svg>
          <span>Notificaciones</span>
        </a>
        <a class="mi" href="/settings.html">
          <svg class="ico"><use href="#i-gear"/></svg>
          <span>Ajustes</span>
        </a>
      </nav>
    </aside>

    <main class="container container-wide">
      <div class="page-actions">
        <a href="projects.html" class="btn btn-outline">‚Üê Volver</a>
        <button id="btn-editar" class="btn btn-primary">Editar proyecto</button>
      </div>

      <section class="card hero-card">
        <div class="hero-head">
          <h1 class="project-title" id="vm-nombre">Nombre del proyecto</h1>
          <div class="meta-row">
            <span id="vm-desc" class="project-desc">Descripci√≥n del proyecto‚Ä¶</span>
            <span class="team-pill">Equipo <strong id="vm-equipo">‚Äî</strong></span>
          </div>
        </div>

        <div class="status-advance">
          <div class="status-chip-wrap">
            <span id="vm-estado-chip" class="chip">‚Äî</span>
          </div>

          <div class="progress-layout">
            <div class="radial-wrap">
              <div id="vm-radial" class="radial-progress" style="--p:0">
                <span id="vm-percent">0%</span>
              </div>
            </div>

            <div class="board">
              <div class="stat-card">
                <div class="label">Inicio</div>
                <div class="value" id="vm-inicio">‚Äî</div>
              </div>
              <div class="stat-card">
                <div class="label">Fin</div>
                <div class="value" id="vm-fin">‚Äî</div>
              </div>
              <div class="stat-card" style="grid-column: 1 / -1">
                <div class="label">Avance por tareas</div>
                <div class="progress" style="margin-top:8px"><span id="vm-bar" style="width:0%"></span></div>
                <div class="tiny muted" id="tasks-summary" style="margin-top:6px">0/0 completadas</div>
              </div>
            </div>
          </div>
        </div>
      </section>

      <section class="tasks-card">
        <div class="tasks-head">
          <h2 class="h6">Tareas del proyecto</h2>
          <button id="btn-refrescar" class="btn-ghost">‚Üª Refrescar</button>
        </div>

        <div class="task-form">
          <div class="field">
            <label for="t-title">T√≠tulo</label>
            <input id="t-title" placeholder="Ej. Dise√±ar mockups de login">
            <div class="hint" id="hint-title">Obligatorio</div>
          </div>

          <div class="field">
            <label for="t-estimated">Horas estimadas (‚â§ 4)</label>
            <input id="t-estimated" type="number" step="0.5" min="0" max="4" placeholder="Ej. 2">
            <div class="hint" id="hint-est">Recomendado: ‚â§ 4h</div>
          </div>

          <div class="field">
            <label for="t-priority">Prioridad</label>
            <select id="t-priority">
              <option value="">Seleccionar</option>
              <option>Alta</option>
              <option>Media</option>
              <option>Baja</option>
            </select>
          </div>

          <div class="field span-2">
            <label for="t-desc">Descripci√≥n</label>
            <textarea id="t-desc" placeholder="Breve detalle de la tarea‚Ä¶"></textarea>
            <div class="hint" id="hint-desc"><span id="desc-count">0</span>/300</div>
          </div>

          <div class="field">
            <label>&nbsp;</label>
            <button id="btn-add-task" class="btn btn-primary">+ Agregar</button>
          </div>
        </div>

        <div id="tasks-list" class="tasks-list">
          <div class="muted" style="padding:6px 0 12px">Cargando tareas‚Ä¶</div>
        </div>
      </section>
    </main>
  </div>

  <div id="toast-stack" class="toast-stack" aria-live="polite" aria-atomic="true"></div>

  <!-- Modal Edici√≥n Proyecto -->
  <div id="edit-modal-overlay" class="edit-modal-overlay" aria-hidden="true">
    <div class="edit-modal" role="dialog" aria-modal="true" aria-labelledby="edit-modal-title">
      <div class="edit-modal-header">
        <h2 class="h6" id="edit-modal-title">Editar proyecto <span id="p-id">‚Äî</span></h2>
        <button id="btn-close-modal" class="icon-btn" aria-label="Cerrar">‚úï</button>
      </div>

      <div class="edit-modal-body">
        <div class="grid2">
          <div class="field">
            <label>Nombre</label>
            <input id="p-nombre" type="text" placeholder="Nombre del proyecto">
          </div>
          <div class="field">
            <label>Equipo ID</label>
            <input id="p-equipo" type="number" min="1" placeholder="Ej. 1">
          </div>
          <div class="field field-full">
            <label>Descripci√≥n</label>
            <input id="p-desc" type="text" placeholder="Breve descripci√≥n">
          </div>
          <div class="field">
            <label>Inicio</label>
            <input id="p-inicio" type="date">
          </div>
          <div class="field">
            <label>Fin</label>
            <input id="p-fin" type="date">
          </div>
          <div class="field">
            <label>Estado</label>
            <select id="p-estado-sel">
              <option value="Pendiente">Pendiente</option>
              <option value="En curso">En curso</option>
              <option value="Finalizado">Finalizado</option>
            </select>
          </div>
        </div>

        <div class="edit-progress" style="display:flex; align-items:center; gap:12px; margin-top:10px;">
          <div class="radial-wrap" style="padding:10px">
            <div id="p-radial" class="radial-progress" style="--p:0; width:80px;height:80px">
              <span id="p-percent" style="font-size:14px">0%</span>
            </div>
          </div>
          <div style="flex:1">
            <div class="progress"><span id="p-avance" style="width:0%"></span></div>
            <div class="tiny muted" id="p-avance-text">0%</div>
          </div>
        </div>
      </div>

      <div class="edit-modal-footer" style="display:flex; justify-content:flex-end; gap:10px; margin-top:10px;">
        <button id="btn-cancelar" class="btn btn-outline">Cancelar</button>
        <button id="btn-guardar" class="btn btn-primary">Guardar</button>
      </div>
    </div>
  </div>

  <script>
    /* ================== CONFIG ================== */
    const API_BASE  = "http://localhost:8080/proyectos";
    const TASKS_API = "/api/tasks";

    /* ========= UTILIDADES ========= */
    function qs(name){ return new URL(window.location.href).searchParams.get(name); }
    function estadoToChipClass(estado){
      switch((estado||"").toLowerCase()){
        case "pendiente": return "chip state-pend";
        case "en curso":  return "chip state-run";
        case "finalizado":return "chip state-done";
        default: return "chip";
      }
    }
    function fmtFecha(iso){
      if(!iso) return "‚Äî";
      const d = new Date(iso);
      if (isNaN(d.getTime())) return iso;
      return d.toLocaleDateString();
    }
    function toISODateInput(iso){
      if(!iso) return "";
      const d = new Date(iso);
      if (isNaN(d.getTime())) return iso;
      const yy = d.getFullYear(), mm = String(d.getMonth()+1).padStart(2,"0"), dd = String(d.getDate()).padStart(2,"0");
      return `${yy}-${mm}-${dd}`;
    }
    function getRadialPercent(el){
      const v = getComputedStyle(el).getPropertyValue('--p').trim();
      const n = parseFloat(v || '0');
      return isNaN(n) ? 0 : n;
    }
    function easeInOut(t){ return t<.5 ? 2*t*t : 1 - Math.pow(-2*t+2,2)/2; }
    function setRadialAnimated(el, toPercent, labelEl, duration=600){
      const from = getRadialPercent(el);
      const to = Math.max(0, Math.min(100, toPercent|0));
      if (from === to){
        if (labelEl) labelEl.textContent = to + "%";
        el.style.setProperty('--p', to);
        return;
      }
      const start = performance.now();
      function step(now){
        const t = Math.min(1, (now - start) / duration);
        const eased = easeInOut(t);
        const val = Math.round(from + (to - from) * eased);
        el.style.setProperty('--p', val);
        if (labelEl) labelEl.textContent = val + "%";
        if (t < 1) requestAnimationFrame(step);
      }
      requestAnimationFrame(step);
    }
    function escapeHtml(s){ return String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])) }

    // Toasts
    const $toastStack = document.getElementById('toast-stack');
    function showToast({type="success", title="Listo", message="", timeout=3000}={}){
      const item = document.createElement('div');
      item.className = `toast ${type}`;
      item.innerHTML = `
        <div class="toast-icon">${type==="success"?"‚úÖ":type==="error"?"‚ö†Ô∏è":"‚ÑπÔ∏è"}</div>
        <div class="toast-body">
          <div class="toast-title">${title}</div>
          ${message?`<div class="toast-msg">${message}</div>`:""}
          <div class="toast-progress"></div>
        </div>
        <button class="toast-close" aria-label="Cerrar">‚úï</button>
      `;
      $toastStack.appendChild(item);
      const dismiss = ()=>{ item.classList.remove('show'); setTimeout(()=> item.remove(), 180); };
      item.querySelector('.toast-close').onclick = dismiss;
      setTimeout(()=> item.classList.add('show'), 10);
      const bar = item.querySelector('.toast-progress');
      bar.style.animationDuration = `${timeout}ms`;
      const auto = setTimeout(dismiss, timeout);
      item.addEventListener('mouseenter', ()=>{ bar.style.animationPlayState="paused"; clearTimeout(auto); });
      item.addEventListener('mouseleave', ()=>{ bar.style.animationPlayState="running"; setTimeout(dismiss, 1200); });
    }

    /* ========= SESI√ìN ========= */
    const sessionUser  = JSON.parse(localStorage.getItem("user") || "null");
    const sessionEmail = sessionUser?.email || "";
    function mustHaveEmail(){
      if(!sessionEmail){
        showToast({type:"error", title:"Sesi√≥n requerida", message:"Inicia sesi√≥n para gestionar tareas."});
        throw new Error("No session email");
      }
    }

    /* ========= REFS VISTA ========= */
    const $vmNombre = document.getElementById("vm-nombre");
    const $vmEquipo = document.getElementById("vm-equipo");
    const $vmDesc   = document.getElementById("vm-desc");
    const $vmEstadoChip = document.getElementById("vm-estado-chip");
    const $vmRadial = document.getElementById("vm-radial");
    const $vmPercent= document.getElementById("vm-percent");
    const $vmBar    = document.getElementById("vm-bar");
    const $vmIni    = document.getElementById("vm-inicio");
    const $vmFin    = document.getElementById("vm-fin");
    const $tasksSummary = document.getElementById("tasks-summary");

    const $btnEditar = document.getElementById("btn-editar");
    const $btnRefrescar = document.getElementById("btn-refrescar");

    // Modal edici√≥n
    const $overlay = document.getElementById("edit-modal-overlay");
    const $btnClose = document.getElementById("btn-close-modal");
    const $btnCancelar = document.getElementById("btn-cancelar");
    const $btnGuardar = document.getElementById("btn-guardar");
    const $pId = document.getElementById("p-id");
    const $nombre = document.getElementById("p-nombre");
    const $equipo = document.getElementById("p-equipo");
    const $descP  = document.getElementById("p-desc");
    const $inicio = document.getElementById("p-inicio");
    const $fin    = document.getElementById("p-fin");
    const $estadoSel = document.getElementById("p-estado-sel");
    const $pRadial = document.getElementById("p-radial");
    const $pPercent= document.getElementById("p-percent");
    const $pAvance = document.getElementById("p-avance");
    const $pAvanceText = document.getElementById("p-avance-text");

    // Tareas
    const $tasksListEl  = document.getElementById("tasks-list");
    const $btnAddTask   = document.getElementById("btn-add-task");
    const $tTitle       = document.getElementById("t-title");
    const $tEstimated   = document.getElementById("t-estimated");
    const $tPriority    = document.getElementById("t-priority");
    const $tDesc        = document.getElementById("t-desc");
    const $descCount    = document.getElementById("desc-count");

    /* ========= ESTADO ========= */
    let proyectoActual = null;
    let tareasCache = [];

    /* ========= HELPERS UI ========= */
    $tDesc.addEventListener("input", ()=>{
      const len = ($tDesc.value || "").length;
      $descCount.textContent = len;
      if (len > 300) $tDesc.value = $tDesc.value.slice(0, 300);
    });

    function pintarView(p){
      $vmNombre.textContent = p.nombreProyecto || "‚Äî";
      $vmEquipo.textContent = (p.equipoId ?? "‚Äî");
      $vmDesc.textContent   = p.descripcion || "‚Äî";
      $vmEstadoChip.className = estadoToChipClass(p.estado);
      $vmEstadoChip.textContent = p.estado || "‚Äî";
      $vmIni.textContent = fmtFecha(p.fechaInicio);
      $vmFin.textContent = fmtFecha(p.fechaFin);

      const initialPct = (p.estado==="Finalizado") ? 100 : (p.estado==="En curso" ? 50 : 0);
      setRadialAnimated($vmRadial, initialPct, $vmPercent, 600);
      $vmBar.style.width = initialPct + "%";
    }

    async function cargarProyecto(){
      const id = qs("id");
      if(!id){
        showToast({type:"error", title:"Falta el id", message:"No se encontr√≥ ?id en la URL"});
        window.location.href = "projects.html";
        return;
      }
      try{
        const res = await fetch(`${API_BASE}/${id}`);
        if(!res.ok) throw new Error("No encontrado");
        const p = await res.json();
        proyectoActual = p;
        pintarView(p);
        await loadTasks(p.id);
      }catch(e){
        showToast({type:"error", title:"No se pudo cargar", message:"Intenta de nuevo m√°s tarde"});
        window.location.href = "projects.html";
      }
    }

    /* ========= MODAL EDICI√ìN ========= */
    function openModal(){
      if(!proyectoActual) return;
      const p = proyectoActual;
      $pId.textContent = `#${p.id}`;
      $nombre.value = p.nombreProyecto || "";
      $equipo.value = (p.equipoId ?? "");
      $descP.value  = p.descripcion || "";
      $inicio.value = toISODateInput(p.fechaInicio);
      $fin.value    = toISODateInput(p.fechaFin);
      $estadoSel.value = p.estado || "Pendiente";

      const av = (p.estado==="Finalizado") ? 100 : (p.estado==="En curso" ? 50 : 0);
      setRadialAnimated($pRadial, av, $pPercent, 500);
      $pAvance.style.width = av + "%";
      $pAvanceText.textContent = av + "%";

      $overlay.classList.add("open");
      $overlay.setAttribute("aria-hidden","false");
    }
    function closeModal(){
      $overlay.classList.remove("open");
      $overlay.setAttribute("aria-hidden","true");
    }
    $estadoSel.addEventListener("change", () => {
      const est = $estadoSel.value;
      const av = (est==="Finalizado") ? 100 : (est==="En curso" ? 50 : 0);
      setRadialAnimated($pRadial, av, $pPercent, 500);
      $pAvance.style.width = av + "%";
      $pAvanceText.textContent = av + "%";
    });
    $btnEditar.addEventListener("click", openModal);
    $btnClose.addEventListener("click", closeModal);
    $overlay.addEventListener("click", (e) => { if (e.target === $overlay) closeModal(); });
    $btnCancelar.addEventListener("click", (e) => { e.preventDefault(); closeModal(); });
    $btnGuardar.addEventListener("click", async () => {
      if (!proyectoActual) return;
      const payload = {
        id: proyectoActual.id,
        nombreProyecto: $nombre.value.trim(),
        descripcion: $descP.value.trim(),
        estado: $estadoSel.value,
        equipoId: Number($equipo.value||0),
        fechaInicio: $inicio.value || null,
        fechaFin: $fin.value || null,
        ultimoAcceso: proyectoActual.ultimoAcceso || null
      };
      try{
        const res = await fetch(`${API_BASE}/${proyectoActual.id}`, {
          method:"PUT",
          headers:{ "Content-Type":"application/json" },
          body: JSON.stringify(payload)
        });
        if (res.ok){
          proyectoActual = await res.json();
          pintarView(proyectoActual);
          closeModal();
          showToast({type:"success", title:"Cambios guardados", message:"El proyecto se actualiz√≥ correctamente."});
          updateProgressFromTasks(); // re-sincroniza visual con tareas
        } else {
          showToast({type:"error", title:"Error al guardar", message:"Revisa los datos e int√©ntalo nuevamente."});
        }
      }catch(err){
        showToast({type:"error", title:"Error de red", message:"No se pudo conectar con el servidor."});
      }
    });
    document.addEventListener("keydown", (e)=>{ if(e.key==="Escape") closeModal(); });

    /* ========= PERSISTIR ESTADO DESDE % ========= */
    async function persistProjectEstadoFromPct(pct){
      if (!proyectoActual?.id) return;
      const nuevo = (pct===0) ? "Pendiente" : (pct===100 ? "Finalizado" : "En curso");
      if (proyectoActual.estado === nuevo) return;
      const payload = {
        id: proyectoActual.id,
        nombreProyecto: proyectoActual.nombreProyecto,
        descripcion: proyectoActual.descripcion,
        estado: nuevo,
        equipoId: proyectoActual.equipoId,
        fechaInicio: proyectoActual.fechaInicio || null,
        fechaFin: proyectoActual.fechaFin || null,
        ultimoAcceso: proyectoActual.ultimoAcceso || null
      };
      try{
        const res = await fetch(`${API_BASE}/${proyectoActual.id}`, {
          method:"PUT",
          headers:{ "Content-Type":"application/json" },
          body: JSON.stringify(payload)
        });
        if (res.ok){
          const updated = await res.json();
          proyectoActual.estado = updated.estado;
          // Refrescar chip
          $vmEstadoChip.className = estadoToChipClass(updated.estado);
          $vmEstadoChip.textContent = updated.estado;
        }
      }catch(e){ /* silencioso */ }
    }

    /* ========= TAREAS ========= */
    function tareaRow(t){
      const isDone = (t.status||"").toLowerCase()==="done" || (t.completedAt != null);
      const descHtml = escapeHtml(t.description || t.longDescription || "");
      return `
        <div class="task-item" data-id="${t.id}">
          <input type="checkbox" class="t-check" ${isDone ? "checked" : ""} title="Completar / Reabrir">
          <div>
            <div class="task-title">${escapeHtml(t.title || '')}</div>
            <div class="task-meta">
              Prio: ${escapeHtml(t.priority||'-')}
              ¬∑ Est: ${t.estimatedHours ?? '-'}h
              ${t.realHours ? (' ¬∑ Real: '+t.realHours+'h') : ''}
            </div>
          </div>
          <div class="task-actions">
            <span class="badge status ${isDone?'done':'todo'}">${isDone?'done':'todo'}</span>
            ${descHtml ? `<button class="desc-toggle" type="button">ver descripci√≥n</button>` : ""}
            <button class="btn-danger btn-xs t-del" title="Borrar">Borrar</button>
          </div>
          ${descHtml ? `<div class="task-desc">${descHtml}</div>` : ""}
        </div>
      `;
    }

    function updateProgressFromTasks(){
      const total = tareasCache.length;
      const done  = tareasCache.filter(t => (t.status||"").toLowerCase()==="done" || t.completedAt != null).length;
      $tasksSummary.textContent = `${done}/${total} completadas`;
      const pct = total === 0 ? 0 : Math.round((done/total)*100);

      setRadialAnimated($vmRadial, pct, $vmPercent, 500);
      $vmBar.style.width = pct + "%";

      // Persistir estado en BD seg√∫n %
      persistProjectEstadoFromPct(pct);
    }

    function renderTareas(arr){
      if(!arr.length){
        $tasksListEl.innerHTML = `<div class="muted" style="padding:6px 0 12px">No hay tareas a√∫n. ¬°Crea la primera! üöÄ</div>`;
      } else {
        $tasksListEl.innerHTML = arr.map(tareaRow).join("");
      }

      $tasksListEl.querySelectorAll(".t-check").forEach(chk => {
        chk.addEventListener("change", async (e)=>{
          const id = Number(e.target.closest(".task-item").dataset.id);
          await toggleTaskStatus(id, e.target.checked);
        });
      });
      $tasksListEl.querySelectorAll(".t-del").forEach(btn => {
        btn.addEventListener("click", async (e)=>{
          const id = Number(e.target.closest(".task-item").dataset.id);
          await deleteTask(id);
        });
      });
      $tasksListEl.querySelectorAll(".desc-toggle").forEach(btn => {
        btn.addEventListener("click", (e)=>{
          const row = e.target.closest(".task-item");
          const desc = row.querySelector(".task-desc");
          if (!desc) return;
          desc.classList.toggle("show");
          e.target.textContent = desc.classList.contains("show") ? "ocultar descripci√≥n" : "ver descripci√≥n";
        });
      });

      updateProgressFromTasks();
    }

    async function loadTasks(projectId){
      mustHaveEmail();
      try{
        const res = await fetch(`${TASKS_API}?projectId=${encodeURIComponent(projectId)}`, {
          headers: { "X-User-Email": sessionEmail }
        });
        if(!res.ok) throw new Error("Error listando tareas");
        tareasCache = await res.json();
        renderTareas(tareasCache);
      }catch(err){
        $tasksListEl.innerHTML = `<div class="muted" style="padding:6px 0 12px">No se pudieron cargar las tareas.</div>`;
      }
    }

    async function createTask(projectId){
      mustHaveEmail();
      const title = ($tTitle.value||"").trim();
      const description = ($tDesc.value||"").trim();
      const estimatedHours = $tEstimated.value ? Number($tEstimated.value) : null;
      const priority = ($tPriority.value||"").trim() || null;

      if (!title){
        showToast({type:"error", title:"Falta t√≠tulo", message:"Escribe el t√≠tulo de la tarea."});
        return;
      }
      if ((description||"").length > 300){
        showToast({type:"error", title:"Descripci√≥n muy larga", message:"M√°ximo 300 caracteres."});
        return;
      }
      if (estimatedHours != null && estimatedHours > 4){
        showToast({type:"error", title:"M√°ximo 4 horas", message:"Divide en subtareas si supera 4h."});
        return;
      }

      const payload = { title, description, projectId: Number(projectId), estimatedHours, priority };

      try{
        const res = await fetch(TASKS_API, {
          method: "POST",
          headers: { "Content-Type": "application/json", "X-User-Email": sessionEmail },
          body: JSON.stringify(payload)
        });
        if (res.status === 201){
          const created = await res.json();
          tareasCache.unshift(created);
          renderTareas(tareasCache);
          $tTitle.value = ""; $tEstimated.value = ""; $tPriority.value = ""; $tDesc.value = ""; $descCount.textContent = "0";
          showToast({type:"success", title:"Tarea creada"});
        } else {
          const text = await res.text();
          showToast({type:"error", title:"No se cre√≥", message:text || "Valida los datos."});
        }
      }catch(err){
        showToast({type:"error", title:"Error de red", message:"No se pudo crear la tarea."});
      }
    }

    async function deleteTask(id){
      mustHaveEmail();
      try{
        const res = await fetch(`${TASKS_API}/${id}`, {
          method: "DELETE",
          headers: { "X-User-Email": sessionEmail }
        });
        if (res.status === 204){
          tareasCache = tareasCache.filter(t => t.id !== id);
          renderTareas(tareasCache);
          showToast({type:"success", title:"Tarea eliminada"});
        } else {
          showToast({type:"error", title:"No se pudo borrar"});
        }
      }catch(err){
        showToast({type:"error", title:"Error de red"});
      }
    }

    async function toggleTaskStatus(id, checked){
      mustHaveEmail();
      const newStatus = checked ? "done" : "todo";
      try{
        const res = await fetch(`${TASKS_API}/${id}/status`, {
          method: "PATCH",
          headers: { "Content-Type": "application/json", "X-User-Email": sessionEmail },
          body: JSON.stringify({ status: newStatus })
        });
        if (res.ok){
          const updated = await res.json();
          const idx = tareasCache.findIndex(t => t.id === id);
          if (idx >= 0) tareasCache[idx] = updated;
          renderTareas(tareasCache);
        } else {
          showToast({type:"error", title:"No se pudo actualizar estado"});
          const chk = $tasksListEl.querySelector(`.task-item[data-id="${id}"] .t-check`);
          if (chk) chk.checked = !checked;
        }
      }catch(err){
        showToast({type:"error", title:"Error de red"});
        const chk = $tasksListEl.querySelector(`.task-item[data-id="${id}"] .t-check`);
        if (chk) chk.checked = !checked;
      }
    }

    if ($btnAddTask){
      $btnAddTask.addEventListener("click", ()=>{
        if (!proyectoActual?.id) return;
        createTask(proyectoActual.id);
      });
    }
    if ($btnRefrescar){
      $btnRefrescar.addEventListener("click", ()=>{
        if (!proyectoActual?.id) return;
        loadTasks(proyectoActual.id);
      });
    }

    document.addEventListener("DOMContentLoaded", cargarProyecto);
  </script>
</body>
</html>
